import{a_ as Q,b6 as ae,b7 as Z,b8 as oe,b9 as i,ba as E,bb as G,b1 as se,bc as _e,aS as B,aT as w,aW as h,b4 as r,bd as me,aX as Y,aU as y,be as fe,aY as be,aV as H,bf as ve,bg as ge,aQ as we,a$ as ne,bh as ie,b3 as J,bi as X,bj as ye,bk as he,b0 as Se,bl as Ie,b2 as j,bm as Ne,bn as ee,bo as Fe,bp as Te,bq as ke,br as xe,bs as Ce}from"./CFpP0Qfr.js";import{u as Re,v as De,a as te,_ as Ue,f as Me,b as Be}from"./CT8jtLTZ.js";import{L as Ee,u as $e}from"./l4Q9i8j1.js";import{u as Le,a as le,b as Ae,_ as Ve}from"./FLvd_8g7.js";import{D as Oe}from"./B7iuO3sF.js";import{_ as Pe}from"./C4sskN5n.js";import{_ as Ke}from"./ChNgszvx.js";import"./BxhtcnH3.js";import"./DdpYE5kc.js";import"./CrJ7IZ_X.js";import"./BFnfdNQ7.js";import"./BRFo-rWG.js";import"./CKvoyTkq.js";import"./D6TRAm2U.js";import"./Dgbln9FO.js";import"./CsGK_NXO.js";import"./BL62hFLV.js";import"./C3jLROnn.js";import"./ChnNUsB3.js";(function(){try{var b=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},l=new b.Error().stack;l&&(b._sentryDebugIds=b._sentryDebugIds||{},b._sentryDebugIds[l]="b7ce7420-8458-4828-b1a4-3c1b9f28f4ce",b._sentryDebugIdIdentifier="sentry-dbid-b7ce7420-8458-4828-b1a4-3c1b9f28f4ce")}catch{}})();const qe={class:"space-y-3"},ze={class:"flex justify-between items-center"},We={class:"text-xs text-gray-500"},je=Q({__name:"RegisterISCN",emits:["handleSubmit","submit","formValidChange"],setup(b,{expose:l,emit:C}){const R=ae(),{getFileType:$}=te(),{LIKE_EVM_NFT_TARGET_ADDRESS:L}=Z().public,{wallet:u,signer:v}=oe(R),{validateWalletConsistency:A}=R,{assertPositiveWalletBalance:s,waitForTransactionReceipt:T}=Le(),{stripHtmlTags:D,formatLanguage:U}=te(),{showErrorToast:V}=le(),{LIKE_NFT_CONTRACT_ADDRESS:k}=Z().public,d=i({type:"Book",title:"",description:"",isbn:"",publisher:"",publicationDate:"",author:{name:"",description:""},license:"All Rights Reserved",customLicense:"",contentFingerprints:[{url:""}],downloadableUrls:[{url:"",type:"",fileName:""}],language:"",bookInfoUrl:"",tags:[],coverUrl:""}),c=i(""),O=i(""),M=C,{payload:n,computeISCNSalt:_}=Re({iscnFormData:d}),{writeContractAsync:x}=Ae(),m=E(()=>De(d.value)),g=E(()=>{var e;return!((e=m.value)!=null&&e.length)});G(g,e=>{M("formValidChange",e)},{immediate:!0}),se(()=>{const e=q();e&&(d.value=e)});const q=()=>{var S,I,p,N,a,o;const e=_e();if(!e)return null;const f={type:"Book",title:((S=e.epubMetadata)==null?void 0:S.title)||"",description:D(((I=e.epubMetadata)==null?void 0:I.description)||""),isbn:"",publisher:"",publicationDate:new Date().toISOString().split("T")[0],author:{name:((p=e.epubMetadata)==null?void 0:p.author)||"",description:""},license:"All Rights Reserved",contentFingerprints:[],downloadableUrls:[],coverUrl:(N=e.epubMetadata)!=null&&N.thumbnailArweaveId?`ar://${e.epubMetadata.thumbnailArweaveId}`:"",language:U(((a=e.epubMetadata)==null?void 0:a.language)||"zh"),tags:((o=e.epubMetadata)==null?void 0:o.tags)||[]};return f.downloadableUrls=e.fileRecords.filter(t=>t.fileType==="application/pdf"||t.fileType==="application/epub+zip").map(t=>({url:t.arweaveKey?t.arweaveLink:`ar://${t.arweaveId}`,type:$(t.fileType),fileName:t.fileName})),f.contentFingerprints=[...new Set(e.fileRecords.map(t=>{const W=t.arweaveKey?t.arweaveLink:`ar://${t.arweaveId}`;return t.fileType==="application/epub+zip"||t.fileType==="application/pdf"?W:`ar://${t.arweaveId}`}).filter(Boolean))].map(t=>({url:t})),f},P=async()=>{if(c.value="checking",!g.value){V(m.value.join(", "));return}d.value.contentFingerprints.length&&await z()},z=async()=>{if(c.value="loading",await A(),!u.value||!v.value){O.value="MISSING_SIGNER",c.value="";return}try{c.value="signing";const e=Me(n.value),f={name:e.name,description:e.description,...e,symbol:"BOOK",image:(e==null?void 0:e.thumbnailUrl)||"",external_link:(e==null?void 0:e.url)||"",nft_meta_collection_id:"nft_book",nft_meta_collection_name:"NFT Book",nft_meta_collection_description:"NFT Book by Liker Land",recordTimestamp:new Date().toISOString()};await s({wallet:u.value});const S=_(u.value),I=await x({address:k,abi:Ee,functionName:"newBookNFT",args:[S,{creator:u.value,updaters:[u.value,L],minters:[u.value,L],config:{name:f.name,symbol:"BOOK",metadata:JSON.stringify(f),max_supply:Oe}},500]}),p=await T({hash:I});if(console.log(p),!p||p.status!=="success")throw new Error("INVALID_RECEIPT");if(!p.logs[0].address)throw new Error("INVALID_CLASS_ID");const N=p.logs[0].address;c.value="success",M("submit",{iscnId:N,txHash:I})}catch(e){console.error(e),V(`'SIGNING_ERROR':${e}`),c.value=""}finally{c.value=""}};return l({onSubmit:P}),(e,f)=>{const S=Ue,I=fe,p=ve,N=ge;return w(),B("div",null,[h(S,{modelValue:r(d),"onUpdate:modelValue":f[0]||(f[0]=a=>me(d)?d.value=a:null)},null,8,["modelValue"]),h(N,{"model-value":!!r(c),"prevent-close":!0,ui:{base:"p-4 gap-2"}},{default:Y(()=>[y("div",qe,[y("div",ze,[h(I,{variant:"soft"},{default:Y(()=>[be(H(r(c)),1)]),_:1}),y("p",We,H(e.$t("notifications.iscn_registration_complete")),1)]),h(p,{animation:"carousel",color:"primary",class:"w-full"})])]),_:1},8,["model-value"])])}}}),Ge=we(je,[["__scopeId","data-v-cb01cd69"]]),Ye={class:"flex flex-col items-stretch grow space-y-4"},He=3,Je=Q({__name:"MintNFT",props:{iscnId:{type:String,default:""}},emits:["submit","loadingChange"],setup(b,{expose:l,emit:C}){const{getClassOwner:R,getClassMetadata:$,checkNFTClassIsBookNFT:L}=$e(),u=i(""),v=i(!1),A=i(""),s=i(null),T=i(""),D=i(null),U=C,V=E(()=>[{label:k("button.retry"),variant:"solid",color:"red",click:()=>window.location.reload()}]);G(v,n=>{U("loadingChange",n),n&&(u.value="")},{immediate:!0});const{t:k}=ne();ie({title:()=>k("seo.mint_nft_book_title"),ogTitle:()=>k("seo.mint_nft_book_title")});const d=b;G(()=>d.iscnId,async n=>{n&&await c(d.iscnId)},{immediate:!0});async function c(n,_=0){if(n)try{if(v.value=!0,!await L(n))throw new Error("Invalid NFT Class ID");const[m,g]=await Promise.all([$(n),R(n)]);if(!m)throw new Error("Failed to fetch ISCN metadata");s.value={contentMetadata:m,owner:g,"@id":n},A.value=g,T.value=n,u.value="",v.value=!1}catch(x){if(_<He){const m=_+1,g=m*1e3;setTimeout(()=>{c(n,m)},g)}else u.value=k("error.fetch_classid_failed")+x,v.value=!1}}function O(){var n;(n=D.value)==null||n.startNFTMintFlow()}function M({classId:n,nftMintCount:_}={}){T.value=n||"",U("submit",{classId:n||"",nftMintCount:_})}return l({startNFTMintFlow:O}),(n,_)=>{const x=ye,m=Ve;return w(),B("div",Ye,[r(u)?(w(),J(x,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${r(u)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},actions:r(V),onClose:_[0]||(_[0]=g=>u.value="")},null,8,["title","actions"])):X("",!0),h(m,{ref_key:"liteMintNFTRef",ref:D,"iscn-data":r(s),"iscn-id":b.iscnId,"should-show-submit":!1,onSubmit:M},null,8,["iscn-data","iscn-id"])])}}}),Xe={class:"w-full"},Qe={class:"justify-evenly items-center flex space-x-4 relative"},Ze={class:"text-sm font-semibold"},et={class:"mt-6 p-4 border rounded-lg bg-gray-100 text-center flex flex-col gap-[24px]"},tt={key:0},at={key:1},ot={key:2},st={key:3},nt={class:"flex gap-2 justify-center mt-4"},Ft=Q({__name:"new-book",setup(b){var p,N;const{t:l}=ne(),C=ae(),{wallet:R,signer:$}=oe(C),{validateWalletConsistency:L}=C,u=he(),v=Se(),{showErrorToast:A}=le(),s=i(0),T=i(),D=i(),U=i(),V=i(""),k=i(""),d=i(((p=u.query.iscn_id)==null?void 0:p.toString())||""),c=i(((N=u.query.class_id)==null?void 0:N.toString())||""),O=i([]),M=i(""),n=i(!1),_=i(!1);ie({title:()=>l("seo_titles.publish_nft_book"),ogTitle:()=>l("seo_titles.publish_nft_book")});const x=E(()=>{switch(s.value){case 0:return l("publish_button.upload_files");case 1:return l("publish_button.metadata");case 2:return l("publish_button.mint_nft");default:return l("publish_button.publish_now")}}),m=E(()=>{var a;return((a=O.value)==null?void 0:a.length)>0}),g=E(()=>s.value===0?m.value:s.value<3),q=E(()=>s.value===0?M.value!=="":s.value===2?_.value:!1),P=[{title:l("publish_steps.upload_files"),description:"Upload your book file"},{title:l("publish_steps.register_iscn"),description:"Register ISCN"},{title:l("publish_steps.mint_nft"),description:"Mint NFT"},{title:l("publish_steps.new_book_publish"),description:"Publish new book"}];se(()=>{var o;let a=null;try{const t=sessionStorage.getItem(Ie);t&&(a=JSON.parse(t))}catch(t){console.error(t)}d.value?(V.value=d.value,f({iscnId:d.value})):c.value?S({classId:c.value}):a!=null&&a.epubMetadata&&(a!=null&&a.fileRecords)&&(k.value=(o=a==null?void 0:a.epubMetadata)==null?void 0:o.title)});const z=async()=>{if((!R.value||!$.value)&&await L(),!R.value||!$.value){A(l("auth.login_required"));return}try{if(s.value===0&&T.value){await T.value.onSubmit();return}if(s.value===1){if(!n.value){A("Please fill in all required fields");return}await D.value.onSubmit();return}if(s.value===2){await U.value.startNFTMintFlow();return}s.value<P.length-1&&s.value++}catch(a){console.error("Error during form submission:",a)}},e=a=>{const{fileRecords:o,epubMetadata:t}=a;t!=null&&t.coverData&&(t.coverData=void 0),Ce({fileRecords:o,epubMetadata:t}),s.value=1},f=async a=>{const{iscnId:o}=a;o&&await j(v({query:{iscn_id:o}}),{replace:!0}),Ne(),s.value=2,await ee(),d.value=o},S=async a=>{const{classId:o,nftMintCount:t}=a;o&&(c.value=o,await j(v({query:{class_id:o,count:t}}),{replace:!0}),s.value=3,await ee())},I=async()=>{await j(v({name:"my-books"}))};return(a,o)=>{const t=ke,W=Be,re=Ge,ce=Je,ue=Pe,de=xe,pe=Ke;return w(),J(pe,{class:"flex flex-col items-stretch grow space-y-4"},{default:Y(()=>[y("div",Xe,[y("div",Qe,[o[4]||(o[4]=y("div",{class:"absolute w-full h-[1px] bg-gray-300 top-[50%] left-0 z-[-1]"},null,-1)),(w(),B(Fe,null,Te(P,(F,K)=>y("div",{key:K,class:"flex items-center space-x-2 bg-white p-2 rounded-lg"},[h(t,{size:K===r(s)?"lg":"md",text:(K+1).toString(),ui:{background:K===r(s)?"bg-primary-100":"bg-gray-200"}},null,8,["size","text","ui"]),y("p",Ze,H(F.title),1)])),64))]),y("div",et,[r(s)===0?(w(),B("div",tt,[h(W,{ref_key:"uploadFormRef",ref:T,onFileUploadStatus:o[0]||(o[0]=F=>M.value=F),onFileReady:o[1]||(o[1]=F=>O.value=F),onSubmit:e},null,512)])):r(s)===1?(w(),B("div",at,[h(re,{ref_key:"registerISCN",ref:D,onFormValidChange:o[2]||(o[2]=F=>n.value=F),onSubmit:f},null,512)])):r(s)===2?(w(),B("div",ot,[h(ce,{ref_key:"mintNFT",ref:U,"iscn-id":r(d),onLoadingChange:o[3]||(o[3]=F=>_.value=F),onSubmit:S},null,8,["iscn-id"])])):r(s)===3?(w(),B("div",st,[h(ue,{ref:"newNFTBook",class:"p-0 flex flex-col text-left gap-[24px]","is-new-class-page":!0,"class-id":r(c),onSubmit:I},null,8,["class-id"])])):X("",!0),y("div",nt,[r(g)?(w(),J(de,{key:0,disabled:r(q),label:r(x),onClick:z},null,8,["disabled","label"])):X("",!0)])])])]),_:1})}}});export{Ft as default};
