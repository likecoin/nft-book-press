import{_ as pt}from"./CHhQ3aA6.js";import{n as mt,T as vt,q as yt,s as Q,v as _t,u as gt,M as xt,r,C as J,h as X,z as ht,a9 as It,o as y,B as q,w as p,aa as Y,W as wt,a,t as d,F as t,N as E,d as Z,b as v,G as bt,c as V,H as Nt,I as $t,bd as kt,$ as tt,D as St,ab as Ct,ac as Tt,ad as Ft,a2 as qt,Q as Et,K as Bt,J as Dt}from"./C7bisW_2.js";import{_ as Ut}from"./BGz2mRwj.js";import{_ as Rt}from"./BVKsxaOv.js";import{_ as Vt}from"./CKnHQrM_.js";import{u as At,_ as Lt}from"./D690u35E.js";import{_ as Mt}from"./CH8H_au0.js";import{u as Pt}from"./fZ7j_FUX.js";import"./CAWsDG_t.js";(function(){try{var N=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},$=new Error().stack;$&&(N._sentryDebugIds=N._sentryDebugIds||{},N._sentryDebugIds[$]="515451b8-75c0-462c-ae76-c126d0fe213d",N._sentryDebugIdIdentifier="sentry-dbid-515451b8-75c0-462c-ae76-c126d0fe213d")}catch{}})();const zt={class:"text-lg font-bold font-mono"},Ht={class:"divide-y w-full"},Ot={class:"px-4 py-3"},Wt={class:"px-4 py-3"},jt={class:"px-4 py-3"},Gt={class:"px-4 py-3"},Kt={class:"px-4 py-3"},Qt={class:"px-4 py-3"},Jt={class:"px-4 py-3"},Xt={class:"px-4 py-3"},Yt={class:"px-4 py-3"},Zt={class:"flex flex-wrap items-center justify-center gap-2 w-full"},te={class:"text-sm text-gray-400 dark:text-gray-600"},ee=["src"],ce=mt({__name:"[classId]",setup(N){const{LIKE_CO_API:$,LCD_URL:A}=vt().public,L=yt(),{wallet:k,signer:S}=Q(L),{initIfNecessary:M}=L,P=_t(),{token:z}=Q(P),H=Pt(),{lazyFetchClassMetadataById:et}=H,D=gt(),at=xt(),_=r(""),g=r(!1),i=r(D.params.classId),O=r(D.query.payment_id),B=r(D.query.owner_wallet||k.value),C=r(""),{messageCharCount:nt,isLimitReached:W}=At(C,Y),T=r([]),l=r([]),h=r(!1),I=r(!1),x=r(""),m=r(!1),j=r(void 0),n=r({}),w=r(""),G=J(()=>m.value||g.value||h.value||I.value||!!x.value||W.value),st=J(()=>{var s;return(s=H.getClassMetadataById(i.value))==null?void 0:s.name});X(g,s=>{s&&(_.value="")}),X(m,async s=>{if(!s)if(T.value){const e=T.value.filter(o=>o.trim()!=="");if(n.value.quantity&&e.length>0&&e.length!==n.value.quantity){x.value=`Number of NFT IDs (${e.length}) does not match the required quantity (${n.value.quantity})`,l.value=[];return}l.value=e,await K()}else w.value="",l.value=[]}),ht(async()=>{const s=await $fetch(`${$}/likernft/book/purchase/${i.value}/status/${O.value}`,{headers:{authorization:`Bearer ${z.value}`}});n.value=s,et(i.value),U(n.value.quantity||1)});function lt(){m.value=!m.value,x.value="",St(()=>{var s,e,o;m.value&&((o=(e=(s=j.value)==null?void 0:s[0].$refs)==null?void 0:e.input)==null||o.focus())})}async function K(){var s,e,o,F;try{if(h.value=!0,!l.value.length||!l.value[0]){w.value="";return}try{const u=await $fetch(`${A}/cosmos/nft/v1beta1/nfts/${i.value}/${l.value[0]}`),b=((o=(e=(s=u==null?void 0:u.nft)==null?void 0:s.data)==null?void 0:e.metadata)==null?void 0:o.image)||"";w.value=wt(b)}catch(u){w.value="",((F=u==null?void 0:u.data)==null?void 0:F.code)===2?x.value="NFT not found":x.value=u.toString()}}catch(u){_.value=u.toString()}finally{h.value=!1}}async function U(s=1){try{if(x.value="",I.value=!0,(!k.value||!S.value)&&await M(),!B.value)return;const{nfts:e}=await It({classId:i.value,owner:B.value,needCount:s});if(e.length)l.value=e.map(o=>o.id),T.value=l.value,await K();else throw new Error(`${B.value} does not hold any NFT of class ${i.value}`)}catch(e){_.value=e.toString()}finally{I.value=!1}}function ot(){U(n.value.quantity||1)}async function rt(){if(!G.value)try{if(g.value=!0,(!k.value||!S.value)&&await M(),!k.value||!S.value)return;if(l.value){const b=(await Promise.all(l.value.map(c=>Ct(i.value,c)))).map(c=>c.owner).findIndex(c=>c!==B.value);if(b>=0){const c=l.value[b];throw new Error(`NFT classId: ${i.value} nftId:${c} is not owned by sender!`)}}else await U(n.value.quantity||1);if(l.value.length!==n.value.quantity)throw new Error(`NFT quantity mismatch! Expected ${n.value.quantity}, got ${l.value.length}`);if(!(await Tt(S.value)).getSigningStargateClient())throw new Error("Signing client not exists");const o=await Ft(n.value.wallet,Array(l.value.length).fill(i.value),l.value,S.value,k.value,C.value);o.transactionHash&&o.code===0&&(await $fetch(`${$}/likernft/book/purchase/${i.value}/sent/${O.value}`,{method:"POST",body:{txHash:o.transactionHash,quantity:n.value.quantity||1},headers:{authorization:`Bearer ${z.value}`}}),at.push({name:"nft-book-store-status-classId",params:{classId:i.value}}))}catch(s){console.error(s),_.value=s.toString()}finally{g.value=!1}}return(s,e)=>{const o=pt,F=qt,u=Et,b=Ut,c=Rt,ut=Vt,R=Bt,it=Dt,dt=Lt,ct=Mt;return y(),q(ct,null,{default:p(()=>[a("h1",zt,' Deliver NFT Book "'+d(t(st)||t(i))+'" ',1),t(_)?(y(),q(o,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${t(_)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:e[0]||(e[0]=f=>_.value="")},null,8,["title"])):E("",!0),t(g)?(y(),q(F,{key:1,animation:"carousel"},{indicator:p(()=>e[2]||(e[2]=[Z(" Loading... ")])),_:1})):E("",!0),t(P).isAuthenticated?(y(),q(u,{key:2,ui:{body:{base:"space-y-4"},footer:{base:"flex justify-center gap-2"}}},{footer:p(()=>[v(R,{label:"Sign and Send",disabled:t(G),size:"xl",onClick:rt},null,8,["disabled"])]),default:p(()=>[v(u,{ui:{body:{padding:""}}},{default:p(()=>{var f;return[a("table",Ht,[a("tbody",null,[a("tr",null,[e[3]||(e[3]=a("th",{class:"text-left px-4 py-3"}," Buyer Email ",-1)),a("td",Ot,d(t(n).email),1)]),a("tr",null,[e[4]||(e[4]=a("th",{class:"text-left px-4 py-3"}," Reader Email ",-1)),a("td",Wt,d(((f=t(n).giftInfo)==null?void 0:f.toEmail)||t(n).email),1)]),a("tr",null,[e[5]||(e[5]=a("th",{class:"text-left px-4 py-3"}," Status ",-1)),a("td",jt,d(t(n).status),1)]),a("tr",null,[e[6]||(e[6]=a("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),a("td",Gt,d(t(n).wallet),1)]),a("tr",null,[e[7]||(e[7]=a("th",{class:"text-left px-4 py-3"}," Price Name ",-1)),a("td",Kt,d(t(n).priceName),1)]),a("tr",null,[e[8]||(e[8]=a("th",{class:"text-left px-4 py-3"}," Price ",-1)),a("td",Qt,d(t(n).price),1)]),a("tr",null,[e[9]||(e[9]=a("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),a("td",Jt,d(t(n).quantity),1)]),a("tr",null,[e[10]||(e[10]=a("th",{class:"text-left px-4 py-3"}," Buyer message ",-1)),a("td",Xt,d(t(n).message),1)]),a("tr",null,[e[11]||(e[11]=a("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),a("td",Yt,d(t(n).from),1)])])])]}),_:1}),v(c,{label:"Enter Author's Message",error:t(W),hint:`${t(nt)} / ${t(Y)}`},{default:p(()=>[v(b,{modelValue:t(C),"onUpdate:modelValue":e[1]||(e[1]=f=>bt(C)?C.value=f:null),placeholder:"default memo"},null,8,["modelValue"])]),_:1},8,["error","hint"]),v(c,{label:"Specify NFT ID",description:"Leave empty to auto-fetch NFT ID",error:t(x),ui:{description:"text-gray-400 dark:text-gray-600"}},{default:p(()=>[a("div",Zt,[t(n).quantity?(y(),V("div",{key:0,class:tt([t(n).quantity>1?"w-full":"flex-grow","space-y-1"])},[(y(!0),V(Nt,null,$t(t(n).quantity,f=>(y(),q(ut,{key:`nft-id-input-${f}`,ref_for:!0,ref_key:"nftIdInputRef",ref:j,modelValue:t(T)[f-1],"onUpdate:modelValue":ft=>t(T)[f-1]=ft,class:"font-mono",readonly:!t(m),disabled:!t(m)},kt({_:2},[t(n).quantity>1?{name:"leading",fn:p(()=>[a("span",te,"#"+d(f),1)]),key:"0"}:void 0]),1032,["modelValue","onUpdate:modelValue","readonly","disabled"]))),128))],2)):E("",!0),v(R,{label:t(m)||t(h)&&!t(I)?"Confirm":"Edit",disabled:t(g)||t(h),variant:"outline",loading:t(h)&&!t(I),color:"gray",onClick:lt},null,8,["label","disabled","loading"]),v(it,{class:tt(["text-sm text-gray-600",{"sm:w-min":t(n).quantity<=1}])},{default:p(()=>e[12]||(e[12]=[Z(" OR ")])),_:1},8,["class"]),v(R,{label:`Auto-fetch NFT ID for ${t(n).quantity} NFTs`,disabled:t(g)||t(m),loading:t(I),variant:"outline",onClick:ot},null,8,["label","disabled","loading"])])]),_:1},8,["error"]),v(dt,{class:"h-[300px]"},{default:p(()=>[t(w)?(y(),V("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",src:t(w)},null,8,ee)):E("",!0)]),_:1})]),_:1})):E("",!0)]),_:1})}}});export{ce as default};
//# sourceMappingURL=Bb5FDEYY.js.map
