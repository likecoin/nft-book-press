import{dc as L,bz as M,b8 as S,b9 as m,bb as T,ba as k,cf as d,dd as P}from"./B9KV3Ijx.js";(function(){try{var l=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},u=new l.Error().stack;u&&(l._sentryDebugIds=l._sentryDebugIds||{},l._sentryDebugIds[u]="ba74b677-3592-4954-97db-c30f6a30b2cd",l._sentryDebugIdIdentifier="sentry-dbid-ba74b677-3592-4954-97db-c30f6a30b2cd")}catch{}})();const _=L("orders",()=>{const l=M(),{token:u,isAuthenticated:I}=S(l),o=m({}),c=m([]),g=m(!1),f=m("");T(I,()=>{I.value?b():B()});const E=k(()=>{const t=new Map;return c.value.forEach(a=>{const s=a.classId;t.has(s)||t.set(s,[]),t.get(s).push(a)}),t}),i=k(()=>{const t=Object.keys(o.value);if(t.length===0||c.value.length===0)return[];const a=new Map;return c.value.forEach(s=>{const r=s.email;if(!r)return;const e=new Date(s.timestamp).toISOString(),h=s.price||0,D=!!(s.message&&s.message.trim()),p=s.wallet;if(a.has(r)){const n=a.get(r);if(!n)return;new Date(e)<new Date(n.firstPurchaseTime)&&(n.firstPurchaseTime=e),new Date(e)>new Date(n.lastPurchaseTime)&&(n.lastPurchaseTime=e),n.lifetimeValue+=h,D&&(n.hasMessage=!0),n.purchasedBooks[s.classId]=!0,p&&!n.readerWallet&&(n.readerWallet=p)}else{const n={};t.forEach(C=>{n[C]=!1}),n[s.classId]=!0,a.set(r,{readerEmail:r,readerWallet:p,firstPurchaseTime:e,lastPurchaseTime:e,lifetimeValue:h,hasMessage:D,purchasedBooks:n})}}),Array.from(a.values()).map(s=>{const r={};return t.forEach(e=>{r[`book_${e}`]=s.purchasedBooks[e]?1:0}),{...s,...r}})});async function y(t){const a=[];for(const s of t)try{const e=(await P(s,u.value))?.orders||[];e.length>0&&a.push(...e.map(h=>({...h,classId:s})))}catch(r){console.error(`Failed to fetch orders for classId ${s}:`,r)}return c.value=a,a}async function v(t,a=!1){return!a&&c.value.length>0?c.value:await y(t)}async function w(t=!1){if(!(!t&&i.value.length>0))try{g.value=!0,f.value="",await l.fetchBookListing(),await l.fetchModeratedBookList();const a=[...l.listingList.map(e=>e.classId),...l.moderatedBookList.map(e=>e.classId)],s=[...new Set(a)];if(s.length===0){o.value={};return}const r={};l.listingList.forEach(e=>{s.includes(e.classId)&&(r[e.classId]={name:e.name||e.classId,classId:e.classId})}),l.moderatedBookList.forEach(e=>{s.includes(e.classId)&&(r[e.classId]={name:e.name||e.classId,classId:e.classId})}),o.value=r,await v(s,t)}catch(a){throw f.value=a.message||"Failed to load readers data",a}finally{g.value=!1}}async function b(){return i.value.length>0||await w(),i.value}function O(){f.value=""}function B(){c.value=[],o.value={}}return{readers:i,booksInfo:d(o),allOrders:d(c),ordersByClassIdMap:d(E),isLoading:d(g),error:d(f),fetchReaders:w,lazyFetchReaders:b,fetchOrdersByClassId:y,lazyFetchOrdersByClassId:v,clearError:O,clearCache:B}});export{_ as u};
