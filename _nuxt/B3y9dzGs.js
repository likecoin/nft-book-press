import{a_ as Te,b3 as Ce,bj as ke,bl as J,bi as Fe,bv as Se,bk as Be,a$ as $e,b5 as s,b6 as L,b7 as Z,b0 as Ee,b1 as E,aX as p,bo as ee,cS as te,aT as v,aU as l,bp as B,aV as i,bd as t,bq as Ae,bM as Re,aY as ae,br as Ue,aW as u,bc as qe,aS as A,bg as oe,bh as De,be as Ve,bb as Me,b9 as Pe}from"./CeIklSyJ.js";import{_ as Le}from"./CVGjVs3_.js";import{_ as We}from"./fGt39iZq.js";import{_ as Oe}from"./DADAE9fp.js";import{u as ze,_ as je}from"./BnqKy-DC.js";import{_ as Ge}from"./DUly4NUS.js";import{u as He}from"./FgLE7jCP.js";import{u as Ke,L as Qe}from"./CFsgg7xR.js";import{u as Xe,a as Ye}from"./DjhHsaRu.js";import"./CCJQTraR.js";(function(){try{var w=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},T=new w.Error().stack;T&&(w._sentryDebugIds=w._sentryDebugIds||{},w._sentryDebugIds[T]="0e91ba15-d4a6-4004-b750-5492b3c4069a",w._sentryDebugIdIdentifier="sentry-dbid-0e91ba15-d4a6-4004-b750-5492b3c4069a")}catch{}})();const Je={class:"text-lg font-bold font-mono"},Ze={class:"divide-y w-full"},et={class:"px-4 py-3"},tt={class:"px-4 py-3"},at={class:"px-4 py-3"},ot={class:"px-4 py-3"},lt={class:"px-4 py-3"},nt={class:"text-left px-4 py-3"},st={class:"px-4 py-3"},rt={class:"px-4 py-3"},it={class:"flex flex-wrap items-center justify-center gap-2"},ut=["src"],wt=Te({__name:"[collectionId]",setup(w){const{LIKE_CO_API:T}=Ce().public,R=ke(),{wallet:I,signer:U}=J(R),{initIfNecessary:W}=R,O=Fe(),{token:z}=J(O),j=He(),q=Se(),{lazyFetchClassMetadataById:le}=j,{lazyFetchCollectionById:ne}=q,{getNFTMetadata:G,getNFTOwner:se,getBalanceOf:re,getTokenIdByOwnerIndex:ie}=Ke(),{writeContractAsync:ue}=Xe(),{assertPositiveWalletBalance:ce,waitForTransactionReceipt:de}=Ye(),D=Be(),fe=$e(),_=s(""),y=s(!1),b=s(D.params.collectionId),H=s(D.query.payment_id),C=s(D.query.owner_wallet||I.value),k=s(""),{messageCharCount:pe,isLimitReached:K}=ze(k,te),c=s([]),h=s([]),x=s(!1),N=s(!1),F=s(""),d=s(!1),Q=s(void 0),n=s({}),S=s([]),X=L(()=>d.value||y.value||x.value||N.value||!!F.value||K.value),me=L(()=>{var o;return(o=q.getCollectionById(b.value))==null?void 0:o.name}),m=L(()=>{var o;return(o=q.getCollectionById(b.value))==null?void 0:o.classIds});Z(y,o=>{o&&(_.value="")}),Z(d,o=>{o||c.value.forEach(async(e,a)=>{if(e){const r=await G(m.value[a],parseInt(e,10));S.value[a]=ee(r==null?void 0:r.image)}else S.value[a]=""})}),Ee(async()=>{const o=await $fetch(`${T}/likernft/book/collection/purchase/${b.value}/status/${H.value}`,{headers:{authorization:`Bearer ${z.value}`}});n.value=o,await ne(b.value),await Promise.all(m.value.map(e=>le(e))),V(n.value.quantity||1)});function ve(o){var e;return(e=j.getClassMetadataById(o))==null?void 0:e.name}function _e(){d.value=!d.value,F.value="",Pe(()=>{var o,e,a;d.value&&((a=(e=(o=Q.value)==null?void 0:o.$refs)==null?void 0:e.input)==null||a.focus())})}async function ye(o,e){try{x.value=!0;const a=await G(o,parseInt(e,10));return ee(a==null?void 0:a.image)}catch(a){return _.value=a.toString(),""}finally{x.value=!1}}async function V(o=1){try{if(F.value="",N.value=!0,h.value=[],(!I.value||!U.value)&&await W(),!C.value)return;await Promise.all(m.value.map(async(e,a)=>{if(!h.value[a]){const r=await re(e,C.value);if(Number(r)<o)throw new Error(`Insufficient balance of NFT classId: ${e} for wallet: ${C.value}`);h.value[a]=[];for(let g=0;g<o;g++){const M=await ie(e,C.value,g);h.value[a].push(M),c.value[a]=h.value[a][0],S.value[a]=await ye(e,c.value[a])||""}}}))}catch(e){_.value=e.toString()}finally{N.value=!1}}function be(){V(n.value.quantity||1)}async function ge(){if(!X.value)try{if(y.value=!0,(!I.value||!U.value)&&await W(),!I.value||!U.value)return;if(await V(n.value.quantity),await Promise.all(m.value.map(async(a,r)=>{if(c.value[r]&&await se(a,parseInt(c.value[r],10))!==C.value)throw new Error(`NFT classId: ${a} nftId:${c.value[r]} is not owned by sender!`)})),m.value.find(a=>!a))throw new Error("Please specify NFT class ID");if(c.value.find(a=>!a))throw new Error("Please specify NFT ID");let o,e;await ce({wallet:I.value});for(let a=0;a<m.value.length;a++){const r=m.value[a];e=await ue({address:r,abi:Qe,functionName:"batchTransferWithMemo",args:[I.value,Array(n.value.quantity).fill(n.value.wallet),h.value[a],Array(n.value.quantity).fill(k.value)]}),o=await de({hash:e})}(o==null?void 0:o.status)==="success"&&(await $fetch(`${T}/likernft/book/collection/purchase/${b.value}/sent/${H.value}`,{method:"POST",body:{txHash:e,quantity:n.value.quantity||1},headers:{authorization:`Bearer ${z.value}`}}),fe.push({name:"nft-book-store-collection-status-collectionId",params:{collectionId:b.value}}))}catch(o){console.error(o),_.value=o.toString()}finally{y.value=!1}}return(o,e)=>{const a=Ae,r=Re,g=Ue,M=Le,Y=We,we=Oe,P=Ve,Ie=Me,he=je,xe=Ge;return v(),E(xe,null,{default:p(()=>[l("h1",Je,' Deliver NFT Book Collection "'+i(t(me)||t(b))+'" ',1),t(_)?(v(),E(a,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${t(_)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:e[0]||(e[0]=f=>_.value="")},null,8,["title"])):B("",!0),t(y)?(v(),E(r,{key:1,animation:"carousel"},{indicator:p(()=>e[2]||(e[2]=[ae(" Loading... ")])),_:1})):B("",!0),t(O).isAuthenticated?(v(),E(g,{key:2,ui:{body:{base:"space-y-4"},footer:{base:"flex justify-center gap-2"}}},{footer:p(()=>[u(P,{label:"Sign and Send",disabled:t(X),size:"xl",onClick:ge},null,8,["disabled"])]),default:p(()=>[u(g,{ui:{body:{padding:""}}},{default:p(()=>{var f;return[l("table",Ze,[l("tbody",null,[l("tr",null,[e[3]||(e[3]=l("th",{class:"text-left px-4 py-3"}," Buyer Email ",-1)),l("td",et,i(t(n).email),1)]),l("tr",null,[e[4]||(e[4]=l("th",{class:"text-left px-4 py-3"}," Reader Email ",-1)),l("td",tt,i(((f=t(n).giftInfo)==null?void 0:f.toEmail)||t(n).email),1)]),l("tr",null,[e[5]||(e[5]=l("th",{class:"text-left px-4 py-3"}," Status ",-1)),l("td",at,i(t(n).status),1)]),l("tr",null,[e[6]||(e[6]=l("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),l("td",ot,i(t(n).wallet),1)]),l("tr",null,[e[7]||(e[7]=l("th",{class:"text-left px-4 py-3"}," Price ",-1)),l("td",lt,i(t(n).price),1)]),l("tr",null,[e[8]||(e[8]=l("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),l("td",nt,i(t(n).quantity),1)]),l("tr",null,[e[9]||(e[9]=l("th",{class:"text-left px-4 py-3"}," Buyer message ",-1)),l("td",st,i(t(n).message),1)]),l("tr",null,[e[10]||(e[10]=l("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),l("td",rt,i(t(n).from),1)])])])]}),_:1}),u(Y,{label:"Enter Author's Message",error:t(K),hint:`${t(pe)} / ${t(te)}`},{default:p(()=>[u(M,{modelValue:t(k),"onUpdate:modelValue":e[1]||(e[1]=f=>qe(k)?k.value=f:null),placeholder:"default memo"},null,8,["modelValue"])]),_:1},8,["error","hint"]),u(Y,{label:"Specify NFT ID",error:t(F)},{default:p(()=>[(v(!0),A(oe,null,De(t(m),(f,$)=>(v(),A("div",{key:f},[l("label",null,i(ve(f)+": "+f),1),l("div",it,[t(n).quantity===1?(v(),A(oe,{key:0},[u(we,{ref_for:!0,ref_key:"nftIdInputRef",ref:Q,modelValue:t(c)[$],"onUpdate:modelValue":Ne=>t(c)[$]=Ne,class:"font-mono flex-grow",readonly:!t(d),disabled:!t(d),placeholder:"Leave empty to auto-fetch NFT ID","trailing-icon":t(F)?"i-heroicons-exclamation-triangle-20-solid":void 0},null,8,["modelValue","onUpdate:modelValue","readonly","disabled","trailing-icon"]),u(P,{label:t(d)||t(x)&&!t(N)?"Confirm":"Edit",disabled:t(y)||t(x),variant:"outline",loading:t(x)&&!t(N),color:"gray",onClick:_e},null,8,["label","disabled","loading"]),u(Ie,{class:"text-sm text-gray-600 sm:w-min"},{default:p(()=>e[11]||(e[11]=[ae(" OR ")])),_:1,__:[11]})],64)):B("",!0),u(P,{label:`Auto-fetch NFT ID for ${t(n).quantity} orders`,disabled:t(y)||t(d),loading:t(N),variant:"outline",onClick:be},null,8,["label","disabled","loading"])]),u(he,{class:"h-[300px]"},{default:p(()=>[t(S)[$]?(v(),A("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",src:t(S)[$]},null,8,ut)):B("",!0)]),_:2},1024)]))),128))]),_:1},8,["error"])]),_:1})):B("",!0)]),_:1})}}});export{wt as default};
