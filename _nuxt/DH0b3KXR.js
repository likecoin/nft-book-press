import{a_ as Q,b6 as ae,b7 as Z,b8 as se,b9 as i,ba as V,bb as G,b1 as oe,bc as _e,aS as B,aT as v,aW as w,b4 as r,bd as me,aX as Y,aU as g,be as fe,aY as be,aV as H,bf as ve,bg as ge,aQ as we,a$ as ne,bh as ie,b3 as J,bi as X,bj as ye,bk as he,b0 as Ie,bl as Se,b2 as j,bm as Ne,bn as ee,bo as Fe,bp as Te,bq as ke,br as xe,bs as Ce}from"./CoORw_0l.js";import{u as Re,v as De,a as te,_ as Ue,f as Me,b as Be}from"./CKAJIGmR.js";import{L as Ee,u as $e}from"./ByGww92Y.js";import{u as Le,a as le,b as Ae,_ as Ve}from"./Bo-l-FaD.js";import{D as Oe}from"./CAUHJyOv.js";import{_ as Pe}from"./DqeNNgiW.js";import{_ as Ke}from"./Bq6tPet3.js";import"./CN_cSw_w.js";import"./CBDT-iwv.js";import"./B4mjdIG2.js";import"./CrT-yyLF.js";import"./CIjvCkTo.js";import"./COcvkfHo.js";import"./Bwf7YKwU.js";import"./CrK9HNS6.js";import"./BRdPIiz5.js";import"./Cump9dhP.js";import"./BrMdpjMD.js";import"./D52lr4dA.js";(function(){try{var b=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},l=new b.Error().stack;l&&(b._sentryDebugIds=b._sentryDebugIds||{},b._sentryDebugIds[l]="b96a53f2-9469-44b2-a4ea-b6ff1914e8c2",b._sentryDebugIdIdentifier="sentry-dbid-b96a53f2-9469-44b2-a4ea-b6ff1914e8c2")}catch{}})();const qe={class:"space-y-3"},ze={class:"flex justify-between items-center"},We={class:"text-xs text-gray-500"},je=Q({__name:"RegisterISCN",emits:["handleSubmit","submit","formValidChange"],setup(b,{expose:l,emit:x}){const C=ae(),{getFileType:E}=te(),{LIKE_EVM_NFT_TARGET_ADDRESS:$}=Z().public,{wallet:m,signer:f}=se(C),{validateWalletConsistency:F}=C,{assertPositiveWalletBalance:o,waitForTransactionReceipt:T}=Le(),{stripHtmlTags:R,formatLanguage:D}=te(),{showErrorToast:U}=le(),{LIKE_NFT_CONTRACT_ADDRESS:L}=Z().public,c=i({type:"Book",title:"",description:"",isbn:"",publisher:"",publicationDate:"",author:{name:"",description:""},license:"All Rights Reserved",customLicense:"",contentFingerprints:[{url:""}],downloadableUrls:[{url:"",type:"",fileName:""}],language:"",bookInfoUrl:"",tags:[],coverUrl:""}),u=i(""),A=i(""),M=x,{payload:n,computeISCNSalt:d}=Re({iscnFormData:c}),{writeContractAsync:k}=Ae(),y=V(()=>De(c.value)),O=V(()=>{var e;return!((e=y.value)!=null&&e.length)});G(O,e=>{M("formValidChange",e)},{immediate:!0}),oe(()=>{const e=q();e&&(c.value=e)});const q=()=>{var h,I,p,S,a,s;const e=_e();if(!e)return null;const _={type:"Book",title:((h=e.epubMetadata)==null?void 0:h.title)||"",description:R(((I=e.epubMetadata)==null?void 0:I.description)||""),isbn:"",publisher:"",publicationDate:new Date().toISOString().split("T")[0],author:{name:((p=e.epubMetadata)==null?void 0:p.author)||"",description:""},license:"All Rights Reserved",contentFingerprints:[],downloadableUrls:[],coverUrl:(S=e.epubMetadata)!=null&&S.thumbnailArweaveId?`ar://${e.epubMetadata.thumbnailArweaveId}`:"",language:D(((a=e.epubMetadata)==null?void 0:a.language)||"zh"),tags:((s=e.epubMetadata)==null?void 0:s.tags)||[]};return _.downloadableUrls=e.fileRecords.filter(t=>t.fileType==="application/pdf"||t.fileType==="application/epub+zip").map(t=>({url:t.arweaveKey?t.arweaveLink:`ar://${t.arweaveId}`,type:E(t.fileType),fileName:t.fileName})),_.contentFingerprints=[...new Set(e.fileRecords.map(t=>{const W=t.arweaveKey?t.arweaveLink:`ar://${t.arweaveId}`;return t.fileType==="application/epub+zip"||t.fileType==="application/pdf"?W:`ar://${t.arweaveId}`}).filter(Boolean))].map(t=>({url:t})),_},P=async()=>{if(u.value="checking",!O.value){U(y.value.join(", "));return}c.value.contentFingerprints.length&&await z()},z=async()=>{if(u.value="loading",await F(),!m.value||!f.value){A.value="MISSING_SIGNER",u.value="";return}try{u.value="signing";const e=Me(n.value),_={name:e.name,description:e.description,...e,symbol:"BOOK",image:(e==null?void 0:e.thumbnailUrl)||"",external_link:(e==null?void 0:e.url)||"",nft_meta_collection_id:"nft_book",nft_meta_collection_name:"NFT Book",nft_meta_collection_description:"NFT Book by Liker Land",recordTimestamp:new Date().toISOString()};await o({wallet:m.value});const h=d(m.value),I=await k({address:L,abi:Ee,functionName:"newBookNFT",args:[h,{creator:m.value,updaters:[m.value,$],minters:[m.value,$],config:{name:_.name,symbol:"BOOK",metadata:JSON.stringify(_),max_supply:Oe}},500]}),p=await T({hash:I});if(console.log(p),!p||p.status!=="success")throw new Error("INVALID_RECEIPT");if(!p.logs[0].address)throw new Error("INVALID_CLASS_ID");const S=p.logs[0].address;u.value="success",M("submit",{iscnId:S,txHash:I})}catch(e){console.error(e),U(`'SIGNING_ERROR':${e}`),u.value=""}finally{u.value=""}};return l({onSubmit:P}),(e,_)=>{const h=Ue,I=fe,p=ve,S=ge;return v(),B("div",null,[w(h,{modelValue:r(c),"onUpdate:modelValue":_[0]||(_[0]=a=>me(c)?c.value=a:null)},null,8,["modelValue"]),w(S,{"model-value":!!r(u),"prevent-close":!0,ui:{base:"p-4 gap-2"}},{default:Y(()=>[g("div",qe,[g("div",ze,[w(I,{variant:"soft"},{default:Y(()=>[be(H(r(u)),1)]),_:1}),g("p",We,H(e.$t("notifications.iscn_registration_complete")),1)]),w(p,{animation:"carousel",color:"primary",class:"w-full"})])]),_:1},8,["model-value"])])}}}),Ge=we(je,[["__scopeId","data-v-cb01cd69"]]),Ye={class:"flex flex-col items-stretch grow space-y-4"},He=Q({__name:"MintNFT",props:{iscnId:{type:String,default:""}},emits:["submit","loadingChange"],setup(b,{expose:l,emit:x}){const{getClassOwner:C,getClassMetadata:E,checkNFTClassIsBookNFT:$}=$e(),m=i(1),f=i(""),F=i(!1),o=i(""),T=i(null),R=i(""),D=i(null),U=x;G(F,n=>{U("loadingChange",n),n&&(f.value="")},{immediate:!0});const{t:L}=ne();ie({title:()=>L("seo.mint_nft_book_title"),ogTitle:()=>L("seo.mint_nft_book_title")});const c=b;G(()=>c.iscnId,async n=>{n&&await u(c.iscnId)},{immediate:!0});async function u(n){if(n)try{if(F.value=!0,!await $(n))throw new Error("Invalid NFT Class ID");const[k,y]=await Promise.all([E(n),C(n)]);if(!k)throw new Error("Invalid NFT Class ID");T.value={contentMetadata:k,owner:y,"@id":n},o.value=y,R.value=n,m.value=3}catch(d){console.error(d),f.value=d.toString()}finally{F.value=!1}}function A(){var n;(n=D.value)==null||n.startNFTMintFlow()}function M({classId:n,nftMintCount:d}={}){R.value=n||"",U("submit",{classId:n||"",nftMintCount:d})}return l({startNFTMintFlow:A}),(n,d)=>{const k=ye,y=Ve;return v(),B("div",Ye,[r(f)?(v(),J(k,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${r(f)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:d[0]||(d[0]=O=>f.value="")},null,8,["title"])):X("",!0),w(y,{ref_key:"liteMintNFTRef",ref:D,"iscn-data":r(T),"iscn-id":b.iscnId,"should-show-submit":!1,onSubmit:M},null,8,["iscn-data","iscn-id"])])}}}),Je={class:"w-full"},Xe={class:"justify-evenly items-center flex space-x-4 relative"},Qe={class:"text-sm font-semibold"},Ze={class:"mt-6 p-4 border rounded-lg bg-gray-100 text-center flex flex-col gap-[24px]"},et={key:0},tt={key:1},at={key:2},st={key:3},ot={class:"flex gap-2 justify-center mt-4"},Nt=Q({__name:"new-book",setup(b){var p,S;const{t:l}=ne(),x=ae(),{wallet:C,signer:E}=se(x),{validateWalletConsistency:$}=x,m=he(),f=Ie(),{showErrorToast:F}=le(),o=i(0),T=i(),R=i(),D=i(),U=i(""),L=i(""),c=i(((p=m.query.iscn_id)==null?void 0:p.toString())||""),u=i(((S=m.query.class_id)==null?void 0:S.toString())||""),A=i([]),M=i(""),n=i(!1),d=i(!1);ie({title:()=>l("seo_titles.publish_nft_book"),ogTitle:()=>l("seo_titles.publish_nft_book")});const k=V(()=>{switch(o.value){case 0:return l("publish_button.upload_files");case 1:return l("publish_button.metadata");case 2:return l("publish_button.mint_nft");default:return l("publish_button.publish_now")}}),y=V(()=>{var a;return((a=A.value)==null?void 0:a.length)>0}),O=V(()=>o.value===0?y.value:o.value<3),q=V(()=>o.value===0?M.value!=="":o.value===2?d.value:!1),P=[{title:l("publish_steps.upload_files"),description:"Upload your book file"},{title:l("publish_steps.register_iscn"),description:"Register ISCN"},{title:l("publish_steps.mint_nft"),description:"Mint NFT"},{title:l("publish_steps.new_book_publish"),description:"Publish new book"}];oe(()=>{var s;let a=null;try{const t=sessionStorage.getItem(Se);t&&(a=JSON.parse(t))}catch(t){console.error(t)}c.value?(U.value=c.value,_({iscnId:c.value})):u.value?h({classId:u.value}):a!=null&&a.epubMetadata&&(a!=null&&a.fileRecords)&&(L.value=(s=a==null?void 0:a.epubMetadata)==null?void 0:s.title)});const z=async()=>{if((!C.value||!E.value)&&await $(),!C.value||!E.value){F(l("auth.login_required"));return}try{if(o.value===0&&T.value){await T.value.onSubmit();return}if(o.value===1){if(!n.value){F("Please fill in all required fields");return}await R.value.onSubmit();return}if(o.value===2){await D.value.startNFTMintFlow();return}o.value<P.length-1&&o.value++}catch(a){console.error("Error during form submission:",a)}},e=a=>{const{fileRecords:s,epubMetadata:t}=a;t!=null&&t.coverData&&(t.coverData=void 0),Ce({fileRecords:s,epubMetadata:t}),o.value=1},_=async a=>{const{iscnId:s}=a;s&&await j(f({query:{iscn_id:s}}),{replace:!0}),Ne(),o.value=2,await ee(),c.value=s},h=async a=>{const{classId:s,nftMintCount:t}=a;s&&(u.value=s,await j(f({query:{class_id:s,count:t}}),{replace:!0}),o.value=3,await ee())},I=async()=>{await j(f({name:"my-books"}))};return(a,s)=>{const t=ke,W=Be,re=Ge,ce=He,ue=Pe,de=xe,pe=Ke;return v(),J(pe,{class:"flex flex-col items-stretch grow space-y-4"},{default:Y(()=>[g("div",Je,[g("div",Xe,[s[4]||(s[4]=g("div",{class:"absolute w-full h-[1px] bg-gray-300 top-[50%] left-0 z-[-1]"},null,-1)),(v(),B(Fe,null,Te(P,(N,K)=>g("div",{key:K,class:"flex items-center space-x-2 bg-white p-2 rounded-lg"},[w(t,{size:K===r(o)?"lg":"md",text:(K+1).toString(),ui:{background:K===r(o)?"bg-primary-100":"bg-gray-200"}},null,8,["size","text","ui"]),g("p",Qe,H(N.title),1)])),64))]),g("div",Ze,[r(o)===0?(v(),B("div",et,[w(W,{ref_key:"uploadFormRef",ref:T,onFileUploadStatus:s[0]||(s[0]=N=>M.value=N),onFileReady:s[1]||(s[1]=N=>A.value=N),onSubmit:e},null,512)])):r(o)===1?(v(),B("div",tt,[w(re,{ref_key:"registerISCN",ref:R,onFormValidChange:s[2]||(s[2]=N=>n.value=N),onSubmit:_},null,512)])):r(o)===2?(v(),B("div",at,[w(ce,{ref_key:"mintNFT",ref:D,"iscn-id":r(c),onLoadingChange:s[3]||(s[3]=N=>d.value=N),onSubmit:h},null,8,["iscn-id"])])):r(o)===3?(v(),B("div",st,[w(ue,{ref:"newNFTBook",class:"p-0 flex flex-col text-left gap-[24px]","is-new-class-page":!0,"class-id":r(u),onSubmit:I},null,8,["class-id"])])):X("",!0),g("div",ot,[r(O)?(v(),J(de,{key:0,disabled:r(q),label:r(k),onClick:z},null,8,["disabled","label"])):X("",!0)])])])]),_:1})}}});export{Nt as default};
