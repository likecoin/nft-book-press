import{a_ as Te,b6 as Ce,bl as ke,bn as J,bk as Fe,bx as Se,bm as Be,by as $e,b8 as s,b9 as M,ba as Z,b1 as Ee,b3 as E,aX as p,bq as ee,cV as te,aT as _,aU as l,br as B,aV as i,b4 as t,bs as Ae,bP as Re,aY as ae,bt as Ue,aW as u,bf as Ve,aS as A,bi as oe,bj as qe,bg as De,be as Pe,bc as Le}from"./C1Iws6nc.js";import{_ as Me}from"./C8rFwdj2.js";import{_ as We}from"./BAWiKx-w.js";import{_ as Oe}from"./UdKhLVak.js";import{u as ze,_ as je}from"./CRawfbbB.js";import{_ as Ge}from"./CckUxYIo.js";import{u as He}from"./Cw4LaRUG.js";import{u as Ke,L as Qe}from"./Cxa2cc_s.js";import{u as Xe,a as Ye}from"./BmObtvYH.js";import"./DXAePL8a.js";(function(){try{var w=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},T=new w.Error().stack;T&&(w._sentryDebugIds=w._sentryDebugIds||{},w._sentryDebugIds[T]="8db2266b-3419-48c2-aae0-601b56c4e6b5",w._sentryDebugIdIdentifier="sentry-dbid-8db2266b-3419-48c2-aae0-601b56c4e6b5")}catch{}})();const Je={class:"text-lg font-bold font-mono"},Ze={class:"divide-y w-full"},et={class:"px-4 py-3"},tt={class:"px-4 py-3"},at={class:"px-4 py-3"},ot={class:"px-4 py-3"},lt={class:"px-4 py-3"},nt={class:"text-left px-4 py-3"},st={class:"px-4 py-3"},rt={class:"px-4 py-3"},it={class:"flex flex-wrap items-center justify-center gap-2"},ut=["src"],wt=Te({__name:"[collectionId]",setup(w){const{LIKE_CO_API:T}=Ce().public,R=ke(),{wallet:I,signer:U}=J(R),{initIfNecessary:W}=R,O=Fe(),{token:z}=J(O),j=He(),V=Se(),{lazyFetchClassMetadataById:le}=j,{lazyFetchCollectionById:ne}=V,{getNFTMetadata:G,getNFTOwner:se,getBalanceOf:re,getTokenIdByOwnerIndex:ie}=Ke(),{writeContractAsync:ue}=Xe(),{assertPositiveWalletBalance:ce,waitForTransactionReceipt:de}=Ye(),q=Be(),fe=$e(),v=s(""),y=s(!1),b=s(q.params.collectionId),H=s(q.query.payment_id),C=s(q.query.owner_wallet||I.value),k=s(""),{messageCharCount:pe,isLimitReached:K}=ze(k,te),c=s([]),h=s([]),x=s(!1),N=s(!1),F=s(""),d=s(!1),Q=s(void 0),n=s({}),S=s([]),X=M(()=>d.value||y.value||x.value||N.value||!!F.value||K.value),me=M(()=>{var o;return(o=V.getCollectionById(b.value))==null?void 0:o.name}),m=M(()=>{var o;return(o=V.getCollectionById(b.value))==null?void 0:o.classIds});Z(y,o=>{o&&(v.value="")}),Z(d,o=>{o||c.value.forEach(async(e,a)=>{if(e){const r=await G(m.value[a],parseInt(e,10));S.value[a]=ee(r==null?void 0:r.image)}else S.value[a]=""})}),Ee(async()=>{const o=await $fetch(`${T}/likernft/book/collection/purchase/${b.value}/status/${H.value}`,{headers:{authorization:`Bearer ${z.value}`}});n.value=o,await ne(b.value),await Promise.all(m.value.map(e=>le(e))),D(n.value.quantity||1)});function _e(o){var e;return(e=j.getClassMetadataById(o))==null?void 0:e.name}function ve(){d.value=!d.value,F.value="",Le(()=>{var o,e,a;d.value&&((a=(e=(o=Q.value)==null?void 0:o.$refs)==null?void 0:e.input)==null||a.focus())})}async function ye(o,e){try{x.value=!0;const a=await G(o,parseInt(e,10));return ee(a==null?void 0:a.image)}catch(a){return v.value=a.toString(),""}finally{x.value=!1}}async function D(o=1){try{if(F.value="",N.value=!0,h.value=[],(!I.value||!U.value)&&await W(),!C.value)return;await Promise.all(m.value.map(async(e,a)=>{if(!h.value[a]){const r=await re(e,C.value);if(Number(r)<o)throw new Error(`Insufficient balance of NFT classId: ${e} for wallet: ${C.value}`);h.value[a]=[];for(let g=0;g<o;g++){const P=await ie(e,C.value,g);h.value[a].push(P),c.value[a]=h.value[a][0],S.value[a]=await ye(e,c.value[a])||""}}}))}catch(e){v.value=e.toString()}finally{N.value=!1}}function be(){D(n.value.quantity||1)}async function ge(){if(!X.value)try{if(y.value=!0,(!I.value||!U.value)&&await W(),!I.value||!U.value)return;if(await D(n.value.quantity),await Promise.all(m.value.map(async(a,r)=>{if(c.value[r]&&await se(a,parseInt(c.value[r],10))!==C.value)throw new Error(`NFT classId: ${a} nftId:${c.value[r]} is not owned by sender!`)})),m.value.find(a=>!a))throw new Error("Please specify NFT class ID");if(c.value.find(a=>!a))throw new Error("Please specify NFT ID");let o,e;await ce({wallet:I.value});for(let a=0;a<m.value.length;a++){const r=m.value[a];e=await ue({address:r,abi:Qe,functionName:"batchTransferWithMemo",args:[I.value,Array(n.value.quantity).fill(n.value.wallet),h.value[a],Array(n.value.quantity).fill(k.value)]}),o=await de({hash:e})}(o==null?void 0:o.status)==="success"&&(await $fetch(`${T}/likernft/book/collection/purchase/${b.value}/sent/${H.value}`,{method:"POST",body:{txHash:e,quantity:n.value.quantity||1},headers:{authorization:`Bearer ${z.value}`}}),fe.push({name:"nft-book-store-collection-status-collectionId",params:{collectionId:b.value}}))}catch(o){console.error(o),v.value=o.toString()}finally{y.value=!1}}return(o,e)=>{const a=Ae,r=Re,g=Ue,P=Me,Y=We,we=Oe,L=De,Ie=Pe,he=je,xe=Ge;return _(),E(xe,null,{default:p(()=>[l("h1",Je,' Deliver NFT Book Collection "'+i(t(me)||t(b))+'" ',1),t(v)?(_(),E(a,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${t(v)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:e[0]||(e[0]=f=>v.value="")},null,8,["title"])):B("",!0),t(y)?(_(),E(r,{key:1,animation:"carousel"},{indicator:p(()=>e[2]||(e[2]=[ae(" Loading... ")])),_:1})):B("",!0),t(O).isAuthenticated?(_(),E(g,{key:2,ui:{body:{base:"space-y-4"},footer:{base:"flex justify-center gap-2"}}},{footer:p(()=>[u(L,{label:"Sign and Send",disabled:t(X),size:"xl",onClick:ge},null,8,["disabled"])]),default:p(()=>[u(g,{ui:{body:{padding:""}}},{default:p(()=>{var f;return[l("table",Ze,[l("tbody",null,[l("tr",null,[e[3]||(e[3]=l("th",{class:"text-left px-4 py-3"}," Buyer Email ",-1)),l("td",et,i(t(n).email),1)]),l("tr",null,[e[4]||(e[4]=l("th",{class:"text-left px-4 py-3"}," Reader Email ",-1)),l("td",tt,i(((f=t(n).giftInfo)==null?void 0:f.toEmail)||t(n).email),1)]),l("tr",null,[e[5]||(e[5]=l("th",{class:"text-left px-4 py-3"}," Status ",-1)),l("td",at,i(t(n).status),1)]),l("tr",null,[e[6]||(e[6]=l("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),l("td",ot,i(t(n).wallet),1)]),l("tr",null,[e[7]||(e[7]=l("th",{class:"text-left px-4 py-3"}," Price ",-1)),l("td",lt,i(t(n).price),1)]),l("tr",null,[e[8]||(e[8]=l("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),l("td",nt,i(t(n).quantity),1)]),l("tr",null,[e[9]||(e[9]=l("th",{class:"text-left px-4 py-3"}," Buyer message ",-1)),l("td",st,i(t(n).message),1)]),l("tr",null,[e[10]||(e[10]=l("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),l("td",rt,i(t(n).from),1)])])])]}),_:1}),u(Y,{label:"Enter Author's Message",error:t(K),hint:`${t(pe)} / ${t(te)}`},{default:p(()=>[u(P,{modelValue:t(k),"onUpdate:modelValue":e[1]||(e[1]=f=>Ve(k)?k.value=f:null),placeholder:"default memo"},null,8,["modelValue"])]),_:1},8,["error","hint"]),u(Y,{label:"Specify NFT ID",error:t(F)},{default:p(()=>[(_(!0),A(oe,null,qe(t(m),(f,$)=>(_(),A("div",{key:f},[l("label",null,i(_e(f)+": "+f),1),l("div",it,[t(n).quantity===1?(_(),A(oe,{key:0},[u(we,{ref_for:!0,ref_key:"nftIdInputRef",ref:Q,modelValue:t(c)[$],"onUpdate:modelValue":Ne=>t(c)[$]=Ne,class:"font-mono flex-grow",readonly:!t(d),disabled:!t(d),placeholder:"Leave empty to auto-fetch NFT ID","trailing-icon":t(F)?"i-heroicons-exclamation-triangle-20-solid":void 0},null,8,["modelValue","onUpdate:modelValue","readonly","disabled","trailing-icon"]),u(L,{label:t(d)||t(x)&&!t(N)?"Confirm":"Edit",disabled:t(y)||t(x),variant:"outline",loading:t(x)&&!t(N),color:"gray",onClick:ve},null,8,["label","disabled","loading"]),u(Ie,{class:"text-sm text-gray-600 sm:w-min"},{default:p(()=>e[11]||(e[11]=[ae(" OR ")])),_:1,__:[11]})],64)):B("",!0),u(L,{label:`Auto-fetch NFT ID for ${t(n).quantity} orders`,disabled:t(y)||t(d),loading:t(N),variant:"outline",onClick:be},null,8,["label","disabled","loading"])]),u(he,{class:"h-[300px]"},{default:p(()=>[t(S)[$]?(_(),A("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",src:t(S)[$]},null,8,ut)):B("",!0)]),_:2},1024)]))),128))]),_:1},8,["error"])]),_:1})):B("",!0)]),_:1})}}});export{wt as default};
