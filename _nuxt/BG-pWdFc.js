import{a_ as X,bl as te,b6 as Q,bn as ae,b8 as n,b9 as O,ba as j,b1 as se,bI as pe,aS as E,aT as v,aW as w,b4 as i,bf as me,aX as G,aU as g,bJ as _e,aY as fe,aV as J,bK as be,bh as ve,aQ as ge,a$ as oe,bb as we,b3 as Y,br as H,bs as ye,bm as he,b0 as Ie,bL as Ne,b2 as W,bM as Se,bc as Z,bi as Fe,bj as Te,bN as xe,bg as ke,bO as Ce}from"./CObEiTlD.js";import{u as ne,a as Re,v as De,b as ee,_ as Me,f as Ue,c as Be,d as Ee}from"./Gdb7vUYN.js";import{L as Le,u as $e}from"./B5U7svZ3.js";import{D as Ae}from"./Dad1k5ls.js";import{u as Ve,a as Oe}from"./j62I9iP4.js";import{_ as Pe}from"./CR7XqVUz.js";import{_ as Ke}from"./DwImBlNl.js";import"./CIKxai_K.js";import"./BXFN2J2y.js";import"./DSwz9RZo.js";import"./B0HripVs.js";import"./CHFe8Bac.js";import"./FBX8tK2E.js";import"./DJsWHdRE.js";import"./Df6aoneV.js";import"./Di7gx4jH.js";import"./CnPe1CLt.js";import"./CeoqiVZx.js";import"./CT6jEmLw.js";import"./DOxC06Np.js";import"./Lyw4tghA.js";import"./DnoxhuSq.js";import"./Dd0YCoVm.js";(function(){try{var y=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},l=new y.Error().stack;l&&(y._sentryDebugIds=y._sentryDebugIds||{},y._sentryDebugIds[l]="89a2e8ff-f81f-4e79-b7f9-b0e19002c4bb",y._sentryDebugIdIdentifier="sentry-dbid-89a2e8ff-f81f-4e79-b7f9-b0e19002c4bb")}catch{}})();const ze={class:"space-y-3"},qe={class:"flex justify-between items-center"},We={class:"text-xs text-gray-500"},je=X({__name:"RegisterISCN",emits:["handleSubmit","submit","formValidChange"],setup(y,{expose:l,emit:x}){const k=te(),{getFileType:L}=ee(),{LIKE_EVM_NFT_TARGET_ADDRESS:$}=Q().public,{wallet:_,signer:p}=ae(k),{initIfNecessary:S}=k,{assertPositiveWalletBalance:s,waitForTransactionReceipt:F}=Ve(),{stripHtmlTags:C,formatLanguage:R}=ee(),{showErrorToast:D}=ne(),{LIKE_NFT_CONTRACT_ADDRESS:A}=Q().public,r=n({type:"Book",title:"",description:"",isbn:"",publisher:"",publicationDate:"",author:{name:"",description:""},license:"All Rights Reserved",customLicense:"",contentFingerprints:[{url:""}],downloadableUrls:[{url:"",type:"",fileName:""}],language:"",bookInfoUrl:"",tags:[],coverUrl:""}),c=n(""),V=n(""),M=x,{payload:o}=Re({iscnFormData:r}),{writeContractAsync:u}=Oe(),h=O(()=>De(r.value)),I=O(()=>{var t;return!((t=h.value)!=null&&t.length)});j(I,t=>{M("formValidChange",t)},{immediate:!0}),se(()=>{const t=P();t&&(r.value=t)});const P=()=>{var f,d,T,U,B,a;const t=pe();if(!t)return null;const m={type:"Book",title:((f=t.epubMetadata)==null?void 0:f.title)||"",description:C(((d=t.epubMetadata)==null?void 0:d.description)||""),isbn:"",publisher:"",publicationDate:new Date().toISOString().split("T")[0],author:{name:((T=t.epubMetadata)==null?void 0:T.author)||"",description:""},license:"All Rights Reserved",contentFingerprints:[],downloadableUrls:[],coverUrl:(U=t.epubMetadata)!=null&&U.thumbnailArweaveId?`ar://${t.epubMetadata.thumbnailArweaveId}`:"",language:R(((B=t.epubMetadata)==null?void 0:B.language)||"zh"),tags:((a=t.epubMetadata)==null?void 0:a.tags)||[]};return m.downloadableUrls=t.fileRecords.filter(e=>e.fileType==="application/pdf"||e.fileType==="application/epub+zip").map(e=>({url:e.arweaveKey?e.arweaveLink:`ar://${e.arweaveId}`,type:L(e.fileType),fileName:e.fileName})),m.contentFingerprints=[...new Set(t.fileRecords.map(e=>{const b=e.arweaveKey?e.arweaveLink:`ar://${e.arweaveId}`;return e.fileType==="application/epub+zip"||e.fileType==="application/pdf"?b:`ar://${e.arweaveId}`}).filter(Boolean))].map(e=>({url:e})),m},q=async()=>{if(c.value="checking",!I.value){D(h.value.join(", "));return}r.value.contentFingerprints.length&&await K()},K=async()=>{if(c.value="loading",await S(),!_.value||!p.value){V.value="MISSING_SIGNER",c.value="";return}try{c.value="signing";const t=Ue(o.value),m={name:t.name,description:t.description,...t,symbol:"BOOK",image:(t==null?void 0:t.thumbnailUrl)||"",external_link:(t==null?void 0:t.url)||"",nft_meta_collection_id:"nft_book",nft_meta_collection_name:"NFT Book",nft_meta_collection_description:"NFT Book by Liker Land",recordTimestamp:new Date().toISOString()};await s({wallet:_.value});const f=await u({address:A,abi:Le,functionName:"newBookNFTWithRoyalty",args:[{creator:_.value,updaters:[_.value,$],minters:[_.value,$],config:{name:m.name,symbol:"BOOK",metadata:JSON.stringify(m),max_supply:Ae}},500]}),d=await F({hash:f});if(console.log(d),!d||d.status!=="success")throw new Error("INVALID_RECEIPT");if(!d.logs[0].address)throw new Error("INVALID_CLASS_ID");const T=d.logs[0].address;c.value="success",M("submit",{iscnId:T,txHash:f})}catch(t){console.error(t),D(`'SIGNING_ERROR':${t}`),c.value=""}finally{c.value=""}};return l({onSubmit:q}),(t,m)=>{const f=Me,d=_e,T=be,U=ve;return v(),E("div",null,[w(f,{modelValue:i(r),"onUpdate:modelValue":m[0]||(m[0]=B=>me(r)?r.value=B:null)},null,8,["modelValue"]),w(U,{"model-value":!!i(c),"prevent-close":!0,ui:{base:"p-4 gap-2"}},{default:G(()=>[g("div",ze,[g("div",qe,[w(d,{variant:"soft"},{default:G(()=>[fe(J(i(c)),1)]),_:1}),g("p",We,J(t.$t("notifications.iscn_registration_complete")),1)]),w(T,{animation:"carousel",color:"primary",class:"w-full"})])]),_:1},8,["model-value"])])}}}),Ge=ge(je,[["__scopeId","data-v-1eece739"]]),Je={class:"flex flex-col items-stretch grow space-y-4"},Ye=X({__name:"MintNFT",props:{iscnId:{type:String,default:""}},emits:["submit","loadingChange"],setup(y,{expose:l,emit:x}){const{getClassOwner:k,getClassMetadata:L,checkNFTClassIsBookNFT:$}=$e(),_=n(1),p=n(""),S=n(!1),s=n(""),F=n(null),C=n(""),R=n(null),D=x;j(S,o=>{D("loadingChange",o),o&&(p.value="")},{immediate:!0});const{t:A}=oe();we({title:()=>A("seo.mint_nft_book_title"),ogTitle:()=>A("seo.mint_nft_book_title")});const r=y;j(()=>r.iscnId,async o=>{o&&await c(r.iscnId)},{immediate:!0});async function c(o){if(o)try{if(S.value=!0,!await $(o))throw new Error("Invalid NFT Class ID");const[h,I]=await Promise.all([L(o),k(o)]);if(!h)throw new Error("Invalid NFT Class ID");F.value={contentMetadata:h,owner:I,"@id":o},s.value=I,C.value=o,_.value=3}catch(u){console.error(u),p.value=u.toString()}finally{S.value=!1}}function V(){var o;(o=R.value)==null||o.startNFTMintFlow()}function M({classId:o,nftMintCount:u}={}){C.value=o||"",D("submit",{classId:o||"",nftMintCount:u})}return l({startNFTMintFlow:V}),(o,u)=>{const h=ye,I=Be;return v(),E("div",Je,[i(p)?(v(),Y(h,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${i(p)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:u[0]||(u[0]=P=>p.value="")},null,8,["title"])):H("",!0),w(I,{ref_key:"liteMintNFTRef",ref:R,"iscn-data":i(F),"should-show-submit":!1,onSubmit:M},null,8,["iscn-data"])])}}}),He={class:"w-full"},Xe={class:"justify-evenly items-center flex space-x-4 relative"},Qe={class:"text-sm font-semibold"},Ze={class:"mt-6 p-4 border rounded-lg bg-gray-100 text-center flex flex-col gap-[24px]"},et={key:0},tt={key:1},at={key:2},st={key:3},ot={class:"flex gap-2 justify-center mt-4"},kt=X({__name:"index",setup(y){var U,B;const{t:l}=oe(),x=te(),{wallet:k,signer:L}=ae(x),{initIfNecessary:$}=x,_=he(),p=Ie(),{showErrorToast:S}=ne(),s=n(0),F=n(),C=n(),R=n(),D=n(""),A=n(""),r=n(((U=_.query.iscn_id)==null?void 0:U.toString())||""),c=n(((B=_.query.class_id)==null?void 0:B.toString())||""),V=n([]),M=n(""),o=n(!1),u=n(!1),h=O(()=>{switch(s.value){case 0:return l("publish_button.upload_files");case 1:return l("publish_button.metadata");case 2:return l("publish_button.mint_nft");default:return l("publish_button.publish_now")}}),I=O(()=>{var a;return((a=V.value)==null?void 0:a.length)>0}),P=O(()=>s.value===0?I.value:s.value<3),q=O(()=>s.value===0?M.value!=="":s.value===2?u.value:!1),K=[{title:l("publish_steps.upload_files"),description:"Upload your book file"},{title:l("publish_steps.register_iscn"),description:"Register ISCN"},{title:l("publish_steps.mint_nft"),description:"Mint NFT"},{title:l("publish_steps.new_book_publish"),description:"Publish new book"}];se(()=>{var e;let a=null;try{const b=sessionStorage.getItem(Ne);b&&(a=JSON.parse(b))}catch(b){console.error(b)}r.value?(D.value=r.value,f({iscnId:r.value})):c.value?d({classId:c.value}):a!=null&&a.epubMetadata&&(a!=null&&a.fileRecords)&&(A.value=(e=a==null?void 0:a.epubMetadata)==null?void 0:e.title)});const t=async()=>{if((!k.value||!L.value)&&await $(),!k.value||!L.value){S(l("auth.login_required"));return}try{if(s.value===0&&F.value){await F.value.onSubmit();return}if(s.value===1){if(!o.value){S("Please fill in all required fields");return}await C.value.onSubmit();return}if(s.value===2){await R.value.startNFTMintFlow();return}s.value<K.length-1&&s.value++}catch(a){console.error("Error during form submission:",a)}},m=a=>{Ce(a),s.value=1},f=async a=>{const{iscnId:e}=a;e&&await W(p({query:{iscn_id:e}}),{replace:!0}),Se(),s.value=2,await Z(),r.value=e},d=async a=>{const{classId:e,nftMintCount:b}=a;e&&(c.value=e,await W(p({query:{class_id:e,count:b}}),{replace:!0}),s.value=3,await Z())},T=async()=>{await W(p({name:"nft-book-store"}))};return(a,e)=>{const b=xe,ie=Ee,le=Ge,re=Ye,ce=Pe,ue=ke,de=Ke;return v(),Y(de,{class:"flex flex-col items-stretch grow space-y-4"},{default:G(()=>[g("div",He,[g("div",Xe,[e[4]||(e[4]=g("div",{class:"absolute w-full h-[1px] bg-gray-300 top-[50%] left-0 z-[-1]"},null,-1)),(v(),E(Fe,null,Te(K,(N,z)=>g("div",{key:z,class:"flex items-center space-x-2 bg-white p-2 rounded-lg"},[w(b,{size:z===i(s)?"lg":"md",text:(z+1).toString(),ui:{background:z===i(s)?"bg-primary-100":"bg-gray-200"}},null,8,["size","text","ui"]),g("p",Qe,J(N.title),1)])),64))]),g("div",Ze,[i(s)===0?(v(),E("div",et,[w(ie,{ref_key:"uploadFormRef",ref:F,onFileUploadStatus:e[0]||(e[0]=N=>M.value=N),onFileReady:e[1]||(e[1]=N=>V.value=N),onSubmit:m},null,512)])):i(s)===1?(v(),E("div",tt,[w(le,{ref_key:"registerISCN",ref:C,onFormValidChange:e[2]||(e[2]=N=>o.value=N),onSubmit:f},null,512)])):i(s)===2?(v(),E("div",at,[w(re,{ref_key:"mintNFT",ref:R,"iscn-id":i(r),onLoadingChange:e[3]||(e[3]=N=>u.value=N),onSubmit:d},null,8,["iscn-id"])])):i(s)===3?(v(),E("div",st,[w(ce,{ref:"newNFTBook",class:"p-0 flex flex-col text-left gap-[24px]","is-new-class-page":!0,"class-id":i(c),onSubmit:T},null,8,["class-id"])])):H("",!0),g("div",ot,[i(P)?(v(),Y(ue,{key:0,disabled:i(q),label:i(h),onClick:t},null,8,["disabled","label"])):H("",!0)])])])]),_:1})}}});export{kt as default};
