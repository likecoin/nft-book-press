import{aQ as Fe,aS as $,aT as u,aU as t,bY as Be,ba as x,a_ as Re,a$ as Ue,b7 as J,b6 as Me,b8 as Z,bz as Ve,bk as qe,b0 as Ee,b9 as f,bb as ee,b1 as Ae,b3 as k,aX as p,bC as Le,bi as b,aW as h,aV as l,b4 as e,bj as We,bf as De,aY as te,bD as Oe,bv as Pe,bd as ae,b$ as ne,bo as ze,bp as je,bw as Qe,cc as Ge,br as He,bx as Ke,bg as Ye,b2 as Xe}from"./BVgQfaNN.js";import{_ as Je}from"./C7sKLTEE.js";import{b as Ze,u as et,_ as tt}from"./BGPgemeJ.js";import{_ as at}from"./B7Q4iAhT.js";import{a as nt,u as se,b as st}from"./mJZnu1Sy.js";import{b as oe}from"./DjcwmYGS.js";(function(){try{var c=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},o=new c.Error().stack;o&&(c._sentryDebugIds=c._sentryDebugIds||{},c._sentryDebugIds[o]="785b6cfe-d411-4cbf-947a-35652dbcd59f",c._sentryDebugIdIdentifier="sentry-dbid-785b6cfe-d411-4cbf-947a-35652dbcd59f")}catch{}})();const ot={},lt={class:"relative overflow-hidden rounded border border-dashed border-gray-400 dark:border-gray-500 opacity-75 flex items-center justify-center p-4"};function rt(c,o){return u(),$("div",lt,[o[0]||(o[0]=t("svg",{class:"absolute inset-0 h-full w-full stroke-gray-900/10 dark:stroke-white/10",fill:"none"},[t("defs",null,[t("pattern",{id:"placeholder-pattern",x:"0",y:"0",width:"10",height:"10",patternUnits:"userSpaceOnUse"},[t("path",{d:"M-3 13 15-5M-5 5l18-18M-1 21 17 3"})])]),t("rect",{stroke:"none",fill:"url(#placeholder-pattern)",width:"100%",height:"100%"})],-1)),Be(c.$slots,"default")])}const it=Fe(ot,[["render",rt]]);function ut(c){return c.charCodeAt(0)>255}function ct(c,o){const T=x(()=>{let v=0;for(let I=0;I<c.value.length;I++)v+=ut(c.value[I])?2:1;return v}),E=x(()=>T.value>o);return{messageCharCount:T,isLimitReached:E}}const dt={class:"text-lg font-bold font-mono"},ft={class:"divide-y w-full"},_t={class:"text-left px-4 py-3"},mt={class:"px-4 py-3"},pt={key:0},vt={class:"text-left px-4 py-3"},bt={class:"px-4 py-3"},yt={class:"text-left px-4 py-3"},ht={class:"px-4 py-3"},xt={class:"px-4 py-3"},gt={class:"text-left px-4 py-3"},wt={class:"px-4 py-3"},kt={class:"px-4 py-3"},It={class:"px-4 py-3"},Ct={class:"px-4 py-3"},Nt={class:"space-y-2 mb-4"},$t=["textContent"],Tt=["textContent"],St={class:"flex flex-wrap items-center justify-center gap-2 w-full"},Ft={class:"text-sm text-gray-400 dark:text-gray-600"},Bt=["textContent"],Rt=["textContent"],Ut=["src"],Wt=Re({__name:"[classId]",setup(c){const{t:o}=Ue(),{LIKE_CO_API:T}=J().public,E=Me(),{wallet:v,signer:I}=Z(E),{validateWalletConsistency:D}=E,O=Ve(),{token:P}=Z(O),z=nt(),{lazyFetchClassMetadataById:le}=z,A=qe(),re=Ee(),{writeContractAsync:ie}=Ze(),{getBalanceOf:ue,getTokenIdByOwnerIndex:ce}=se(),{assertPositiveWalletBalance:de,waitForTransactionReceipt:fe}=et(),g=f({message:"",actions:[]}),C=f(!1),r=x(()=>A.params.classId),j=x(()=>A.query.payment_id),R=x(()=>A.query.owner_wallet||v.value),U=f(o("nft_book_form.default_memo")),{messageCharCount:_e,isLimitReached:Q}=ct(U,oe),{getNFTMetadata:me,getNFTOwner:G}=se(),S=f([]),i=f([]),M=f(!1),w=f(""),F=f(!1),pe=f(void 0),s=f({}),V=f(""),q=f(!1),N=f(""),{NFT_ITEM_URL:ve}=J().public,H=x(()=>S.value.some(a=>a.trim()!=="")),K=x(()=>C.value||M.value||!!w.value||Q.value||!F.value),B=x(()=>s.value.quantity===1),be=x(()=>z.getClassMetadataById(r.value)?.name);ee(C,a=>{a&&(g.value={message:"",actions:[]})}),ee(S,(a,n)=>{n&&n.length>0&&B.value&&(F.value=!1,N.value="",w.value="")},{deep:!0}),Ae(async()=>{const a=await $fetch(`${T}/likernft/book/purchase/${r.value}/status/${j.value}`,{headers:{authorization:`Bearer ${P.value}`}});s.value=a,le(r.value),await L(s.value.quantity||1)});async function ye(){if(H.value)try{if(N.value="",w.value="",i.value=S.value.filter(_=>_.trim()!=="").map(_=>Number(_)),i.value.includes(0)){N.value=o("error.nft_id_reserved_for_author"),i.value=[];return}const[a,n]=await Promise.all([Y(),G(r.value,i.value[0])]);if(!a||n!==v.value){N.value=o("error.fetch_nft_metadata_failed"),i.value=[];return}F.value=!0}catch(a){N.value=a.message,i.value=[],F.value=!1}}async function Y(){try{if(M.value=!0,!i.value.length||i.value[0]===void 0){V.value="";return}try{const a=await me(r.value,i.value[0]);return V.value=Le(a?.image),a}catch(a){V.value="",a?.data?.code===2?w.value="NFT not found":w.value=a.toString()}}catch(a){g.value={message:a.toString(),actions:[]}}finally{M.value=!1}}async function L(a=1){try{if(i.value=[],w.value="",(!v.value||!I.value)&&await D(),!R.value)throw new Error("Missing owner wallet");const n=await ue(r.value,R.value);if(n<BigInt(a))throw new Error(`No NFTs available for classId: ${r.value} in wallet: ${R.value}`);const d=[];for(let _=0;_<Number(n);_++){const m=await ce(r.value,R.value,_);if(m!==0n&&(d.push(Number(m)),d.length>=a))break}if(d.length<a)throw new Error(`Failed to collect enough available NFTs. Collected ${d.length}/${a}`);i.value=d,S.value=d.map(String),F.value=!0,await Y()}catch(n){const d=n.toString();w.value=d,g.value={message:d,actions:[{label:o("button.restock_nft"),variant:"outline",color:"red",click:()=>{q.value=!0}}]}}}function he(){window.open(`${ve}/${r.value}`,"_blank","noopener")}async function xe(){if(!K.value)try{if(C.value=!0,(!v.value||!I.value)&&await D(),!v.value||!I.value)return;if(i.value){const _=(await Promise.all(i.value.map(m=>G(r.value,m)))).findIndex(m=>m!==R.value);if(_>=0){const m=i.value[_];throw new Error(`NFT classId: ${r.value} nftId:${m} is not owned by sender!`)}}else await L(s.value.quantity);await de({wallet:v.value});const a=await ie({address:r.value,abi:st,functionName:"batchTransferWithMemo",args:[v.value,Array(s.value.quantity).fill(s.value.wallet),i.value,Array(s.value.quantity).fill(U.value)]});(await fe({hash:a}))?.status==="success"&&(await $fetch(`${T}/likernft/book/purchase/${r.value}/sent/${j.value}`,{method:"POST",body:{txHash:a,quantity:s.value.quantity||1},headers:{authorization:`Bearer ${P.value}`}}),await Xe(re({name:"my-books-status-classId",params:{classId:r.value}})))}catch(a){console.error(a),g.value={message:a.toString(),actions:[]}}finally{C.value=!1}}function ge(){q.value=!1,L(s.value.quantity||1)}return(a,n)=>{const d=We,_=De,m=Oe,we=Je,X=Pe,ke=Qe,W=He,Ie=Ke,Ce=it,Ne=tt,$e=Ye,Te=at;return u(),k(Te,null,{default:p(()=>[t("h1",dt,' Deliver NFT Book "'+l(e(be)||e(r))+'" ',1),e(g).message?(u(),k(d,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${e(g).message}`,actions:e(g).actions,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:n[0]||(n[0]=y=>g.value={message:"",actions:[]})},null,8,["title","actions"])):b("",!0),e(C)?(u(),k(_,{key:1,animation:"carousel"},{indicator:p(()=>[...n[3]||(n[3]=[te(" Loading... ",-1)])]),_:1})):b("",!0),e(O).isAuthenticated?(u(),k(m,{key:2,ui:{body:{base:"space-y-6"},footer:{base:"flex justify-center gap-2"}}},{footer:p(()=>[h(W,{label:e(o)("nft_send.sign_and_send"),disabled:e(K),size:"xl",onClick:xe},null,8,["label","disabled"])]),default:p(()=>[h(m,{ui:{body:{padding:""}}},{default:p(()=>[t("table",ft,[t("tbody",null,[t("tr",null,[t("th",_t,l(e(o)("table.buyer_email")),1),t("td",mt,l(e(s).email),1)]),e(s).giftInfo?.toEmail?(u(),$("tr",pt,[t("th",vt,l(e(o)("table.reader_email")),1),t("td",bt,l(e(s).giftInfo?.toEmail||e(s).email),1)])):b("",!0),t("tr",null,[t("th",yt,l(e(o)("table.status")),1),t("td",ht,l(e(s).status),1)]),t("tr",null,[n[4]||(n[4]=t("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),t("td",xt,l(e(s).wallet),1)]),t("tr",null,[t("th",gt,l(e(o)("table.price_name")),1),t("td",wt,l(e(s).priceName),1)]),t("tr",null,[n[5]||(n[5]=t("th",{class:"text-left px-4 py-3"}," Price ",-1)),t("td",kt,l(e(s).price),1)]),t("tr",null,[n[6]||(n[6]=t("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),t("td",It,l(e(s).quantity),1)]),t("tr",null,[n[7]||(n[7]=t("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),t("td",Ct,l(e(s).from),1)])])])]),_:1}),h(m,null,{default:p(()=>[t("div",Nt,[t("h5",{class:"text-sm font-bold",textContent:l(`${e(o)("nft_book_form.buyer_message")}`)},null,8,$t),t("p",{textContent:l(e(s).message)},null,8,Tt)]),h(X,{label:e(o)("nft_book_form.author_message"),error:e(Q),hint:`${e(_e)} / ${e(oe)}`},{default:p(()=>[h(we,{modelValue:e(U),"onUpdate:modelValue":n[1]||(n[1]=y=>ae(U)?U.value=y:null)},null,8,["modelValue"])]),_:1},8,["label","error","hint"])]),_:1}),h(X,{label:e(o)("form.nft_id_label"),class:"mb-4",error:e(w),ui:{description:"text-gray-400 dark:text-gray-600"}},{default:p(()=>[t("div",St,[e(s).quantity?(u(),$("div",{key:0,class:ne([e(s).quantity>1?"w-full":"flex-grow","space-y-1","relative"])},[(u(!0),$(ze,null,je(e(s).quantity,y=>(u(),k(ke,{key:`nft-id-input-${y}`,ref_for:!0,ref_key:"nftIdInputRef",ref:pe,modelValue:e(S)[y-1],"onUpdate:modelValue":Se=>e(S)[y-1]=Se,disabled:!e(B),class:"font-mono"},Ge({_:2},[e(s).quantity>1?{name:"leading",fn:p(()=>[t("span",Ft,"#"+l(y),1)]),key:"0"}:void 0]),1032,["modelValue","onUpdate:modelValue","disabled"]))),128)),e(N)?(u(),$("span",{key:0,class:"text-xs text-red-500 absolute",textContent:l(e(N))},null,8,Bt)):e(F)&&e(B)?(u(),$("span",{key:1,class:"text-xs text-green-500 absolute",textContent:l(e(o)("button.confirmed"))},null,8,Rt)):b("",!0)],2)):b("",!0),e(B)?(u(),k(W,{key:1,label:e(o)("button.confirm_nft_id"),disabled:e(C)||e(M)||!e(H),variant:"outline",loading:e(M),color:"primary",onClick:ye},null,8,["label","disabled","loading"])):b("",!0),e(B)?(u(),k(Ie,{key:2,class:ne(["text-sm text-gray-600","sm:w-min"])},{default:p(()=>[...n[8]||(n[8]=[te(" OR ",-1)])]),_:1})):b("",!0),e(B)?(u(),k(W,{key:3,label:e(o)("button.check_all_nft_ids"),disabled:e(C),variant:"outline",onClick:he},null,8,["label","disabled"])):b("",!0)])]),_:1},8,["label","error"]),h(Ce,{class:"h-[300px]"},{default:p(()=>[e(V)?(u(),$("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",alt:"preview",src:e(V)},null,8,Ut)):b("",!0)]),_:1})]),_:1})):b("",!0),h($e,{modelValue:e(q),"onUpdate:modelValue":n[2]||(n[2]=y=>ae(q)?q.value=y:null)},{default:p(()=>[h(Ne,{"is-restock":!0,"iscn-id":e(r),onSubmit:ge},null,8,["iscn-id"])]),_:1},8,["modelValue"])]),_:1})}}});export{Wt as default};
