import{a_ as Te,b6 as Ce,bl as ke,bn as J,bk as Fe,bx as Se,bm as $e,b0 as Be,b8 as s,b9 as M,ba as Z,b1 as Ee,b3 as E,aX as p,bq as ee,c7 as te,aT as _,aU as l,br as $,aV as i,b4 as t,bs as Ae,bO as Re,aY as ae,bt as Ue,aW as u,bf as qe,aS as A,bi as oe,bj as De,bg as Ve,be as Le,bc as Pe,b2 as Me}from"./DPV33gLp.js";import{_ as Oe}from"./BFdfRuIA.js";import{_ as We}from"./kT3N-m6s.js";import{_ as ze}from"./CuE38GTW.js";import{u as je,_ as Ge}from"./B53DQJQM.js";import{_ as He}from"./Cxmw_PcO.js";import{u as Ke}from"./Cwc4CJZM.js";import{u as Qe,L as Xe}from"./BUxwVkJy.js";import{u as Ye,a as Je}from"./CFKVXl5M.js";import"./tnam1YGD.js";(function(){try{var h=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},T=new h.Error().stack;T&&(h._sentryDebugIds=h._sentryDebugIds||{},h._sentryDebugIds[T]="93796149-9963-4f32-a543-802ce8587154",h._sentryDebugIdIdentifier="sentry-dbid-93796149-9963-4f32-a543-802ce8587154")}catch{}})();const Ze={class:"text-lg font-bold font-mono"},et={class:"divide-y w-full"},tt={class:"text-left px-4 py-3"},at={class:"px-4 py-3"},ot={class:"text-left px-4 py-3"},lt={class:"px-4 py-3"},nt={class:"px-4 py-3"},st={class:"px-4 py-3"},rt={class:"px-4 py-3"},it={class:"text-left px-4 py-3"},ut={class:"px-4 py-3"},ct={class:"px-4 py-3"},dt={class:"flex flex-wrap items-center justify-center gap-2"},ft=["src"],xt=Te({__name:"[collectionId]",setup(h){const{LIKE_CO_API:T}=Ce().public,R=ke(),{wallet:w,signer:U}=J(R),{initIfNecessary:O}=R,W=Fe(),{token:z}=J(W),j=Ke(),q=Se(),{lazyFetchClassMetadataById:le}=j,{lazyFetchCollectionById:ne}=q,{getNFTMetadata:G,getNFTOwner:se,getBalanceOf:re,getTokenIdByOwnerIndex:ie}=Qe(),{writeContractAsync:ue}=Ye(),{assertPositiveWalletBalance:ce,waitForTransactionReceipt:de}=Je(),D=$e(),fe=Be(),v=s(""),y=s(!1),b=s(D.params.collectionId),H=s(D.query.payment_id),C=s(D.query.owner_wallet||w.value),k=s(""),{messageCharCount:pe,isLimitReached:K}=je(k,te),c=s([]),I=s([]),x=s(!1),N=s(!1),F=s(""),d=s(!1),Q=s(void 0),n=s({}),S=s([]),X=M(()=>d.value||y.value||x.value||N.value||!!F.value||K.value),me=M(()=>{var o;return(o=q.getCollectionById(b.value))==null?void 0:o.name}),m=M(()=>{var o;return(o=q.getCollectionById(b.value))==null?void 0:o.classIds});Z(y,o=>{o&&(v.value="")}),Z(d,o=>{o||c.value.forEach(async(e,a)=>{if(e){const r=await G(m.value[a],parseInt(e,10));S.value[a]=ee(r==null?void 0:r.image)}else S.value[a]=""})}),Ee(async()=>{const o=await $fetch(`${T}/likernft/book/collection/purchase/${b.value}/status/${H.value}`,{headers:{authorization:`Bearer ${z.value}`}});n.value=o,await ne(b.value),await Promise.all(m.value.map(e=>le(e))),V(n.value.quantity||1)});function _e(o){var e;return(e=j.getClassMetadataById(o))==null?void 0:e.name}function ve(){d.value=!d.value,F.value="",Pe(()=>{var o,e,a;d.value&&((a=(e=(o=Q.value)==null?void 0:o.$refs)==null?void 0:e.input)==null||a.focus())})}async function ye(o,e){try{x.value=!0;const a=await G(o,parseInt(e,10));return ee(a==null?void 0:a.image)}catch(a){return v.value=a.toString(),""}finally{x.value=!1}}async function V(o=1){try{if(F.value="",N.value=!0,I.value=[],(!w.value||!U.value)&&await O(),!C.value)return;await Promise.all(m.value.map(async(e,a)=>{if(!I.value[a]){const r=await re(e,C.value);if(Number(r)<o)throw new Error(`Insufficient balance of NFT classId: ${e} for wallet: ${C.value}`);I.value[a]=[];for(let g=0;g<o;g++){const L=await ie(e,C.value,g);I.value[a].push(L),c.value[a]=I.value[a][0],S.value[a]=await ye(e,c.value[a])||""}}}))}catch(e){v.value=e.toString()}finally{N.value=!1}}function be(){V(n.value.quantity||1)}async function ge(){if(!X.value)try{if(y.value=!0,(!w.value||!U.value)&&await O(),!w.value||!U.value)return;if(await V(n.value.quantity),await Promise.all(m.value.map(async(a,r)=>{if(c.value[r]&&await se(a,parseInt(c.value[r],10))!==C.value)throw new Error(`NFT classId: ${a} nftId:${c.value[r]} is not owned by sender!`)})),m.value.find(a=>!a))throw new Error("Please specify NFT class ID");if(c.value.find(a=>!a))throw new Error("Please specify NFT ID");let o,e;await ce({wallet:w.value});for(let a=0;a<m.value.length;a++){const r=m.value[a];e=await ue({address:r,abi:Xe,functionName:"batchTransferWithMemo",args:[w.value,Array(n.value.quantity).fill(n.value.wallet),I.value[a],Array(n.value.quantity).fill(k.value)]}),o=await de({hash:e})}(o==null?void 0:o.status)==="success"&&(await $fetch(`${T}/likernft/book/collection/purchase/${b.value}/sent/${H.value}`,{method:"POST",body:{txHash:e,quantity:n.value.quantity||1},headers:{authorization:`Bearer ${z.value}`}}),await Me(fe({name:"nft-book-store-collection-status-collectionId",params:{collectionId:b.value}})))}catch(o){console.error(o),v.value=o.toString()}finally{y.value=!1}}return(o,e)=>{const a=Ae,r=Re,g=Ue,L=Oe,Y=We,he=ze,P=Ve,we=Le,Ie=Ge,xe=He;return _(),E(xe,null,{default:p(()=>[l("h1",Ze,' Deliver NFT Book Collection "'+i(t(me)||t(b))+'" ',1),t(v)?(_(),E(a,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${t(v)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:e[0]||(e[0]=f=>v.value="")},null,8,["title"])):$("",!0),t(y)?(_(),E(r,{key:1,animation:"carousel"},{indicator:p(()=>e[2]||(e[2]=[ae(" Loading... ")])),_:1})):$("",!0),t(W).isAuthenticated?(_(),E(g,{key:2,ui:{body:{base:"space-y-4"},footer:{base:"flex justify-center gap-2"}}},{footer:p(()=>[u(P,{label:"Sign and Send",disabled:t(X),size:"xl",onClick:ge},null,8,["disabled"])]),default:p(()=>[u(g,{ui:{body:{padding:""}}},{default:p(()=>{var f;return[l("table",et,[l("tbody",null,[l("tr",null,[l("th",tt,i(o.$t("table.buyer_email")),1),l("td",at,i(t(n).email),1)]),l("tr",null,[l("th",ot,i(o.$t("table.reader_email")),1),l("td",lt,i(((f=t(n).giftInfo)==null?void 0:f.toEmail)||t(n).email),1)]),l("tr",null,[e[3]||(e[3]=l("th",{class:"text-left px-4 py-3"}," Status ",-1)),l("td",nt,i(t(n).status),1)]),l("tr",null,[e[4]||(e[4]=l("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),l("td",st,i(t(n).wallet),1)]),l("tr",null,[e[5]||(e[5]=l("th",{class:"text-left px-4 py-3"}," Price ",-1)),l("td",rt,i(t(n).price),1)]),l("tr",null,[e[6]||(e[6]=l("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),l("td",it,i(t(n).quantity),1)]),l("tr",null,[e[7]||(e[7]=l("th",{class:"text-left px-4 py-3"}," Buyer message ",-1)),l("td",ut,i(t(n).message),1)]),l("tr",null,[e[8]||(e[8]=l("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),l("td",ct,i(t(n).from),1)])])])]}),_:1}),u(Y,{label:"Enter Author's Message",error:t(K),hint:`${t(pe)} / ${t(te)}`},{default:p(()=>[u(L,{modelValue:t(k),"onUpdate:modelValue":e[1]||(e[1]=f=>qe(k)?k.value=f:null),placeholder:"default memo"},null,8,["modelValue"])]),_:1},8,["error","hint"]),u(Y,{label:"Specify NFT ID",error:t(F)},{default:p(()=>[(_(!0),A(oe,null,De(t(m),(f,B)=>(_(),A("div",{key:f},[l("label",null,i(_e(f)+": "+f),1),l("div",dt,[t(n).quantity===1?(_(),A(oe,{key:0},[u(he,{ref_for:!0,ref_key:"nftIdInputRef",ref:Q,modelValue:t(c)[B],"onUpdate:modelValue":Ne=>t(c)[B]=Ne,class:"font-mono flex-grow",readonly:!t(d),disabled:!t(d),placeholder:"Leave empty to auto-fetch NFT ID","trailing-icon":t(F)?"i-heroicons-exclamation-triangle-20-solid":void 0},null,8,["modelValue","onUpdate:modelValue","readonly","disabled","trailing-icon"]),u(P,{label:t(d)||t(x)&&!t(N)?"Confirm":"Edit",disabled:t(y)||t(x),variant:"outline",loading:t(x)&&!t(N),color:"gray",onClick:ve},null,8,["label","disabled","loading"]),u(we,{class:"text-sm text-gray-600 sm:w-min"},{default:p(()=>e[9]||(e[9]=[ae(" OR ")])),_:1,__:[9]})],64)):$("",!0),u(P,{label:`Auto-fetch NFT ID for ${t(n).quantity} orders`,disabled:t(y)||t(d),loading:t(N),variant:"outline",onClick:be},null,8,["label","disabled","loading"])]),u(Ie,{class:"h-[300px]"},{default:p(()=>[t(S)[B]?(_(),A("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",src:t(S)[B]},null,8,ft)):$("",!0)]),_:2},1024)]))),128))]),_:1},8,["error"])]),_:1})):$("",!0)]),_:1})}}});export{xt as default};
