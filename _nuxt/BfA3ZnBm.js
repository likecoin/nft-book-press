import{a_ as xe,b3 as Ne,bj as Te,bl as J,bi as ke,bv as Ce,bk as Fe,a$ as Se,b5 as s,b6 as P,b7 as Z,b0 as $e,b1 as E,aX as p,bo as ee,cS as te,aT as _,aU as l,bp as $,aV as i,bd as t,bq as Be,bM as Ee,aY as ae,br as Ae,aW as u,bc as Re,aS as A,bg as oe,bh as Ue,be as qe,bb as De,b9 as Ve,cT as Me}from"./BTgmShB0.js";import{_ as Le}from"./D-tw_PJZ.js";import{_ as Pe}from"./D3pMUPT6.js";import{_ as Oe}from"./Kaa100Vk.js";import{u as We,_ as ze}from"./DZ9OiVOL.js";import{_ as je}from"./CZsiBBgC.js";import{u as Ge}from"./DAV3lIDy.js";import{u as He,L as Ke}from"./DF5aNtBQ.js";import{u as Qe,w as Xe}from"./noA2pr89.js";import"./C6_JTRsm.js";(function(){try{var w=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},N=new w.Error().stack;N&&(w._sentryDebugIds=w._sentryDebugIds||{},w._sentryDebugIds[N]="28fc7abd-1c66-4514-9987-7ab241b11738",w._sentryDebugIdIdentifier="sentry-dbid-28fc7abd-1c66-4514-9987-7ab241b11738")}catch{}})();const Ye={class:"text-lg font-bold font-mono"},Je={class:"divide-y w-full"},Ze={class:"px-4 py-3"},et={class:"px-4 py-3"},tt={class:"px-4 py-3"},at={class:"px-4 py-3"},ot={class:"px-4 py-3"},lt={class:"text-left px-4 py-3"},nt={class:"px-4 py-3"},st={class:"px-4 py-3"},rt={class:"flex flex-wrap items-center justify-center gap-2"},it=["src"],gt=xe({__name:"[collectionId]",setup(w){const{LIKE_CO_API:N}=Ne().public,R=Te(),{wallet:T,signer:U}=J(R),{initIfNecessary:O}=R,W=ke(),{token:z}=J(W),j=Ge(),q=Ce(),{lazyFetchClassMetadataById:le}=j,{lazyFetchCollectionById:ne}=q,{getNFTMetadata:G,getNFTOwner:se,getBalanceOf:re,getTokenIdByOwnerIndex:ie}=He(),{writeContractAsync:ue}=Qe(),D=Fe(),ce=Se(),v=s(""),y=s(!1),b=s(D.params.collectionId),H=s(D.query.payment_id),k=s(D.query.owner_wallet||T.value),C=s(""),{messageCharCount:de,isLimitReached:K}=We(C,te),c=s([]),I=s([]),h=s(!1),x=s(!1),F=s(""),d=s(!1),Q=s(void 0),n=s({}),S=s([]),X=P(()=>d.value||y.value||h.value||x.value||!!F.value||K.value),fe=P(()=>{var o;return(o=q.getCollectionById(b.value))==null?void 0:o.name}),m=P(()=>{var o;return(o=q.getCollectionById(b.value))==null?void 0:o.classIds});Z(y,o=>{o&&(v.value="")}),Z(d,o=>{o||c.value.forEach(async(e,a)=>{if(e){const r=await G(m.value[a],parseInt(e,10));S.value[a]=ee(r==null?void 0:r.image)}else S.value[a]=""})}),$e(async()=>{const o=await $fetch(`${N}/likernft/book/collection/purchase/${b.value}/status/${H.value}`,{headers:{authorization:`Bearer ${z.value}`}});n.value=o,await ne(b.value),await Promise.all(m.value.map(e=>le(e))),V(n.value.quantity||1)});function pe(o){var e;return(e=j.getClassMetadataById(o))==null?void 0:e.name}function me(){d.value=!d.value,F.value="",Ve(()=>{var o,e,a;d.value&&((a=(e=(o=Q.value)==null?void 0:o.$refs)==null?void 0:e.input)==null||a.focus())})}async function _e(o,e){try{h.value=!0;const a=await G(o,parseInt(e,10));return ee(a==null?void 0:a.image)}catch(a){return v.value=a.toString(),""}finally{h.value=!1}}async function V(o=1){try{if(F.value="",x.value=!0,I.value=[],(!T.value||!U.value)&&await O(),!k.value)return;await Promise.all(m.value.map(async(e,a)=>{if(!I.value[a]){const r=await re(e,k.value);if(Number(r)<o)throw new Error(`Insufficient balance of NFT classId: ${e} for wallet: ${k.value}`);I.value[a]=[];for(let g=0;g<o;g++){const M=await ie(e,k.value,g);I.value[a].push(M),c.value[a]=I.value[a][0],S.value[a]=await _e(e,c.value[a])||""}}}))}catch(e){v.value=e.toString()}finally{x.value=!1}}function ve(){V(n.value.quantity||1)}async function ye(){if(!X.value)try{if(y.value=!0,(!T.value||!U.value)&&await O(),!T.value||!U.value)return;if(await V(n.value.quantity),await Promise.all(m.value.map(async(a,r)=>{if(c.value[r]&&await se(a,parseInt(c.value[r],10))!==k.value)throw new Error(`NFT classId: ${a} nftId:${c.value[r]} is not owned by sender!`)})),m.value.find(a=>!a))throw new Error("Please specify NFT class ID");if(c.value.find(a=>!a))throw new Error("Please specify NFT ID");let o,e;for(let a=0;a<m.value.length;a++){const r=m.value[a];e=await ue({address:r,abi:Ke,functionName:"batchTransferWithMemo",args:[T.value,Array(n.value.quantity).fill(n.value.wallet),I.value[a],Array(n.value.quantity).fill(C.value)]}),o=await Xe(Me,{hash:e})}(o==null?void 0:o.status)==="success"&&(await $fetch(`${N}/likernft/book/collection/purchase/${b.value}/sent/${H.value}`,{method:"POST",body:{txHash:e,quantity:n.value.quantity||1},headers:{authorization:`Bearer ${z.value}`}}),ce.push({name:"nft-book-store-collection-status-collectionId",params:{collectionId:b.value}}))}catch(o){console.error(o),v.value=o.toString()}finally{y.value=!1}}return(o,e)=>{const a=Be,r=Ee,g=Ae,M=Le,Y=Pe,be=Oe,L=qe,ge=De,we=ze,Ie=je;return _(),E(Ie,null,{default:p(()=>[l("h1",Ye,' Deliver NFT Book Collection "'+i(t(fe)||t(b))+'" ',1),t(v)?(_(),E(a,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${t(v)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:e[0]||(e[0]=f=>v.value="")},null,8,["title"])):$("",!0),t(y)?(_(),E(r,{key:1,animation:"carousel"},{indicator:p(()=>e[2]||(e[2]=[ae(" Loading... ")])),_:1})):$("",!0),t(W).isAuthenticated?(_(),E(g,{key:2,ui:{body:{base:"space-y-4"},footer:{base:"flex justify-center gap-2"}}},{footer:p(()=>[u(L,{label:"Sign and Send",disabled:t(X),size:"xl",onClick:ye},null,8,["disabled"])]),default:p(()=>[u(g,{ui:{body:{padding:""}}},{default:p(()=>{var f;return[l("table",Je,[l("tbody",null,[l("tr",null,[e[3]||(e[3]=l("th",{class:"text-left px-4 py-3"}," Buyer Email ",-1)),l("td",Ze,i(t(n).email),1)]),l("tr",null,[e[4]||(e[4]=l("th",{class:"text-left px-4 py-3"}," Reader Email ",-1)),l("td",et,i(((f=t(n).giftInfo)==null?void 0:f.toEmail)||t(n).email),1)]),l("tr",null,[e[5]||(e[5]=l("th",{class:"text-left px-4 py-3"}," Status ",-1)),l("td",tt,i(t(n).status),1)]),l("tr",null,[e[6]||(e[6]=l("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),l("td",at,i(t(n).wallet),1)]),l("tr",null,[e[7]||(e[7]=l("th",{class:"text-left px-4 py-3"}," Price ",-1)),l("td",ot,i(t(n).price),1)]),l("tr",null,[e[8]||(e[8]=l("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),l("td",lt,i(t(n).quantity),1)]),l("tr",null,[e[9]||(e[9]=l("th",{class:"text-left px-4 py-3"}," Buyer message ",-1)),l("td",nt,i(t(n).message),1)]),l("tr",null,[e[10]||(e[10]=l("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),l("td",st,i(t(n).from),1)])])])]}),_:1}),u(Y,{label:"Enter Author's Message",error:t(K),hint:`${t(de)} / ${t(te)}`},{default:p(()=>[u(M,{modelValue:t(C),"onUpdate:modelValue":e[1]||(e[1]=f=>Re(C)?C.value=f:null),placeholder:"default memo"},null,8,["modelValue"])]),_:1},8,["error","hint"]),u(Y,{label:"Specify NFT ID",error:t(F)},{default:p(()=>[(_(!0),A(oe,null,Ue(t(m),(f,B)=>(_(),A("div",{key:f},[l("label",null,i(pe(f)+": "+f),1),l("div",rt,[t(n).quantity===1?(_(),A(oe,{key:0},[u(be,{ref_for:!0,ref_key:"nftIdInputRef",ref:Q,modelValue:t(c)[B],"onUpdate:modelValue":he=>t(c)[B]=he,class:"font-mono flex-grow",readonly:!t(d),disabled:!t(d),placeholder:"Leave empty to auto-fetch NFT ID","trailing-icon":t(F)?"i-heroicons-exclamation-triangle-20-solid":void 0},null,8,["modelValue","onUpdate:modelValue","readonly","disabled","trailing-icon"]),u(L,{label:t(d)||t(h)&&!t(x)?"Confirm":"Edit",disabled:t(y)||t(h),variant:"outline",loading:t(h)&&!t(x),color:"gray",onClick:me},null,8,["label","disabled","loading"]),u(ge,{class:"text-sm text-gray-600 sm:w-min"},{default:p(()=>e[11]||(e[11]=[ae(" OR ")])),_:1,__:[11]})],64)):$("",!0),u(L,{label:`Auto-fetch NFT ID for ${t(n).quantity} orders`,disabled:t(y)||t(d),loading:t(x),variant:"outline",onClick:ve},null,8,["label","disabled","loading"])]),u(we,{class:"h-[300px]"},{default:p(()=>[t(S)[B]?(_(),A("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",src:t(S)[B]},null,8,it)):$("",!0)]),_:2},1024)]))),128))]),_:1},8,["error"])]),_:1})):$("",!0)]),_:1})}}});export{gt as default};
