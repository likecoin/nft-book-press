import{a_ as xt,b6 as gt,bl as It,bn as G,bk as wt,bm as Nt,b0 as Tt,b8 as o,b9 as K,ba as Q,b1 as kt,b3 as C,aX as d,bq as Ft,cU as X,aT as _,aU as a,br as S,aV as r,b4 as e,bs as $t,bO as Ct,aY as Y,bt as St,aW as p,bf as qt,aS as R,bI as J,bi as Bt,bj as At,bH as Ut,bg as Et,be as Rt,bc as Vt,b2 as Dt}from"./C_iIk3B2.js";import{_ as Lt}from"./DN_YN0gu.js";import{_ as Mt}from"./DoLT8sxl.js";import{_ as Ot}from"./jkTzhJ-8.js";import{u as Pt,_ as Wt}from"./CVMAIs1Q.js";import{_ as zt}from"./D7FwGhZR.js";import{u as jt}from"./PSasOj5b.js";import{u as Z,L as Ht}from"./Cyt6qPFm.js";import{u as Gt,a as Kt}from"./CIhxs5fO.js";import"./CDmhjFLy.js";(function(){try{var h=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},T=new h.Error().stack;T&&(h._sentryDebugIds=h._sentryDebugIds||{},h._sentryDebugIds[T]="922f3c52-8bbd-46bb-946f-9423a62ef14f",h._sentryDebugIdIdentifier="sentry-dbid-922f3c52-8bbd-46bb-946f-9423a62ef14f")}catch{}})();const Qt={class:"text-lg font-bold font-mono"},Xt={class:"divide-y w-full"},Yt={class:"text-left px-4 py-3"},Jt={class:"px-4 py-3"},Zt={class:"text-left px-4 py-3"},te={class:"px-4 py-3"},ee={class:"text-left px-4 py-3"},ae={class:"px-4 py-3"},ne={class:"px-4 py-3"},se={class:"text-left px-4 py-3"},le={class:"px-4 py-3"},oe={class:"px-4 py-3"},re={class:"px-4 py-3"},ue={class:"px-4 py-3"},ie={class:"px-4 py-3"},ce={class:"flex flex-wrap items-center justify-center gap-2 w-full"},de={class:"text-sm text-gray-400 dark:text-gray-600"},fe=["src"],we=xt({__name:"[classId]",setup(h){const{LIKE_CO_API:T}=gt().public,q=It(),{wallet:x,signer:B}=G(q),{initIfNecessary:V}=q,D=wt(),{token:L}=G(D),M=jt(),{lazyFetchClassMetadataById:tt}=M,A=Nt(),et=Tt(),{writeContractAsync:at}=Gt(),{getBalanceOf:nt,getTokenIdByOwnerIndex:st}=Z(),{assertPositiveWalletBalance:lt,waitForTransactionReceipt:ot}=Kt(),v=o(""),y=o(!1),u=o(A.params.classId),O=o(A.query.payment_id),k=o(A.query.owner_wallet||x.value),F=o(""),{messageCharCount:rt,isLimitReached:P}=Pt(F,X),{getNFTMetadata:ut,getNFTOwner:it}=Z(),$=o([]),i=o([]),g=o(!1),I=o(!1),b=o(""),f=o(!1),W=o(void 0),s=o({}),w=o(""),z=K(()=>f.value||y.value||g.value||I.value||!!b.value||P.value),ct=K(()=>{var n;return(n=M.getClassMetadataById(u.value))==null?void 0:n.name});Q(y,n=>{n&&(v.value="")}),Q(f,async n=>{if(!n)if($.value){const t=$.value.filter(l=>l.trim()!=="").map(l=>Number(l));if(s.value.quantity&&t.length>0&&t.length!==s.value.quantity){b.value=`Number of NFT IDs (${t.length}) does not match the required quantity (${s.value.quantity})`,i.value=[];return}i.value=t,await j()}else w.value="",i.value=[]}),kt(async()=>{const n=await $fetch(`${T}/likernft/book/purchase/${u.value}/status/${O.value}`,{headers:{authorization:`Bearer ${L.value}`}});s.value=n,tt(u.value),U(s.value.quantity||1)});function dt(){f.value=!f.value,b.value="",Vt(()=>{var n,t,l;f.value&&((l=(t=(n=W.value)==null?void 0:n[0].$refs)==null?void 0:t.input)==null||l.focus())})}async function j(){var n;try{if(g.value=!0,!i.value.length||i.value[0]===void 0){w.value="";return}try{const t=await ut(u.value,i.value[0]);w.value=Ft(t==null?void 0:t.image)}catch(t){w.value="",((n=t==null?void 0:t.data)==null?void 0:n.code)===2?b.value="NFT not found":b.value=t.toString()}}catch(t){v.value=t.toString()}finally{g.value=!1}}async function U(n=1){try{if(i.value=[],b.value="",I.value=!0,(!x.value||!B.value)&&await V(),!k.value)return;const t=await nt(u.value,k.value);if(Number(t)<n)throw new Error(`Insufficient balance of NFT classId: ${u.value} for wallet: ${k.value}`);for(let l=0;l<n;l++){const N=await st(u.value,k.value,l);i.value.push(Number(N))}$.value=i.value.map(l=>l.toString()),await j()}catch(t){v.value=t.toString()}finally{I.value=!1}}function ft(){U(s.value.quantity||1)}async function pt(){if(!z.value)try{if(y.value=!0,(!x.value||!B.value)&&await V(),!x.value||!B.value)return;if(i.value){const N=(await Promise.all(i.value.map(m=>it(u.value,m)))).findIndex(m=>m!==k.value);if(N>=0){const m=i.value[N];throw new Error(`NFT classId: ${u.value} nftId:${m} is not owned by sender!`)}}else await U(s.value.quantity);await lt({wallet:x.value});const n=await at({address:u.value,abi:Ht,functionName:"batchTransferWithMemo",args:[x.value,Array(s.value.quantity).fill(s.value.wallet),i.value,Array(s.value.quantity).fill(F.value)]}),t=await ot({hash:n});(t==null?void 0:t.status)==="success"&&(await $fetch(`${T}/likernft/book/purchase/${u.value}/sent/${O.value}`,{method:"POST",body:{txHash:n,quantity:s.value.quantity||1},headers:{authorization:`Bearer ${L.value}`}}),await Dt(et({name:"nft-book-store-status-classId",params:{classId:u.value}})))}catch(n){console.error(n),v.value=n.toString()}finally{y.value=!1}}return(n,t)=>{const l=$t,N=Ct,m=St,mt=Lt,H=Mt,_t=Ot,E=Et,vt=Rt,yt=Wt,bt=zt;return _(),C(bt,null,{default:d(()=>[a("h1",Qt,' Deliver NFT Book "'+r(e(ct)||e(u))+'" ',1),e(v)?(_(),C(l,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${e(v)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:t[0]||(t[0]=c=>v.value="")},null,8,["title"])):S("",!0),e(y)?(_(),C(N,{key:1,animation:"carousel"},{indicator:d(()=>t[2]||(t[2]=[Y(" Loading... ")])),_:1})):S("",!0),e(D).isAuthenticated?(_(),C(m,{key:2,ui:{body:{base:"space-y-4"},footer:{base:"flex justify-center gap-2"}}},{footer:d(()=>[p(E,{label:"Sign and Send",disabled:e(z),size:"xl",onClick:pt},null,8,["disabled"])]),default:d(()=>[p(m,{ui:{body:{padding:""}}},{default:d(()=>{var c;return[a("table",Xt,[a("tbody",null,[a("tr",null,[a("th",Yt,r(n.$t("table.buyer_email")),1),a("td",Jt,r(e(s).email),1)]),a("tr",null,[a("th",Zt,r(n.$t("table.reader_email")),1),a("td",te,r(((c=e(s).giftInfo)==null?void 0:c.toEmail)||e(s).email),1)]),a("tr",null,[a("th",ee,r(n.$t("table.status")),1),a("td",ae,r(e(s).status),1)]),a("tr",null,[t[3]||(t[3]=a("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),a("td",ne,r(e(s).wallet),1)]),a("tr",null,[a("th",se,r(n.$t("table.price_name")),1),a("td",le,r(e(s).priceName),1)]),a("tr",null,[t[4]||(t[4]=a("th",{class:"text-left px-4 py-3"}," Price ",-1)),a("td",oe,r(e(s).price),1)]),a("tr",null,[t[5]||(t[5]=a("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),a("td",re,r(e(s).quantity),1)]),a("tr",null,[t[6]||(t[6]=a("th",{class:"text-left px-4 py-3"}," Buyer message ",-1)),a("td",ue,r(e(s).message),1)]),a("tr",null,[t[7]||(t[7]=a("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),a("td",ie,r(e(s).from),1)])])])]}),_:1}),p(H,{label:"Enter Author's Message",error:e(P),hint:`${e(rt)} / ${e(X)}`},{default:d(()=>[p(mt,{modelValue:e(F),"onUpdate:modelValue":t[1]||(t[1]=c=>qt(F)?F.value=c:null),placeholder:"default memo"},null,8,["modelValue"])]),_:1},8,["error","hint"]),p(H,{label:"Specify NFT ID",description:"Leave empty to auto-fetch NFT ID",error:e(b),ui:{description:"text-gray-400 dark:text-gray-600"}},{default:d(()=>[a("div",ce,[e(s).quantity?(_(),R("div",{key:0,class:J([e(s).quantity>1?"w-full":"flex-grow","space-y-1"])},[(_(!0),R(Bt,null,At(e(s).quantity,c=>(_(),C(_t,{key:`nft-id-input-${c}`,ref_for:!0,ref_key:"nftIdInputRef",ref:W,modelValue:e($)[c-1],"onUpdate:modelValue":ht=>e($)[c-1]=ht,class:"font-mono",readonly:!e(f),disabled:!e(f)},Ut({_:2},[e(s).quantity>1?{name:"leading",fn:d(()=>[a("span",de,"#"+r(c),1)]),key:"0"}:void 0]),1032,["modelValue","onUpdate:modelValue","readonly","disabled"]))),128))],2)):S("",!0),p(E,{label:e(f)||e(g)&&!e(I)?"Confirm":"Edit",disabled:e(y)||e(g),variant:"outline",loading:e(g)&&!e(I),color:"gray",onClick:dt},null,8,["label","disabled","loading"]),p(vt,{class:J(["text-sm text-gray-600",{"sm:w-min":e(s).quantity<=1}])},{default:d(()=>t[8]||(t[8]=[Y(" OR ")])),_:1,__:[8]},8,["class"]),p(E,{label:`Auto-fetch NFT ID for ${e(s).quantity} NFTs`,disabled:e(y)||e(f),loading:e(I),variant:"outline",onClick:ft},null,8,["label","disabled","loading"])])]),_:1},8,["error"]),p(yt,{class:"h-[300px]"},{default:d(()=>[e(w)?(_(),R("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",src:e(w)},null,8,fe)):S("",!0)]),_:1})]),_:1})):S("",!0)]),_:1})}}});export{we as default};
