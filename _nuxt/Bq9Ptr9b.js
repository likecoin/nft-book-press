import{dl as tt,dm as pt,dn as xt,dp as ht,dq as Rt,dr as Ft,ds as ut,dt as j,du as Bt,dv as At,cw as Et,dw as rt,dx as ot,dy as Dt,dz as Ut,dA as Mt,dB as St,dC as dt,dD as $t,dE as Ot,dF as Pt,cz as G,dG as jt,dH as gt,dI as Vt,dJ as wt,dK as Lt,cy as Gt,dL as qt,cY as zt,cZ as Ht,dM as Wt,d1 as Kt,bt as Jt,a_ as Yt,bk as Zt,a$ as Xt,b6 as Qt,b8 as te,b9 as O,cR as ee,ba as q,bA as ae,bb as K,bK as ne,aS as J,aT as P,b3 as et,bi as Y,aW as Z,b4 as C,bj as re,bB as oe,aX as at,aU as z,bf as se,bZ as ce,be as ie,aY as le,aV as nt,br as ue,b7 as de}from"./Ds3ab4RW.js";import{_ as me}from"./BZ9675yX.js";import{N as fe,d as be}from"./kAqF0rbD.js";import{g as pe,r as he,m as ge,d as we,c as st,e as ye,b as X,u as _e}from"./DPM66n0n.js";(function(){try{var t=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},n=new t.Error().stack;n&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[n]="c90d4504-8280-410d-bd7a-023d99fa9ada",t._sentryDebugIdIdentifier="sentry-dbid-c90d4504-8280-410d-bd7a-023d99fa9ada")}catch{}})();const Ce=new Map,ve=new Map;function ke(t){const n=(r,s)=>({clear:()=>s.delete(r),get:()=>s.get(r),set:i=>s.set(r,i)}),a=n(t,Ce),c=n(t,ve);return{clear:()=>{a.clear(),c.clear()},promise:a,response:c}}async function Ne(t,{cacheKey:n,cacheTime:a=Number.POSITIVE_INFINITY}){const c=ke(n),r=c.response.get();if(r&&a>0&&new Date().getTime()-r.created.getTime()<a)return r.data;let s=c.promise.get();s||(s=t(),c.promise.set(s));try{const i=await s;return c.response.set({created:new Date,data:i}),i}finally{c.promise.clear()}}const Te=t=>`blockNumber.${t}`;async function Ie(t,{cacheTime:n=t.cacheTime}={}){const a=await Ne(()=>t.request({method:"eth_blockNumber"}),{cacheKey:Te(t.uid),cacheTime:n});return BigInt(a)}async function yt(t,{blockHash:n,blockNumber:a,blockTag:c,hash:r,index:s}){var p,u,o;const i=c||"latest",l=a!==void 0?tt(a):void 0;let e=null;if(r?e=await t.request({method:"eth_getTransactionByHash",params:[r]},{dedupe:!0}):n?e=await t.request({method:"eth_getTransactionByBlockHashAndIndex",params:[n,tt(s)]},{dedupe:!0}):e=await t.request({method:"eth_getTransactionByBlockNumberAndIndex",params:[l||i,tt(s)]},{dedupe:!!l}),!e)throw new pt({blockHash:n,blockNumber:a,blockTag:i,hash:r,index:s});return(((o=(u=(p=t.chain)==null?void 0:p.formatters)==null?void 0:u.transaction)==null?void 0:o.format)||xt)(e)}async function mt(t,{hash:n}){var r,s,i;const a=await t.request({method:"eth_getTransactionReceipt",params:[n]},{dedupe:!0});if(!a)throw new ht({hash:n});return(((i=(s=(r=t.chain)==null?void 0:r.formatters)==null?void 0:s.transactionReceipt)==null?void 0:i.format)||Rt)(a)}async function xe(t,n){var k;const{account:a,allowFailure:c=!0,batchSize:r,blockNumber:s,blockTag:i,multicallAddress:l,stateOverride:e}=n,m=n.contracts,p=r??(typeof((k=t.batch)==null?void 0:k.multicall)=="object"&&t.batch.multicall.batchSize||1024);let u=l;if(!u){if(!t.chain)throw new Error("client chain not configured. multicallAddress is required.");u=pe({blockNumber:s,chain:t.chain,contract:"multicall3"})}const o=[[]];let b=0,h=0;for(let g=0;g<m.length;g++){const{abi:w,address:B,args:y,functionName:f}=m[g];try{const T=Ft({abi:w,args:y,functionName:f});h+=(T.length-2)/2,p>0&&h>p&&o[b].length>0&&(b++,h=(T.length-2)/2,o[b]=[]),o[b]=[...o[b],{allowFailure:!0,callData:T,target:B}]}catch(T){const A=ut(T,{abi:w,address:B,args:y,docsPath:"/docs/contract/multicall",functionName:f,sender:a});if(!c)throw A;o[b]=[...o[b],{allowFailure:!0,callData:"0x",target:B}]}}const v=await Promise.allSettled(o.map(g=>j(t,he,"readContract")({abi:ge,account:a,address:u,args:[g],blockNumber:s,blockTag:i,functionName:"aggregate3",stateOverride:e}))),_=[];for(let g=0;g<v.length;g++){const w=v[g];if(w.status==="rejected"){if(!c)throw w.reason;for(let y=0;y<o[g].length;y++)_.push({status:"failure",error:w.reason,result:void 0});continue}const B=w.value;for(let y=0;y<B.length;y++){const{returnData:f,success:T}=B[y],{callData:A}=o[g][y],{abi:R,address:D,functionName:I,args:$}=m[_.length];try{if(A==="0x")throw new Bt;if(!T)throw new At({data:f});const V=we({abi:R,args:$,data:f,functionName:I});_.push(c?{result:V,status:"success"}:V)}catch(V){const F=ut(V,{abi:R,address:D,args:$,docsPath:"/docs/contract/multicall",functionName:I});if(!c)throw F;_.push({error:F,result:void 0,status:"failure"})}}}if(_.length!==m.length)throw new Et("multicall results mismatch");return _}function Re(t,{emitOnBegin:n=!1,emitMissed:a=!1,onBlockNumber:c,onError:r,poll:s,pollingInterval:i=t.pollingInterval}){const l=typeof s<"u"?s:!(t.transport.type==="webSocket"||t.transport.type==="ipc"||t.transport.type==="fallback"&&(t.transport.transports[0].config.type==="webSocket"||t.transport.transports[0].config.type==="ipc"));let e;return l?(()=>{const u=rt(["watchBlockNumber",t.uid,n,a,i]);return ot(u,{onBlockNumber:c,onError:r},o=>Dt(async()=>{var b;try{const h=await j(t,Ie,"getBlockNumber")({cacheTime:0});if(e){if(h===e)return;if(h-e>1&&a)for(let v=e+1n;v<h;v++)o.onBlockNumber(v,e),e=v}(!e||h>e)&&(o.onBlockNumber(h,e),e=h)}catch(h){(b=o.onError)==null||b.call(o,h)}},{emitOnBegin:n,interval:i}))})():(()=>{const u=rt(["watchBlockNumber",t.uid,n,a]);return ot(u,{onBlockNumber:c,onError:r},o=>{let b=!0,h=()=>b=!1;return(async()=>{try{const v=(()=>{if(t.transport.type==="fallback"){const k=t.transport.transports.find(g=>g.config.type==="webSocket"||g.config.type==="ipc");return k?k.value:t.transport}return t.transport})(),{unsubscribe:_}=await v.subscribe({params:["newHeads"],onData(k){var w;if(!b)return;const g=Ut((w=k.result)==null?void 0:w.number);o.onBlockNumber(g,e),e=g},onError(k){var g;(g=o.onError)==null||g.call(o,k)}});h=_,b||h()}catch(v){r==null||r(v)}})(),()=>h()})})()}async function Fe(t,{confirmations:n=1,hash:a,onReplaced:c,pollingInterval:r=t.pollingInterval,retryCount:s=6,retryDelay:i=({count:e})=>~~(1<<e)*200,timeout:l=18e4}){const e=rt(["waitForTransactionReceipt",t.uid,a]);let m,p,u,o=!1,b,h;const{promise:v,resolve:_,reject:k}=Mt(),g=l?setTimeout(()=>{h(),b(),k(new St({hash:a}))},l):void 0;return b=ot(e,{onReplaced:c,resolve:_,reject:k},w=>{h=j(t,Re,"watchBlockNumber")({emitMissed:!0,emitOnBegin:!0,poll:!0,pollingInterval:r,async onBlockNumber(B){const y=T=>{clearTimeout(g),h(),T(),b()};let f=B;if(!o)try{if(u){if(n>1&&(!u.blockNumber||f-u.blockNumber+1n<n))return;y(()=>w.resolve(u));return}if(m||(o=!0,await dt(async()=>{m=await j(t,yt,"getTransaction")({hash:a}),m.blockNumber&&(f=m.blockNumber)},{delay:i,retryCount:s}),o=!1),u=await j(t,mt,"getTransactionReceipt")({hash:a}),n>1&&(!u.blockNumber||f-u.blockNumber+1n<n))return;y(()=>w.resolve(u))}catch(T){if(T instanceof pt||T instanceof ht){if(!m){o=!1;return}try{p=m,o=!0;const A=await dt(()=>j(t,$t,"getBlock")({blockNumber:f,includeTransactions:!0}),{delay:i,retryCount:s,shouldRetry:({error:I})=>I instanceof Ot});o=!1;const R=A.transactions.find(({from:I,nonce:$})=>I===p.from&&$===p.nonce);if(!R||(u=await j(t,mt,"getTransactionReceipt")({hash:R.hash}),n>1&&(!u.blockNumber||f-u.blockNumber+1n<n)))return;let D="replaced";R.to===p.to&&R.value===p.value&&R.input===p.input?D="repriced":R.from===R.to&&R.value===0n&&(D="cancelled"),y(()=>{var I;(I=w.onReplaced)==null||I.call(w,{reason:D,replacedTransaction:p,transaction:R,transactionReceipt:u}),w.resolve(u)})}catch(A){y(()=>w.reject(A))}}else y(()=>w.reject(T))}}})}),v}function _t(t){return typeof t=="number"?t:t==="wei"?0:Math.abs(Pt[t])}async function Be(t,n){const{allowFailure:a=!0,chainId:c,contracts:r,...s}=n,i=t.getClient({chainId:c});return G(i,xe,"multicall")({allowFailure:a,contracts:r,...s})}async function Ae(t,n){var l;const{allowFailure:a=!0,blockNumber:c,blockTag:r,...s}=n,i=n.contracts;try{const e={};for(const[o,b]of i.entries()){const h=b.chainId??t.state.chainId;e[h]||(e[h]=[]),(l=e[h])==null||l.push({contract:b,index:o})}const m=()=>Object.entries(e).map(([o,b])=>Be(t,{...s,allowFailure:a,blockNumber:c,blockTag:r,chainId:Number.parseInt(o),contracts:b.map(({contract:h})=>h)})),p=(await Promise.all(m())).flat(),u=Object.values(e).flatMap(o=>o.map(({index:b})=>b));return p.reduce((o,b,h)=>(o&&(o[u[h]]=b),o),[])}catch(e){if(e instanceof jt)throw e;const m=()=>i.map(p=>st(t,{...p,blockNumber:c,blockTag:r}));return a?(await Promise.allSettled(m())).map(p=>p.status==="fulfilled"?{result:p.value,status:"success"}:{error:p.reason,result:void 0,status:"failure"}):await Promise.all(m())}}async function Ee(t,n){const{address:a,blockNumber:c,blockTag:r,chainId:s,token:i,unit:l="ether"}=n;if(i)try{return await ft(t,{balanceAddress:a,chainId:s,symbolType:"string",tokenAddress:i})}catch(o){if(o.name==="ContractFunctionExecutionError"){const b=await ft(t,{balanceAddress:a,chainId:s,symbolType:"bytes32",tokenAddress:i}),h=gt(Vt(b.symbol,{dir:"right"}));return{...b,symbol:h}}throw o}const e=t.getClient({chainId:s}),p=await G(e,Lt,"getBalance")(c?{address:a,blockNumber:c}:{address:a,blockTag:r}),u=t.chains.find(o=>o.id===s)??e.chain;return{decimals:u.nativeCurrency.decimals,formatted:wt(p,_t(l)),symbol:u.nativeCurrency.symbol,value:p}}async function ft(t,n){const{balanceAddress:a,chainId:c,symbolType:r,tokenAddress:s,unit:i}=n,l={abi:[{type:"function",name:"balanceOf",stateMutability:"view",inputs:[{type:"address"}],outputs:[{type:"uint256"}]},{type:"function",name:"decimals",stateMutability:"view",inputs:[],outputs:[{type:"uint8"}]},{type:"function",name:"symbol",stateMutability:"view",inputs:[],outputs:[{type:r}]}],address:s},[e,m,p]=await Ae(t,{allowFailure:!1,contracts:[{...l,functionName:"balanceOf",args:[a],chainId:c},{...l,functionName:"decimals",chainId:c},{...l,functionName:"symbol",chainId:c}]}),u=wt(e??"0",_t(i??m));return{decimals:m,formatted:u,symbol:p,value:e}}async function bt(t,n){const{chainId:a,timeout:c=0,...r}=n,s=t.getClient({chainId:a}),l=await G(s,Fe,"waitForTransactionReceipt")({...r,timeout:c});if(l.status==="reverted"){const m=await G(s,yt,"getTransaction")({hash:l.transactionHash}),u=await G(s,ye,"call")({...m,data:m.input,gasPrice:m.type!=="eip1559"?m.gasPrice:void 0,maxFeePerGas:m.type==="eip1559"?m.maxFeePerGas:void 0,maxPriorityFeePerGas:m.type==="eip1559"?m.maxPriorityFeePerGas:void 0}),o=u!=null&&u.data?gt(`0x${u.data.substring(138)}`):"unknown reason";throw new Error(o)}return{...l,chainId:s.chain.id}}async function De(t,n){const{account:a,chainId:c,connector:r,...s}=n;let i;return typeof a=="object"&&(a==null?void 0:a.type)==="local"?i=t.getClient({chainId:c}):i=await Gt(t,{account:a??void 0,chainId:c,connector:r}),await G(i,qt,"writeContract")({...s,...a?{account:a}:{},chain:c?{id:c}:null})}function Ue(t){return{mutationFn(n){return De(t,n)},mutationKey:["writeContract"]}}function Ct(t={}){const{mutation:n}=t,a=zt(t),c=Ue(a),{mutate:r,mutateAsync:s,...i}=Ht({...n,...c});return{...i,writeContract:r,writeContractAsync:s}}const Me=()=>{const{writeContractAsync:t}=Ct(),{$wagmiConfig:n}=Wt(),a=async({classId:l,wallet:e},m)=>{const p=await st(n,{abi:X,address:l,functionName:m});if(!await st(n,{abi:X,address:l,functionName:"hasRole",args:[p,e]})){const o=await t({abi:X,address:l,functionName:"ownerGrantRole",args:[p,e]});console.log(`Granted ${m} to ${e} in class ${l}. Transaction hash: ${o}`)}},c=async({classId:l,wallet:e})=>(await s({wallet:e}),a({classId:l,wallet:e},"UPDATER_ROLE")),r=async({classId:l,wallet:e})=>(await s({wallet:e}),a({classId:l,wallet:e},"MINTER_ROLE")),s=async({wallet:l})=>{const e=await Ee(n,{address:l});if(e.value<=0n)throw new Error("Insufficient OP-ETH balance");return e};return{checkAndGrantUpdater:c,checkAndGrantMinter:r,assertPositiveWalletBalance:s,waitForTransactionReceipt:async l=>{let e;try{e=await bt(n,l)}catch{await Kt(3e3),e=await bt(n,l)}return e}}},Se=()=>{const t=Jt();return{showErrorToast:a=>{t.add({icon:"i-heroicons-exclamation-circle",title:a,timeout:3e3,color:"red"})}}},$e={class:"flex flex-col items-stretch grow space-y-4"},Oe=["textContent"],Pe={class:"flex justify-center"},je=["src"],Ve={key:1,class:"w-full"},Le={class:"space-y-3"},Ge={class:"flex justify-between items-center"},qe={class:"text-xs text-gray-500"},ze={key:2,class:"flex justify-center"},Ze=Yt({__name:"LiteMintNFT",props:{iscnData:{type:Object,default:null},shouldShowSubmit:{type:Boolean,default:!0},iscnId:{type:String,default:""},isRestock:{type:Boolean,default:!1},restockCount:{type:Number,default:0}},emits:["submit","formValidChange"],setup(t,{expose:n,emit:a}){const c=Zt(),{t:r}=Xt(),{writeContractAsync:s}=Ct(),{getClassOwner:i,getClassMetadata:l,checkNFTClassIsBookNFT:e,getClassCurrentTokenId:m}=_e(),{checkAndGrantMinter:p,waitForTransactionReceipt:u}=Me(),o=Qt(),{wallet:b}=te(o),{validateWalletConsistency:h}=o,v=O(""),_=O(!1),k=O(null),g=O(""),w=O([]),B=O(null),y=O(c.params.classId||""),f=ee({mintCount:fe,imageUrl:"",externalUrl:""}),T=a,{showErrorToast:A}=Se(),R=q(()=>{const d={mintCount:f.mintCount!==void 0,imageUrl:!!f.imageUrl};return Object.entries(d).filter(([N,x])=>!x).map(([N])=>N.toUpperCase())}),D=q(()=>{var d;return!((d=R.value)!=null&&d.length)}),I=q(()=>{var d,N;return((N=(d=k.value)==null?void 0:d.contentMetadata)==null?void 0:N.name)||""}),$=q(()=>ae(f.imageUrl)),V=q(()=>I.value?F.isRestock?I.value:r("nft.mint_by_filling_info",{bookName:I.value}):r("nft.minting_loading"));K(D,d=>{T("formValidChange",d)},{immediate:!0}),K(_,d=>{d&&(v.value="")},{immediate:!0});const F=t;ne(async()=>{var d;F.iscnData?(k.value=F.iscnData,g.value=F.iscnData["@id"],f.imageUrl=((d=F.iscnData.contentMetadata)==null?void 0:d.thumbnailUrl)||"",y.value=F.iscnData["@id"]):F.iscnId&&await Nt(F.iscnId)}),K(_,d=>{d&&(v.value="")}),K(()=>F.isRestock,d=>{d&&(F.restockCount<0?f.mintCount=Math.abs(F.restockCount):f.mintCount=be)},{immediate:!0});function vt({nftMintCount:d,imgUrl:N}){const x=[];for(let E=0;E<d;E++)x.push({image:N,metadata:""});return x}async function ct(){try{_.value=!0;const{contentMetadata:d}=k.value;if(!D.value){const x=R.value.join(", ");A(r("errors.required_field_missing",{fields:x}));return}const N={metadata:{name:d.name,description:d.description,symbol:"BOOK",...d,image:f.imageUrl,external_url:f.externalUrl}};typeof f.mintCount!="number"&&(f.mintCount=Number(f.mintCount)),B.value=N,w.value=vt({nftMintCount:f.mintCount,imgUrl:f.imageUrl}),f.mintCount=w.value.length,f.mintCount>0&&await kt(),y.value&&T("submit",{classId:y.value,nftMintCount:f.mintCount})}catch(d){console.error(d),A(`${r("nft.mint_error")}: ${d.toString()}`)}finally{_.value=!1}}async function kt(){try{if(_.value=!0,b.value||await h(),!b.value)return;if(!B.value)throw new Error(r("errors.no_mint_data"));const d=B.value.metadata,N=[...Array(f.mintCount).keys()].map(M=>{var it;const{image:S,metadata:H,...Tt}=((it=w==null?void 0:w.value)==null?void 0:it[M])||{},It=JSON.parse(H||"{}"),W={...d,...It};return S&&(W.image=S),Object.entries(Tt).forEach(([lt,Q])=>{if(Q)try{W[lt]=JSON.parse(Q)}catch{W[lt]=Q}}),{id:-1,metadata:W}}),x=await m(y.value),{BOOK3_URL:E}=de().public;await p({classId:y.value,wallet:b.value});const L=await s({address:y.value,abi:X,functionName:"safeMintWithTokenId",args:[x,Array(f.mintCount).fill(b.value),Array(f.mintCount).fill(""),N.map((M,S)=>JSON.stringify({image:M.metadata.image,external_url:`${E}/store/${y.value}/${Number(x)+S}`,description:`Copy #${Number(x)+S} of ${M.metadata.name}`,name:`${M.metadata.name} #${Number(x)+S}`,attributes:M.metadata.attributes}))]}),U=await u({hash:L});if(console.log(U),!U||U.status!=="success")throw new Error("INVALID_RECEIPT");if(U.logs[0].topics[3]===void 0)throw new Error("INVALID_NFT_ID")}catch(d){throw new Error("MINT_NFT_ERROR:"+d.toString())}finally{_.value=!1}}async function Nt(d){var N,x;_.value=!0;try{if(g.value=d,!await e(d))throw new Error("Invalid NFT Class ID");const[L,U]=await Promise.all([l(d),i(d)]);if(!L)throw new Error("Invalid NFT Class ID");k.value={contentMetadata:L,owner:U,"@id":d},f.imageUrl=((N=k.value.contentMetadata)==null?void 0:N.thumbnailUrl)||"",f.externalUrl=((x=k.value.contentMetadata)==null?void 0:x.url)||"",y.value=d}catch(E){console.error(E)}finally{_.value=!1}}return n({startNFTMintFlow:ct}),(d,N)=>{const x=re,E=se,L=me,U=ie,M=ue,S=oe;return P(),J("div",$e,[C(v)?(P(),et(x,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${C(v)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:N[0]||(N[0]=H=>v.value="")},null,8,["title"])):Y("",!0),Z(S,{class:"flex-1",ui:{body:{base:"space-y-4"}}},{header:at(()=>[z("h3",{class:"font-bold text-center",textContent:nt(C(V))},null,8,Oe)]),default:at(()=>[z("div",Pe,[C($)?(P(),J("img",{key:1,src:C($),alt:"Cover preview",class:ce([t.isRestock?"max-w-[150px]":"max-w-[300px]","object-contain","rounded-lg","border","border-gray-200"])},null,10,je)):(P(),et(E,{key:0,animation:"carousel",color:"primary",class:"w-full"}))]),t.isRestock&&C(I)?(P(),et(L,{key:0,modelValue:C(f).mintCount,"onUpdate:modelValue":N[1]||(N[1]=H=>C(f).mintCount=H),type:"number",class:"w-full max-w-[180px] mx-auto",placeholder:C(r)("nft.mint_count_placeholder")},null,8,["modelValue","placeholder"])):Y("",!0),C(_)&&C(I)?(P(),J("div",Ve,[z("div",Le,[z("div",Ge,[Z(U,{variant:"soft"},{default:at(()=>[le(nt(t.isRestock?C(r)("nft.minting_restock"):C(r)("nft.minting")),1)]),_:1}),z("p",qe,nt(t.isRestock?C(r)("nft.minting_restock_in_progress",{count:C(f).mintCount}):C(r)("nft.minting_in_progress")),1)]),Z(E,{animation:"carousel",color:"primary",class:"w-full"})])])):Y("",!0),t.shouldShowSubmit?(P(),J("div",ze,[Z(M,{label:C(I)?C(r)("common.submit"):C(r)("loading.progress"),loading:C(_),size:"lg",disabled:C(_),onClick:ct},null,8,["label","loading","disabled"])])):Y("",!0)]),_:1})])}}});export{Ze as _,Se as a,Ct as b,Ee as g,Me as u};
