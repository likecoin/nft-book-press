import{dc as L,bz as M,b8 as S,b9 as m,bb as T,ba as E,cf as u,dd as P}from"./DzF9i0mN.js";(function(){try{var l=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},d=new l.Error().stack;d&&(l._sentryDebugIds=l._sentryDebugIds||{},l._sentryDebugIds[d]="ba74b677-3592-4954-97db-c30f6a30b2cd",l._sentryDebugIdIdentifier="sentry-dbid-ba74b677-3592-4954-97db-c30f6a30b2cd")}catch{}})();const _=L("orders",()=>{const l=M(),{token:d,isAuthenticated:I}=S(l),o=m({}),c=m([]),g=m(!1),f=m("");T(I,()=>{I.value?b():B()});const O=E(()=>{const r=new Map;return c.value.forEach(a=>{const s=a.classId;r.has(s)||r.set(s,[]),r.get(s).push(a)}),r}),i=E(()=>{const r=Object.keys(o.value);if(r.length===0||c.value.length===0)return[];const a=new Map;return c.value.forEach(s=>{const t=s.email;if(!t)return;const e=new Date(s.timestamp).toISOString(),h=s.price||0,k=!!(s.message&&s.message.trim()),p=s.wallet;if(a.has(t)){const n=a.get(t);if(!n)return;new Date(e)<new Date(n.firstPurchaseTime)&&(n.firstPurchaseTime=e),new Date(e)>new Date(n.lastPurchaseTime)&&(n.lastPurchaseTime=e),n.lifetimeValue+=h,k&&(n.hasMessage=!0),n.purchasedBooks[s.classId]=!0,p&&!n.readerWallet&&(n.readerWallet=p)}else{const n={};r.forEach(D=>{n[D]=!1}),n[s.classId]=!0,a.set(t,{readerEmail:t,readerWallet:p,firstPurchaseTime:e,lastPurchaseTime:e,lifetimeValue:h,hasMessage:k,purchasedBooks:n})}}),Array.from(a.values()).map(s=>{const t={};return r.forEach(e=>{t[`book_${e}`]=s.purchasedBooks[e]?1:0}),{...s,...t}})});async function y(r){const a=[];for(const s of r)try{const t=await P(s,d.value),e=(t==null?void 0:t.orders)||[];e.length>0&&a.push(...e.map(h=>({...h,classId:s})))}catch(t){console.error(`Failed to fetch orders for classId ${s}:`,t)}return c.value=a,a}async function v(r,a=!1){return!a&&c.value.length>0?c.value:await y(r)}async function w(r=!1){if(!(!r&&i.value.length>0))try{g.value=!0,f.value="",await l.fetchBookListing(),await l.fetchModeratedBookList();const a=[...l.listingList.map(e=>e.classId),...l.moderatedBookList.map(e=>e.classId)],s=[...new Set(a)];if(s.length===0){o.value={};return}const t={};l.listingList.forEach(e=>{s.includes(e.classId)&&(t[e.classId]={name:e.name||e.classId,classId:e.classId})}),l.moderatedBookList.forEach(e=>{s.includes(e.classId)&&(t[e.classId]={name:e.name||e.classId,classId:e.classId})}),o.value=t,await v(s,r)}catch(a){throw f.value=a.message||"Failed to load readers data",a}finally{g.value=!1}}async function b(){return i.value.length>0||await w(),i.value}function C(){f.value=""}function B(){c.value=[],o.value={}}return{readers:i,booksInfo:u(o),allOrders:u(c),ordersByClassIdMap:u(O),isLoading:u(g),error:u(f),fetchReaders:w,lazyFetchReaders:b,fetchOrdersByClassId:y,lazyFetchOrdersByClassId:v,clearError:C,clearCache:B}});export{_ as u};
