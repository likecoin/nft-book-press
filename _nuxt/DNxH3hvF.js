import{aQ as gt,aS as A,aT as m,aU as a,bW as wt,ba as E,a_ as It,a$ as kt,b7 as Nt,b6 as Ct,b8 as X,bx as Tt,bk as $t,b0 as Ft,b9 as u,bb as Y,b1 as St,b3 as B,aX as f,bA as qt,bi as $,aV as o,b4 as t,bj as Bt,bf as At,aY as Z,bB as Ut,aW as p,bd as Rt,bZ as J,bo as Et,bp as Mt,ca as Vt,br as Dt,bv as Lt,bn as Wt,b2 as Ot}from"./BNJsiGCO.js";import{_ as Pt}from"./BtYl4DPh.js";import{_ as jt}from"./s3WriuFn.js";import{_ as zt}from"./CVLFrEHa.js";import{_ as Gt}from"./Ch7v__HZ.js";import{a as Ht,u as tt,b as Kt}from"./Cp5MMBuI.js";import{b as et}from"./76TD-cBR.js";import{a as Qt,u as Xt}from"./CTjPX_T9.js";import"./F4jfc6Fi.js";(function(){try{var i=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},l=new i.Error().stack;l&&(i._sentryDebugIds=i._sentryDebugIds||{},i._sentryDebugIds[l]="afc4867b-d39e-4cf0-959a-9f77518f0b85",i._sentryDebugIdIdentifier="sentry-dbid-afc4867b-d39e-4cf0-959a-9f77518f0b85")}catch{}})();const Yt={},Zt={class:"relative overflow-hidden rounded border border-dashed border-gray-400 dark:border-gray-500 opacity-75 flex items-center justify-center p-4"};function Jt(i,l){return m(),A("div",Zt,[l[0]||(l[0]=a("svg",{class:"absolute inset-0 h-full w-full stroke-gray-900/10 dark:stroke-white/10",fill:"none"},[a("defs",null,[a("pattern",{id:"placeholder-pattern",x:"0",y:"0",width:"10",height:"10",patternUnits:"userSpaceOnUse"},[a("path",{d:"M-3 13 15-5M-5 5l18-18M-1 21 17 3"})])]),a("rect",{stroke:"none",fill:"url(#placeholder-pattern)",width:"100%",height:"100%"})],-1)),wt(i.$slots,"default")])}const te=gt(Yt,[["render",Jt]]);function ee(i){return i.charCodeAt(0)>255}function ae(i,l){const I=E(()=>{let v=0;for(let h=0;h<i.value.length;h++)v+=ee(i.value[h])?2:1;return v}),U=E(()=>I.value>l);return{messageCharCount:I,isLimitReached:U}}const ne={class:"text-lg font-bold font-mono"},se={class:"divide-y w-full"},oe={class:"text-left px-4 py-3"},le={class:"px-4 py-3"},re={key:0},ue={class:"text-left px-4 py-3"},ie={class:"px-4 py-3"},ce={class:"text-left px-4 py-3"},de={class:"px-4 py-3"},fe={class:"px-4 py-3"},_e={class:"text-left px-4 py-3"},pe={class:"px-4 py-3"},me={class:"px-4 py-3"},ve={class:"px-4 py-3"},ye={class:"px-4 py-3"},be={class:"space-y-2 mb-4"},he=["textContent"],xe=["textContent"],ge={class:"flex flex-wrap items-center justify-center gap-2 w-full"},we={class:"text-sm text-gray-400 dark:text-gray-600"},Ie=["src"],Ae=It({__name:"[classId]",setup(i){const{t:l}=kt(),{LIKE_CO_API:I}=Nt().public,U=Ct(),{wallet:v,signer:h}=X(U),{validateWalletConsistency:L}=U,W=Tt(),{token:O}=X(W),P=Ht(),{lazyFetchClassMetadataById:at}=P,M=$t(),nt=Ft(),{writeContractAsync:st}=Qt(),{getBalanceOf:ot,getTokenIdByOwnerIndex:lt}=tt(),{assertPositiveWalletBalance:rt,waitForTransactionReceipt:ut}=Xt(),x=u(""),g=u(!1),c=u(M.params.classId),j=u(M.query.payment_id),F=u(M.query.owner_wallet||v.value),S=u(l("nft_book_form.default_memo")),{messageCharCount:it,isLimitReached:z}=ae(S,et),{getNFTMetadata:ct,getNFTOwner:dt}=tt(),q=u([]),d=u([]),k=u(!1),N=u(!1),w=u(""),y=u(!1),G=u(void 0),n=u({}),C=u(""),H=E(()=>y.value||g.value||k.value||N.value||!!w.value||z.value),ft=E(()=>{var s;return(s=P.getClassMetadataById(c.value))==null?void 0:s.name});Y(g,s=>{s&&(x.value="")}),Y(y,async s=>{if(!s)if(q.value){const e=q.value.filter(r=>r.trim()!=="").map(r=>Number(r));if(n.value.quantity&&e.length>0&&e.length!==n.value.quantity){w.value=`Number of NFT IDs (${e.length}) does not match the required quantity (${n.value.quantity})`,d.value=[];return}d.value=e,await K()}else C.value="",d.value=[]}),St(async()=>{const s=await $fetch(`${I}/likernft/book/purchase/${c.value}/status/${j.value}`,{headers:{authorization:`Bearer ${O.value}`}});n.value=s,at(c.value),V(n.value.quantity||1)});function _t(){y.value=!y.value,w.value="",Wt(()=>{var s,e,r;y.value&&((r=(e=(s=G.value)==null?void 0:s[0].$refs)==null?void 0:e.input)==null||r.focus())})}async function K(){var s;try{if(k.value=!0,!d.value.length||d.value[0]===void 0){C.value="";return}try{const e=await ct(c.value,d.value[0]);C.value=qt(e==null?void 0:e.image)}catch(e){C.value="",((s=e==null?void 0:e.data)==null?void 0:s.code)===2?w.value="NFT not found":w.value=e.toString()}}catch(e){x.value=e.toString()}finally{k.value=!1}}async function V(s=1){try{if(d.value=[],w.value="",N.value=!0,(!v.value||!h.value)&&await L(),!F.value)return;const e=await ot(c.value,F.value);if(Number(e)<s)throw new Error(`Insufficient balance of NFT classId: ${c.value} for wallet: ${F.value}`);for(let r=0;r<s;r++){const T=await lt(c.value,F.value,r);d.value.push(Number(T))}q.value=d.value.map(r=>r.toString()),await K()}catch(e){x.value=e.toString()}finally{N.value=!1}}function pt(){V(n.value.quantity||1)}async function mt(){if(!H.value)try{if(g.value=!0,(!v.value||!h.value)&&await L(),!v.value||!h.value)return;if(d.value){const T=(await Promise.all(d.value.map(b=>dt(c.value,b)))).findIndex(b=>b!==F.value);if(T>=0){const b=d.value[T];throw new Error(`NFT classId: ${c.value} nftId:${b} is not owned by sender!`)}}else await V(n.value.quantity);await rt({wallet:v.value});const s=await st({address:c.value,abi:Kt,functionName:"batchTransferWithMemo",args:[v.value,Array(n.value.quantity).fill(n.value.wallet),d.value,Array(n.value.quantity).fill(S.value)]}),e=await ut({hash:s});(e==null?void 0:e.status)==="success"&&(await $fetch(`${I}/likernft/book/purchase/${c.value}/sent/${j.value}`,{method:"POST",body:{txHash:s,quantity:n.value.quantity||1},headers:{authorization:`Bearer ${O.value}`}}),await Ot(nt({name:"my-books-status-classId",params:{classId:c.value}})))}catch(s){console.error(s),x.value=s.toString()}finally{g.value=!1}}return(s,e)=>{const r=Bt,T=At,b=Ut,vt=Pt,Q=jt,yt=zt,D=Dt,bt=Lt,ht=te,xt=Gt;return m(),B(xt,null,{default:f(()=>[a("h1",ne,' Deliver NFT Book "'+o(t(ft)||t(c))+'" ',1),t(x)?(m(),B(r,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${t(x)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:e[0]||(e[0]=_=>x.value="")},null,8,["title"])):$("",!0),t(g)?(m(),B(T,{key:1,animation:"carousel"},{indicator:f(()=>e[2]||(e[2]=[Z(" Loading... ")])),_:1})):$("",!0),t(W).isAuthenticated?(m(),B(b,{key:2,ui:{body:{base:"space-y-4"},footer:{base:"flex justify-center gap-2"}}},{footer:f(()=>[p(D,{label:"Sign and Send",disabled:t(H),size:"xl",onClick:mt},null,8,["disabled"])]),default:f(()=>[p(b,{ui:{body:{padding:""}}},{default:f(()=>{var _,R;return[a("table",se,[a("tbody",null,[a("tr",null,[a("th",oe,o(t(l)("table.buyer_email")),1),a("td",le,o(t(n).email),1)]),(_=t(n).giftInfo)!=null&&_.toEmail?(m(),A("tr",re,[a("th",ue,o(t(l)("table.reader_email")),1),a("td",ie,o(((R=t(n).giftInfo)==null?void 0:R.toEmail)||t(n).email),1)])):$("",!0),a("tr",null,[a("th",ce,o(t(l)("table.status")),1),a("td",de,o(t(n).status),1)]),a("tr",null,[e[3]||(e[3]=a("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),a("td",fe,o(t(n).wallet),1)]),a("tr",null,[a("th",_e,o(t(l)("table.price_name")),1),a("td",pe,o(t(n).priceName),1)]),a("tr",null,[e[4]||(e[4]=a("th",{class:"text-left px-4 py-3"}," Price ",-1)),a("td",me,o(t(n).price),1)]),a("tr",null,[e[5]||(e[5]=a("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),a("td",ve,o(t(n).quantity),1)]),a("tr",null,[e[6]||(e[6]=a("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),a("td",ye,o(t(n).from),1)])])])]}),_:1}),p(b,null,{default:f(()=>[a("div",be,[a("h5",{class:"text-sm font-bold",textContent:o(`${t(l)("nft_book_form.buyer_message")}`)},null,8,he),a("p",{textContent:o(t(n).message)},null,8,xe)]),p(Q,{label:t(l)("nft_book_form.author_message"),error:t(z),hint:`${t(it)} / ${t(et)}`},{default:f(()=>[p(vt,{modelValue:t(S),"onUpdate:modelValue":e[1]||(e[1]=_=>Rt(S)?S.value=_:null)},null,8,["modelValue"])]),_:1},8,["label","error","hint"])]),_:1}),p(Q,{label:"Specify NFT ID",description:"Leave empty to auto-fetch NFT ID",error:t(w),ui:{description:"text-gray-400 dark:text-gray-600"}},{default:f(()=>[a("div",ge,[t(n).quantity?(m(),A("div",{key:0,class:J([t(n).quantity>1?"w-full":"flex-grow","space-y-1"])},[(m(!0),A(Et,null,Mt(t(n).quantity,_=>(m(),B(yt,{key:`nft-id-input-${_}`,ref_for:!0,ref_key:"nftIdInputRef",ref:G,modelValue:t(q)[_-1],"onUpdate:modelValue":R=>t(q)[_-1]=R,class:"font-mono",readonly:!t(y),disabled:!t(y)},Vt({_:2},[t(n).quantity>1?{name:"leading",fn:f(()=>[a("span",we,"#"+o(_),1)]),key:"0"}:void 0]),1032,["modelValue","onUpdate:modelValue","readonly","disabled"]))),128))],2)):$("",!0),p(D,{label:t(y)||t(k)&&!t(N)?"Confirm":"Edit",disabled:t(g)||t(k),variant:"outline",loading:t(k)&&!t(N),color:"gray",onClick:_t},null,8,["label","disabled","loading"]),p(bt,{class:J(["text-sm text-gray-600",{"sm:w-min":t(n).quantity<=1}])},{default:f(()=>e[7]||(e[7]=[Z(" OR ")])),_:1,__:[7]},8,["class"]),p(D,{label:`Auto-fetch NFT ID for ${t(n).quantity} NFTs`,disabled:t(g)||t(y),loading:t(N),variant:"outline",onClick:pt},null,8,["label","disabled","loading"])])]),_:1},8,["error"]),p(ht,{class:"h-[300px]"},{default:f(()=>[t(C)?(m(),A("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",alt:"preview",src:t(C)},null,8,Ie)):$("",!0)]),_:1})]),_:1})):$("",!0)]),_:1})}}});export{Ae as default};
