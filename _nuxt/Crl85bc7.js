import{dt as yt,du as pt,dv as it,dw as _t,dx as Ct,dy as vt,cy as Tt,dz as Nt,cB as O,dA as xt,dB as ut,dC as kt,dD as dt,dE as Ft,dF as It,cA as At,dG as Et,c_ as Rt,c$ as Ut,dH as Dt,d3 as Mt,bt as $t,a_ as Bt,bk as St,a$ as Ot,b6 as Pt,b8 as jt,b9 as M,cT as Lt,ba as V,bC as Vt,bb as K,bM as Gt,aS as J,aT as $,b3 as tt,bi as X,aW as Y,b4 as g,bj as zt,bD as Wt,aX as et,aU as G,bf as Ht,b$ as qt,bw as Kt,be as Jt,aY as Xt,aV as at,br as Yt,b7 as Zt}from"./C0DiHk_K.js";import{N as Qt,d as te}from"./DmHSYOHO.js";import{g as ee,r as ae,m as ne,c as oe,d as se,e as nt,f as re,b as Z,u as ie}from"./2t2KiD8m.js";(function(){try{var t=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},a=new t.Error().stack;a&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[a]="d5f975c0-ea79-496a-8fb8-cd8fc0a5faf5",t._sentryDebugIdIdentifier="sentry-dbid-d5f975c0-ea79-496a-8fb8-cd8fc0a5faf5")}catch{}})();async function ce(t,{address:a,blockNumber:n,blockTag:l=t.experimental_blockTag??"latest"}){const s=typeof n=="bigint"?yt(n):void 0,c=await t.request({method:"eth_getBalance",params:[a,s||l]});return BigInt(c)}async function le(t,a){var P;const{account:n,authorizationList:l,allowFailure:s=!0,blockNumber:c,blockOverrides:f,blockTag:i,stateOverride:o}=a,u=a.contracts,{batchSize:h=a.batchSize??1024,deployless:p=a.deployless??!1}=typeof((P=t.batch)==null?void 0:P.multicall)=="object"?t.batch.multicall:{},m=(()=>{if(a.multicallAddress)return a.multicallAddress;if(p)return null;if(t.chain)return ee({blockNumber:c,chain:t.chain,contract:"multicall3"});throw new Error("client chain not configured. multicallAddress is required.")})(),d=[[]];let b=0,I=0;for(let y=0;y<u.length;y++){const{abi:x,address:v,args:r,functionName:A}=u[y];try{const k=pt({abi:x,args:r,functionName:A});I+=(k.length-2)/2,h>0&&I>h&&d[b].length>0&&(b++,I=(k.length-2)/2,d[b]=[]),d[b]=[...d[b],{allowFailure:!0,callData:k,target:v}]}catch(k){const B=it(k,{abi:x,address:v,args:r,docsPath:"/docs/contract/multicall",functionName:A,sender:n});if(!s)throw B;d[b]=[...d[b],{allowFailure:!0,callData:"0x",target:v}]}}const T=await Promise.allSettled(d.map(y=>_t(t,ae,"readContract")({...m===null?{code:oe}:{address:m},abi:ne,account:n,args:[y],authorizationList:l,blockNumber:c,blockOverrides:f,blockTag:i,functionName:"aggregate3",stateOverride:o}))),N=[];for(let y=0;y<T.length;y++){const x=T[y];if(x.status==="rejected"){if(!s)throw x.reason;for(let r=0;r<d[y].length;r++)N.push({status:"failure",error:x.reason,result:void 0});continue}const v=x.value;for(let r=0;r<v.length;r++){const{returnData:A,success:k}=v[r],{callData:B}=d[y][r],{abi:j,address:E,functionName:L,args:z}=u[N.length];try{if(B==="0x")throw new Ct;if(!k)throw new vt({data:A});const _=se({abi:j,args:z,data:A,functionName:L});N.push(s?{result:_,status:"success"}:_)}catch(_){const W=it(_,{abi:j,address:E,args:z,docsPath:"/docs/contract/multicall",functionName:L});if(!s)throw W;N.push({error:W,result:void 0,status:"failure"})}}}if(N.length!==u.length)throw new Tt("multicall results mismatch");return N}function mt(t){return typeof t=="number"?t:t==="wei"?0:Math.abs(Nt[t])}async function ue(t,a){const{allowFailure:n=!0,chainId:l,contracts:s,...c}=a,f=t.getClient({chainId:l});return O(f,le,"multicall")({allowFailure:n,contracts:s,...c})}async function de(t,a){var i;const{allowFailure:n=!0,blockNumber:l,blockTag:s,...c}=a,f=a.contracts;try{const o={};for(const[m,d]of f.entries()){const b=d.chainId??t.state.chainId;o[b]||(o[b]=[]),(i=o[b])==null||i.push({contract:d,index:m})}const u=()=>Object.entries(o).map(([m,d])=>ue(t,{...c,allowFailure:n,blockNumber:l,blockTag:s,chainId:Number.parseInt(m),contracts:d.map(({contract:b})=>b)})),h=(await Promise.all(u())).flat(),p=Object.values(o).flatMap(m=>m.map(({index:d})=>d));return h.reduce((m,d,b)=>(m&&(m[p[b]]=d),m),[])}catch(o){if(o instanceof xt)throw o;const u=()=>f.map(h=>nt(t,{...h,blockNumber:l,blockTag:s}));return n?(await Promise.allSettled(u())).map(h=>h.status==="fulfilled"?{result:h.value,status:"success"}:{error:h.reason,result:void 0,status:"failure"}):await Promise.all(u())}}async function me(t,a){const{address:n,blockNumber:l,blockTag:s,chainId:c,token:f,unit:i="ether"}=a;if(f)try{return await ct(t,{balanceAddress:n,chainId:c,symbolType:"string",tokenAddress:f})}catch(m){if(m.name==="ContractFunctionExecutionError"){const d=await ct(t,{balanceAddress:n,chainId:c,symbolType:"bytes32",tokenAddress:f}),b=ut(kt(d.symbol,{dir:"right"}));return{...d,symbol:b}}throw m}const o=t.getClient({chainId:c}),h=await O(o,ce,"getBalance")(l?{address:n,blockNumber:l}:{address:n,blockTag:s}),p=t.chains.find(m=>m.id===c)??o.chain;return{decimals:p.nativeCurrency.decimals,formatted:dt(h,mt(i)),symbol:p.nativeCurrency.symbol,value:h}}async function ct(t,a){const{balanceAddress:n,chainId:l,symbolType:s,tokenAddress:c,unit:f}=a,i={abi:[{type:"function",name:"balanceOf",stateMutability:"view",inputs:[{type:"address"}],outputs:[{type:"uint256"}]},{type:"function",name:"decimals",stateMutability:"view",inputs:[],outputs:[{type:"uint8"}]},{type:"function",name:"symbol",stateMutability:"view",inputs:[],outputs:[{type:s}]}],address:c},[o,u,h]=await de(t,{allowFailure:!1,contracts:[{...i,functionName:"balanceOf",args:[n],chainId:l},{...i,functionName:"decimals",chainId:l},{...i,functionName:"symbol",chainId:l}]}),p=dt(o??"0",mt(f??u));return{decimals:u,formatted:p,symbol:h,value:o}}async function lt(t,a){const{chainId:n,timeout:l=0,...s}=a,c=t.getClient({chainId:n}),i=await O(c,Ft,"waitForTransactionReceipt")({...s,timeout:l});if(i.status==="reverted"){const u=await O(c,It,"getTransaction")({hash:i.transactionHash}),p=await O(c,re,"call")({...u,data:u.input,gasPrice:u.type!=="eip1559"?u.gasPrice:void 0,maxFeePerGas:u.type==="eip1559"?u.maxFeePerGas:void 0,maxPriorityFeePerGas:u.type==="eip1559"?u.maxPriorityFeePerGas:void 0}),m=p!=null&&p.data?ut(`0x${p.data.substring(138)}`):"unknown reason";throw new Error(m)}return{...i,chainId:c.chain.id}}async function fe(t,a){const{account:n,chainId:l,connector:s,...c}=a;let f;return typeof n=="object"&&(n==null?void 0:n.type)==="local"?f=t.getClient({chainId:l}):f=await At(t,{account:n??void 0,chainId:l,connector:s}),await O(f,Et,"writeContract")({...c,...n?{account:n}:{},chain:l?{id:l}:null})}function he(t){return{mutationFn(a){return fe(t,a)},mutationKey:["writeContract"]}}function ft(t={}){const{mutation:a}=t,n=Rt(t),l=he(n),{mutate:s,mutateAsync:c,...f}=Ut({...a,...l});return{...f,writeContract:s,writeContractAsync:c}}const ge=()=>{const{writeContractAsync:t}=ft(),{$wagmiConfig:a}=Dt(),n=async({classId:i,wallet:o},u)=>{const h=await nt(a,{abi:Z,address:i,functionName:u});if(!await nt(a,{abi:Z,address:i,functionName:"hasRole",args:[h,o]})){const m=await t({abi:Z,address:i,functionName:"ownerGrantRole",args:[h,o]});console.log(`Granted ${u} to ${o} in class ${i}. Transaction hash: ${m}`)}},l=async({classId:i,wallet:o})=>(await c({wallet:o}),n({classId:i,wallet:o},"UPDATER_ROLE")),s=async({classId:i,wallet:o})=>(await c({wallet:o}),n({classId:i,wallet:o},"MINTER_ROLE")),c=async({wallet:i})=>{const o=await me(a,{address:i});if(o.value<=0n)throw new Error("INSUFFICIENT_BASE_ETH_BALANCE");return o};return{checkAndGrantUpdater:l,checkAndGrantMinter:s,assertPositiveWalletBalance:c,waitForTransactionReceipt:async i=>{let o;try{o=await lt(a,i)}catch{await Mt(3e3),o=await lt(a,i)}return o}}},be=()=>{const t=$t();return{showErrorToast:n=>{t.add({icon:"i-heroicons-exclamation-circle",title:n,timeout:3e3,color:"red"})}}},we={class:"flex flex-col items-stretch grow space-y-4"},ye=["textContent"],pe={class:"flex justify-center"},_e=["src"],Ce={key:1,class:"w-full"},ve={class:"space-y-3"},Te={class:"flex justify-between items-center"},Ne={class:"text-xs text-gray-500"},xe={key:2,class:"flex justify-center"},Ee=Bt({__name:"LiteMintNFT",props:{iscnData:{type:Object,default:null},shouldShowSubmit:{type:Boolean,default:!0},iscnId:{type:String,default:""},isRestock:{type:Boolean,default:!1},restockCount:{type:Number,default:0}},emits:["submit","formValidChange"],setup(t,{expose:a,emit:n}){const l=St(),{t:s}=Ot(),{writeContractAsync:c}=ft(),{getClassOwner:f,getClassMetadata:i,checkNFTClassIsBookNFT:o,getClassCurrentTokenId:u}=ie(),{checkAndGrantMinter:h,waitForTransactionReceipt:p}=ge(),m=Pt(),{wallet:d}=jt(m),{validateWalletConsistency:b}=m,I=M(""),T=M(!1),N=M(null),P=M(""),y=M([]),x=M(null),v=M(l.params.classId||""),r=Lt({mintCount:Qt,imageUrl:"",externalUrl:""}),A=n,{showErrorToast:k}=be(),B=V(()=>{const e={mintCount:r.mintCount!==void 0,imageUrl:!!r.imageUrl};return Object.entries(e).filter(([w,C])=>!C).map(([w])=>w.toUpperCase())}),j=V(()=>{var e;return!((e=B.value)!=null&&e.length)}),E=V(()=>{var e,w;return((w=(e=N.value)==null?void 0:e.contentMetadata)==null?void 0:w.name)||""}),L=V(()=>Vt(r.imageUrl)),z=V(()=>E.value?_.isRestock?E.value:s("nft.mint_by_filling_info",{bookName:E.value}):s("nft.minting_loading"));K(j,e=>{A("formValidChange",e)},{immediate:!0}),K(T,e=>{e&&(I.value="")},{immediate:!0});const _=t;Gt(async()=>{var e;_.iscnData?(N.value=_.iscnData,P.value=_.iscnData["@id"],r.imageUrl=((e=_.iscnData.contentMetadata)==null?void 0:e.thumbnailUrl)||"",v.value=_.iscnData["@id"]):_.iscnId&&await gt(_.iscnId)}),K(T,e=>{e&&(I.value="")}),K(()=>_.isRestock,e=>{e&&(_.restockCount<0?r.mintCount=Math.abs(_.restockCount):r.mintCount=te)},{immediate:!0});function W({nftMintCount:e,imgUrl:w}){const C=[];for(let F=0;F<e;F++)C.push({image:w,metadata:""});return C}async function ot(){try{T.value=!0;const{contentMetadata:e}=N.value;if(!j.value){const C=B.value.join(", ");k(s("errors.required_field_missing",{fields:C}));return}const w={metadata:{name:e.name,description:e.description,symbol:"BOOK",...e,image:r.imageUrl,external_url:r.externalUrl}};typeof r.mintCount!="number"&&(r.mintCount=Number(r.mintCount)),x.value=w,y.value=W({nftMintCount:r.mintCount,imgUrl:r.imageUrl}),r.mintCount=y.value.length,r.mintCount>0&&await ht(),v.value&&A("submit",{classId:v.value,nftMintCount:r.mintCount})}catch(e){console.error(e),k(`${s("nft.mint_error")}: ${e.toString()}`)}finally{T.value=!1}}async function ht(){try{if(T.value=!0,d.value||await b(),!d.value)return;if(!x.value)throw new Error(s("errors.no_mint_data"));const e=x.value.metadata,w=[...Array(r.mintCount).keys()].map(U=>{var st;const{image:D,metadata:H,...bt}=((st=y==null?void 0:y.value)==null?void 0:st[U])||{},wt=JSON.parse(H||"{}"),q={...e,...wt};return D&&(q.image=D),Object.entries(bt).forEach(([rt,Q])=>{if(Q)try{q[rt]=JSON.parse(Q)}catch{q[rt]=Q}}),{id:-1,metadata:q}}),C=await u(v.value),{BOOK3_URL:F}=Zt().public;await h({classId:v.value,wallet:d.value});const S=await c({address:v.value,abi:Z,functionName:"safeMintWithTokenId",args:[C,Array(r.mintCount).fill(d.value),Array(r.mintCount).fill(""),w.map((U,D)=>JSON.stringify({image:U.metadata.image,external_url:`${F}/store/${v.value}/${Number(C)+D}`,description:`Copy #${Number(C)+D} of ${U.metadata.name}`,name:`${U.metadata.name} #${Number(C)+D}`,attributes:U.metadata.attributes}))]}),R=await p({hash:S});if(console.log(R),!R||R.status!=="success")throw new Error("INVALID_RECEIPT");if(R.logs[0].topics[3]===void 0)throw new Error("INVALID_NFT_ID")}catch(e){throw new Error("MINT_NFT_ERROR:"+e.toString())}finally{T.value=!1}}async function gt(e){var w,C;T.value=!0;try{if(P.value=e,!await o(e))throw new Error("Invalid NFT Class ID");const[S,R]=await Promise.all([i(e),f(e)]);if(!S)throw new Error("Invalid NFT Class ID");N.value={contentMetadata:S,owner:R,"@id":e},r.imageUrl=((w=N.value.contentMetadata)==null?void 0:w.thumbnailUrl)||"",r.externalUrl=((C=N.value.contentMetadata)==null?void 0:C.url)||"",v.value=e}catch(F){console.error(F)}finally{T.value=!1}}return a({startNFTMintFlow:ot}),(e,w)=>{const C=zt,F=Ht,S=Kt,R=Jt,U=Yt,D=Wt;return $(),J("div",we,[g(I)?($(),tt(C,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${g(I)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:w[0]||(w[0]=H=>I.value="")},null,8,["title"])):X("",!0),Y(D,{class:"flex-1",ui:{body:{base:"space-y-4"}}},{header:et(()=>[G("h3",{class:"font-bold text-center",textContent:at(g(z))},null,8,ye)]),default:et(()=>[G("div",pe,[g(L)?($(),J("img",{key:1,src:g(L),alt:"Cover preview",class:qt([t.isRestock?"max-w-[150px]":"max-w-[300px]","object-contain","rounded-lg","border","border-gray-200"])},null,10,_e)):($(),tt(F,{key:0,animation:"carousel",color:"primary",class:"w-full"}))]),t.isRestock&&g(E)?($(),tt(S,{key:0,modelValue:g(r).mintCount,"onUpdate:modelValue":w[1]||(w[1]=H=>g(r).mintCount=H),type:"number",class:"w-full max-w-[180px] mx-auto",placeholder:g(s)("nft.mint_count_placeholder")},null,8,["modelValue","placeholder"])):X("",!0),g(T)&&g(E)?($(),J("div",Ce,[G("div",ve,[G("div",Te,[Y(R,{variant:"soft"},{default:et(()=>[Xt(at(t.isRestock?g(s)("nft.minting_restock"):g(s)("nft.minting")),1)]),_:1}),G("p",Ne,at(t.isRestock?g(s)("nft.minting_restock_in_progress",{count:g(r).mintCount}):g(s)("nft.minting_in_progress")),1)]),Y(F,{animation:"carousel",color:"primary",class:"w-full"})])])):X("",!0),t.shouldShowSubmit?($(),J("div",xe,[Y(U,{label:g(E)?g(s)("common.submit"):g(s)("loading.progress"),loading:g(T),size:"lg",disabled:g(T),onClick:ot},null,8,["label","loading","disabled"])])):X("",!0)]),_:1})])}}});export{Ee as _,be as a,ft as b,me as g,ge as u};
