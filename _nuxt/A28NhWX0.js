import{a_ as xt,b3 as gt,bj as ht,bl as H,bi as It,bk as wt,a$ as Nt,b5 as o,b6 as K,b7 as Q,b0 as Tt,b1 as C,aX as c,bo as kt,cS as X,aT as v,aU as a,bp as $,aV as i,bd as e,bq as Ft,bM as St,aY as Y,br as Ct,aW as p,bc as $t,aS as U,bG as J,bg as qt,bh as Bt,bF as Et,be as At,bb as Rt,b9 as Ut,cT as Vt}from"./Dm55n_q7.js";import{_ as Dt}from"./9FAC0F-8.js";import{_ as Mt}from"./BNRh5wRg.js";import{_ as Lt}from"./BeJGAGuW.js";import{u as Pt,_ as Wt}from"./n67cbV5_.js";import{_ as Ot}from"./BrbWWaox.js";import{u as zt}from"./BZ3sWSG7.js";import{u as Z,L as jt}from"./FexUiCd7.js";import{u as Gt,a as Ht,w as Kt}from"./BLL8ThKJ.js";import"./DGf9HjKN.js";(function(){try{var x=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},T=new x.Error().stack;T&&(x._sentryDebugIds=x._sentryDebugIds||{},x._sentryDebugIds[T]="f0eaea90-13a8-47d6-a4ff-998b6b2a938a",x._sentryDebugIdIdentifier="sentry-dbid-f0eaea90-13a8-47d6-a4ff-998b6b2a938a")}catch{}})();const Qt={class:"text-lg font-bold font-mono"},Xt={class:"divide-y w-full"},Yt={class:"px-4 py-3"},Jt={class:"px-4 py-3"},Zt={class:"px-4 py-3"},te={class:"px-4 py-3"},ee={class:"px-4 py-3"},ae={class:"px-4 py-3"},ne={class:"px-4 py-3"},se={class:"px-4 py-3"},le={class:"px-4 py-3"},oe={class:"flex flex-wrap items-center justify-center gap-2 w-full"},re={class:"text-sm text-gray-400 dark:text-gray-600"},ue=["src"],xe=xt({__name:"[classId]",setup(x){const{LIKE_CO_API:T}=gt().public,q=ht(),{wallet:g,signer:B}=H(q),{initIfNecessary:V}=q,D=It(),{token:M}=H(D),L=zt(),{lazyFetchClassMetadataById:tt}=L,E=wt(),et=Nt(),{writeContractAsync:at}=Gt(),{getBalanceOf:nt,getTokenIdByOwnerIndex:st}=Z(),{assertPositiveWalletBalance:lt}=Ht(),y=o(""),_=o(!1),r=o(E.params.classId),P=o(E.query.payment_id),k=o(E.query.owner_wallet||g.value),F=o(""),{messageCharCount:ot,isLimitReached:W}=Pt(F,X),{getNFTMetadata:rt,getNFTOwner:ut}=Z(),S=o([]),u=o([]),h=o(!1),I=o(!1),b=o(""),f=o(!1),O=o(void 0),n=o({}),w=o(""),z=K(()=>f.value||_.value||h.value||I.value||!!b.value||W.value),it=K(()=>{var s;return(s=L.getClassMetadataById(r.value))==null?void 0:s.name});Q(_,s=>{s&&(y.value="")}),Q(f,async s=>{if(!s)if(S.value){const t=S.value.filter(l=>l.trim()!=="").map(l=>Number(l));if(n.value.quantity&&t.length>0&&t.length!==n.value.quantity){b.value=`Number of NFT IDs (${t.length}) does not match the required quantity (${n.value.quantity})`,u.value=[];return}u.value=t,await j()}else w.value="",u.value=[]}),Tt(async()=>{const s=await $fetch(`${T}/likernft/book/purchase/${r.value}/status/${P.value}`,{headers:{authorization:`Bearer ${M.value}`}});n.value=s,tt(r.value),A(n.value.quantity||1)});function dt(){f.value=!f.value,b.value="",Ut(()=>{var s,t,l;f.value&&((l=(t=(s=O.value)==null?void 0:s[0].$refs)==null?void 0:t.input)==null||l.focus())})}async function j(){var s;try{if(h.value=!0,!u.value.length||u.value[0]===void 0){w.value="";return}try{const t=await rt(r.value,u.value[0]);w.value=kt(t==null?void 0:t.image)}catch(t){w.value="",((s=t==null?void 0:t.data)==null?void 0:s.code)===2?b.value="NFT not found":b.value=t.toString()}}catch(t){y.value=t.toString()}finally{h.value=!1}}async function A(s=1){try{if(u.value=[],b.value="",I.value=!0,(!g.value||!B.value)&&await V(),!k.value)return;const t=await nt(r.value,k.value);if(Number(t)<s)throw new Error(`Insufficient balance of NFT classId: ${r.value} for wallet: ${k.value}`);for(let l=0;l<s;l++){const N=await st(r.value,k.value,l);u.value.push(Number(N))}S.value=u.value.map(l=>l.toString()),await j()}catch(t){y.value=t.toString()}finally{I.value=!1}}function ct(){A(n.value.quantity||1)}async function ft(){if(!z.value)try{if(_.value=!0,(!g.value||!B.value)&&await V(),!g.value||!B.value)return;if(u.value){const N=(await Promise.all(u.value.map(m=>ut(r.value,m)))).findIndex(m=>m!==k.value);if(N>=0){const m=u.value[N];throw new Error(`NFT classId: ${r.value} nftId:${m} is not owned by sender!`)}}else await A(n.value.quantity);await lt({wallet:g.value});const s=await at({address:r.value,abi:jt,functionName:"batchTransferWithMemo",args:[g.value,Array(n.value.quantity).fill(n.value.wallet),u.value,Array(n.value.quantity).fill(F.value)]}),t=await Kt(Vt,{hash:s});(t==null?void 0:t.status)==="success"&&(await $fetch(`${T}/likernft/book/purchase/${r.value}/sent/${P.value}`,{method:"POST",body:{txHash:s,quantity:n.value.quantity||1},headers:{authorization:`Bearer ${M.value}`}}),et.push({name:"nft-book-store-status-classId",params:{classId:r.value}}))}catch(s){console.error(s),y.value=s.toString()}finally{_.value=!1}}return(s,t)=>{const l=Ft,N=St,m=Ct,pt=Dt,G=Mt,mt=Lt,R=At,vt=Rt,yt=Wt,_t=Ot;return v(),C(_t,null,{default:c(()=>[a("h1",Qt,' Deliver NFT Book "'+i(e(it)||e(r))+'" ',1),e(y)?(v(),C(l,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${e(y)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:t[0]||(t[0]=d=>y.value="")},null,8,["title"])):$("",!0),e(_)?(v(),C(N,{key:1,animation:"carousel"},{indicator:c(()=>t[2]||(t[2]=[Y(" Loading... ")])),_:1})):$("",!0),e(D).isAuthenticated?(v(),C(m,{key:2,ui:{body:{base:"space-y-4"},footer:{base:"flex justify-center gap-2"}}},{footer:c(()=>[p(R,{label:"Sign and Send",disabled:e(z),size:"xl",onClick:ft},null,8,["disabled"])]),default:c(()=>[p(m,{ui:{body:{padding:""}}},{default:c(()=>{var d;return[a("table",Xt,[a("tbody",null,[a("tr",null,[t[3]||(t[3]=a("th",{class:"text-left px-4 py-3"}," Buyer Email ",-1)),a("td",Yt,i(e(n).email),1)]),a("tr",null,[t[4]||(t[4]=a("th",{class:"text-left px-4 py-3"}," Reader Email ",-1)),a("td",Jt,i(((d=e(n).giftInfo)==null?void 0:d.toEmail)||e(n).email),1)]),a("tr",null,[t[5]||(t[5]=a("th",{class:"text-left px-4 py-3"}," Status ",-1)),a("td",Zt,i(e(n).status),1)]),a("tr",null,[t[6]||(t[6]=a("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),a("td",te,i(e(n).wallet),1)]),a("tr",null,[t[7]||(t[7]=a("th",{class:"text-left px-4 py-3"}," Price Name ",-1)),a("td",ee,i(e(n).priceName),1)]),a("tr",null,[t[8]||(t[8]=a("th",{class:"text-left px-4 py-3"}," Price ",-1)),a("td",ae,i(e(n).price),1)]),a("tr",null,[t[9]||(t[9]=a("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),a("td",ne,i(e(n).quantity),1)]),a("tr",null,[t[10]||(t[10]=a("th",{class:"text-left px-4 py-3"}," Buyer message ",-1)),a("td",se,i(e(n).message),1)]),a("tr",null,[t[11]||(t[11]=a("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),a("td",le,i(e(n).from),1)])])])]}),_:1}),p(G,{label:"Enter Author's Message",error:e(W),hint:`${e(ot)} / ${e(X)}`},{default:c(()=>[p(pt,{modelValue:e(F),"onUpdate:modelValue":t[1]||(t[1]=d=>$t(F)?F.value=d:null),placeholder:"default memo"},null,8,["modelValue"])]),_:1},8,["error","hint"]),p(G,{label:"Specify NFT ID",description:"Leave empty to auto-fetch NFT ID",error:e(b),ui:{description:"text-gray-400 dark:text-gray-600"}},{default:c(()=>[a("div",oe,[e(n).quantity?(v(),U("div",{key:0,class:J([e(n).quantity>1?"w-full":"flex-grow","space-y-1"])},[(v(!0),U(qt,null,Bt(e(n).quantity,d=>(v(),C(mt,{key:`nft-id-input-${d}`,ref_for:!0,ref_key:"nftIdInputRef",ref:O,modelValue:e(S)[d-1],"onUpdate:modelValue":bt=>e(S)[d-1]=bt,class:"font-mono",readonly:!e(f),disabled:!e(f)},Et({_:2},[e(n).quantity>1?{name:"leading",fn:c(()=>[a("span",re,"#"+i(d),1)]),key:"0"}:void 0]),1032,["modelValue","onUpdate:modelValue","readonly","disabled"]))),128))],2)):$("",!0),p(R,{label:e(f)||e(h)&&!e(I)?"Confirm":"Edit",disabled:e(_)||e(h),variant:"outline",loading:e(h)&&!e(I),color:"gray",onClick:dt},null,8,["label","disabled","loading"]),p(vt,{class:J(["text-sm text-gray-600",{"sm:w-min":e(n).quantity<=1}])},{default:c(()=>t[12]||(t[12]=[Y(" OR ")])),_:1,__:[12]},8,["class"]),p(R,{label:`Auto-fetch NFT ID for ${e(n).quantity} NFTs`,disabled:e(_)||e(f),loading:e(I),variant:"outline",onClick:ct},null,8,["label","disabled","loading"])])]),_:1},8,["error"]),p(yt,{class:"h-[300px]"},{default:c(()=>[e(w)?(v(),U("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",src:e(w)},null,8,ue)):$("",!0)]),_:1})]),_:1})):$("",!0)]),_:1})}}});export{xe as default};
