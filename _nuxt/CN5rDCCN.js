import{dv as wt,dw as yt,dx as rt,dy as pt,dz as _t,dA as Ct,cA as vt,dB as Tt,cD as O,dC as Nt,dD as lt,dE as xt,dF as ut,dG as kt,dH as It,cC as Ft,dI as At,c$ as Et,d0 as Rt,dJ as Dt,d3 as Ut,bt as Mt,a_ as $t,a$ as St,b6 as Bt,b8 as Ot,b9 as U,cV as Pt,ba as G,bC as jt,bb as K,bM as Lt,aS as J,aT as M,b3 as tt,bi as X,aW as Y,b4 as b,bj as Vt,bD as Gt,aX as et,aU as z,bf as zt,b$ as Wt,bw as Ht,be as qt,aY as Kt,aV as at,br as Jt,b7 as Xt}from"./B-7B4l0H.js";import{N as Yt,d as Zt}from"./BjmbJqu7.js";import{g as Qt,r as te,m as ee,c as ae,d as ne,e as nt,f as oe,b as Z,u as se}from"./DgPxeVB5.js";(function(){try{var t=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},n=new t.Error().stack;n&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[n]="1868837c-bdf3-4541-b26a-a7c54d4875e7",t._sentryDebugIdIdentifier="sentry-dbid-1868837c-bdf3-4541-b26a-a7c54d4875e7")}catch{}})();async function re(t,{address:n,blockNumber:o,blockTag:e=t.experimental_blockTag??"latest"}){const m=typeof o=="bigint"?wt(o):void 0,c=await t.request({method:"eth_getBalance",params:[n,m||e]});return BigInt(c)}async function ie(t,n){var P;const{account:o,authorizationList:e,allowFailure:m=!0,blockNumber:c,blockOverrides:h,blockTag:i,stateOverride:s}=n,u=n.contracts,{batchSize:g=n.batchSize??1024,deployless:y=n.deployless??!1}=typeof((P=t.batch)==null?void 0:P.multicall)=="object"?t.batch.multicall:{},d=(()=>{if(n.multicallAddress)return n.multicallAddress;if(y)return null;if(t.chain)return Qt({blockNumber:c,chain:t.chain,contract:"multicall3"});throw new Error("client chain not configured. multicallAddress is required.")})(),f=[[]];let l=0,I=0;for(let p=0;p<u.length;p++){const{abi:N,address:C,args:r,functionName:F}=u[p];try{const x=yt({abi:N,args:r,functionName:F});I+=(x.length-2)/2,g>0&&I>g&&f[l].length>0&&(l++,I=(x.length-2)/2,f[l]=[]),f[l]=[...f[l],{allowFailure:!0,callData:x,target:C}]}catch(x){const $=rt(x,{abi:N,address:C,args:r,docsPath:"/docs/contract/multicall",functionName:F,sender:o});if(!m)throw $;f[l]=[...f[l],{allowFailure:!0,callData:"0x",target:C}]}}const v=await Promise.allSettled(f.map(p=>pt(t,te,"readContract")({...d===null?{code:ae}:{address:d},abi:ee,account:o,args:[p],authorizationList:e,blockNumber:c,blockOverrides:h,blockTag:i,functionName:"aggregate3",stateOverride:s}))),T=[];for(let p=0;p<v.length;p++){const N=v[p];if(N.status==="rejected"){if(!m)throw N.reason;for(let r=0;r<f[p].length;r++)T.push({status:"failure",error:N.reason,result:void 0});continue}const C=N.value;for(let r=0;r<C.length;r++){const{returnData:F,success:x}=C[r],{callData:$}=f[p][r],{abi:j,address:A,functionName:L,args:W}=u[T.length];try{if($==="0x")throw new _t;if(!x)throw new Ct({data:F});const S=ne({abi:j,args:W,data:F,functionName:L});T.push(m?{result:S,status:"success"}:S)}catch(S){const V=rt(S,{abi:j,address:A,args:W,docsPath:"/docs/contract/multicall",functionName:L});if(!m)throw V;T.push({error:V,result:void 0,status:"failure"})}}}if(T.length!==u.length)throw new vt("multicall results mismatch");return T}function dt(t){return typeof t=="number"?t:t==="wei"?0:Math.abs(Tt[t])}async function ce(t,n){const{allowFailure:o=!0,chainId:e,contracts:m,...c}=n,h=t.getClient({chainId:e});return O(h,ie,"multicall")({allowFailure:o,contracts:m,...c})}async function le(t,n){var i;const{allowFailure:o=!0,blockNumber:e,blockTag:m,...c}=n,h=n.contracts;try{const s={};for(const[d,f]of h.entries()){const l=f.chainId??t.state.chainId;s[l]||(s[l]=[]),(i=s[l])==null||i.push({contract:f,index:d})}const u=()=>Object.entries(s).map(([d,f])=>ce(t,{...c,allowFailure:o,blockNumber:e,blockTag:m,chainId:Number.parseInt(d),contracts:f.map(({contract:l})=>l)})),g=(await Promise.all(u())).flat(),y=Object.values(s).flatMap(d=>d.map(({index:f})=>f));return g.reduce((d,f,l)=>(d&&(d[y[l]]=f),d),[])}catch(s){if(s instanceof Nt)throw s;const u=()=>h.map(g=>nt(t,{...g,blockNumber:e,blockTag:m}));return o?(await Promise.allSettled(u())).map(g=>g.status==="fulfilled"?{result:g.value,status:"success"}:{error:g.reason,result:void 0,status:"failure"}):await Promise.all(u())}}async function ue(t,n){const{address:o,blockNumber:e,blockTag:m,chainId:c,token:h,unit:i="ether"}=n;if(h)try{return await it(t,{balanceAddress:o,chainId:c,symbolType:"string",tokenAddress:h})}catch(d){if(d.name==="ContractFunctionExecutionError"){const f=await it(t,{balanceAddress:o,chainId:c,symbolType:"bytes32",tokenAddress:h}),l=lt(xt(f.symbol,{dir:"right"}));return{...f,symbol:l}}throw d}const s=t.getClient({chainId:c}),g=await O(s,re,"getBalance")(e?{address:o,blockNumber:e}:{address:o,blockTag:m}),y=t.chains.find(d=>d.id===c)??s.chain;return{decimals:y.nativeCurrency.decimals,formatted:ut(g,dt(i)),symbol:y.nativeCurrency.symbol,value:g}}async function it(t,n){const{balanceAddress:o,chainId:e,symbolType:m,tokenAddress:c,unit:h}=n,i={abi:[{type:"function",name:"balanceOf",stateMutability:"view",inputs:[{type:"address"}],outputs:[{type:"uint256"}]},{type:"function",name:"decimals",stateMutability:"view",inputs:[],outputs:[{type:"uint8"}]},{type:"function",name:"symbol",stateMutability:"view",inputs:[],outputs:[{type:m}]}],address:c},[s,u,g]=await le(t,{allowFailure:!1,contracts:[{...i,functionName:"balanceOf",args:[o],chainId:e},{...i,functionName:"decimals",chainId:e},{...i,functionName:"symbol",chainId:e}]}),y=ut(s??"0",dt(h??u));return{decimals:u,formatted:y,symbol:g,value:s}}async function ct(t,n){const{chainId:o,timeout:e=0,...m}=n,c=t.getClient({chainId:o}),i=await O(c,kt,"waitForTransactionReceipt")({...m,timeout:e});if(i.status==="reverted"){const u=await O(c,It,"getTransaction")({hash:i.transactionHash}),y=await O(c,oe,"call")({...u,data:u.input,gasPrice:u.type!=="eip1559"?u.gasPrice:void 0,maxFeePerGas:u.type==="eip1559"?u.maxFeePerGas:void 0,maxPriorityFeePerGas:u.type==="eip1559"?u.maxPriorityFeePerGas:void 0}),d=y!=null&&y.data?lt(`0x${y.data.substring(138)}`):"unknown reason";throw new Error(d)}return{...i,chainId:c.chain.id}}async function de(t,n){const{account:o,chainId:e,connector:m,...c}=n;let h;return typeof o=="object"&&(o==null?void 0:o.type)==="local"?h=t.getClient({chainId:e}):h=await Ft(t,{account:o??void 0,chainId:e,connector:m}),await O(h,At,"writeContract")({...c,...o?{account:o}:{},chain:e?{id:e}:null})}function me(t){return{mutationFn(n){return de(t,n)},mutationKey:["writeContract"]}}function mt(t={}){const{mutation:n}=t,o=Et(t),e=me(o),{mutate:m,mutateAsync:c,...h}=Rt({...n,...e});return{...h,writeContract:m,writeContractAsync:c}}const fe=()=>{const{writeContractAsync:t}=mt(),{$wagmiConfig:n}=Dt(),o=async({classId:i,wallet:s},u)=>{const g=await nt(n,{abi:Z,address:i,functionName:u});if(!await nt(n,{abi:Z,address:i,functionName:"hasRole",args:[g,s]})){const d=await t({abi:Z,address:i,functionName:"ownerGrantRole",args:[g,s]});console.log(`Granted ${u} to ${s} in class ${i}. Transaction hash: ${d}`)}},e=async({classId:i,wallet:s})=>(await c({wallet:s}),o({classId:i,wallet:s},"UPDATER_ROLE")),m=async({classId:i,wallet:s})=>(await c({wallet:s}),o({classId:i,wallet:s},"MINTER_ROLE")),c=async({wallet:i})=>{const s=await ue(n,{address:i});if(s.value<=0n)throw new Error("INSUFFICIENT_BASE_ETH_BALANCE");return s};return{checkAndGrantUpdater:e,checkAndGrantMinter:m,assertPositiveWalletBalance:c,waitForTransactionReceipt:async i=>{let s;try{s=await ct(n,i)}catch{await Ut(3e3),s=await ct(n,i)}return s}}},he=()=>{const t=Mt();return{showErrorToast:o=>{t.add({icon:"i-heroicons-exclamation-circle",title:o,timeout:3e3,color:"red"})}}},ge={class:"flex flex-col items-stretch grow space-y-4"},be=["textContent"],we={class:"flex justify-center"},ye=["src"],pe={key:1,class:"w-full"},_e={class:"space-y-3"},Ce={class:"flex justify-between items-center"},ve={class:"text-xs text-gray-500"},Te={key:2,class:"flex justify-center"},Fe=$t({__name:"LiteMintNFT",props:{iscnData:{type:Object,default:null},shouldShowSubmit:{type:Boolean,default:!0},iscnId:{type:String,default:""},isRestock:{type:Boolean,default:!1},restockCount:{type:Number,default:0}},emits:["submit","formValidChange"],setup(t,{expose:n,emit:o}){const{t:e}=St(),{writeContractAsync:m}=mt(),{getClassOwner:c,getClassMetadata:h,checkNFTClassIsBookNFT:i,getClassCurrentTokenId:s}=se(),{checkAndGrantMinter:u,waitForTransactionReceipt:g}=fe(),y=Bt(),{wallet:d}=Ot(y),{validateWalletConsistency:f}=y,l=t,I=U(""),v=U(!1),T=U(null),P=U(""),p=U([]),N=U(null),C=U(l.iscnId||""),r=Pt({mintCount:Yt,imageUrl:"",externalUrl:""}),F=o,{showErrorToast:x}=he(),$=G(()=>{const a={mintCount:r.mintCount!==void 0,imageUrl:!!r.imageUrl};return Object.entries(a).filter(([w,_])=>!_).map(([w])=>w.toUpperCase())}),j=G(()=>{var a;return!((a=$.value)!=null&&a.length)}),A=G(()=>{var a,w;return((w=(a=T.value)==null?void 0:a.contentMetadata)==null?void 0:w.name)||""}),L=G(()=>jt(r.imageUrl)),W=G(()=>A.value?l.isRestock?A.value:e("nft.mint_by_filling_info",{bookName:A.value}):e("nft.minting_loading"));K(j,a=>{F("formValidChange",a)},{immediate:!0}),K(v,a=>{a&&(I.value="")},{immediate:!0}),Lt(async()=>{var a;l.iscnData?(T.value=l.iscnData,P.value=l.iscnData["@id"],r.imageUrl=((a=l.iscnData.contentMetadata)==null?void 0:a.thumbnailUrl)||"",C.value=l.iscnData["@id"]):l.iscnId&&await ht(l.iscnId)}),K(v,a=>{a&&(I.value="")}),K(()=>l.isRestock,a=>{a&&(l.restockCount<0?r.mintCount=Math.abs(l.restockCount):r.mintCount=Zt)},{immediate:!0});function S({nftMintCount:a,imgUrl:w}){const _=[];for(let k=0;k<a;k++)_.push({image:w,metadata:""});return _}async function V(){try{const{contentMetadata:a}=T.value;if(!j.value){const _=$.value.join(", ");x(e("errors.required_field_missing",{fields:_}));return}v.value=!0;const w={metadata:{name:a.name,description:a.description,symbol:"BOOK",...a,image:r.imageUrl,external_url:r.externalUrl}};typeof r.mintCount!="number"&&(r.mintCount=Number(r.mintCount)),N.value=w,p.value=S({nftMintCount:r.mintCount,imgUrl:r.imageUrl}),r.mintCount=p.value.length,r.mintCount>0&&await ft(),C.value&&F("submit",{classId:C.value,nftMintCount:r.mintCount})}catch(a){console.error(a),x(`${e("nft.mint_error")}: ${a.toString()}`)}finally{v.value=!1}}async function ft(){try{if(v.value=!0,d.value||await f(),!d.value)return;if(!N.value)throw new Error(e("errors.no_mint_data"));const a=N.value.metadata,w=[...Array(r.mintCount).keys()].map(R=>{var ot;const{image:D,metadata:H,...gt}=((ot=p==null?void 0:p.value)==null?void 0:ot[R])||{},bt=JSON.parse(H||"{}"),q={...a,...bt};return D&&(q.image=D),Object.entries(gt).forEach(([st,Q])=>{if(Q)try{q[st]=JSON.parse(Q)}catch{q[st]=Q}}),{id:-1,metadata:q}}),_=await s(C.value),{BOOK3_URL:k}=Xt().public;await u({classId:C.value,wallet:d.value});const B=await m({address:C.value,abi:Z,functionName:"safeMintWithTokenId",args:[_,Array(r.mintCount).fill(d.value),Array(r.mintCount).fill(""),w.map((R,D)=>JSON.stringify({image:R.metadata.image,external_url:`${k}/store/${C.value}/${Number(_)+D}`,description:`Copy #${Number(_)+D} of ${R.metadata.name}`,name:`${R.metadata.name} #${Number(_)+D}`,attributes:R.metadata.attributes}))]}),E=await g({hash:B});if(console.log(E),!E||E.status!=="success")throw new Error("INVALID_RECEIPT");if(E.logs[0].topics[3]===void 0)throw new Error("INVALID_NFT_ID")}catch(a){throw new Error("MINT_NFT_ERROR:"+a.toString())}finally{v.value=!1}}async function ht(a){var w,_;v.value=!0;try{if(P.value=a,!await i(a))throw new Error("Invalid NFT Class ID");const[B,E]=await Promise.all([h(a),c(a)]);if(!B)throw new Error("Invalid NFT Class ID");T.value={contentMetadata:B,owner:E,"@id":a},r.imageUrl=((w=T.value.contentMetadata)==null?void 0:w.thumbnailUrl)||"",r.externalUrl=((_=T.value.contentMetadata)==null?void 0:_.url)||"",C.value=a}catch(k){console.error(k)}finally{v.value=!1}}return n({startNFTMintFlow:V}),(a,w)=>{const _=Vt,k=zt,B=Ht,E=qt,R=Jt,D=Gt;return M(),J("div",ge,[b(I)?(M(),tt(_,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${b(I)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:w[0]||(w[0]=H=>I.value="")},null,8,["title"])):X("",!0),Y(D,{class:"flex-1",ui:{body:{base:"space-y-4"}}},{header:et(()=>[z("h3",{class:"font-bold text-center",textContent:at(b(W))},null,8,be)]),default:et(()=>[z("div",we,[b(L)?(M(),J("img",{key:1,src:b(L),alt:"Cover preview",class:Wt([t.isRestock?"max-w-[150px]":"max-w-[300px]","object-contain","rounded-lg","border","border-gray-200"])},null,10,ye)):(M(),tt(k,{key:0,animation:"carousel",color:"primary",class:"w-full"}))]),t.isRestock&&b(A)?(M(),tt(B,{key:0,modelValue:b(r).mintCount,"onUpdate:modelValue":w[1]||(w[1]=H=>b(r).mintCount=H),type:"number",class:"w-full max-w-[180px] mx-auto",placeholder:b(e)("nft.mint_count_placeholder")},null,8,["modelValue","placeholder"])):X("",!0),b(v)&&b(A)?(M(),J("div",pe,[z("div",_e,[z("div",Ce,[Y(E,{variant:"soft"},{default:et(()=>[Kt(at(t.isRestock?b(e)("nft.minting_restock"):b(e)("nft.minting")),1)]),_:1}),z("p",ve,at(t.isRestock?b(e)("nft.minting_restock_in_progress",{count:b(r).mintCount}):b(e)("nft.minting_in_progress")),1)]),Y(k,{animation:"carousel",color:"primary",class:"w-full"})])])):X("",!0),t.shouldShowSubmit?(M(),J("div",Te,[Y(R,{label:b(A)?b(e)("common.submit"):b(e)("loading.progress"),loading:b(v),size:"lg",disabled:b(v),onClick:V},null,8,["label","loading","disabled"])])):X("",!0)]),_:1})])}}});export{Fe as _,he as a,mt as b,ue as g,fe as u};
