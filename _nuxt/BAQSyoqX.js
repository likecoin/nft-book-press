import{aQ as Se,aS as N,aT as c,aU as t,bV as Be,ba as x,a_ as Re,a$ as Ue,b7 as J,b6 as Me,b8 as Z,bz as Ve,bk as qe,b0 as Ee,b9 as f,bb as ee,b1 as Ae,b3 as I,aX as m,bF as Le,bi as v,aW as h,aV as l,b4 as e,bj as Oe,bg as Pe,aY as te,bA as We,bw as De,bd as ae,bp as je,bo as ze,bY as ne,bq as Qe,bx as Ge,be as He,bv as Ke,c9 as Ye,b2 as Xe}from"./CdYtZq0D.js";import{_ as Je}from"./DpP4PhUR.js";import{b as Ze,u as et,_ as tt}from"./DLbs_xwC.js";import{_ as at}from"./BoePP6o3.js";import{a as nt,u as se,b as st}from"./BAP3jfZe.js";import{b as oe}from"./BETsY8fF.js";(function(){try{var _=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},s=new _.Error().stack;s&&(_._sentryDebugIds=_._sentryDebugIds||{},_._sentryDebugIds[s]="c394ae0e-494f-4a58-a463-f00630f8a4ee",_._sentryDebugIdIdentifier="sentry-dbid-c394ae0e-494f-4a58-a463-f00630f8a4ee")}catch{}})();const ot={},lt={class:"relative overflow-hidden rounded border border-dashed border-gray-400 dark:border-gray-500 opacity-75 flex items-center justify-center p-4"};function rt(_,s){return c(),N("div",lt,[s[0]||(s[0]=t("svg",{class:"absolute inset-0 h-full w-full stroke-gray-900/10 dark:stroke-white/10",fill:"none"},[t("defs",null,[t("pattern",{id:"placeholder-pattern",x:"0",y:"0",width:"10",height:"10",patternUnits:"userSpaceOnUse"},[t("path",{d:"M-3 13 15-5M-5 5l18-18M-1 21 17 3"})])]),t("rect",{stroke:"none",fill:"url(#placeholder-pattern)",width:"100%",height:"100%"})],-1)),Be(_.$slots,"default")])}const it=Object.assign(Se(ot,[["render",rt]]),{__name:"PlaceholderCard"});function ut(_){return _.charCodeAt(0)>255}function ct(_,s){const $=x(()=>{const p=_.value||"";let T=0;for(let F=0;F<p.length;F++){const U=p[F];U&&(T+=ut(U)?2:1)}return T}),L=x(()=>$.value>s);return{messageCharCount:$,isLimitReached:L}}const dt={class:"text-lg font-bold font-mono"},ft={class:"divide-y w-full"},_t={class:"text-left px-4 py-3"},mt={class:"px-4 py-3"},pt={key:0},vt={class:"text-left px-4 py-3"},bt={class:"px-4 py-3"},yt={class:"text-left px-4 py-3"},ht={class:"px-4 py-3"},xt={class:"px-4 py-3"},gt={class:"text-left px-4 py-3"},wt={class:"px-4 py-3"},kt={class:"px-4 py-3"},It={class:"px-4 py-3"},Ct={class:"px-4 py-3"},Nt={class:"space-y-2 mb-4"},$t=["textContent"],Tt=["textContent"],Ft={class:"flex flex-wrap items-center justify-center gap-2 w-full"},St={class:"text-sm text-gray-400 dark:text-gray-600"},Bt=["textContent"],Rt=["textContent"],Ut=["src"],Ot=Re({__name:"[classId]",setup(_){const{t:s}=Ue(),{LIKE_CO_API:$}=J().public,L=Me(),{wallet:p,signer:T}=Z(L),{validateWalletConsistency:F}=L,U=Ve(),{token:D}=Z(U),j=nt(),{lazyFetchClassMetadataById:le}=j,O=qe(),re=Ee(),{writeContractAsync:ie}=Ze(),{getBalanceOf:ue,getTokenIdByOwnerIndex:ce}=se(),{assertPositiveWalletBalance:de,waitForTransactionReceipt:fe}=et(),g=f({message:"",actions:[]}),C=f(!1),r=x(()=>O.params.classId),z=x(()=>O.query.payment_id),M=x(()=>O.query.owner_wallet||p.value),V=f(s("nft_book_form.default_memo")),{messageCharCount:_e,isLimitReached:Q}=ct(V,oe),{getNFTMetadata:me,getNFTOwner:G}=se(),S=f([]),u=f([]),q=f(!1),w=f(""),B=f(!1),pe=f(void 0),o=f({}),E=f(""),A=f(!1),k=f(""),{NFT_ITEM_URL:ve}=J().public,H=x(()=>S.value.some(a=>a.trim()!=="")),K=x(()=>C.value||q.value||!!w.value||Q.value||!B.value),R=x(()=>o.value.quantity===1),be=x(()=>j.getClassMetadataById(r.value)?.name);ee(C,a=>{a&&(g.value={message:"",actions:[]})}),ee(S,(a,n)=>{n&&n.length>0&&R.value&&(B.value=!1,k.value="",w.value="")},{deep:!0}),Ae(async()=>{const a=await $fetch(`${$}/likernft/book/purchase/${r.value}/status/${z.value}`,{headers:{authorization:`Bearer ${D.value}`}});o.value=a,le(r.value),await P(o.value.quantity||1)});async function ye(){if(H.value)try{if(k.value="",w.value="",u.value=S.value.filter(i=>i.trim()!=="").map(i=>Number(i)),u.value.includes(0)){k.value=s("error.nft_id_reserved_for_author"),u.value=[];return}const a=u.value[0];if(!a){k.value=s("error.invalid_nft_id");return}const[n,d]=await Promise.all([Y(),G(r.value,a)]);if(!n||d!==p.value){k.value=s("error.fetch_nft_metadata_failed"),u.value=[];return}B.value=!0}catch(a){k.value=a.message,u.value=[],B.value=!1}}async function Y(){try{if(q.value=!0,!u.value.length||u.value[0]===void 0){E.value="";return}try{const a=await me(r.value,u.value[0]);return E.value=Le(a?.image),a}catch(a){E.value="",a?.data?.code===2?w.value="NFT not found":w.value=a.toString()}}catch(a){g.value={message:a.toString(),actions:[]}}finally{q.value=!1}}async function P(a=1){try{if(u.value=[],w.value="",(!p.value||!T.value)&&await F(),!M.value)throw new Error("Missing owner wallet");const n=await ue(r.value,M.value);if(n<BigInt(a))throw new Error(`No NFTs available for classId: ${r.value} in wallet: ${M.value}`);const d=[];for(let b=0;b<Number(n);b++){const i=await ce(r.value,M.value,b);if(i!==0n&&(d.push(Number(i)),d.length>=a))break}if(d.length<a)throw new Error(`Failed to collect enough available NFTs. Collected ${d.length}/${a}`);u.value=d,S.value=d.map(String),B.value=!0,await Y()}catch(n){const d=n.toString();w.value=d,g.value={message:d,actions:[{label:s("button.restock_nft"),variant:"outline",color:"red",click:()=>{A.value=!0}}]}}}function he(){window.open(`${ve}/${r.value}`,"_blank","noopener")}async function xe(){if(!K.value)try{if(C.value=!0,(!p.value||!T.value)&&await F(),!p.value||!T.value)return;if(u.value){const b=(await Promise.all(u.value.map(i=>G(r.value,i)))).findIndex(i=>i!==M.value);if(b>=0){const i=u.value[b];throw new Error(`NFT classId: ${r.value} nftId:${i} is not owned by sender!`)}}else await P(o.value.quantity);await de({wallet:p.value});const a=await ie({address:r.value,abi:st,functionName:"batchTransferWithMemo",args:[p.value,Array(o.value.quantity).fill(o.value.wallet),u.value,Array(o.value.quantity).fill(V.value)]});(await fe({hash:a}))?.status==="success"&&(await $fetch(`${$}/likernft/book/purchase/${r.value}/sent/${z.value}`,{method:"POST",body:{txHash:a,quantity:o.value.quantity||1},headers:{authorization:`Bearer ${D.value}`}}),await Xe(re({name:"my-books-status-classId",params:{classId:r.value}})))}catch(a){console.error(a),g.value={message:a.toString(),actions:[]}}finally{C.value=!1}}function ge(){A.value=!1,P(o.value.quantity||1)}return(a,n)=>{const d=Oe,b=Pe,i=We,we=Je,X=De,ke=Ke,W=Qe,Ie=Ge,Ce=it,Ne=tt,$e=He,Te=at;return c(),I(Te,null,{default:m(()=>[t("h1",dt,' Deliver NFT Book "'+l(e(be)||e(r))+'" ',1),e(g).message?(c(),I(d,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${e(g).message}`,actions:e(g).actions,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:n[0]||(n[0]=y=>g.value={message:"",actions:[]})},null,8,["title","actions"])):v("",!0),e(C)?(c(),I(b,{key:1,animation:"carousel"},{indicator:m(()=>[...n[3]||(n[3]=[te(" Loading... ",-1)])]),_:1})):v("",!0),e(U).isAuthenticated?(c(),I(i,{key:2,ui:{body:{base:"space-y-6"},footer:{base:"flex justify-center gap-2"}}},{footer:m(()=>[h(W,{label:e(s)("nft_send.sign_and_send"),disabled:e(K),size:"xl",onClick:xe},null,8,["label","disabled"])]),default:m(()=>[h(i,{ui:{body:{padding:""}}},{default:m(()=>[t("table",ft,[t("tbody",null,[t("tr",null,[t("th",_t,l(e(s)("table.buyer_email")),1),t("td",mt,l(e(o).email),1)]),e(o).giftInfo?.toEmail?(c(),N("tr",pt,[t("th",vt,l(e(s)("table.reader_email")),1),t("td",bt,l(e(o).giftInfo?.toEmail||e(o).email),1)])):v("",!0),t("tr",null,[t("th",yt,l(e(s)("table.status")),1),t("td",ht,l(e(o).status),1)]),t("tr",null,[n[4]||(n[4]=t("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),t("td",xt,l(e(o).wallet),1)]),t("tr",null,[t("th",gt,l(e(s)("table.price_name")),1),t("td",wt,l(e(o).priceName),1)]),t("tr",null,[n[5]||(n[5]=t("th",{class:"text-left px-4 py-3"}," Price ",-1)),t("td",kt,l(e(o).price),1)]),t("tr",null,[n[6]||(n[6]=t("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),t("td",It,l(e(o).quantity),1)]),t("tr",null,[n[7]||(n[7]=t("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),t("td",Ct,l(e(o).from),1)])])])]),_:1}),h(i,null,{default:m(()=>[t("div",Nt,[t("h5",{class:"text-sm font-bold",textContent:l(`${e(s)("nft_book_form.buyer_message")}`)},null,8,$t),t("p",{textContent:l(e(o).message)},null,8,Tt)]),h(X,{label:e(s)("nft_book_form.author_message"),error:e(Q),hint:`${e(_e)} / ${e(oe)}`},{default:m(()=>[h(we,{modelValue:e(V),"onUpdate:modelValue":n[1]||(n[1]=y=>ae(V)?V.value=y:null)},null,8,["modelValue"])]),_:1},8,["label","error","hint"])]),_:1}),h(X,{label:e(s)("form.nft_id_label"),class:"mb-4",error:e(w),ui:{description:"text-gray-400 dark:text-gray-600"}},{default:m(()=>[t("div",Ft,[e(o).quantity?(c(),N("div",{key:0,class:ne([e(o).quantity>1?"w-full":"flex-grow","space-y-1","relative"])},[(c(!0),N(je,null,ze(e(o).quantity,y=>(c(),I(ke,{key:`nft-id-input-${y}`,ref_for:!0,ref_key:"nftIdInputRef",ref:pe,modelValue:e(S)[y-1],"onUpdate:modelValue":Fe=>e(S)[y-1]=Fe,disabled:!e(R),class:"font-mono"},Ye({_:2},[e(o).quantity>1?{name:"leading",fn:m(()=>[t("span",St,"#"+l(y),1)]),key:"0"}:void 0]),1032,["modelValue","onUpdate:modelValue","disabled"]))),128)),e(k)?(c(),N("span",{key:0,class:"text-xs text-red-500 absolute",textContent:l(e(k))},null,8,Bt)):e(B)&&e(R)?(c(),N("span",{key:1,class:"text-xs text-green-500 absolute",textContent:l(e(s)("button.confirmed"))},null,8,Rt)):v("",!0)],2)):v("",!0),e(R)?(c(),I(W,{key:1,label:e(s)("button.confirm_nft_id"),disabled:e(C)||e(q)||!e(H),variant:"outline",loading:e(q),color:"primary",onClick:ye},null,8,["label","disabled","loading"])):v("",!0),e(R)?(c(),I(Ie,{key:2,class:ne(["text-sm text-gray-600","sm:w-min"])},{default:m(()=>[...n[8]||(n[8]=[te(" OR ",-1)])]),_:1})):v("",!0),e(R)?(c(),I(W,{key:3,label:e(s)("button.check_all_nft_ids"),disabled:e(C),variant:"outline",onClick:he},null,8,["label","disabled"])):v("",!0)])]),_:1},8,["label","error"]),h(Ce,{class:"h-[300px]"},{default:m(()=>[e(E)?(c(),N("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",alt:"preview",src:e(E)},null,8,Ut)):v("",!0)]),_:1})]),_:1})):v("",!0),h($e,{modelValue:e(A),"onUpdate:modelValue":n[2]||(n[2]=y=>ae(A)?A.value=y:null)},{default:m(()=>[h(Ne,{"is-restock":!0,"iscn-id":e(r),onSubmit:ge},null,8,["iscn-id"])]),_:1},8,["modelValue"])]),_:1})}}});export{Ot as default};
