import{a_ as H,b6 as Z,b7 as J,b8 as ee,b9 as i,ba as U,bb as q,b1 as te,bc as de,aS as D,aT as g,aW as y,b4 as r,bd as pe,be as _e,aX as z,aU as w,bf as me,aY as fe,aV as W,bg as be,aQ as ve,a$ as ae,bh as oe,b3 as G,bi as Y,bj as ge,bk as we,b0 as ye,bl as he,b2 as j,bm as Se,bn as X,bo as Ie,bp as Ne,bq as Fe,br as Te,bs as xe}from"./DumGTjYM.js";import{u as ke,a as Q,_ as Ce,f as Re,v as Me,b as De}from"./aO7JgZpG.js";import{L as Ue,u as Be}from"./DNWyslUn.js";import{u as Ee,a as se,b as Le,_ as $e}from"./D9TWD27c.js";import{D as Ae}from"./CktR75xe.js";import{_ as Ve}from"./BMhfIFUL.js";import{_ as Oe}from"./W3ygKMn8.js";import"./DPKmFKMY.js";import"./CxGu1Oix.js";import"./BxZXZrCg.js";import"./AuUVz0Lv.js";import"./BSGCmasE.js";import"./BG98oYV1.js";import"./CXGkooF0.js";import"./BgVieAPN.js";import"./aSwfBVgJ.js";import"./CojZis71.js";import"./BMjTwTvZ.js";import"./CtdeBz3_.js";(function(){try{var f=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},l=new f.Error().stack;l&&(f._sentryDebugIds=f._sentryDebugIds||{},f._sentryDebugIds[l]="a0a349bc-fc8e-4692-9f36-cba65b500d59",f._sentryDebugIdIdentifier="sentry-dbid-a0a349bc-fc8e-4692-9f36-cba65b500d59")}catch{}})();const Pe={class:"space-y-3"},Ke={class:"flex justify-between items-center"},je={class:"text-xs text-gray-500"},qe=H({__name:"RegisterISCN",emits:["handleSubmit","submit","formValidChange"],setup(f,{expose:l,emit:x}){const k=Z(),{getFileType:B}=Q(),{LIKE_EVM_NFT_TARGET_ADDRESS:E}=J().public,{wallet:u,signer:b}=ee(k),{validateWalletConsistency:L}=k,{assertPositiveWalletBalance:a,waitForTransactionReceipt:I}=Ee(),{stripHtmlTags:C,formatLanguage:R}=Q(),{showErrorToast:$}=se(),{LIKE_NFT_CONTRACT_ADDRESS:N}=J().public,d=i({type:"Book",title:"",description:"",isbn:"",publisher:"",publicationDate:"",author:{name:"",description:""},license:"All Rights Reserved",customLicense:"",contentFingerprints:[{url:""}],downloadableUrls:[{url:"",type:"",fileName:""}],language:"",bookInfoUrl:"",tags:[],coverUrl:""}),c=i(""),A=i(""),M=x,{payload:s,computeISCNSalt:p}=ke({iscnFormData:d}),{writeContractAsync:F}=Le(),_=U(()=>Me(d.value)),v=U(()=>!_.value?.length);q(v,t=>{M("formValidChange",t)},{immediate:!0}),te(()=>{const t=P();t&&(d.value=t)});const P=()=>{const t=de();if(!t)return null;const m={type:"Book",title:t.epubMetadata?.title||"",description:C(t.epubMetadata?.description||""),isbn:"",publisher:"",publicationDate:new Date().toISOString().split("T")[0],author:{name:t.epubMetadata?.author||"",description:""},license:"All Rights Reserved",contentFingerprints:[],downloadableUrls:[],coverUrl:t.epubMetadata?.thumbnailArweaveId?`ar://${t.epubMetadata.thumbnailArweaveId}`:"",language:R(t.epubMetadata?.language||"zh"),tags:t.epubMetadata?.tags||[]};return m.downloadableUrls=t.fileRecords.filter(o=>o.fileType==="application/pdf"||o.fileType==="application/epub+zip").map(o=>({url:o.arweaveKey?o.arweaveLink:`ar://${o.arweaveId}`,type:B(o.fileType),fileName:o.fileName})),m.contentFingerprints=[...new Set(t.fileRecords.map(o=>{const T=o.arweaveKey?o.arweaveLink:`ar://${o.arweaveId}`;return o.fileType==="application/epub+zip"||o.fileType==="application/pdf"?T:`ar://${o.arweaveId}`}).filter(Boolean))].map(o=>({url:o})),m},V=async()=>{if(c.value="checking",!v.value){$(_.value.join(", "));return}d.value.contentFingerprints.length&&await K()},K=async()=>{if(c.value="loading",await L(),!u.value||!b.value){A.value="MISSING_SIGNER",c.value="";return}try{c.value="signing";const t=Re(s.value),m={name:t.name,description:t.description,...t,symbol:"BOOK",image:t?.thumbnailUrl||"",external_link:t?.url||"",nft_meta_collection_id:"nft_book",nft_meta_collection_name:"NFT Book",nft_meta_collection_description:"NFT Book by Liker Land",recordTimestamp:new Date().toISOString()};await a({wallet:u.value});const o=p(u.value),T=await F({address:N,abi:Ue,functionName:"newBookNFT",args:[o,{creator:u.value,updaters:[u.value,E],minters:[u.value,E],config:{name:m.name,symbol:"BOOK",metadata:JSON.stringify(m),max_supply:Ae}},500]}),n=await I({hash:T});if(console.log(n),!n||n.status!=="success")throw new Error("INVALID_RECEIPT");if(!n.logs?.[0]?.address)throw new Error("INVALID_CLASS_ID");const e=n.logs[0].address;c.value="success",M("submit",{iscnId:e,txHash:T})}catch(t){console.error(t),$(`'SIGNING_ERROR':${t}`),c.value=""}finally{c.value=""}};return l({onSubmit:V}),(t,m)=>{const o=Ce,T=me,n=be,e=_e;return g(),D("div",null,[y(o,{modelValue:r(d),"onUpdate:modelValue":m[0]||(m[0]=h=>pe(d)?d.value=h:null)},null,8,["modelValue"]),y(e,{"model-value":!!r(c),"prevent-close":!0,ui:{base:"p-4 gap-2"}},{default:z(()=>[w("div",Pe,[w("div",Ke,[y(T,{variant:"soft"},{default:z(()=>[fe(W(r(c)),1)]),_:1}),w("p",je,W(t.$t("notifications.iscn_registration_complete")),1)]),y(n,{animation:"carousel",color:"primary",class:"w-full"})])]),_:1},8,["model-value"])])}}}),ze=Object.assign(ve(qe,[["__scopeId","data-v-79e141ee"]]),{__name:"RegisterISCN"}),We={class:"flex flex-col items-stretch grow space-y-4"},Ge=3,Ye=H({__name:"MintNFT",props:{iscnId:{type:String,default:""}},emits:["submit","loadingChange"],setup(f,{expose:l,emit:x}){const{getClassOwner:k,getClassMetadata:B,checkNFTClassIsBookNFT:E}=Be(),u=i(""),b=i(!1),L=i(""),a=i(null),I=i(""),C=i(null),R=x,$=U(()=>[{label:N("button.retry"),variant:"solid",color:"red",click:()=>window.location.reload()}]);q(b,s=>{R("loadingChange",s),s&&(u.value="")},{immediate:!0});const{t:N}=ae();oe({title:()=>N("seo.mint_nft_book_title"),ogTitle:()=>N("seo.mint_nft_book_title")});const d=f;q(()=>d.iscnId,async s=>{s&&await c(d.iscnId)},{immediate:!0});async function c(s,p=0){if(s)try{if(b.value=!0,!await E(s))throw new Error("Invalid NFT Class ID");const[_,v]=await Promise.all([B(s),k(s)]);if(!_)throw new Error("Failed to fetch ISCN metadata");a.value={contentMetadata:_,owner:v,"@id":s},L.value=v,I.value=s,u.value="",b.value=!1}catch(F){if(p<Ge){const _=p+1,v=_*1e3;setTimeout(()=>{c(s,_)},v)}else u.value=N("error.fetch_classid_failed")+F,b.value=!1}}function A(){C.value?.startNFTMintFlow()}function M({classId:s,nftMintCount:p}={}){I.value=s||"",R("submit",{classId:s||"",nftMintCount:p})}return l({startNFTMintFlow:A}),(s,p)=>{const F=ge,_=$e;return g(),D("div",We,[r(u)?(g(),G(F,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${r(u)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},actions:r($),onClose:p[0]||(p[0]=v=>u.value="")},null,8,["title","actions"])):Y("",!0),y(_,{ref_key:"liteMintNFTRef",ref:C,"iscn-data":r(a),"iscn-id":f.iscnId,"should-show-submit":!1,onSubmit:M},null,8,["iscn-data","iscn-id"])])}}}),He=Object.assign(Ye,{__name:"MintNFT"}),Je={class:"w-full"},Xe={class:"justify-evenly items-center flex space-x-4 relative"},Qe={class:"text-sm font-semibold"},Ze={class:"mt-6 p-4 border rounded-lg bg-gray-100 text-center flex flex-col gap-[24px]"},et={key:0},tt={key:1},at={key:2},ot={key:3},st={class:"flex gap-2 justify-center mt-4"},Nt=H({__name:"new-book",setup(f){const{t:l}=ae(),x=Z(),{wallet:k,signer:B}=ee(x),{validateWalletConsistency:E}=x,u=we(),b=ye(),{showErrorToast:L}=se(),a=i(0),I=i(),C=i(),R=i(),$=i(""),N=i(""),d=i(u.query.iscn_id?.toString()||""),c=i(u.query.class_id?.toString()||""),A=i([]),M=i(""),s=i(!1),p=i(!1);oe({title:()=>l("seo_titles.publish_nft_book"),ogTitle:()=>l("seo_titles.publish_nft_book")});const F=U(()=>{switch(a.value){case 0:return l("publish_button.upload_files");case 1:return l("publish_button.metadata");case 2:return l("publish_button.mint_nft");default:return l("publish_button.publish_now")}}),_=U(()=>A.value?.length>0),v=U(()=>a.value===0?_.value:a.value<3),P=U(()=>a.value===0?M.value!=="":a.value===2?p.value:!1),V=[{title:l("publish_steps.upload_files"),description:"Upload your book file"},{title:l("publish_steps.register_iscn"),description:"Register ISCN"},{title:l("publish_steps.mint_nft"),description:"Mint NFT"},{title:l("publish_steps.new_book_publish"),description:"Publish new book"}];te(()=>{let n=null;try{const e=sessionStorage.getItem(he);e&&(n=JSON.parse(e))}catch(e){console.error(e)}d.value?($.value=d.value,m({iscnId:d.value})):c.value?o({classId:c.value}):n?.epubMetadata&&n?.fileRecords&&(N.value=n?.epubMetadata?.title)});const K=async()=>{if((!k.value||!B.value)&&await E(),!k.value||!B.value){L(l("auth.login_required"));return}try{if(a.value===0&&I.value){await I.value.onSubmit();return}if(a.value===1){if(!s.value){L("Please fill in all required fields");return}await C.value.onSubmit();return}if(a.value===2){await R.value.startNFTMintFlow();return}a.value<V.length-1&&a.value++}catch(n){console.error("Error during form submission:",n)}},t=n=>{const{fileRecords:e,epubMetadata:h}=n;h?.coverData&&(h.coverData=void 0),xe({fileRecords:e,epubMetadata:h}),a.value=1},m=async n=>{const{iscnId:e}=n;e&&await j(b({query:{iscn_id:e}}),{replace:!0}),Se(),a.value=2,await X(),d.value=e},o=async n=>{const{classId:e,nftMintCount:h}=n;e&&(c.value=e,await j(b({query:{class_id:e,count:h}}),{replace:!0}),a.value=3,await X())},T=async()=>{await j(b({name:"my-books"}))};return(n,e)=>{const h=Te,ne=De,ie=ze,le=He,re=Ve,ce=Fe,ue=Oe;return g(),G(ue,{class:"flex flex-col items-stretch grow space-y-4"},{default:z(()=>[w("div",Je,[w("div",Xe,[e[4]||(e[4]=w("div",{class:"absolute w-full h-[1px] bg-gray-300 top-[50%] left-0 z-[-1]"},null,-1)),(g(),D(Ne,null,Ie(V,(S,O)=>w("div",{key:O,class:"flex items-center space-x-2 bg-white p-2 rounded-lg"},[y(h,{size:O===r(a)?"lg":"md",text:(O+1).toString(),ui:{background:O===r(a)?"bg-primary-100":"bg-gray-200"}},null,8,["size","text","ui"]),w("p",Qe,W(S.title),1)])),64))]),w("div",Ze,[r(a)===0?(g(),D("div",et,[y(ne,{ref_key:"uploadFormRef",ref:I,onFileUploadStatus:e[0]||(e[0]=S=>M.value=S),onFileReady:e[1]||(e[1]=S=>A.value=S),onSubmit:t},null,512)])):r(a)===1?(g(),D("div",tt,[y(ie,{ref_key:"registerISCN",ref:C,onFormValidChange:e[2]||(e[2]=S=>s.value=S),onSubmit:m},null,512)])):r(a)===2?(g(),D("div",at,[y(le,{ref_key:"mintNFT",ref:R,"iscn-id":r(d),onLoadingChange:e[3]||(e[3]=S=>p.value=S),onSubmit:o},null,8,["iscn-id"])])):r(a)===3?(g(),D("div",ot,[y(re,{ref:"newNFTBook",class:"p-0 flex flex-col text-left gap-[24px]","is-new-class-page":!0,"class-id":r(c),onSubmit:T},null,8,["class-id"])])):Y("",!0),w("div",st,[r(v)?(g(),G(ce,{key:0,disabled:r(P),label:r(F),onClick:K},null,8,["disabled","label"])):Y("",!0)])])])]),_:1})}}});export{Nt as default};
