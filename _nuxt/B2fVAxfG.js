import{a_ as qe,a$ as Oe,b6 as Ge,bl as Ke,bk as Xe,bn as G,b9 as V,b8 as c,ba as B,bb as He,b1 as Ye,aS as M,aT as v,b3 as F,br as k,aW as l,b4 as t,bs as Je,bi as oe,aU as i,aX as u,bj as Qe,bt as Ze,bF as ne,c0 as et,bA as tt,aV as h,aY as ae,bg as ot,bf as K,bJ as nt,bK as at,bh as lt,aQ as st}from"./HR-xqfGR.js";import{_ as it}from"./CbqJxXFj.js";import{_ as rt}from"./BR7_kwjA.js";import{_ as ct}from"./cI3tnl-R.js";import{_ as ut}from"./CDipgbae.js";import{_ as dt}from"./8IrqqEoG.js";import{_ as mt}from"./gtn70DB_.js";import{p as _t,c as ft,E as pt,_ as bt,a as gt,v as vt}from"./BW-zypku.js";import{_ as ht}from"./Cs3SfLsU.js";import{f as yt,U as xt,b as kt,M as le,D as wt}from"./CX6U84ZQ.js";import{u as Ct}from"./B6vnn54_.js";import{u as Mt}from"./BTb9JBwe.js";import{g as Ut}from"./BhaEDr6t.js";import{u as Pt}from"./DwhLKAIP.js";(function(){try{var f=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},I=new f.Error().stack;I&&(f._sentryDebugIds=f._sentryDebugIds||{},f._sentryDebugIds[I]="de72c6c4-24dd-4ff9-a08e-4e27f243cc2c",f._sentryDebugIdIdentifier="sentry-dbid-de72c6c4-24dd-4ff9-a08e-4e27f243cc2c")}catch{}})();function j(f=""){return f.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function Et(f){return _t.sanitize(f)}const St={class:"pb-[40px]"},Vt={class:"flex flex-col gap-[12px]"},It={class:"flex items-center justify-between"},At=["textContent"],Dt={class:"flex items-center gap-2"},Nt=["textContent"],Lt=["textContent"],$t={class:"flex flex-col gap-2"},Tt=["onClick"],Bt=["onClick"],Ft={class:"flex items-center gap-2 mb-3"},jt={class:"space-y-3"},zt={class:"space-y-3 w-full"},Wt={key:0,class:"grid grid-cols-2 gap-4 w-full"},Rt=["textContent"],qt=["textContent"],Ot=["textContent"],Gt={class:"flex justify-center items-center mt-2"},Kt={class:"flex justify-center items-center"},Xt={class:"flex justify-between items-center w-full"},Ht=["textContent"],Yt={key:0,class:"mt-[24px] flex flex-col gap-[12px]"},Jt={class:"w-full flex justify-center"},Qt={class:"space-y-3"},Zt={class:"flex justify-between items-center"},eo=["textContent"],to=1*1024*1024,oo=qe({__name:"NewNFTBook",props:{isNewClassPage:{type:Boolean,default:!1},classId:{type:String,default:""},editionIndex:{type:[String,Number],default:void 0},isEditMode:{type:Boolean,default:!1}},emits:["submit"],setup(f,{emit:I}){const{t:n}=Oe(),{LIKE_CO_API:X}=Ge().public,se=Ke(),A=Xe(),H=Ct(),{wallet:y}=G(se),{newBookListing:ie,updateEditionPrice:re,uploadSignImages:ce}=A,{fetchStripeConnectStatusByWallet:ue}=H,{getStripeConnectStatusByWallet:de}=G(H),{token:me}=G(A),_e=Mt(),{getBalanceOf:fe}=Pt(),pe=I,x=V(()=>S.editionIndex),{lazyFetchClassMetadataById:Y}=_e,p=c(""),_=c(!1),be=c({en:"e.g.: This edition includes EPUB and PDF ebook files.",zh:"例：此版本包含 EPUB 及 PDF 電子書檔"}),b=V(()=>S.classId),ge=c(1),J=c(!1),w=c(!0),m=c([{price:-1,deliveryMethod:"auto",autoMemo:"",stock:100,name:n("prices.standard_edition"),description:"",isAllowCustomPrice:w.value,isListed:!0,enableCustomMessagePage:!1}]),ve=V(()=>m.value.length>1),he=c(["like1rclg677y2jqt8x4ylj0kjlqjjmnn6w63uflpgr"]),ye=c([]),xe=c(""),ke=c(""),U=c(!1),P=c(""),z=c(!1),W=c(!0),D=c(null),we=c(Number(wt)),Ce=c(0),Me=c(0),Ue=c(0),Pe=c(["bold","italic","strikeThrough","title","-","unorderedList","orderedList","-","code","link","=","preview"]),E=V(()=>S.isEditMode),Ee=V(()=>E.value?n("common.save"):n("common.submit")),N=c(!0);B(_,o=>{o&&(p.value="")},{immediate:!0}),ft({markdownItConfig(o){o.options.html=!1}});const S=f;He({title:()=>n("seo_titles.new_book_listing"),ogTitle:()=>n("seo_titles.new_book_listing")}),Ye(async()=>{try{_.value=!0;const o=y.value?await fe(b.value,y.value):0;if(Ue.value=Number(o)||0,E.value||x.value!==void 0){if(y.value)try{await ue(y.value),de.value(y.value).isReady&&(U.value=!0,P.value=y.value)}catch(a){console.error(a)}const e=await $fetch(`${X}/likernft/book/store/${b.value}`,{headers:{authorization:`Bearer ${me.value}`}});if(e){if((e==null?void 0:e.ownerWallet)!==y.value)throw new Error("NOT_OWNER_OF_NFT_CLASS");if(x.value!==void 0)if(e.prices.length){const a=e.prices.find(d=>d.index.toString()===x.value);if(!a)throw new Error("Edition not found");m.value=[{price:a.price,deliveryMethod:a.isAutoDeliver?"auto":"manual",autoMemo:a.autoMemo,stock:a.stock,name:a.name.zh,description:a.description.zh,isAllowCustomPrice:a.isAllowCustomPrice,isListed:!a.isUnlisted,oldIsAutoDeliver:a.isAutoDeliver,oldStock:a.stock,enableCustomMessagePage:a.enableCustomMessagePage||!1}],w.value=a.isAllowCustomPrice}else throw new Error("No prices found");else m.value[0].price=yt;Ce.value=e.prices.reduce((a,d)=>d.index.toString()!==x.value?a+d.stock:a,0),Me.value=e.prices.reduce((a,d)=>d.index.toString()!==x.value&&!d.isAutoDeliver?a+d.stock:a,0)}else throw new Error(n("errors.nft_class_not_found"))}}catch(o){console.error(o)}finally{_.value=!1}}),B(w,o=>{m.value.forEach(e=>{e.isAllowCustomPrice=o})}),B(_,o=>{o&&(p.value="")}),B(b,async o=>{if(o){const e=await Y(o),a=e==null?void 0:e.contentFingerprints;a&&Se(a)&&(J.value=!0)}},{immediate:!0});function Se(o){const a=Ut().API_GET_ARWEAVE_V2_LINK;return o.some(d=>!!d.startsWith(a)||d.includes("?key="))}function Ve(o,e="signatureImage"){if(!(o!=null&&o.length))return;const a=o[0];if(a.type!=="image/png"){p.value=n("errors.png_only");return}if(a.size>to){p.value=n("errors.file_size_limit");return}e==="signatureImage"?D.value=a:console.warn(`Unknown upload key: ${e}`)}function Ie(){ge.value+=1,m.value.push({index:vt(),price:kt,deliveryMethod:"auto",autoMemo:"",stock:100,name:"增訂版",description:"",isAllowCustomPrice:!0,isListed:!0,enableCustomMessagePage:!1})}function Ae(o){m.value.splice(o,1)}function De(o){P.value=o,z.value=!0}function L(o){return o.map(e=>({name:{en:j(e.name),zh:j(e.name)},description:{en:j(e.description),zh:j(e.description)},priceInDecimal:Math.round(Number(e.price)*100),price:Number(e.price),stock:e.deliveryMethod==="auto"?0:Number(e.stock),isAutoDeliver:e.deliveryMethod==="auto",isAllowCustomPrice:e.isAllowCustomPrice,isUnlisted:!e.isListed,autoMemo:e.deliveryMethod==="auto"&&e.autoMemo||"",enableCustomMessagePage:e.enableCustomMessagePage||!1}))}function Ne(o){const e=[];return o.forEach(a=>{a.price!==0&&a.price<le&&e.push({path:"price",message:n("errors.price_validation",{minPrice:le})}),(!a.name.en||!a.name.zh)&&e.push({path:"name",message:n("errors.product_name_required")})}),e.length>0?(p.value=e.map(a=>a.message).join(`
`),!1):!0}async function Le(){try{const o=L(m.value);if(!Ne(o))return;if(E.value?await $e():S.isNewClassPage?await Q():(await fetch(`${X}/likernft/book/store/${b.value}`)).ok?await Te():await Q(),D.value){const e=new FormData;D.value&&e.append("signImage",D.value),await ce(e,b.value)}pe("submit")}catch{}}async function Q(){try{if(!b.value)throw new Error(n("errors.nft_class_id_required"));if(xe.value)throw new Error(n("errors.add_moderator_wallet"));if(ke.value)throw new Error(n("errors.add_notification_email"));_.value=!0;const o=await Y(b.value),e=(o==null?void 0:o.nft_meta_collection_id)||"";if(!e.includes("nft_book")&&!e.includes("book_nft"))throw new Error(n("errors.not_nft_book_collection"));const a=L(m.value),d=U.value&&P.value?{[P.value]:100}:null,R=m.value.some(g=>g.enableCustomMessagePage);await ie(b.value,{defaultPaymentCurrency:"USD",connectedWallets:d,moderatorWallets:he.value,notificationEmails:ye.value,prices:a,mustClaimToView:!0,enableCustomMessagePage:R,hideDownload:J.value})}catch(o){const e=o.data||o;console.error(e),p.value=e}finally{z.value=!1,_.value=!1}}async function $e(){try{if(!E.value)throw new Error(n("errors.missing_edition_data"));const e=L(m.value)[0];_.value=!0,await re(b.value,x.value,{price:e})}catch(o){const e=o.data||o;console.error(e),p.value=e}finally{_.value=!1}}async function Te(){try{_.value=!0;const e=L(m.value)[0];await A.addEditionPrice(b.value.toString(),(x.value||0).toString(),{price:e})}catch(o){console.error(o)}finally{_.value=!1}}function Be(o){const e=m.value[o];e.deliveryMethod="manual",e.enableCustomMessagePage=!0}return(o,e)=>{const a=Je,d=it,R=rt,g=ct,Z=ut,q=tt,ee=et,$=dt,te=mt,Fe=bt,O=Ze,T=ot,je=ht,ze=nt,We=at,Re=lt;return v(),M("div",St,[t(p)?(v(),F(a,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${t(p)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:e[0]||(e[0]=s=>p.value="")},null,8,["title"])):k("",!0),t(A).isAuthenticated?(v(),M(oe,{key:1},[i("ul",Vt,[l(O,{ui:{body:{base:"space-y-5 relative"},base:"overflow-visible border-none !border-transparent"}},{default:u(()=>[(v(!0),M(oe,null,Qe(t(m),(s,C)=>(v(),M("li",{key:s.index},[l(O,{ui:{body:{base:"flex flex-col gap-[20px]"},base:"overflow-visible border-[4px]"}},{header:u(()=>[i("div",It,[i("h3",{class:"font-bold font-mono",textContent:h(`${t(n)("nft_book_form.edition_number",{number:C+1})} - ${s.name||t(n)("nft_book_form.product_name_placeholder")}`)},null,8,At),i("div",Dt,[i("p",{class:"text-sm",textContent:h(t(n)("nft_book_form.pause_selling"))},null,8,Nt),l(d,{modelValue:s.isListed,"onUpdate:modelValue":r=>s.isListed=r},null,8,["modelValue","onUpdate:modelValue"]),i("p",{class:"text-sm",textContent:h(t(n)("nft_book_form.selling"))},null,8,Lt)])])]),default:u(()=>[l(g,{label:t(n)("nft_book_form.unit_price_label")},{default:u(()=>[l(R,{modelValue:s.price,"onUpdate:modelValue":r=>s.price=r,options:t(xt),"value-attribute":"value"},null,8,["modelValue","onUpdate:modelValue","options"])]),_:2},1032,["label"]),l(g,{label:t(n)("nft_book_form.copies_label")},{default:u(()=>[i("div",$t,[i("div",{class:ne(["border-2 rounded-lg p-4 cursor-pointer transition-all duration-200",s.deliveryMethod==="auto"?"border-primary-500 bg-primary-50":"border-gray-200 hover:border-gray-300"]),onClick:r=>s.deliveryMethod="auto"},[l(Z,{modelValue:s.deliveryMethod,"onUpdate:modelValue":r=>s.deliveryMethod=r,value:"auto",name:`deliveryMethod-${C}`,label:t(n)("nft_book_form.unlimited")},null,8,["modelValue","onUpdate:modelValue","name","label"])],10,Tt),i("div",{class:ne(["border-2 rounded-lg p-4 cursor-pointer transition-all duration-200",s.deliveryMethod==="manual"?"border-primary-500 bg-primary-50":"border-gray-200 hover:border-gray-300"]),onClick:r=>Be(C)},[i("div",Ft,[l(Z,{modelValue:s.deliveryMethod,"onUpdate:modelValue":r=>s.deliveryMethod=r,value:"manual",name:`deliveryMethod-${C}`,label:t(n)("nft_book_form.limited")},null,8,["modelValue","onUpdate:modelValue","name","label"]),l(ee,{text:t(n)("nft_book_form.manual_delivery_tooltip")},{default:u(()=>[l(q,{name:"i-heroicons-question-mark-circle"})]),_:1},8,["text"])]),i("div",jt,[l(g,{label:t(n)("nft_book_form.stock")},{default:u(()=>[l($,{modelValue:s.stock,"onUpdate:modelValue":r=>s.stock=r,type:"number",step:"1",min:1,max:t(we),placeholder:"100"},null,8,["modelValue","onUpdate:modelValue","max"])]),_:2},1032,["label"])])],10,Bt)])]),_:2},1032,["label"]),l(g,{label:t(n)("nft_book_form.enable_custom_message_page")},{default:u(()=>[i("div",zt,[l(te,{modelValue:s.enableCustomMessagePage,"onUpdate:modelValue":r=>s.enableCustomMessagePage=r,label:t(n)("nft_book_form.add_custom_message_page")},null,8,["modelValue","onUpdate:modelValue","label"]),s.enableCustomMessagePage?(v(),M("div",Wt,[l(g,{label:t(n)("nft_book_form.auto_delivery_memo")},{default:u(()=>[l($,{modelValue:s.autoMemo,"onUpdate:modelValue":r=>s.autoMemo=r,placeholder:t(n)("nft_book_form.memo_placeholder")},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["label"]),l(g,{ui:{label:{base:"w-full flex justify-between items-center"}}},{label:u(()=>[i("p",{class:"block",textContent:h(t(n)("nft_book_form.autograph_image"))},null,8,Rt),i("span",{class:"text-gray-500 text-[12px] block",textContent:h(t(n)("nft_book_form.image_requirements"))},null,8,qt)]),default:u(()=>[l($,{type:"file",accept:"image/png",onChange:e[1]||(e[1]=r=>Ve(r,"signatureImage"))})]),_:1})])):k("",!0)])]),_:2},1032,["label"]),l(g,{ui:{container:"space-y-2"}},{label:u(()=>[ae(h(t(n)("nft_book_form.product_name"))+" ",1),l(Fe,{"image-style":{width:"250px"}},{image:u(()=>e[6]||(e[6]=[i("img",{src:gt,class:"object-cover",alt:""},null,-1)])),default:u(()=>[l(q,{name:"i-heroicons-question-mark-circle"})]),_:1})]),default:u(()=>[l($,{modelValue:s.name,"onUpdate:modelValue":r=>s.name=r,placeholder:t(n)("nft_book_form.product_name_placeholder")},null,8,["modelValue","onUpdate:modelValue","placeholder"]),i("span",{class:"block text-[14px] text-[#374151] mt-[8px]",textContent:h(t(n)("nft_book_form.description_optional"))},null,8,Ot),l(t(pt),{modelValue:s.description,"onUpdate:modelValue":r=>s.description=r,language:"en-US","editor-id":`en-${C}`,placeholder:t(be).en,toolbars:t(Pe),sanitize:t(Et),style:{height:"200px",width:"100%",marginTop:"0px"}},null,8,["modelValue","onUpdate:modelValue","editor-id","placeholder","toolbars","sanitize"])]),_:2},1024)]),_:2},1024),i("div",Gt,[t(ve)?(v(),F(T,{key:0,label:t(n)("common.delete"),color:"gray","leading-icon":"i-heroicons-trash",onClick:r=>Ae(C)},null,8,["label","onClick"])):k("",!0)])]))),128))]),_:1})]),i("div",Kt,[S.isNewClassPage&&t(m).length<2?(v(),F(T,{key:0,ui:{rounded:"rounded-full"},color:"gray",icon:"i-heroicons-plus-solid",label:t(n)("nft_book_form.add_edition"),onClick:Ie},null,8,["label"])):k("",!0)]),l(O,{ui:{header:{base:"flex justify-between items-center"},body:{padding:"12px"}}},{default:u(()=>[i("div",Xt,[i("h3",{class:"font-bold font-mono",textContent:h(t(n)("nft_book_form.settings"))},null,8,Ht),l(T,{color:"gray",variant:"ghost",icon:t(N)?"i-heroicons-chevron-up":"i-heroicons-chevron-down",onClick:e[2]||(e[2]=()=>{N.value=!t(N)})},null,8,["icon"])]),t(N)?(v(),M("div",Yt,[l(g,{class:"flex items-center"},{default:u(()=>[l(ee,{class:"flex items-center gap-2",text:t(n)("nft_book_form.accept_tipping_tooltip")},{default:u(()=>[l(te,{modelValue:t(w),"onUpdate:modelValue":e[3]||(e[3]=s=>K(w)?w.value=s:null),name:"isAllowCustomPrice",label:t(n)("nft_book_form.accept_tipping")},null,8,["modelValue","label"]),l(q,{name:"i-heroicons-question-mark-circle"})]),_:1},8,["text"])]),_:1}),t(E)?(v(),F(je,{key:0,"is-stripe-connect-checked":t(U),"onUpdate:isStripeConnectChecked":e[4]||(e[4]=s=>K(U)?U.value=s:null),"is-using-default-account":t(W),"onUpdate:isUsingDefaultAccount":e[5]||(e[5]=s=>K(W)?W.value=s:null),"stripe-connect-wallet":t(P),"should-disable-setting":t(z),"login-address":t(y),onSave:De},null,8,["is-stripe-connect-checked","is-using-default-account","stripe-connect-wallet","should-disable-setting","login-address"])):k("",!0)])):k("",!0)]),_:1}),i("div",Jt,[l(T,{label:t(Ee),loading:t(_),size:"lg",disabled:t(_),onClick:Le},null,8,["label","loading","disabled"])])],64)):k("",!0),l(Re,{"model-value":!!t(_),"prevent-close":!0,ui:{base:"p-4 gap-2"}},{default:u(()=>[i("div",Qt,[i("div",Zt,[l(ze,{variant:"soft"},{default:u(()=>[ae(h(t(n)("common.loading")),1)]),_:1}),i("p",{class:"text-xs text-gray-500",textContent:h(t(n)("nft_book_form.loading_progress_text"))},null,8,eo)]),l(We,{animation:"carousel",color:"primary",class:"w-full"})])]),_:1},8,["model-value"])])}}}),vo=st(oo,[["__scopeId","data-v-1b2d8fc7"]]);export{vo as _};
