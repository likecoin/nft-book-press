import{a_ as xe,b6 as ge,bl as Ie,bn as G,bk as we,bm as Ne,b0 as Te,b8 as o,b9 as K,ba as Q,b1 as ke,b3 as C,aX as d,bq as Fe,cU as X,aT as _,aU as a,br as S,aV as r,b4 as t,bs as $e,bO as Ce,aY as Y,bt as Se,aW as p,bf as qe,aS as R,bI as J,bi as Be,bj as Ae,bH as Ue,bg as Ee,be as Re,bc as Ve,b2 as De}from"./C1DlNQ1Y.js";import{_ as Le}from"./CIb3KI9j.js";import{_ as Me}from"./BQ9pqliz.js";import{_ as Oe}from"./DCkyJD-p.js";import{u as Pe,_ as We}from"./B6wixd5u.js";import{_ as ze}from"./Tf8x0ejr.js";import{u as je}from"./DqkmNPyh.js";import{u as Z,L as He}from"./DBDEhSJE.js";import{u as Ge,a as Ke}from"./9sacfGT1.js";import"./DwlfK1yq.js";(function(){try{var h=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},T=new h.Error().stack;T&&(h._sentryDebugIds=h._sentryDebugIds||{},h._sentryDebugIds[T]="2831cb81-7e21-43e6-a803-3c27ac33fe93",h._sentryDebugIdIdentifier="sentry-dbid-2831cb81-7e21-43e6-a803-3c27ac33fe93")}catch{}})();const Qe={class:"text-lg font-bold font-mono"},Xe={class:"divide-y w-full"},Ye={class:"text-left px-4 py-3"},Je={class:"px-4 py-3"},Ze={class:"text-left px-4 py-3"},et={class:"px-4 py-3"},tt={class:"text-left px-4 py-3"},at={class:"px-4 py-3"},st={class:"px-4 py-3"},nt={class:"text-left px-4 py-3"},lt={class:"px-4 py-3"},ot={class:"px-4 py-3"},rt={class:"px-4 py-3"},ut={class:"px-4 py-3"},it={class:"px-4 py-3"},ct={class:"flex flex-wrap items-center justify-center gap-2 w-full"},dt={class:"text-sm text-gray-400 dark:text-gray-600"},ft=["src"],wt=xe({__name:"[classId]",setup(h){const{LIKE_CO_API:T}=ge().public,q=Ie(),{wallet:x,signer:B}=G(q),{initIfNecessary:V}=q,D=we(),{token:L}=G(D),M=je(),{lazyFetchClassMetadataById:ee}=M,A=Ne(),te=Te(),{writeContractAsync:ae}=Ge(),{getBalanceOf:se,getTokenIdByOwnerIndex:ne}=Z(),{assertPositiveWalletBalance:le,waitForTransactionReceipt:oe}=Ke(),v=o(""),y=o(!1),u=o(A.params.classId),O=o(A.query.payment_id),k=o(A.query.owner_wallet||x.value),F=o(""),{messageCharCount:re,isLimitReached:P}=Pe(F,X),{getNFTMetadata:ue,getNFTOwner:ie}=Z(),$=o([]),i=o([]),g=o(!1),I=o(!1),b=o(""),f=o(!1),W=o(void 0),n=o({}),w=o(""),z=K(()=>f.value||y.value||g.value||I.value||!!b.value||P.value),ce=K(()=>{var s;return(s=M.getClassMetadataById(u.value))==null?void 0:s.name});Q(y,s=>{s&&(v.value="")}),Q(f,async s=>{if(!s)if($.value){const e=$.value.filter(l=>l.trim()!=="").map(l=>Number(l));if(n.value.quantity&&e.length>0&&e.length!==n.value.quantity){b.value=`Number of NFT IDs (${e.length}) does not match the required quantity (${n.value.quantity})`,i.value=[];return}i.value=e,await j()}else w.value="",i.value=[]}),ke(async()=>{const s=await $fetch(`${T}/likernft/book/purchase/${u.value}/status/${O.value}`,{headers:{authorization:`Bearer ${L.value}`}});n.value=s,ee(u.value),U(n.value.quantity||1)});function de(){f.value=!f.value,b.value="",Ve(()=>{var s,e,l;f.value&&((l=(e=(s=W.value)==null?void 0:s[0].$refs)==null?void 0:e.input)==null||l.focus())})}async function j(){var s;try{if(g.value=!0,!i.value.length||i.value[0]===void 0){w.value="";return}try{const e=await ue(u.value,i.value[0]);w.value=Fe(e==null?void 0:e.image)}catch(e){w.value="",((s=e==null?void 0:e.data)==null?void 0:s.code)===2?b.value="NFT not found":b.value=e.toString()}}catch(e){v.value=e.toString()}finally{g.value=!1}}async function U(s=1){try{if(i.value=[],b.value="",I.value=!0,(!x.value||!B.value)&&await V(),!k.value)return;const e=await se(u.value,k.value);if(Number(e)<s)throw new Error(`Insufficient balance of NFT classId: ${u.value} for wallet: ${k.value}`);for(let l=0;l<s;l++){const N=await ne(u.value,k.value,l);i.value.push(Number(N))}$.value=i.value.map(l=>l.toString()),await j()}catch(e){v.value=e.toString()}finally{I.value=!1}}function fe(){U(n.value.quantity||1)}async function pe(){if(!z.value)try{if(y.value=!0,(!x.value||!B.value)&&await V(),!x.value||!B.value)return;if(i.value){const N=(await Promise.all(i.value.map(m=>ie(u.value,m)))).findIndex(m=>m!==k.value);if(N>=0){const m=i.value[N];throw new Error(`NFT classId: ${u.value} nftId:${m} is not owned by sender!`)}}else await U(n.value.quantity);await le({wallet:x.value});const s=await ae({address:u.value,abi:He,functionName:"batchTransferWithMemo",args:[x.value,Array(n.value.quantity).fill(n.value.wallet),i.value,Array(n.value.quantity).fill(F.value)]}),e=await oe({hash:s});(e==null?void 0:e.status)==="success"&&(await $fetch(`${T}/likernft/book/purchase/${u.value}/sent/${O.value}`,{method:"POST",body:{txHash:s,quantity:n.value.quantity||1},headers:{authorization:`Bearer ${L.value}`}}),await De(te({name:"nft-book-store-status-classId",params:{classId:u.value}})))}catch(s){console.error(s),v.value=s.toString()}finally{y.value=!1}}return(s,e)=>{const l=$e,N=Ce,m=Se,me=Le,H=Me,_e=Oe,E=Ee,ve=Re,ye=We,be=ze;return _(),C(be,null,{default:d(()=>[a("h1",Qe,' Deliver NFT Book "'+r(t(ce)||t(u))+'" ',1),t(v)?(_(),C(l,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${t(v)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:e[0]||(e[0]=c=>v.value="")},null,8,["title"])):S("",!0),t(y)?(_(),C(N,{key:1,animation:"carousel"},{indicator:d(()=>e[2]||(e[2]=[Y(" Loading... ")])),_:1})):S("",!0),t(D).isAuthenticated?(_(),C(m,{key:2,ui:{body:{base:"space-y-4"},footer:{base:"flex justify-center gap-2"}}},{footer:d(()=>[p(E,{label:"Sign and Send",disabled:t(z),size:"xl",onClick:pe},null,8,["disabled"])]),default:d(()=>[p(m,{ui:{body:{padding:""}}},{default:d(()=>{var c;return[a("table",Xe,[a("tbody",null,[a("tr",null,[a("th",Ye,r(s.$t("table.buyer_email")),1),a("td",Je,r(t(n).email),1)]),a("tr",null,[a("th",Ze,r(s.$t("table.reader_email")),1),a("td",et,r(((c=t(n).giftInfo)==null?void 0:c.toEmail)||t(n).email),1)]),a("tr",null,[a("th",tt,r(s.$t("table.status")),1),a("td",at,r(t(n).status),1)]),a("tr",null,[e[3]||(e[3]=a("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),a("td",st,r(t(n).wallet),1)]),a("tr",null,[a("th",nt,r(s.$t("table.price_name")),1),a("td",lt,r(t(n).priceName),1)]),a("tr",null,[e[4]||(e[4]=a("th",{class:"text-left px-4 py-3"}," Price ",-1)),a("td",ot,r(t(n).price),1)]),a("tr",null,[e[5]||(e[5]=a("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),a("td",rt,r(t(n).quantity),1)]),a("tr",null,[e[6]||(e[6]=a("th",{class:"text-left px-4 py-3"}," Buyer message ",-1)),a("td",ut,r(t(n).message),1)]),a("tr",null,[e[7]||(e[7]=a("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),a("td",it,r(t(n).from),1)])])])]}),_:1}),p(H,{label:"Enter Author's Message",error:t(P),hint:`${t(re)} / ${t(X)}`},{default:d(()=>[p(me,{modelValue:t(F),"onUpdate:modelValue":e[1]||(e[1]=c=>qe(F)?F.value=c:null),placeholder:"default memo"},null,8,["modelValue"])]),_:1},8,["error","hint"]),p(H,{label:"Specify NFT ID",description:"Leave empty to auto-fetch NFT ID",error:t(b),ui:{description:"text-gray-400 dark:text-gray-600"}},{default:d(()=>[a("div",ct,[t(n).quantity?(_(),R("div",{key:0,class:J([t(n).quantity>1?"w-full":"flex-grow","space-y-1"])},[(_(!0),R(Be,null,Ae(t(n).quantity,c=>(_(),C(_e,{key:`nft-id-input-${c}`,ref_for:!0,ref_key:"nftIdInputRef",ref:W,modelValue:t($)[c-1],"onUpdate:modelValue":he=>t($)[c-1]=he,class:"font-mono",readonly:!t(f),disabled:!t(f)},Ue({_:2},[t(n).quantity>1?{name:"leading",fn:d(()=>[a("span",dt,"#"+r(c),1)]),key:"0"}:void 0]),1032,["modelValue","onUpdate:modelValue","readonly","disabled"]))),128))],2)):S("",!0),p(E,{label:t(f)||t(g)&&!t(I)?"Confirm":"Edit",disabled:t(y)||t(g),variant:"outline",loading:t(g)&&!t(I),color:"gray",onClick:de},null,8,["label","disabled","loading"]),p(ve,{class:J(["text-sm text-gray-600",{"sm:w-min":t(n).quantity<=1}])},{default:d(()=>e[8]||(e[8]=[Y(" OR ")])),_:1,__:[8]},8,["class"]),p(E,{label:`Auto-fetch NFT ID for ${t(n).quantity} NFTs`,disabled:t(y)||t(f),loading:t(I),variant:"outline",onClick:fe},null,8,["label","disabled","loading"])])]),_:1},8,["error"]),p(ye,{class:"h-[300px]"},{default:d(()=>[t(w)?(_(),R("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",src:t(w)},null,8,ft)):S("",!0)]),_:1})]),_:1})):S("",!0)]),_:1})}}});export{wt as default};
