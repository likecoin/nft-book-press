import{a_ as X,b6 as te,b7 as Q,b8 as ae,b9 as n,ba as O,bb as j,b1 as se,bc as _e,aS as E,aT as v,aW as w,b4 as l,bd as me,aX as G,aU as g,be as fe,aY as be,aV as Y,bf as ve,bg as ge,aQ as we,a$ as oe,bh as ne,b3 as H,bi as J,bj as ye,bk as he,b0 as Ie,bl as Se,b2 as z,bm as Ne,bn as Z,bo as Fe,bp as Te,bq as ke,br as xe,bs as Ce}from"./Caq_G6mE.js";import{u as Re,v as De,a as ee,_ as Me,f as Ue,b as Be}from"./5LFBHlzp.js";import{L as Ee,u as $e}from"./DlOWeW8Q.js";import{u as Le,a as ie,b as Ae,_ as Ve}from"./DZCXZYzv.js";import{D as Oe}from"./Q1CjyB8c.js";import{_ as Pe}from"./D3XW97c4.js";import{_ as Ke}from"./DAyE9HoD.js";import"./DpXKuDdk.js";import"./DqndA3do.js";import"./C-cHZW0c.js";import"./CkiYQWLh.js";import"./DRFVed2S.js";import"./BU0MK0wk.js";import"./DAw_r0AL.js";import"./BsUN06gN.js";import"./B8exWwLK.js";import"./CgUtcrmH.js";import"./By_gpOnU.js";import"./CwMa147M.js";(function(){try{var y=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},i=new y.Error().stack;i&&(y._sentryDebugIds=y._sentryDebugIds||{},y._sentryDebugIds[i]="4761c9a1-9fe5-47ce-9c4f-dc5213e5c0e0",y._sentryDebugIdIdentifier="sentry-dbid-4761c9a1-9fe5-47ce-9c4f-dc5213e5c0e0")}catch{}})();const We={class:"space-y-3"},qe={class:"flex justify-between items-center"},ze={class:"text-xs text-gray-500"},je=X({__name:"RegisterISCN",emits:["handleSubmit","submit","formValidChange"],setup(y,{expose:i,emit:k}){const x=te(),{getFileType:$}=ee(),{LIKE_EVM_NFT_TARGET_ADDRESS:L}=Q().public,{wallet:m,signer:p}=ae(x),{validateWalletConsistency:N}=x,{assertPositiveWalletBalance:s,waitForTransactionReceipt:F}=Le(),{stripHtmlTags:C,formatLanguage:R}=ee(),{showErrorToast:D}=ie(),{LIKE_NFT_CONTRACT_ADDRESS:A}=Q().public,r=n({type:"Book",title:"",description:"",isbn:"",publisher:"",publicationDate:"",author:{name:"",description:""},license:"All Rights Reserved",customLicense:"",contentFingerprints:[{url:""}],downloadableUrls:[{url:"",type:"",fileName:""}],language:"",bookInfoUrl:"",tags:[],coverUrl:""}),c=n(""),V=n(""),M=k,{payload:o}=Re({iscnFormData:r}),{writeContractAsync:u}=Ae(),h=O(()=>De(r.value)),I=O(()=>{var t;return!((t=h.value)!=null&&t.length)});j(I,t=>{M("formValidChange",t)},{immediate:!0}),se(()=>{const t=P();t&&(r.value=t)});const P=()=>{var f,d,T,U,B,a;const t=_e();if(!t)return null;const _={type:"Book",title:((f=t.epubMetadata)==null?void 0:f.title)||"",description:C(((d=t.epubMetadata)==null?void 0:d.description)||""),isbn:"",publisher:"",publicationDate:new Date().toISOString().split("T")[0],author:{name:((T=t.epubMetadata)==null?void 0:T.author)||"",description:""},license:"All Rights Reserved",contentFingerprints:[],downloadableUrls:[],coverUrl:(U=t.epubMetadata)!=null&&U.thumbnailArweaveId?`ar://${t.epubMetadata.thumbnailArweaveId}`:"",language:R(((B=t.epubMetadata)==null?void 0:B.language)||"zh"),tags:((a=t.epubMetadata)==null?void 0:a.tags)||[]};return _.downloadableUrls=t.fileRecords.filter(e=>e.fileType==="application/pdf"||e.fileType==="application/epub+zip").map(e=>({url:e.arweaveKey?e.arweaveLink:`ar://${e.arweaveId}`,type:$(e.fileType),fileName:e.fileName})),_.contentFingerprints=[...new Set(t.fileRecords.map(e=>{const b=e.arweaveKey?e.arweaveLink:`ar://${e.arweaveId}`;return e.fileType==="application/epub+zip"||e.fileType==="application/pdf"?b:`ar://${e.arweaveId}`}).filter(Boolean))].map(e=>({url:e})),_},q=async()=>{if(c.value="checking",!I.value){D(h.value.join(", "));return}r.value.contentFingerprints.length&&await K()},K=async()=>{if(c.value="loading",await N(),!m.value||!p.value){V.value="MISSING_SIGNER",c.value="";return}try{c.value="signing";const t=Ue(o.value),_={name:t.name,description:t.description,...t,symbol:"BOOK",image:(t==null?void 0:t.thumbnailUrl)||"",external_link:(t==null?void 0:t.url)||"",nft_meta_collection_id:"nft_book",nft_meta_collection_name:"NFT Book",nft_meta_collection_description:"NFT Book by Liker Land",recordTimestamp:new Date().toISOString()};await s({wallet:m.value});const f=await u({address:A,abi:Ee,functionName:"newBookNFTWithRoyalty",args:[{creator:m.value,updaters:[m.value,L],minters:[m.value,L],config:{name:_.name,symbol:"BOOK",metadata:JSON.stringify(_),max_supply:Oe}},500]}),d=await F({hash:f});if(console.log(d),!d||d.status!=="success")throw new Error("INVALID_RECEIPT");if(!d.logs[0].address)throw new Error("INVALID_CLASS_ID");const T=d.logs[0].address;c.value="success",M("submit",{iscnId:T,txHash:f})}catch(t){console.error(t),D(`'SIGNING_ERROR':${t}`),c.value=""}finally{c.value=""}};return i({onSubmit:q}),(t,_)=>{const f=Me,d=fe,T=ve,U=ge;return v(),E("div",null,[w(f,{modelValue:l(r),"onUpdate:modelValue":_[0]||(_[0]=B=>me(r)?r.value=B:null)},null,8,["modelValue"]),w(U,{"model-value":!!l(c),"prevent-close":!0,ui:{base:"p-4 gap-2"}},{default:G(()=>[g("div",We,[g("div",qe,[w(d,{variant:"soft"},{default:G(()=>[be(Y(l(c)),1)]),_:1}),g("p",ze,Y(t.$t("notifications.iscn_registration_complete")),1)]),w(T,{animation:"carousel",color:"primary",class:"w-full"})])]),_:1},8,["model-value"])])}}}),Ge=we(je,[["__scopeId","data-v-6f5b3ef1"]]),Ye={class:"flex flex-col items-stretch grow space-y-4"},He=X({__name:"MintNFT",props:{iscnId:{type:String,default:""}},emits:["submit","loadingChange"],setup(y,{expose:i,emit:k}){const{getClassOwner:x,getClassMetadata:$,checkNFTClassIsBookNFT:L}=$e(),m=n(1),p=n(""),N=n(!1),s=n(""),F=n(null),C=n(""),R=n(null),D=k;j(N,o=>{D("loadingChange",o),o&&(p.value="")},{immediate:!0});const{t:A}=oe();ne({title:()=>A("seo.mint_nft_book_title"),ogTitle:()=>A("seo.mint_nft_book_title")});const r=y;j(()=>r.iscnId,async o=>{o&&await c(r.iscnId)},{immediate:!0});async function c(o){if(o)try{if(N.value=!0,!await L(o))throw new Error("Invalid NFT Class ID");const[h,I]=await Promise.all([$(o),x(o)]);if(!h)throw new Error("Invalid NFT Class ID");F.value={contentMetadata:h,owner:I,"@id":o},s.value=I,C.value=o,m.value=3}catch(u){console.error(u),p.value=u.toString()}finally{N.value=!1}}function V(){var o;(o=R.value)==null||o.startNFTMintFlow()}function M({classId:o,nftMintCount:u}={}){C.value=o||"",D("submit",{classId:o||"",nftMintCount:u})}return i({startNFTMintFlow:V}),(o,u)=>{const h=ye,I=Ve;return v(),E("div",Ye,[l(p)?(v(),H(h,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${l(p)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:u[0]||(u[0]=P=>p.value="")},null,8,["title"])):J("",!0),w(I,{ref_key:"liteMintNFTRef",ref:R,"iscn-data":l(F),"should-show-submit":!1,onSubmit:M},null,8,["iscn-data"])])}}}),Je={class:"w-full"},Xe={class:"justify-evenly items-center flex space-x-4 relative"},Qe={class:"text-sm font-semibold"},Ze={class:"mt-6 p-4 border rounded-lg bg-gray-100 text-center flex flex-col gap-[24px]"},et={key:0},tt={key:1},at={key:2},st={key:3},ot={class:"flex gap-2 justify-center mt-4"},Nt=X({__name:"new-book",setup(y){var U,B;const{t:i}=oe(),k=te(),{wallet:x,signer:$}=ae(k),{validateWalletConsistency:L}=k,m=he(),p=Ie(),{showErrorToast:N}=ie(),s=n(0),F=n(),C=n(),R=n(),D=n(""),A=n(""),r=n(((U=m.query.iscn_id)==null?void 0:U.toString())||""),c=n(((B=m.query.class_id)==null?void 0:B.toString())||""),V=n([]),M=n(""),o=n(!1),u=n(!1);ne({title:()=>i("seo_titles.publish_nft_book"),ogTitle:()=>i("seo_titles.publish_nft_book")});const h=O(()=>{switch(s.value){case 0:return i("publish_button.upload_files");case 1:return i("publish_button.metadata");case 2:return i("publish_button.mint_nft");default:return i("publish_button.publish_now")}}),I=O(()=>{var a;return((a=V.value)==null?void 0:a.length)>0}),P=O(()=>s.value===0?I.value:s.value<3),q=O(()=>s.value===0?M.value!=="":s.value===2?u.value:!1),K=[{title:i("publish_steps.upload_files"),description:"Upload your book file"},{title:i("publish_steps.register_iscn"),description:"Register ISCN"},{title:i("publish_steps.mint_nft"),description:"Mint NFT"},{title:i("publish_steps.new_book_publish"),description:"Publish new book"}];se(()=>{var e;let a=null;try{const b=sessionStorage.getItem(Se);b&&(a=JSON.parse(b))}catch(b){console.error(b)}r.value?(D.value=r.value,f({iscnId:r.value})):c.value?d({classId:c.value}):a!=null&&a.epubMetadata&&(a!=null&&a.fileRecords)&&(A.value=(e=a==null?void 0:a.epubMetadata)==null?void 0:e.title)});const t=async()=>{if((!x.value||!$.value)&&await L(),!x.value||!$.value){N(i("auth.login_required"));return}try{if(s.value===0&&F.value){await F.value.onSubmit();return}if(s.value===1){if(!o.value){N("Please fill in all required fields");return}await C.value.onSubmit();return}if(s.value===2){await R.value.startNFTMintFlow();return}s.value<K.length-1&&s.value++}catch(a){console.error("Error during form submission:",a)}},_=a=>{Ce(a),s.value=1},f=async a=>{const{iscnId:e}=a;e&&await z(p({query:{iscn_id:e}}),{replace:!0}),Ne(),s.value=2,await Z(),r.value=e},d=async a=>{const{classId:e,nftMintCount:b}=a;e&&(c.value=e,await z(p({query:{class_id:e,count:b}}),{replace:!0}),s.value=3,await Z())},T=async()=>{await z(p({name:"my-books"}))};return(a,e)=>{const b=ke,le=Be,re=Ge,ce=He,ue=Pe,de=xe,pe=Ke;return v(),H(pe,{class:"flex flex-col items-stretch grow space-y-4"},{default:G(()=>[g("div",Je,[g("div",Xe,[e[4]||(e[4]=g("div",{class:"absolute w-full h-[1px] bg-gray-300 top-[50%] left-0 z-[-1]"},null,-1)),(v(),E(Fe,null,Te(K,(S,W)=>g("div",{key:W,class:"flex items-center space-x-2 bg-white p-2 rounded-lg"},[w(b,{size:W===l(s)?"lg":"md",text:(W+1).toString(),ui:{background:W===l(s)?"bg-primary-100":"bg-gray-200"}},null,8,["size","text","ui"]),g("p",Qe,Y(S.title),1)])),64))]),g("div",Ze,[l(s)===0?(v(),E("div",et,[w(le,{ref_key:"uploadFormRef",ref:F,onFileUploadStatus:e[0]||(e[0]=S=>M.value=S),onFileReady:e[1]||(e[1]=S=>V.value=S),onSubmit:_},null,512)])):l(s)===1?(v(),E("div",tt,[w(re,{ref_key:"registerISCN",ref:C,onFormValidChange:e[2]||(e[2]=S=>o.value=S),onSubmit:f},null,512)])):l(s)===2?(v(),E("div",at,[w(ce,{ref_key:"mintNFT",ref:R,"iscn-id":l(r),onLoadingChange:e[3]||(e[3]=S=>u.value=S),onSubmit:d},null,8,["iscn-id"])])):l(s)===3?(v(),E("div",st,[w(ue,{ref:"newNFTBook",class:"p-0 flex flex-col text-left gap-[24px]","is-new-class-page":!0,"class-id":l(c),onSubmit:T},null,8,["class-id"])])):J("",!0),g("div",ot,[l(P)?(v(),H(de,{key:0,disabled:l(q),label:l(h),onClick:t},null,8,["disabled","label"])):J("",!0)])])])]),_:1})}}});export{Nt as default};
