import{aQ as Fe,aS as $,aT as i,aU as a,bY as Be,ba as h,a_ as Ue,a$ as Me,b7 as J,b6 as Re,b8 as Z,bz as Ve,bk as qe,b0 as Ee,b9 as d,bb as ee,b1 as Ae,b3 as k,aX as p,bC as Le,bi as v,aW as y,aV as l,b4 as e,bj as We,bf as De,aY as te,bD as Oe,bv as Pe,bd as ae,b$ as ne,bo as ze,bp as je,bw as Qe,cc as Ge,br as He,bx as Ke,bg as Ye,b2 as Xe}from"./DKWF-UHc.js";import{_ as Je}from"./DzAVTspI.js";import{b as Ze,u as et,_ as tt}from"./jP0GuKnU.js";import{_ as at}from"./CaZsIfJV.js";import{a as nt,u as se,b as st}from"./BD2DqrTR.js";import{b as oe}from"./9wvsEM8H.js";(function(){try{var c=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},o=new c.Error().stack;o&&(c._sentryDebugIds=c._sentryDebugIds||{},c._sentryDebugIds[o]="3360c9cd-7091-4d0e-aedf-dbd68f28658d",c._sentryDebugIdIdentifier="sentry-dbid-3360c9cd-7091-4d0e-aedf-dbd68f28658d")}catch{}})();const ot={},lt={class:"relative overflow-hidden rounded border border-dashed border-gray-400 dark:border-gray-500 opacity-75 flex items-center justify-center p-4"};function rt(c,o){return i(),$("div",lt,[o[0]||(o[0]=a("svg",{class:"absolute inset-0 h-full w-full stroke-gray-900/10 dark:stroke-white/10",fill:"none"},[a("defs",null,[a("pattern",{id:"placeholder-pattern",x:"0",y:"0",width:"10",height:"10",patternUnits:"userSpaceOnUse"},[a("path",{d:"M-3 13 15-5M-5 5l18-18M-1 21 17 3"})])]),a("rect",{stroke:"none",fill:"url(#placeholder-pattern)",width:"100%",height:"100%"})],-1)),Be(c.$slots,"default")])}const it=Fe(ot,[["render",rt]]);function ut(c){return c.charCodeAt(0)>255}function ct(c,o){const T=h(()=>{let b=0;for(let I=0;I<c.value.length;I++)b+=ut(c.value[I])?2:1;return b}),E=h(()=>T.value>o);return{messageCharCount:T,isLimitReached:E}}const dt={class:"text-lg font-bold font-mono"},ft={class:"divide-y w-full"},_t={class:"text-left px-4 py-3"},mt={class:"px-4 py-3"},pt={key:0},vt={class:"text-left px-4 py-3"},bt={class:"px-4 py-3"},yt={class:"text-left px-4 py-3"},ht={class:"px-4 py-3"},xt={class:"px-4 py-3"},gt={class:"text-left px-4 py-3"},wt={class:"px-4 py-3"},kt={class:"px-4 py-3"},It={class:"px-4 py-3"},Ct={class:"px-4 py-3"},Nt={class:"space-y-2 mb-4"},$t=["textContent"],Tt=["textContent"],St={class:"flex flex-wrap items-center justify-center gap-2 w-full"},Ft={class:"text-sm text-gray-400 dark:text-gray-600"},Bt=["textContent"],Ut=["textContent"],Mt=["src"],Wt=Ue({__name:"[classId]",setup(c){const{t:o}=Me(),{LIKE_CO_API:T}=J().public,E=Re(),{wallet:b,signer:I}=Z(E),{validateWalletConsistency:O}=E,P=Ve(),{token:z}=Z(P),j=nt(),{lazyFetchClassMetadataById:le}=j,L=qe(),re=Ee(),{writeContractAsync:ie}=Ze(),{getBalanceOf:ue,getTokenIdByOwnerIndex:ce}=se(),{assertPositiveWalletBalance:de,waitForTransactionReceipt:fe}=et(),x=d({message:"",actions:[]}),C=d(!1),r=h(()=>L.params.classId),Q=h(()=>L.query.payment_id),U=h(()=>L.query.owner_wallet||b.value),M=d(o("nft_book_form.default_memo")),{messageCharCount:_e,isLimitReached:G}=ct(M,oe),{getNFTMetadata:me,getNFTOwner:pe}=se(),S=d([]),u=d([]),R=d(!1),g=d(""),F=d(!1),ve=d(void 0),s=d({}),V=d(""),q=d(!1),N=d(""),{NFT_ITEM_URL:be}=J().public,H=h(()=>S.value.some(n=>n.trim()!=="")),K=h(()=>C.value||R.value||!!g.value||G.value||!F.value),B=h(()=>s.value.quantity===1),ye=h(()=>{var n;return(n=j.getClassMetadataById(r.value))==null?void 0:n.name});ee(C,n=>{n&&(x.value={message:"",actions:[]})}),ee(S,(n,t)=>{t&&t.length>0&&B.value&&(F.value=!1,N.value="",g.value="")},{deep:!0}),Ae(async()=>{const n=await $fetch(`${T}/likernft/book/purchase/${r.value}/status/${Q.value}`,{headers:{authorization:`Bearer ${z.value}`}});s.value=n,le(r.value),await W(s.value.quantity||1)});async function he(){if(H.value)try{if(N.value="",g.value="",u.value=S.value.filter(t=>t.trim()!=="").map(t=>Number(t)),u.value.includes(0)){N.value=o("error.nft_id_reserved_for_author"),u.value=[];return}if(!await Y()){N.value=o("error.fetch_nft_metadata_failed"),u.value=[];return}F.value=!0}catch(n){N.value=n.message,u.value=[],F.value=!1}}async function Y(){var n;try{if(R.value=!0,!u.value.length||u.value[0]===void 0){V.value="";return}try{const t=await me(r.value,u.value[0]);return V.value=Le(t==null?void 0:t.image),t}catch(t){V.value="",((n=t==null?void 0:t.data)==null?void 0:n.code)===2?g.value="NFT not found":g.value=t.toString()}}catch(t){x.value={message:t.toString(),actions:[]}}finally{R.value=!1}}async function W(n=1){try{if(u.value=[],g.value="",(!b.value||!I.value)&&await O(),!U.value)throw new Error("Missing owner wallet");const t=await ue(r.value,U.value);if(t<BigInt(n))throw new Error(`No NFTs available for classId: ${r.value} in wallet: ${U.value}`);const f=[];for(let w=0;w<Number(t);w++){const _=await ce(r.value,U.value,w);if(_!==0n&&(f.push(Number(_)),f.length>=n))break}if(f.length<n)throw new Error(`Failed to collect enough available NFTs. Collected ${f.length}/${n}`);u.value=f,S.value=f.map(String),F.value=!0,await Y()}catch(t){const f=t.toString();g.value=f,x.value={message:f,actions:[{label:o("button.restock_nft"),variant:"outline",color:"red",click:()=>{q.value=!0}}]}}}function xe(){window.open(`${be}/${r.value}`,"_blank","noopener")}async function ge(){if(!K.value)try{if(C.value=!0,(!b.value||!I.value)&&await O(),!b.value||!I.value)return;if(u.value){const w=(await Promise.all(u.value.map(_=>pe(r.value,_)))).findIndex(_=>_!==U.value);if(w>=0){const _=u.value[w];throw new Error(`NFT classId: ${r.value} nftId:${_} is not owned by sender!`)}}else await W(s.value.quantity);await de({wallet:b.value});const n=await ie({address:r.value,abi:st,functionName:"batchTransferWithMemo",args:[b.value,Array(s.value.quantity).fill(s.value.wallet),u.value,Array(s.value.quantity).fill(M.value)]}),t=await fe({hash:n});(t==null?void 0:t.status)==="success"&&(await $fetch(`${T}/likernft/book/purchase/${r.value}/sent/${Q.value}`,{method:"POST",body:{txHash:n,quantity:s.value.quantity||1},headers:{authorization:`Bearer ${z.value}`}}),await Xe(re({name:"my-books-status-classId",params:{classId:r.value}})))}catch(n){console.error(n),x.value={message:n.toString(),actions:[]}}finally{C.value=!1}}function we(){q.value=!1,W(s.value.quantity||1)}return(n,t)=>{const f=We,w=De,_=Oe,ke=Je,X=Pe,Ie=Qe,D=He,Ce=Ke,Ne=it,$e=tt,Te=Ye,Se=at;return i(),k(Se,null,{default:p(()=>[a("h1",dt,' Deliver NFT Book "'+l(e(ye)||e(r))+'" ',1),e(x).message?(i(),k(f,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${e(x).message}`,actions:e(x).actions,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:t[0]||(t[0]=m=>x.value={message:"",actions:[]})},null,8,["title","actions"])):v("",!0),e(C)?(i(),k(w,{key:1,animation:"carousel"},{indicator:p(()=>t[3]||(t[3]=[te(" Loading... ")])),_:1})):v("",!0),e(P).isAuthenticated?(i(),k(_,{key:2,ui:{body:{base:"space-y-6"},footer:{base:"flex justify-center gap-2"}}},{footer:p(()=>[y(D,{label:e(o)("nft_send.sign_and_send"),disabled:e(K),size:"xl",onClick:ge},null,8,["label","disabled"])]),default:p(()=>[y(_,{ui:{body:{padding:""}}},{default:p(()=>{var m,A;return[a("table",ft,[a("tbody",null,[a("tr",null,[a("th",_t,l(e(o)("table.buyer_email")),1),a("td",mt,l(e(s).email),1)]),(m=e(s).giftInfo)!=null&&m.toEmail?(i(),$("tr",pt,[a("th",vt,l(e(o)("table.reader_email")),1),a("td",bt,l(((A=e(s).giftInfo)==null?void 0:A.toEmail)||e(s).email),1)])):v("",!0),a("tr",null,[a("th",yt,l(e(o)("table.status")),1),a("td",ht,l(e(s).status),1)]),a("tr",null,[t[4]||(t[4]=a("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),a("td",xt,l(e(s).wallet),1)]),a("tr",null,[a("th",gt,l(e(o)("table.price_name")),1),a("td",wt,l(e(s).priceName),1)]),a("tr",null,[t[5]||(t[5]=a("th",{class:"text-left px-4 py-3"}," Price ",-1)),a("td",kt,l(e(s).price),1)]),a("tr",null,[t[6]||(t[6]=a("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),a("td",It,l(e(s).quantity),1)]),a("tr",null,[t[7]||(t[7]=a("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),a("td",Ct,l(e(s).from),1)])])])]}),_:1}),y(_,null,{default:p(()=>[a("div",Nt,[a("h5",{class:"text-sm font-bold",textContent:l(`${e(o)("nft_book_form.buyer_message")}`)},null,8,$t),a("p",{textContent:l(e(s).message)},null,8,Tt)]),y(X,{label:e(o)("nft_book_form.author_message"),error:e(G),hint:`${e(_e)} / ${e(oe)}`},{default:p(()=>[y(ke,{modelValue:e(M),"onUpdate:modelValue":t[1]||(t[1]=m=>ae(M)?M.value=m:null)},null,8,["modelValue"])]),_:1},8,["label","error","hint"])]),_:1}),y(X,{label:e(o)("form.nft_id_label"),class:"mb-4",error:e(g),ui:{description:"text-gray-400 dark:text-gray-600"}},{default:p(()=>[a("div",St,[e(s).quantity?(i(),$("div",{key:0,class:ne([e(s).quantity>1?"w-full":"flex-grow","space-y-1","relative"])},[(i(!0),$(ze,null,je(e(s).quantity,m=>(i(),k(Ie,{key:`nft-id-input-${m}`,ref_for:!0,ref_key:"nftIdInputRef",ref:ve,modelValue:e(S)[m-1],"onUpdate:modelValue":A=>e(S)[m-1]=A,disabled:!e(B),class:"font-mono"},Ge({_:2},[e(s).quantity>1?{name:"leading",fn:p(()=>[a("span",Ft,"#"+l(m),1)]),key:"0"}:void 0]),1032,["modelValue","onUpdate:modelValue","disabled"]))),128)),e(N)?(i(),$("span",{key:0,class:"text-xs text-red-500 absolute",textContent:l(e(N))},null,8,Bt)):e(F)&&e(B)?(i(),$("span",{key:1,class:"text-xs text-green-500 absolute",textContent:l(e(o)("button.confirmed"))},null,8,Ut)):v("",!0)],2)):v("",!0),e(B)?(i(),k(D,{key:1,label:e(o)("button.confirm_nft_id"),disabled:e(C)||e(R)||!e(H),variant:"outline",loading:e(R),color:"primary",onClick:he},null,8,["label","disabled","loading"])):v("",!0),e(B)?(i(),k(Ce,{key:2,class:ne(["text-sm text-gray-600","sm:w-min"])},{default:p(()=>t[8]||(t[8]=[te(" OR ")])),_:1,__:[8]})):v("",!0),e(B)?(i(),k(D,{key:3,label:e(o)("button.check_all_nft_ids"),disabled:e(C),variant:"outline",onClick:xe},null,8,["label","disabled"])):v("",!0)])]),_:1},8,["label","error"]),y(Ne,{class:"h-[300px]"},{default:p(()=>[e(V)?(i(),$("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",alt:"preview",src:e(V)},null,8,Mt)):v("",!0)]),_:1})]),_:1})):v("",!0),y(Te,{modelValue:e(q),"onUpdate:modelValue":t[2]||(t[2]=m=>ae(q)?q.value=m:null)},{default:p(()=>[y($e,{"is-restock":!0,"iscn-id":e(r),onSubmit:we},null,8,["iscn-id"])]),_:1},8,["modelValue"])]),_:1})}}});export{Wt as default};
