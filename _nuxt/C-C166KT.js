import{_ as ge}from"./muC8c6V8.js";import{aQ as xe,aS as U,aT as v,aU as a,bV as we,ba as R,a_ as Ie,b7 as Ne,b6 as ke,b8 as K,bw as Te,bj as $e,b0 as Ce,b9 as o,bb as Q,b1 as Fe,b3 as B,aX as p,bz as Se,bi as A,aV as r,b4 as t,bf as qe,aY as Y,bA as Be,aW as m,bd as Ae,bY as X,bn as Ue,bo as Re,c9 as Ee,bq as Me,bu as Ve,bm as De,b2 as Le}from"./BHFTF29u.js";import{_ as We}from"./DnIVIGX0.js";import{_ as Oe}from"./C5a47DHg.js";import{_ as Pe}from"./QL_iHPV6.js";import{_ as ze}from"./BB88T75T.js";import{a as je,u as J,b as Ge}from"./BDDXKHgg.js";import{b as Z}from"./CTHH3OuM.js";import{a as He,u as Ke}from"./O0G487-C.js";import"./cikBV9y9.js";(function(){try{var u=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},c=new u.Error().stack;c&&(u._sentryDebugIds=u._sentryDebugIds||{},u._sentryDebugIds[c]="2f9ad0ac-3b34-4588-90e5-36055fd571b2",u._sentryDebugIdIdentifier="sentry-dbid-2f9ad0ac-3b34-4588-90e5-36055fd571b2")}catch{}})();const Qe={},Ye={class:"relative overflow-hidden rounded border border-dashed border-gray-400 dark:border-gray-500 opacity-75 flex items-center justify-center p-4"};function Xe(u,c){return v(),U("div",Ye,[c[0]||(c[0]=a("svg",{class:"absolute inset-0 h-full w-full stroke-gray-900/10 dark:stroke-white/10",fill:"none"},[a("defs",null,[a("pattern",{id:"placeholder-pattern",x:"0",y:"0",width:"10",height:"10",patternUnits:"userSpaceOnUse"},[a("path",{d:"M-3 13 15-5M-5 5l18-18M-1 21 17 3"})])]),a("rect",{stroke:"none",fill:"url(#placeholder-pattern)",width:"100%",height:"100%"})],-1)),we(u.$slots,"default")])}const Je=xe(Qe,[["render",Xe]]);function Ze(u){return u.charCodeAt(0)>255}function et(u,c){const w=R(()=>{let I=0;for(let N=0;N<u.value.length;N++)I+=Ze(u.value[N])?2:1;return I}),y=R(()=>w.value>c);return{messageCharCount:w,isLimitReached:y}}const tt={class:"text-lg font-bold font-mono"},at={class:"divide-y w-full"},nt={class:"text-left px-4 py-3"},st={class:"px-4 py-3"},lt={class:"text-left px-4 py-3"},ot={class:"px-4 py-3"},rt={class:"text-left px-4 py-3"},ut={class:"px-4 py-3"},it={class:"px-4 py-3"},dt={class:"text-left px-4 py-3"},ct={class:"px-4 py-3"},ft={class:"px-4 py-3"},pt={class:"px-4 py-3"},_t={class:"px-4 py-3"},mt={class:"px-4 py-3"},vt={class:"flex flex-wrap items-center justify-center gap-2 w-full"},yt={class:"text-sm text-gray-400 dark:text-gray-600"},bt=["src"],Ft=Ie({__name:"[classId]",setup(u){const{LIKE_CO_API:c}=Ne().public,w=ke(),{wallet:y,signer:I}=K(w),{initIfNecessary:N}=w,D=Te(),{token:L}=K(D),W=je(),{lazyFetchClassMetadataById:ee}=W,E=$e(),te=Ce(),{writeContractAsync:ae}=He(),{getBalanceOf:ne,getTokenIdByOwnerIndex:se}=J(),{assertPositiveWalletBalance:le,waitForTransactionReceipt:oe}=Ke(),h=o(""),g=o(!1),i=o(E.params.classId),O=o(E.query.payment_id),F=o(E.query.owner_wallet||y.value),S=o(""),{messageCharCount:re,isLimitReached:P}=et(S,Z),{getNFTMetadata:ue,getNFTOwner:ie}=J(),q=o([]),d=o([]),k=o(!1),T=o(!1),x=o(""),_=o(!1),z=o(void 0),s=o({}),$=o(""),j=R(()=>_.value||g.value||k.value||T.value||!!x.value||P.value),de=R(()=>{var n;return(n=W.getClassMetadataById(i.value))==null?void 0:n.name});Q(g,n=>{n&&(h.value="")}),Q(_,async n=>{if(!n)if(q.value){const e=q.value.filter(l=>l.trim()!=="").map(l=>Number(l));if(s.value.quantity&&e.length>0&&e.length!==s.value.quantity){x.value=`Number of NFT IDs (${e.length}) does not match the required quantity (${s.value.quantity})`,d.value=[];return}d.value=e,await G()}else $.value="",d.value=[]}),Fe(async()=>{const n=await $fetch(`${c}/likernft/book/purchase/${i.value}/status/${O.value}`,{headers:{authorization:`Bearer ${L.value}`}});s.value=n,ee(i.value),M(s.value.quantity||1)});function ce(){_.value=!_.value,x.value="",De(()=>{var n,e,l;_.value&&((l=(e=(n=z.value)==null?void 0:n[0].$refs)==null?void 0:e.input)==null||l.focus())})}async function G(){var n;try{if(k.value=!0,!d.value.length||d.value[0]===void 0){$.value="";return}try{const e=await ue(i.value,d.value[0]);$.value=Se(e==null?void 0:e.image)}catch(e){$.value="",((n=e==null?void 0:e.data)==null?void 0:n.code)===2?x.value="NFT not found":x.value=e.toString()}}catch(e){h.value=e.toString()}finally{k.value=!1}}async function M(n=1){try{if(d.value=[],x.value="",T.value=!0,(!y.value||!I.value)&&await N(),!F.value)return;const e=await ne(i.value,F.value);if(Number(e)<n)throw new Error(`Insufficient balance of NFT classId: ${i.value} for wallet: ${F.value}`);for(let l=0;l<n;l++){const C=await se(i.value,F.value,l);d.value.push(Number(C))}q.value=d.value.map(l=>l.toString()),await G()}catch(e){h.value=e.toString()}finally{T.value=!1}}function fe(){M(s.value.quantity||1)}async function pe(){if(!j.value)try{if(g.value=!0,(!y.value||!I.value)&&await N(),!y.value||!I.value)return;if(d.value){const C=(await Promise.all(d.value.map(b=>ie(i.value,b)))).findIndex(b=>b!==F.value);if(C>=0){const b=d.value[C];throw new Error(`NFT classId: ${i.value} nftId:${b} is not owned by sender!`)}}else await M(s.value.quantity);await le({wallet:y.value});const n=await ae({address:i.value,abi:Ge,functionName:"batchTransferWithMemo",args:[y.value,Array(s.value.quantity).fill(s.value.wallet),d.value,Array(s.value.quantity).fill(S.value)]}),e=await oe({hash:n});(e==null?void 0:e.status)==="success"&&(await $fetch(`${c}/likernft/book/purchase/${i.value}/sent/${O.value}`,{method:"POST",body:{txHash:n,quantity:s.value.quantity||1},headers:{authorization:`Bearer ${L.value}`}}),await Le(te({name:"my-books-status-classId",params:{classId:i.value}})))}catch(n){console.error(n),h.value=n.toString()}finally{g.value=!1}}return(n,e)=>{const l=ge,C=qe,b=Be,_e=We,H=Oe,me=Pe,V=Me,ve=Ve,ye=Je,be=ze;return v(),B(be,null,{default:p(()=>[a("h1",tt,' Deliver NFT Book "'+r(t(de)||t(i))+'" ',1),t(h)?(v(),B(l,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${t(h)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:e[0]||(e[0]=f=>h.value="")},null,8,["title"])):A("",!0),t(g)?(v(),B(C,{key:1,animation:"carousel"},{indicator:p(()=>e[2]||(e[2]=[Y(" Loading... ")])),_:1})):A("",!0),t(D).isAuthenticated?(v(),B(b,{key:2,ui:{body:{base:"space-y-4"},footer:{base:"flex justify-center gap-2"}}},{footer:p(()=>[m(V,{label:"Sign and Send",disabled:t(j),size:"xl",onClick:pe},null,8,["disabled"])]),default:p(()=>[m(b,{ui:{body:{padding:""}}},{default:p(()=>{var f;return[a("table",at,[a("tbody",null,[a("tr",null,[a("th",nt,r(n.$t("table.buyer_email")),1),a("td",st,r(t(s).email),1)]),a("tr",null,[a("th",lt,r(n.$t("table.reader_email")),1),a("td",ot,r(((f=t(s).giftInfo)==null?void 0:f.toEmail)||t(s).email),1)]),a("tr",null,[a("th",rt,r(n.$t("table.status")),1),a("td",ut,r(t(s).status),1)]),a("tr",null,[e[3]||(e[3]=a("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),a("td",it,r(t(s).wallet),1)]),a("tr",null,[a("th",dt,r(n.$t("table.price_name")),1),a("td",ct,r(t(s).priceName),1)]),a("tr",null,[e[4]||(e[4]=a("th",{class:"text-left px-4 py-3"}," Price ",-1)),a("td",ft,r(t(s).price),1)]),a("tr",null,[e[5]||(e[5]=a("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),a("td",pt,r(t(s).quantity),1)]),a("tr",null,[e[6]||(e[6]=a("th",{class:"text-left px-4 py-3"}," Buyer message ",-1)),a("td",_t,r(t(s).message),1)]),a("tr",null,[e[7]||(e[7]=a("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),a("td",mt,r(t(s).from),1)])])])]}),_:1}),m(H,{label:"Enter Author's Message",error:t(P),hint:`${t(re)} / ${t(Z)}`},{default:p(()=>[m(_e,{modelValue:t(S),"onUpdate:modelValue":e[1]||(e[1]=f=>Ae(S)?S.value=f:null),placeholder:"default memo"},null,8,["modelValue"])]),_:1},8,["error","hint"]),m(H,{label:"Specify NFT ID",description:"Leave empty to auto-fetch NFT ID",error:t(x),ui:{description:"text-gray-400 dark:text-gray-600"}},{default:p(()=>[a("div",vt,[t(s).quantity?(v(),U("div",{key:0,class:X([t(s).quantity>1?"w-full":"flex-grow","space-y-1"])},[(v(!0),U(Ue,null,Re(t(s).quantity,f=>(v(),B(me,{key:`nft-id-input-${f}`,ref_for:!0,ref_key:"nftIdInputRef",ref:z,modelValue:t(q)[f-1],"onUpdate:modelValue":he=>t(q)[f-1]=he,class:"font-mono",readonly:!t(_),disabled:!t(_)},Ee({_:2},[t(s).quantity>1?{name:"leading",fn:p(()=>[a("span",yt,"#"+r(f),1)]),key:"0"}:void 0]),1032,["modelValue","onUpdate:modelValue","readonly","disabled"]))),128))],2)):A("",!0),m(V,{label:t(_)||t(k)&&!t(T)?"Confirm":"Edit",disabled:t(g)||t(k),variant:"outline",loading:t(k)&&!t(T),color:"gray",onClick:ce},null,8,["label","disabled","loading"]),m(ve,{class:X(["text-sm text-gray-600",{"sm:w-min":t(s).quantity<=1}])},{default:p(()=>e[8]||(e[8]=[Y(" OR ")])),_:1,__:[8]},8,["class"]),m(V,{label:`Auto-fetch NFT ID for ${t(s).quantity} NFTs`,disabled:t(g)||t(_),loading:t(T),variant:"outline",onClick:fe},null,8,["label","disabled","loading"])])]),_:1},8,["error"]),m(ye,{class:"h-[300px]"},{default:p(()=>[t($)?(v(),U("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",alt:"preview",src:t($)},null,8,bt)):A("",!0)]),_:1})]),_:1})):A("",!0)]),_:1})}}});export{Ft as default};
