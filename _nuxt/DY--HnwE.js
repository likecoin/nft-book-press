import{dv as bt,dw as wt,dx as st,dy as yt,dz as pt,dA as _t,cA as Ct,dB as vt,cD as B,dC as Tt,dD as ct,dE as Nt,dF as lt,dG as xt,dH as kt,cC as Ft,dI as It,c$ as At,d0 as Et,dJ as Rt,d3 as Dt,bt as Ut,a_ as Mt,a$ as St,b6 as $t,b8 as Bt,b9 as D,cV as Ot,ba as L,bb as q,bL as Pt,aS as H,aT as U,b3 as Q,bi as K,aW as J,b4 as b,bj as Lt,bA as jt,aX as tt,aU as j,bg as Vt,bY as Gt,bv as zt,bf as Wt,aY as qt,aV as et,bq as Ht,b7 as Kt,bF as Jt}from"./B9KV3Ijx.js";import{N as Yt,d as Xt}from"./CGLqMAcl.js";import{g as Zt,r as Qt,m as te,c as ee,d as ae,e as at,f as ne,b as Y,u as oe}from"./BSVciC6n.js";(function(){try{var t=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},n=new t.Error().stack;n&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[n]="71709e79-d372-40c6-9475-ec1200781876",t._sentryDebugIdIdentifier="sentry-dbid-71709e79-d372-40c6-9475-ec1200781876")}catch{}})();async function se(t,{address:n,blockNumber:o,blockTag:e=t.experimental_blockTag??"latest"}){const u=typeof o=="bigint"?bt(o):void 0,i=await t.request({method:"eth_getBalance",params:[n,u||e]});return BigInt(i)}async function re(t,n){const{account:o,authorizationList:e,allowFailure:u=!0,blockNumber:i,blockOverrides:f,blockTag:a,stateOverride:s}=n,r=n.contracts,{batchSize:_=n.batchSize??1024,deployless:m=n.deployless??!1}=typeof t.batch?.multicall=="object"?t.batch.multicall:{},d=(()=>{if(n.multicallAddress)return n.multicallAddress;if(m)return null;if(t.chain)return Zt({blockNumber:i,chain:t.chain,contract:"multicall3"});throw new Error("client chain not configured. multicallAddress is required.")})(),h=[[]];let g=0,F=0;for(let v=0;v<r.length;v++){const{abi:N,address:x,args:w,functionName:c}=r[v];try{const k=wt({abi:N,args:w,functionName:c});F+=(k.length-2)/2,_>0&&F>_&&h[g].length>0&&(g++,F=(k.length-2)/2,h[g]=[]),h[g]=[...h[g],{allowFailure:!0,callData:k,target:x}]}catch(k){const M=st(k,{abi:N,address:x,args:w,docsPath:"/docs/contract/multicall",functionName:c,sender:o});if(!u)throw M;h[g]=[...h[g],{allowFailure:!0,callData:"0x",target:x}]}}const C=await Promise.allSettled(h.map(v=>yt(t,Qt,"readContract")({...d===null?{code:ee}:{address:d},abi:te,account:o,args:[v],authorizationList:e,blockNumber:i,blockOverrides:f,blockTag:a,functionName:"aggregate3",stateOverride:s}))),T=[];for(let v=0;v<C.length;v++){const N=C[v];if(N.status==="rejected"){if(!u)throw N.reason;for(let w=0;w<h[v].length;w++)T.push({status:"failure",error:N.reason,result:void 0});continue}const x=N.value;for(let w=0;w<x.length;w++){const{returnData:c,success:k}=x[w],{callData:M}=h[v][w],{abi:O,address:V,functionName:I,args:P}=r[T.length];try{if(M==="0x")throw new pt;if(!k)throw new _t({data:c});const S=ae({abi:O,args:P,data:c,functionName:I});T.push(u?{result:S,status:"success"}:S)}catch(S){const G=st(S,{abi:O,address:V,args:P,docsPath:"/docs/contract/multicall",functionName:I});if(!u)throw G;T.push({error:G,result:void 0,status:"failure"})}}}if(T.length!==r.length)throw new Ct("multicall results mismatch");return T}function ut(t){return typeof t=="number"?t:t==="wei"?0:Math.abs(vt[t])}async function ie(t,n){const{allowFailure:o=!0,chainId:e,contracts:u,...i}=n,f=t.getClient({chainId:e});return B(f,re,"multicall")({allowFailure:o,contracts:u,...i})}async function ce(t,n){const{allowFailure:o=!0,blockNumber:e,blockTag:u,...i}=n,f=n.contracts;try{const a={};for(const[m,d]of f.entries()){const h=d.chainId??t.state.chainId;a[h]||(a[h]=[]),a[h]?.push({contract:d,index:m})}const s=()=>Object.entries(a).map(([m,d])=>ie(t,{...i,allowFailure:o,blockNumber:e,blockTag:u,chainId:Number.parseInt(m),contracts:d.map(({contract:h})=>h)})),r=(await Promise.all(s())).flat(),_=Object.values(a).flatMap(m=>m.map(({index:d})=>d));return r.reduce((m,d,h)=>(m&&(m[_[h]]=d),m),[])}catch(a){if(a instanceof Tt)throw a;const s=()=>f.map(r=>at(t,{...r,blockNumber:e,blockTag:u}));return o?(await Promise.allSettled(s())).map(r=>r.status==="fulfilled"?{result:r.value,status:"success"}:{error:r.reason,result:void 0,status:"failure"}):await Promise.all(s())}}async function le(t,n){const{address:o,blockNumber:e,blockTag:u,chainId:i,token:f,unit:a="ether"}=n;if(f)try{return await rt(t,{balanceAddress:o,chainId:i,symbolType:"string",tokenAddress:f})}catch(d){if(d.name==="ContractFunctionExecutionError"){const h=await rt(t,{balanceAddress:o,chainId:i,symbolType:"bytes32",tokenAddress:f}),g=ct(Nt(h.symbol,{dir:"right"}));return{...h,symbol:g}}throw d}const s=t.getClient({chainId:i}),_=await B(s,se,"getBalance")(e?{address:o,blockNumber:e}:{address:o,blockTag:u}),m=t.chains.find(d=>d.id===i)??s.chain;return{decimals:m.nativeCurrency.decimals,formatted:lt(_,ut(a)),symbol:m.nativeCurrency.symbol,value:_}}async function rt(t,n){const{balanceAddress:o,chainId:e,symbolType:u,tokenAddress:i,unit:f}=n,a={abi:[{type:"function",name:"balanceOf",stateMutability:"view",inputs:[{type:"address"}],outputs:[{type:"uint256"}]},{type:"function",name:"decimals",stateMutability:"view",inputs:[],outputs:[{type:"uint8"}]},{type:"function",name:"symbol",stateMutability:"view",inputs:[],outputs:[{type:u}]}],address:i},[s,r,_]=await ce(t,{allowFailure:!1,contracts:[{...a,functionName:"balanceOf",args:[o],chainId:e},{...a,functionName:"decimals",chainId:e},{...a,functionName:"symbol",chainId:e}]}),m=lt(s??"0",ut(f??r));return{decimals:r,formatted:m,symbol:_,value:s}}async function it(t,n){const{chainId:o,timeout:e=0,...u}=n,i=t.getClient({chainId:o}),a=await B(i,xt,"waitForTransactionReceipt")({...u,timeout:e});if(a.status==="reverted"){const r=await B(i,kt,"getTransaction")({hash:a.transactionHash}),m=await B(i,ne,"call")({...r,data:r.input,gasPrice:r.type!=="eip1559"?r.gasPrice:void 0,maxFeePerGas:r.type==="eip1559"?r.maxFeePerGas:void 0,maxPriorityFeePerGas:r.type==="eip1559"?r.maxPriorityFeePerGas:void 0}),d=m?.data?ct(`0x${m.data.substring(138)}`):"unknown reason";throw new Error(d)}return{...a,chainId:i.chain.id}}async function ue(t,n){const{account:o,chainId:e,connector:u,...i}=n;let f;return typeof o=="object"&&o?.type==="local"?f=t.getClient({chainId:e}):f=await Ft(t,{account:o??void 0,chainId:e,connector:u}),await B(f,It,"writeContract")({...i,...o?{account:o}:{},chain:e?{id:e}:null})}function de(t){return{mutationFn(n){return ue(t,n)},mutationKey:["writeContract"]}}function dt(t={}){const{mutation:n}=t,o=At(t),e=de(o),{mutate:u,mutateAsync:i,...f}=Et({...n,...e});return{...f,writeContract:u,writeContractAsync:i}}const me=()=>{const{writeContractAsync:t}=dt(),{$wagmiConfig:n}=Rt(),o=async({classId:a,wallet:s},r)=>{const _=await at(n,{abi:Y,address:a,functionName:r});if(!await at(n,{abi:Y,address:a,functionName:"hasRole",args:[_,s]})){const d=await t({abi:Y,address:a,functionName:"ownerGrantRole",args:[_,s]});console.log(`Granted ${r} to ${s} in class ${a}. Transaction hash: ${d}`)}},e=async({classId:a,wallet:s})=>(await i({wallet:s}),o({classId:a,wallet:s},"UPDATER_ROLE")),u=async({classId:a,wallet:s})=>(await i({wallet:s}),o({classId:a,wallet:s},"MINTER_ROLE")),i=async({wallet:a})=>{const s=await le(n,{address:a});if(s.value<=0n)throw new Error("INSUFFICIENT_BASE_ETH_BALANCE");return s};return{checkAndGrantUpdater:e,checkAndGrantMinter:u,assertPositiveWalletBalance:i,waitForTransactionReceipt:async a=>{let s;try{s=await it(n,a)}catch{await Dt(3e3),s=await it(n,a)}return s}}},fe=()=>{const t=Ut();return{showErrorToast:o=>{t.add({icon:"i-heroicons-exclamation-circle",title:o,timeout:3e3,color:"red"})}}},he={class:"flex flex-col items-stretch grow space-y-4"},ge=["textContent"],be={class:"flex justify-center"},we=["src"],ye={key:1,class:"w-full"},pe={class:"space-y-3"},_e={class:"flex justify-between items-center"},Ce={class:"text-xs text-gray-500"},ve={key:2,class:"flex justify-center"},Te=Mt({__name:"LiteMintNFT",props:{iscnData:{type:Object,default:null},shouldShowSubmit:{type:Boolean,default:!0},iscnId:{type:String,default:""},isRestock:{type:Boolean,default:!1},restockCount:{type:Number,default:0}},emits:["submit","formValidChange"],setup(t,{expose:n,emit:o}){const{t:e}=St(),{writeContractAsync:u}=dt(),{getClassOwner:i,getClassMetadata:f,checkNFTClassIsBookNFT:a,getClassCurrentTokenId:s}=oe(),{checkAndGrantMinter:r,waitForTransactionReceipt:_}=me(),m=$t(),{wallet:d}=Bt(m),{validateWalletConsistency:h}=m,g=t,F=D(""),C=D(!1),T=D(null),v=D(""),N=D([]),x=D(null),w=D(g.iscnId||""),c=Ot({mintCount:Yt,imageUrl:"",externalUrl:""}),k=o,{showErrorToast:M}=fe(),O=L(()=>{const l={mintCount:c.mintCount!==void 0,imageUrl:!!c.imageUrl};return Object.entries(l).filter(([y,p])=>!p).map(([y])=>y.toUpperCase())}),V=L(()=>!O.value?.length),I=L(()=>T.value?.contentMetadata?.name||""),P=L(()=>Jt(c.imageUrl)),S=L(()=>I.value?g.isRestock?I.value:e("nft.mint_by_filling_info",{bookName:I.value}):e("nft.minting_loading"));q(V,l=>{k("formValidChange",l)},{immediate:!0}),q(C,l=>{l&&(F.value="")},{immediate:!0}),Pt(async()=>{g.iscnData?(T.value=g.iscnData,v.value=g.iscnData["@id"],c.imageUrl=g.iscnData.contentMetadata?.thumbnailUrl||"",w.value=g.iscnData["@id"]):g.iscnId&&await ft(g.iscnId)}),q(C,l=>{l&&(F.value="")}),q(()=>g.isRestock,l=>{l&&(g.restockCount<0?c.mintCount=Math.abs(g.restockCount):c.mintCount=Xt)},{immediate:!0});function G({nftMintCount:l,imgUrl:y}){const p=[];for(let A=0;A<l;A++)p.push({image:y,metadata:""});return p}async function nt(){try{const{contentMetadata:l}=T.value;if(!V.value){const p=O.value.join(", ");M(e("errors.required_field_missing",{fields:p}));return}C.value=!0;const y={metadata:{name:l.name,description:l.description,symbol:"BOOK",...l,image:c.imageUrl,external_url:c.externalUrl}};typeof c.mintCount!="number"&&(c.mintCount=Number(c.mintCount)),x.value=y,N.value=G({nftMintCount:c.mintCount,imgUrl:c.imageUrl}),c.mintCount=N.value.length,c.mintCount>0&&await mt(),w.value&&k("submit",{classId:w.value,nftMintCount:c.mintCount})}catch(l){console.error(l),M(`${e("nft.mint_error")}: ${l.toString()}`)}finally{C.value=!1}}async function mt(){try{if(C.value=!0,d.value||await h(),!d.value)return;if(!x.value)throw new Error(e("errors.no_mint_data"));const l=x.value.metadata,y=[...Array(c.mintCount).keys()].map(E=>{const{image:R,metadata:z,...ht}=N?.value?.[E]||{},gt=JSON.parse(z||"{}"),W={...l,...gt};return R&&(W.image=R),Object.entries(ht).forEach(([ot,Z])=>{if(Z)try{W[ot]=JSON.parse(Z)}catch{W[ot]=Z}}),{id:-1,metadata:W}}),p=await s(w.value),{BOOK3_URL:A}=Kt().public;await r({classId:w.value,wallet:d.value});const X=await u({address:w.value,abi:Y,functionName:"safeMintWithTokenId",args:[p,Array(c.mintCount).fill(d.value),Array(c.mintCount).fill(""),y.map((E,R)=>JSON.stringify({image:E.metadata.image,external_url:`${A}/store/${w.value}/${Number(p)+R}`,description:`Copy #${Number(p)+R} of ${E.metadata.name}`,name:`${E.metadata.name} #${Number(p)+R}`,attributes:E.metadata.attributes}))]}),$=await _({hash:X});if(console.log($),!$||$.status!=="success")throw new Error("INVALID_RECEIPT");if(!$.logs?.[0]?.topics?.[3])throw new Error("INVALID_NFT_ID")}catch(l){throw new Error("MINT_NFT_ERROR:"+l.toString())}finally{C.value=!1}}async function ft(l){C.value=!0;try{if(v.value=l,!await a(l))throw new Error("Invalid NFT Class ID");const[p,A]=await Promise.all([f(l),i(l)]);if(!p)throw new Error("Invalid NFT Class ID");T.value={contentMetadata:p,owner:A,"@id":l},c.imageUrl=T.value.contentMetadata?.thumbnailUrl||"",c.externalUrl=T.value.contentMetadata?.url||"",w.value=l}catch(y){console.error(y)}finally{C.value=!1}}return n({startNFTMintFlow:nt}),(l,y)=>{const p=Lt,A=Vt,X=zt,$=Wt,E=Ht,R=jt;return U(),H("div",he,[b(F)?(U(),Q(p,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${b(F)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:y[0]||(y[0]=z=>F.value="")},null,8,["title"])):K("",!0),J(R,{class:"flex-1",ui:{body:{base:"space-y-4"}}},{header:tt(()=>[j("h3",{class:"font-bold text-center",textContent:et(b(S))},null,8,ge)]),default:tt(()=>[j("div",be,[b(P)?(U(),H("img",{key:1,src:b(P),alt:"Cover preview",class:Gt([t.isRestock?"max-w-[150px]":"max-w-[300px]","object-contain","rounded-lg","border","border-gray-200"])},null,10,we)):(U(),Q(A,{key:0,animation:"carousel",color:"primary",class:"w-full"}))]),t.isRestock&&b(I)?(U(),Q(X,{key:0,modelValue:b(c).mintCount,"onUpdate:modelValue":y[1]||(y[1]=z=>b(c).mintCount=z),type:"number",class:"w-full max-w-[180px] mx-auto",placeholder:b(e)("nft.mint_count_placeholder")},null,8,["modelValue","placeholder"])):K("",!0),b(C)&&b(I)?(U(),H("div",ye,[j("div",pe,[j("div",_e,[J($,{variant:"soft"},{default:tt(()=>[qt(et(t.isRestock?b(e)("nft.minting_restock"):b(e)("nft.minting")),1)]),_:1}),j("p",Ce,et(t.isRestock?b(e)("nft.minting_restock_in_progress",{count:b(c).mintCount}):b(e)("nft.minting_in_progress")),1)]),J(A,{animation:"carousel",color:"primary",class:"w-full"})])])):K("",!0),t.shouldShowSubmit?(U(),H("div",ve,[J(E,{label:b(I)?b(e)("common.submit"):b(e)("loading.progress"),loading:b(C),size:"lg",disabled:b(C),onClick:nt},null,8,["label","loading","disabled"])])):K("",!0)]),_:1})])}}}),Ie=Object.assign(Te,{__name:"LiteMintNFT"});export{Ie as _,fe as a,dt as b,le as g,me as u};
