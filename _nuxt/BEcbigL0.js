import{n as xe,O as Ne,Q as Ce,R as Y,P as Te,a0 as ke,u as Fe,I as Se,r as s,s as L,h as Z,x as Be,o as y,A as E,w as p,a9 as ee,U as te,a as l,t as i,B as t,J as B,d as ae,b as u,C as $e,c as A,D as Ee,F as oe,y as Ae,aa as Re,X as De,a1 as Ue,M as qe,G as Me,E as Pe}from"./WyIghNlr.js";import{_ as Ve}from"./BX2G8TQM.js";import{_ as Le}from"./BIvgZvzz.js";import{_ as Oe}from"./B_cLSFOR.js";import{u as ze,_ as We}from"./B1kcrfDQ.js";import{_ as je}from"./vTWx-f3y.js";import{u as Ge}from"./RlU746B2.js";import{u as He,L as Ke}from"./BHv8MdEE.js";import{u as Qe,w as Je}from"./D9rvdW7R.js";import"./9LjtXBc7.js";(function(){try{var x=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},N=new Error().stack;N&&(x._sentryDebugIds=x._sentryDebugIds||{},x._sentryDebugIds[N]="8b284a89-3e6a-44d3-9fe7-c18d8f8ecf45",x._sentryDebugIdIdentifier="sentry-dbid-8b284a89-3e6a-44d3-9fe7-c18d8f8ecf45")}catch{}})();const Xe={class:"text-lg font-bold font-mono"},Ye={class:"divide-y w-full"},Ze={class:"px-4 py-3"},et={class:"px-4 py-3"},tt={class:"px-4 py-3"},at={class:"px-4 py-3"},ot={class:"px-4 py-3"},lt={class:"text-left px-4 py-3"},nt={class:"px-4 py-3"},st={class:"px-4 py-3"},rt={class:"flex flex-wrap items-center justify-center gap-2"},it=["src"],wt=xe({__name:"[collectionId]",setup(x){const{LIKE_CO_API:N}=Ne().public,R=Ce(),{wallet:C,signer:D}=Y(R),{initIfNecessary:O}=R,z=Te(),{token:W}=Y(z),j=Ge(),U=ke(),{lazyFetchClassMetadataById:le}=j,{lazyFetchCollectionById:ne}=U,{getNFTMetadata:G,getNFTOwner:se,getBalanceOf:re,getTokenIdByOwnerIndex:ie}=He(),{writeContractAsync:ue}=Qe(),q=Fe(),ce=Se(),v=s(""),_=s(!1),g=s(q.params.collectionId),H=s(q.query.payment_id),T=s(q.query.owner_wallet||C.value),k=s(""),{messageCharCount:de,isLimitReached:K}=ze(k,ee),c=s([]),I=s([]),h=s(!1),b=s(!1),F=s(""),d=s(!1),Q=s(void 0),n=s({}),S=s([]),J=L(()=>d.value||_.value||h.value||b.value||!!F.value||K.value),fe=L(()=>{var o;return(o=U.getCollectionById(g.value))==null?void 0:o.name}),m=L(()=>{var o;return(o=U.getCollectionById(g.value))==null?void 0:o.classIds});Z(_,o=>{o&&(v.value="")}),Z(d,o=>{o||c.value.forEach(async(e,a)=>{if(e){const r=await G(m.value[a],parseInt(e,10));S.value[a]=te(r==null?void 0:r.image)}else S.value[a]=""})}),Be(async()=>{const o=await $fetch(`${N}/likernft/book/collection/purchase/${g.value}/status/${H.value}`,{headers:{authorization:`Bearer ${W.value}`}});n.value=o,await ne(g.value),await Promise.all(m.value.map(e=>le(e))),M(n.value.quantity||1)});function pe(o){var e;return(e=j.getClassMetadataById(o))==null?void 0:e.name}function me(){d.value=!d.value,F.value="",Ae(()=>{var o,e,a;d.value&&((a=(e=(o=Q.value)==null?void 0:o.$refs)==null?void 0:e.input)==null||a.focus())})}async function ye(o,e){try{h.value=!0;const a=await G(o,parseInt(e,10));return te(a==null?void 0:a.image)}catch(a){return v.value=a.toString(),""}finally{h.value=!1}}async function M(o=1){try{if(F.value="",b.value=!0,I.value=[],(!C.value||!D.value)&&await O(),!T.value)return;await Promise.all(m.value.map(async(e,a)=>{if(!I.value[a]){const r=await re(e,T.value);if(Number(r)<o)throw new Error(`Insufficient balance of NFT classId: ${e} for wallet: ${T.value}`);I.value[a]=[];for(let w=0;w<o;w++){const P=await ie(e,T.value,w);I.value[a].push(P),c.value[a]=I.value[a][0],S.value[a]=await ye(e,c.value[a])||""}}}))}catch(e){v.value=e.toString()}finally{b.value=!1}}function ve(){M(n.value.quantity||1)}async function _e(){if(!J.value)try{if(_.value=!0,(!C.value||!D.value)&&await O(),!C.value||!D.value)return;if(await M(n.value.quantity),await Promise.all(m.value.map(async(a,r)=>{if(c.value[r]&&await se(a,parseInt(c.value[r],10))!==T.value)throw new Error(`NFT classId: ${a} nftId:${c.value[r]} is not owned by sender!`)})),m.value.find(a=>!a))throw new Error("Please specify NFT class ID");if(c.value.find(a=>!a))throw new Error("Please specify NFT ID");let o,e;for(let a=0;a<m.value.length;a++){const r=m.value[a];e=await ue({address:r,abi:Ke,functionName:"batchTransferWithMemo",args:[C.value,Array(n.value.quantity).fill(n.value.wallet),I.value[a],Array(n.value.quantity).fill(k.value)]}),o=await Je(Re,{hash:e})}(o==null?void 0:o.status)==="success"&&(await $fetch(`${N}/likernft/book/collection/purchase/${g.value}/sent/${H.value}`,{method:"POST",body:{txHash:e,quantity:n.value.quantity||1},headers:{authorization:`Bearer ${W.value}`}}),ce.push({name:"nft-book-store-collection-status-collectionId",params:{collectionId:g.value}}))}catch(o){console.error(o),v.value=o.toString()}finally{_.value=!1}}return(o,e)=>{const a=De,r=Ue,w=qe,P=Ve,X=Le,ge=Oe,V=Me,we=Pe,Ie=We,he=je;return y(),E(he,null,{default:p(()=>[l("h1",Xe,' Deliver NFT Book Collection "'+i(t(fe)||t(g))+'" ',1),t(v)?(y(),E(a,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${t(v)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:e[0]||(e[0]=f=>v.value="")},null,8,["title"])):B("",!0),t(_)?(y(),E(r,{key:1,animation:"carousel"},{indicator:p(()=>e[2]||(e[2]=[ae(" Loading... ")])),_:1})):B("",!0),t(z).isAuthenticated?(y(),E(w,{key:2,ui:{body:{base:"space-y-4"},footer:{base:"flex justify-center gap-2"}}},{footer:p(()=>[u(V,{label:"Sign and Send",disabled:t(J),size:"xl",onClick:_e},null,8,["disabled"])]),default:p(()=>[u(w,{ui:{body:{padding:""}}},{default:p(()=>{var f;return[l("table",Ye,[l("tbody",null,[l("tr",null,[e[3]||(e[3]=l("th",{class:"text-left px-4 py-3"}," Buyer Email ",-1)),l("td",Ze,i(t(n).email),1)]),l("tr",null,[e[4]||(e[4]=l("th",{class:"text-left px-4 py-3"}," Reader Email ",-1)),l("td",et,i(((f=t(n).giftInfo)==null?void 0:f.toEmail)||t(n).email),1)]),l("tr",null,[e[5]||(e[5]=l("th",{class:"text-left px-4 py-3"}," Status ",-1)),l("td",tt,i(t(n).status),1)]),l("tr",null,[e[6]||(e[6]=l("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),l("td",at,i(t(n).wallet),1)]),l("tr",null,[e[7]||(e[7]=l("th",{class:"text-left px-4 py-3"}," Price ",-1)),l("td",ot,i(t(n).price),1)]),l("tr",null,[e[8]||(e[8]=l("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),l("td",lt,i(t(n).quantity),1)]),l("tr",null,[e[9]||(e[9]=l("th",{class:"text-left px-4 py-3"}," Buyer message ",-1)),l("td",nt,i(t(n).message),1)]),l("tr",null,[e[10]||(e[10]=l("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),l("td",st,i(t(n).from),1)])])])]}),_:1}),u(X,{label:"Enter Author's Message",error:t(K),hint:`${t(de)} / ${t(ee)}`},{default:p(()=>[u(P,{modelValue:t(k),"onUpdate:modelValue":e[1]||(e[1]=f=>$e(k)?k.value=f:null),placeholder:"default memo"},null,8,["modelValue"])]),_:1},8,["error","hint"]),u(X,{label:"Specify NFT ID",error:t(F)},{default:p(()=>[(y(!0),A(oe,null,Ee(t(m),(f,$)=>(y(),A("div",{key:f},[l("label",null,i(pe(f)+": "+f),1),l("div",rt,[t(n).quantity===1?(y(),A(oe,{key:0},[u(ge,{ref_for:!0,ref_key:"nftIdInputRef",ref:Q,modelValue:t(c)[$],"onUpdate:modelValue":be=>t(c)[$]=be,class:"font-mono flex-grow",readonly:!t(d),disabled:!t(d),placeholder:"Leave empty to auto-fetch NFT ID","trailing-icon":t(F)?"i-heroicons-exclamation-triangle-20-solid":void 0},null,8,["modelValue","onUpdate:modelValue","readonly","disabled","trailing-icon"]),u(V,{label:t(d)||t(h)&&!t(b)?"Confirm":"Edit",disabled:t(_)||t(h),variant:"outline",loading:t(h)&&!t(b),color:"gray",onClick:me},null,8,["label","disabled","loading"]),u(we,{class:"text-sm text-gray-600 sm:w-min"},{default:p(()=>e[11]||(e[11]=[ae(" OR ")])),_:1})],64)):B("",!0),u(V,{label:`Auto-fetch NFT ID for ${t(n).quantity} orders`,disabled:t(_)||t(d),loading:t(b),variant:"outline",onClick:ve},null,8,["label","disabled","loading"])]),u(Ie,{class:"h-[300px]"},{default:p(()=>[t(S)[$]?(y(),A("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",src:t(S)[$]},null,8,it)):B("",!0)]),_:2},1024)]))),128))]),_:1},8,["error"])]),_:1})):B("",!0)]),_:1})}}});export{wt as default};
//# sourceMappingURL=BEcbigL0.js.map
