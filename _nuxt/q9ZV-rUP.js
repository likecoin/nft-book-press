import{aQ as Fe,aS as $,aT as i,aU as a,bY as Be,ba as x,a_ as Re,a$ as Ue,b7 as Z,b6 as Me,b8 as ee,bz as Ve,bk as qe,b0 as Ee,b9 as f,bb as te,b1 as Ae,b3 as k,aX as p,bC as Le,bi as y,aW as h,aV as l,b4 as e,bj as We,bf as De,aY as ae,bD as Oe,bv as Pe,bd as ne,b$ as se,bo as ze,bp as je,bw as Qe,cc as Ge,br as He,bx as Ke,bg as Ye,b2 as Xe}from"./DzF9i0mN.js";import{_ as Je}from"./DyuhMv0S.js";import{b as Ze,u as et,_ as tt}from"./NiigBXA4.js";import{_ as at}from"./DGnbXaoB.js";import{a as nt,u as oe,b as st}from"./BD0l2zRg.js";import{b as le}from"./DXk0l7Sg.js";(function(){try{var c=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},o=new c.Error().stack;o&&(c._sentryDebugIds=c._sentryDebugIds||{},c._sentryDebugIds[o]="bb662e1b-4e36-447a-bffd-16e355e00589",c._sentryDebugIdIdentifier="sentry-dbid-bb662e1b-4e36-447a-bffd-16e355e00589")}catch{}})();const ot={},lt={class:"relative overflow-hidden rounded border border-dashed border-gray-400 dark:border-gray-500 opacity-75 flex items-center justify-center p-4"};function rt(c,o){return i(),$("div",lt,[o[0]||(o[0]=a("svg",{class:"absolute inset-0 h-full w-full stroke-gray-900/10 dark:stroke-white/10",fill:"none"},[a("defs",null,[a("pattern",{id:"placeholder-pattern",x:"0",y:"0",width:"10",height:"10",patternUnits:"userSpaceOnUse"},[a("path",{d:"M-3 13 15-5M-5 5l18-18M-1 21 17 3"})])]),a("rect",{stroke:"none",fill:"url(#placeholder-pattern)",width:"100%",height:"100%"})],-1)),Be(c.$slots,"default")])}const ut=Fe(ot,[["render",rt]]);function it(c){return c.charCodeAt(0)>255}function ct(c,o){const T=x(()=>{let b=0;for(let I=0;I<c.value.length;I++)b+=it(c.value[I])?2:1;return b}),E=x(()=>T.value>o);return{messageCharCount:T,isLimitReached:E}}const dt={class:"text-lg font-bold font-mono"},ft={class:"divide-y w-full"},_t={class:"text-left px-4 py-3"},mt={class:"px-4 py-3"},vt={key:0},pt={class:"text-left px-4 py-3"},bt={class:"px-4 py-3"},yt={class:"text-left px-4 py-3"},ht={class:"px-4 py-3"},xt={class:"px-4 py-3"},gt={class:"text-left px-4 py-3"},wt={class:"px-4 py-3"},kt={class:"px-4 py-3"},It={class:"px-4 py-3"},Ct={class:"px-4 py-3"},Nt={class:"space-y-2 mb-4"},$t=["textContent"],Tt=["textContent"],St={class:"flex flex-wrap items-center justify-center gap-2 w-full"},Ft={class:"text-sm text-gray-400 dark:text-gray-600"},Bt=["textContent"],Rt=["textContent"],Ut=["src"],Wt=Re({__name:"[classId]",setup(c){const{t:o}=Ue(),{LIKE_CO_API:T}=Z().public,E=Me(),{wallet:b,signer:I}=ee(E),{validateWalletConsistency:O}=E,P=Ve(),{token:z}=ee(P),j=nt(),{lazyFetchClassMetadataById:re}=j,L=qe(),ue=Ee(),{writeContractAsync:ie}=Ze(),{getBalanceOf:ce,getTokenIdByOwnerIndex:de}=oe(),{assertPositiveWalletBalance:fe,waitForTransactionReceipt:_e}=et(),g=f({message:"",actions:[]}),C=f(!1),r=x(()=>L.params.classId),Q=x(()=>L.query.payment_id),R=x(()=>L.query.owner_wallet||b.value),U=f(o("nft_book_form.default_memo")),{messageCharCount:me,isLimitReached:G}=ct(U,le),{getNFTMetadata:ve,getNFTOwner:H}=oe(),S=f([]),u=f([]),M=f(!1),w=f(""),F=f(!1),pe=f(void 0),s=f({}),V=f(""),q=f(!1),N=f(""),{NFT_ITEM_URL:be}=Z().public,K=x(()=>S.value.some(n=>n.trim()!=="")),Y=x(()=>C.value||M.value||!!w.value||G.value||!F.value),B=x(()=>s.value.quantity===1),ye=x(()=>{var n;return(n=j.getClassMetadataById(r.value))==null?void 0:n.name});te(C,n=>{n&&(g.value={message:"",actions:[]})}),te(S,(n,t)=>{t&&t.length>0&&B.value&&(F.value=!1,N.value="",w.value="")},{deep:!0}),Ae(async()=>{const n=await $fetch(`${T}/likernft/book/purchase/${r.value}/status/${Q.value}`,{headers:{authorization:`Bearer ${z.value}`}});s.value=n,re(r.value),await W(s.value.quantity||1)});async function he(){if(K.value)try{if(N.value="",w.value="",u.value=S.value.filter(_=>_.trim()!=="").map(_=>Number(_)),u.value.includes(0)){N.value=o("error.nft_id_reserved_for_author"),u.value=[];return}const[n,t]=await Promise.all([X(),H(r.value,u.value[0])]);if(!n||t!==b.value){N.value=o("error.fetch_nft_metadata_failed"),u.value=[];return}F.value=!0}catch(n){N.value=n.message,u.value=[],F.value=!1}}async function X(){var n;try{if(M.value=!0,!u.value.length||u.value[0]===void 0){V.value="";return}try{const t=await ve(r.value,u.value[0]);return V.value=Le(t==null?void 0:t.image),t}catch(t){V.value="",((n=t==null?void 0:t.data)==null?void 0:n.code)===2?w.value="NFT not found":w.value=t.toString()}}catch(t){g.value={message:t.toString(),actions:[]}}finally{M.value=!1}}async function W(n=1){try{if(u.value=[],w.value="",(!b.value||!I.value)&&await O(),!R.value)throw new Error("Missing owner wallet");const t=await ce(r.value,R.value);if(t<BigInt(n))throw new Error(`No NFTs available for classId: ${r.value} in wallet: ${R.value}`);const d=[];for(let _=0;_<Number(t);_++){const m=await de(r.value,R.value,_);if(m!==0n&&(d.push(Number(m)),d.length>=n))break}if(d.length<n)throw new Error(`Failed to collect enough available NFTs. Collected ${d.length}/${n}`);u.value=d,S.value=d.map(String),F.value=!0,await X()}catch(t){const d=t.toString();w.value=d,g.value={message:d,actions:[{label:o("button.restock_nft"),variant:"outline",color:"red",click:()=>{q.value=!0}}]}}}function xe(){window.open(`${be}/${r.value}`,"_blank","noopener")}async function ge(){if(!Y.value)try{if(C.value=!0,(!b.value||!I.value)&&await O(),!b.value||!I.value)return;if(u.value){const _=(await Promise.all(u.value.map(m=>H(r.value,m)))).findIndex(m=>m!==R.value);if(_>=0){const m=u.value[_];throw new Error(`NFT classId: ${r.value} nftId:${m} is not owned by sender!`)}}else await W(s.value.quantity);await fe({wallet:b.value});const n=await ie({address:r.value,abi:st,functionName:"batchTransferWithMemo",args:[b.value,Array(s.value.quantity).fill(s.value.wallet),u.value,Array(s.value.quantity).fill(U.value)]}),t=await _e({hash:n});(t==null?void 0:t.status)==="success"&&(await $fetch(`${T}/likernft/book/purchase/${r.value}/sent/${Q.value}`,{method:"POST",body:{txHash:n,quantity:s.value.quantity||1},headers:{authorization:`Bearer ${z.value}`}}),await Xe(ue({name:"my-books-status-classId",params:{classId:r.value}})))}catch(n){console.error(n),g.value={message:n.toString(),actions:[]}}finally{C.value=!1}}function we(){q.value=!1,W(s.value.quantity||1)}return(n,t)=>{const d=We,_=De,m=Oe,ke=Je,J=Pe,Ie=Qe,D=He,Ce=Ke,Ne=ut,$e=tt,Te=Ye,Se=at;return i(),k(Se,null,{default:p(()=>[a("h1",dt,' Deliver NFT Book "'+l(e(ye)||e(r))+'" ',1),e(g).message?(i(),k(d,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${e(g).message}`,actions:e(g).actions,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:t[0]||(t[0]=v=>g.value={message:"",actions:[]})},null,8,["title","actions"])):y("",!0),e(C)?(i(),k(_,{key:1,animation:"carousel"},{indicator:p(()=>t[3]||(t[3]=[ae(" Loading... ")])),_:1})):y("",!0),e(P).isAuthenticated?(i(),k(m,{key:2,ui:{body:{base:"space-y-6"},footer:{base:"flex justify-center gap-2"}}},{footer:p(()=>[h(D,{label:e(o)("nft_send.sign_and_send"),disabled:e(Y),size:"xl",onClick:ge},null,8,["label","disabled"])]),default:p(()=>[h(m,{ui:{body:{padding:""}}},{default:p(()=>{var v,A;return[a("table",ft,[a("tbody",null,[a("tr",null,[a("th",_t,l(e(o)("table.buyer_email")),1),a("td",mt,l(e(s).email),1)]),(v=e(s).giftInfo)!=null&&v.toEmail?(i(),$("tr",vt,[a("th",pt,l(e(o)("table.reader_email")),1),a("td",bt,l(((A=e(s).giftInfo)==null?void 0:A.toEmail)||e(s).email),1)])):y("",!0),a("tr",null,[a("th",yt,l(e(o)("table.status")),1),a("td",ht,l(e(s).status),1)]),a("tr",null,[t[4]||(t[4]=a("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),a("td",xt,l(e(s).wallet),1)]),a("tr",null,[a("th",gt,l(e(o)("table.price_name")),1),a("td",wt,l(e(s).priceName),1)]),a("tr",null,[t[5]||(t[5]=a("th",{class:"text-left px-4 py-3"}," Price ",-1)),a("td",kt,l(e(s).price),1)]),a("tr",null,[t[6]||(t[6]=a("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),a("td",It,l(e(s).quantity),1)]),a("tr",null,[t[7]||(t[7]=a("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),a("td",Ct,l(e(s).from),1)])])])]}),_:1}),h(m,null,{default:p(()=>[a("div",Nt,[a("h5",{class:"text-sm font-bold",textContent:l(`${e(o)("nft_book_form.buyer_message")}`)},null,8,$t),a("p",{textContent:l(e(s).message)},null,8,Tt)]),h(J,{label:e(o)("nft_book_form.author_message"),error:e(G),hint:`${e(me)} / ${e(le)}`},{default:p(()=>[h(ke,{modelValue:e(U),"onUpdate:modelValue":t[1]||(t[1]=v=>ne(U)?U.value=v:null)},null,8,["modelValue"])]),_:1},8,["label","error","hint"])]),_:1}),h(J,{label:e(o)("form.nft_id_label"),class:"mb-4",error:e(w),ui:{description:"text-gray-400 dark:text-gray-600"}},{default:p(()=>[a("div",St,[e(s).quantity?(i(),$("div",{key:0,class:se([e(s).quantity>1?"w-full":"flex-grow","space-y-1","relative"])},[(i(!0),$(ze,null,je(e(s).quantity,v=>(i(),k(Ie,{key:`nft-id-input-${v}`,ref_for:!0,ref_key:"nftIdInputRef",ref:pe,modelValue:e(S)[v-1],"onUpdate:modelValue":A=>e(S)[v-1]=A,disabled:!e(B),class:"font-mono"},Ge({_:2},[e(s).quantity>1?{name:"leading",fn:p(()=>[a("span",Ft,"#"+l(v),1)]),key:"0"}:void 0]),1032,["modelValue","onUpdate:modelValue","disabled"]))),128)),e(N)?(i(),$("span",{key:0,class:"text-xs text-red-500 absolute",textContent:l(e(N))},null,8,Bt)):e(F)&&e(B)?(i(),$("span",{key:1,class:"text-xs text-green-500 absolute",textContent:l(e(o)("button.confirmed"))},null,8,Rt)):y("",!0)],2)):y("",!0),e(B)?(i(),k(D,{key:1,label:e(o)("button.confirm_nft_id"),disabled:e(C)||e(M)||!e(K),variant:"outline",loading:e(M),color:"primary",onClick:he},null,8,["label","disabled","loading"])):y("",!0),e(B)?(i(),k(Ce,{key:2,class:se(["text-sm text-gray-600","sm:w-min"])},{default:p(()=>t[8]||(t[8]=[ae(" OR ")])),_:1,__:[8]})):y("",!0),e(B)?(i(),k(D,{key:3,label:e(o)("button.check_all_nft_ids"),disabled:e(C),variant:"outline",onClick:xe},null,8,["label","disabled"])):y("",!0)])]),_:1},8,["label","error"]),h(Ne,{class:"h-[300px]"},{default:p(()=>[e(V)?(i(),$("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",alt:"preview",src:e(V)},null,8,Ut)):y("",!0)]),_:1})]),_:1})):y("",!0),h(Te,{modelValue:e(q),"onUpdate:modelValue":t[2]||(t[2]=v=>ne(q)?q.value=v:null)},{default:p(()=>[h($e,{"is-restock":!0,"iscn-id":e(r),onSubmit:we},null,8,["iscn-id"])]),_:1},8,["modelValue"])]),_:1})}}});export{Wt as default};
