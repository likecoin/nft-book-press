import{aQ as Te,aS as S,aT as p,aU as a,bW as Se,ba as V,a_ as Fe,a$ as Be,b7 as Y,b6 as Ue,b8 as Z,bx as Ee,bk as Me,b0 as Re,b9 as r,bb as J,b1 as qe,b3 as T,aX as m,bA as Ve,bi as x,aW as b,aV as l,b4 as e,bj as Ae,bf as Le,aY as ee,bB as We,bd as te,bZ as ae,bo as Oe,bp as De,ca as Pe,br as je,bv as ze,bg as Ge,bn as He,b2 as Ke}from"./Cx-ejso0.js";import{_ as Qe}from"./C06z5YA4.js";import{_ as Xe}from"./DosmcLd9.js";import{_ as Ye}from"./Ch6nITpD.js";import{b as Ze,u as Je,_ as et}from"./Dimzd7pR.js";import{_ as tt}from"./L88LHyRM.js";import{a as at,u as ne,b as nt}from"./DAt5R-aG.js";import{b as se}from"./BF1L838a.js";import"./DaA2_OPp.js";(function(){try{var c=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},o=new c.Error().stack;o&&(c._sentryDebugIds=c._sentryDebugIds||{},c._sentryDebugIds[o]="87c9979a-c858-4724-9d1c-d8e264e06574",c._sentryDebugIdIdentifier="sentry-dbid-87c9979a-c858-4724-9d1c-d8e264e06574")}catch{}})();const st={},ot={class:"relative overflow-hidden rounded border border-dashed border-gray-400 dark:border-gray-500 opacity-75 flex items-center justify-center p-4"};function lt(c,o){return p(),S("div",ot,[o[0]||(o[0]=a("svg",{class:"absolute inset-0 h-full w-full stroke-gray-900/10 dark:stroke-white/10",fill:"none"},[a("defs",null,[a("pattern",{id:"placeholder-pattern",x:"0",y:"0",width:"10",height:"10",patternUnits:"userSpaceOnUse"},[a("path",{d:"M-3 13 15-5M-5 5l18-18M-1 21 17 3"})])]),a("rect",{stroke:"none",fill:"url(#placeholder-pattern)",width:"100%",height:"100%"})],-1)),Se(c.$slots,"default")])}const rt=Te(st,[["render",lt]]);function it(c){return c.charCodeAt(0)>255}function ut(c,o){const I=V(()=>{let y=0;for(let w=0;w<c.value.length;w++)y+=it(c.value[w])?2:1;return y}),R=V(()=>I.value>o);return{messageCharCount:I,isLimitReached:R}}const ct={class:"text-lg font-bold font-mono"},dt={class:"divide-y w-full"},ft={class:"text-left px-4 py-3"},_t={class:"px-4 py-3"},mt={key:0},pt={class:"text-left px-4 py-3"},vt={class:"px-4 py-3"},bt={class:"text-left px-4 py-3"},yt={class:"px-4 py-3"},ht={class:"px-4 py-3"},gt={class:"text-left px-4 py-3"},xt={class:"px-4 py-3"},wt={class:"px-4 py-3"},kt={class:"px-4 py-3"},It={class:"px-4 py-3"},Ct={class:"space-y-2 mb-4"},$t=["textContent"],Nt=["textContent"],Tt={class:"flex flex-wrap items-center justify-center gap-2 w-full"},St={class:"text-sm text-gray-400 dark:text-gray-600"},Ft=["textContent"],Bt=["src"],Ot=Fe({__name:"[classId]",setup(c){const{t:o}=Be(),{LIKE_CO_API:I}=Y().public,R=Ue(),{wallet:y,signer:w}=Z(R),{validateWalletConsistency:O}=R,D=Ee(),{token:P}=Z(D),j=at(),{lazyFetchClassMetadataById:oe}=j,A=Me(),le=Re(),{writeContractAsync:re}=Ze(),{getBalanceOf:ie,getTokenIdByOwnerIndex:ue}=ne(),{assertPositiveWalletBalance:ce,waitForTransactionReceipt:de}=Je(),h=r({message:"",actions:[]}),k=r(!1),i=r(A.params.classId),z=r(A.query.payment_id),F=r(A.query.owner_wallet||y.value),B=r(o("nft_book_form.default_memo")),{messageCharCount:fe,isLimitReached:G}=ut(B,se),{getNFTMetadata:_e,getNFTOwner:me}=ne(),U=r([]),u=r([]),C=r(!1),$=r(""),v=r(!1),H=r(void 0),s=r({}),N=r(""),E=r(!1),M=r(""),{NFT_ITEM_URL:pe}=Y().public,K=V(()=>v.value||k.value||C.value||!!$.value||G.value),ve=V(()=>{var n;return(n=j.getClassMetadataById(i.value))==null?void 0:n.name});J(k,n=>{n&&(h.value={message:"",actions:[]})}),J(v,async n=>{n||(U.value?(u.value=U.value.filter(t=>t.trim()!=="").map(t=>Number(t)),u.value[0]===0?(M.value=o("error.nft_id_reserved_for_author"),u.value=[],v.value=!0):await Q()||(M.value=o("error.fetch_nft_metadata_failed"),u.value=[],v.value=!0)):(N.value="",u.value=[]))}),qe(async()=>{const n=await $fetch(`${I}/likernft/book/purchase/${i.value}/status/${z.value}`,{headers:{authorization:`Bearer ${P.value}`}});s.value=n,oe(i.value),L(s.value.quantity||1)});function be(){M.value="",v.value=!v.value,$.value="",He(()=>{var n,t,d;v.value&&((d=(t=(n=H.value)==null?void 0:n[0].$refs)==null?void 0:t.input)==null||d.focus())})}async function Q(){var n;try{if(C.value=!0,!u.value.length||u.value[0]===void 0){N.value="";return}try{const t=await _e(i.value,u.value[0]);return N.value=Ve(t==null?void 0:t.image),t}catch(t){N.value="",((n=t==null?void 0:t.data)==null?void 0:n.code)===2?$.value="NFT not found":$.value=t.toString()}}catch(t){h.value={message:t.toString(),actions:[]}}finally{C.value=!1}}async function L(n=1){try{if(u.value=[],$.value="",(!y.value||!w.value)&&await O(),!F.value)throw new Error("Missing owner wallet");const t=await ie(i.value,F.value);if(t<BigInt(n))throw new Error(`No NFTs available for classId: ${i.value} in wallet: ${F.value}`);const d=[];for(let g=0;g<Number(t);g++){const f=await ue(i.value,F.value,g);if(f!==0n&&(d.push(Number(f)),d.length>=n))break}if(d.length<n)throw new Error(`Failed to collect enough available NFTs. Collected ${d.length}/${n}`);u.value=d,U.value=d.map(String),await Q()}catch(t){h.value={message:t.toString(),actions:[{label:o("button.restock_nft"),variant:"outline",color:"red",click:()=>{E.value=!0}}]}}}function ye(){window.open(`${pe}/${i.value}`,"_blank","noopener")}async function he(){if(!K.value)try{if(k.value=!0,(!y.value||!w.value)&&await O(),!y.value||!w.value)return;if(u.value){const g=(await Promise.all(u.value.map(f=>me(i.value,f)))).findIndex(f=>f!==F.value);if(g>=0){const f=u.value[g];throw new Error(`NFT classId: ${i.value} nftId:${f} is not owned by sender!`)}}else await L(s.value.quantity);await ce({wallet:y.value});const n=await re({address:i.value,abi:nt,functionName:"batchTransferWithMemo",args:[y.value,Array(s.value.quantity).fill(s.value.wallet),u.value,Array(s.value.quantity).fill(B.value)]}),t=await de({hash:n});(t==null?void 0:t.status)==="success"&&(await $fetch(`${I}/likernft/book/purchase/${i.value}/sent/${z.value}`,{method:"POST",body:{txHash:n,quantity:s.value.quantity||1},headers:{authorization:`Bearer ${P.value}`}}),await Ke(le({name:"my-books-status-classId",params:{classId:i.value}})))}catch(n){console.error(n),h.value={message:n.toString(),actions:[]}}finally{k.value=!1}}function ge(){E.value=!1,L(s.value.quantity||1)}return(n,t)=>{const d=Ae,g=Le,f=We,xe=Qe,X=Xe,we=Ye,W=je,ke=ze,Ie=rt,Ce=et,$e=Ge,Ne=tt;return p(),T(Ne,null,{default:m(()=>[a("h1",ct,' Deliver NFT Book "'+l(e(ve)||e(i))+'" ',1),e(h).message?(p(),T(d,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${e(h).message}`,actions:e(h).actions,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:t[0]||(t[0]=_=>h.value={message:"",actions:[]})},null,8,["title","actions"])):x("",!0),e(k)?(p(),T(g,{key:1,animation:"carousel"},{indicator:m(()=>t[3]||(t[3]=[ee(" Loading... ")])),_:1})):x("",!0),e(D).isAuthenticated?(p(),T(f,{key:2,ui:{body:{base:"space-y-6"},footer:{base:"flex justify-center gap-2"}}},{footer:m(()=>[b(W,{label:"Sign and Send",disabled:e(K),size:"xl",onClick:he},null,8,["disabled"])]),default:m(()=>[b(f,{ui:{body:{padding:""}}},{default:m(()=>{var _,q;return[a("table",dt,[a("tbody",null,[a("tr",null,[a("th",ft,l(e(o)("table.buyer_email")),1),a("td",_t,l(e(s).email),1)]),(_=e(s).giftInfo)!=null&&_.toEmail?(p(),S("tr",mt,[a("th",pt,l(e(o)("table.reader_email")),1),a("td",vt,l(((q=e(s).giftInfo)==null?void 0:q.toEmail)||e(s).email),1)])):x("",!0),a("tr",null,[a("th",bt,l(e(o)("table.status")),1),a("td",yt,l(e(s).status),1)]),a("tr",null,[t[4]||(t[4]=a("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),a("td",ht,l(e(s).wallet),1)]),a("tr",null,[a("th",gt,l(e(o)("table.price_name")),1),a("td",xt,l(e(s).priceName),1)]),a("tr",null,[t[5]||(t[5]=a("th",{class:"text-left px-4 py-3"}," Price ",-1)),a("td",wt,l(e(s).price),1)]),a("tr",null,[t[6]||(t[6]=a("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),a("td",kt,l(e(s).quantity),1)]),a("tr",null,[t[7]||(t[7]=a("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),a("td",It,l(e(s).from),1)])])])]}),_:1}),b(f,null,{default:m(()=>[a("div",Ct,[a("h5",{class:"text-sm font-bold",textContent:l(`${e(o)("nft_book_form.buyer_message")}`)},null,8,$t),a("p",{textContent:l(e(s).message)},null,8,Nt)]),b(X,{label:e(o)("nft_book_form.author_message"),error:e(G),hint:`${e(fe)} / ${e(se)}`},{default:m(()=>[b(xe,{modelValue:e(B),"onUpdate:modelValue":t[1]||(t[1]=_=>te(B)?B.value=_:null)},null,8,["modelValue"])]),_:1},8,["label","error","hint"])]),_:1}),b(X,{label:e(o)("form.nft_id_label"),class:"mb-4",error:e($),ui:{description:"text-gray-400 dark:text-gray-600"}},{default:m(()=>[a("div",Tt,[e(s).quantity?(p(),S("div",{key:0,class:ae([e(s).quantity>1?"w-full":"flex-grow","space-y-1","relative"])},[(p(!0),S(Oe,null,De(e(s).quantity,_=>(p(),T(we,{key:`nft-id-input-${_}`,ref_for:!0,ref_key:"nftIdInputRef",ref:H,modelValue:e(U)[_-1],"onUpdate:modelValue":q=>e(U)[_-1]=q,class:"font-mono",readonly:!e(v),disabled:!e(v)},Pe({_:2},[e(s).quantity>1?{name:"leading",fn:m(()=>[a("span",St,"#"+l(_),1)]),key:"0"}:void 0]),1032,["modelValue","onUpdate:modelValue","readonly","disabled"]))),128)),e(M)?(p(),S("span",{key:0,class:"text-xs text-red-500 absolute",textContent:l(e(M))},null,8,Ft)):x("",!0)],2)):x("",!0),e(s).quantity===1?(p(),T(W,{key:1,label:e(v)||e(C)?"Confirm":"Edit",disabled:e(k)||e(C),variant:"outline",loading:e(C),color:"gray",onClick:be},null,8,["label","disabled","loading"])):x("",!0),b(ke,{class:ae(["text-sm text-gray-600",{"sm:w-min":e(s).quantity<=1}])},{default:m(()=>t[8]||(t[8]=[ee(" OR ")])),_:1,__:[8]},8,["class"]),b(W,{label:e(o)("button.check_all_nft_ids"),disabled:e(k)||e(v),variant:"outline",onClick:ye},null,8,["label","disabled"])])]),_:1},8,["label","error"]),b(Ie,{class:"h-[300px]"},{default:m(()=>[e(N)?(p(),S("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",alt:"preview",src:e(N)},null,8,Bt)):x("",!0)]),_:1})]),_:1})):x("",!0),b($e,{modelValue:e(E),"onUpdate:modelValue":t[2]||(t[2]=_=>te(E)?E.value=_:null)},{default:m(()=>[b(Ce,{"is-restock":!0,"iscn-id":e(i),onSubmit:ge},null,8,["iscn-id"])]),_:1},8,["modelValue"])]),_:1})}}});export{Ot as default};
