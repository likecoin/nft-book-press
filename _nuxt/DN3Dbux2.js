import{n as pt,O as mt,Q as vt,R as J,P as yt,u as _t,I as gt,r,s as K,h as X,x as xt,a8 as ht,o as y,A as q,w as p,a9 as Z,U as bt,a,t as d,B as t,J as E,d as Y,b as v,C as It,c as A,F as wt,D as Nt,bc as kt,Z as tt,y as $t,aa as St,ab as Ct,ac as Ft,X as Tt,a1 as qt,M as Et,G as Bt,E as Ut}from"./DBE1DAG7.js";import{_ as Dt}from"./C1ufFlX3.js";import{_ as Rt}from"./BARo-uas.js";import{_ as At}from"./DFyQwwX-.js";import{u as Vt,_ as Lt}from"./CK5FiWBs.js";import{_ as Mt}from"./RnWDTU7B.js";import{u as Pt}from"./CaIMtus0.js";import"./8mvRbGEp.js";(function(){try{var N=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},k=new Error().stack;k&&(N._sentryDebugIds=N._sentryDebugIds||{},N._sentryDebugIds[k]="c1e5aa5c-422b-4775-9f1d-b57b0d17f6d8",N._sentryDebugIdIdentifier="sentry-dbid-c1e5aa5c-422b-4775-9f1d-b57b0d17f6d8")}catch{}})();const Ot={class:"text-lg font-bold font-mono"},zt={class:"divide-y w-full"},Ht={class:"px-4 py-3"},Wt={class:"px-4 py-3"},jt={class:"px-4 py-3"},Gt={class:"px-4 py-3"},Qt={class:"px-4 py-3"},Jt={class:"px-4 py-3"},Kt={class:"px-4 py-3"},Xt={class:"px-4 py-3"},Zt={class:"px-4 py-3"},Yt={class:"flex flex-wrap items-center justify-center gap-2 w-full"},te={class:"text-sm text-gray-400 dark:text-gray-600"},ee=["src"],de=pt({__name:"[classId]",setup(N){const{LIKE_CO_API:k,LCD_URL:V}=mt().public,L=vt(),{wallet:$,signer:S}=J(L),{initIfNecessary:M}=L,P=yt(),{token:O}=J(P),z=Pt(),{lazyFetchClassMetadataById:et}=z,U=_t(),at=gt(),_=r(""),g=r(!1),i=r(U.params.classId),H=r(U.query.payment_id),B=r(U.query.owner_wallet||$.value),C=r(""),{messageCharCount:nt,isLimitReached:W}=Vt(C,Z),F=r([]),l=r([]),h=r(!1),b=r(!1),x=r(""),m=r(!1),j=r(void 0),n=r({}),I=r(""),G=K(()=>m.value||g.value||h.value||b.value||!!x.value||W.value),st=K(()=>{var s;return(s=z.getClassMetadataById(i.value))==null?void 0:s.name});X(g,s=>{s&&(_.value="")}),X(m,async s=>{if(!s)if(F.value){const e=F.value.filter(o=>o.trim()!=="");if(n.value.quantity&&e.length>0&&e.length!==n.value.quantity){x.value=`Number of NFT IDs (${e.length}) does not match the required quantity (${n.value.quantity})`,l.value=[];return}l.value=e,await Q()}else I.value="",l.value=[]}),xt(async()=>{const s=await $fetch(`${k}/likernft/book/purchase/${i.value}/status/${H.value}`,{headers:{authorization:`Bearer ${O.value}`}});n.value=s,et(i.value),D(n.value.quantity||1)});function lt(){m.value=!m.value,x.value="",$t(()=>{var s,e,o;m.value&&((o=(e=(s=j.value)==null?void 0:s[0].$refs)==null?void 0:e.input)==null||o.focus())})}async function Q(){var s,e,o,T;try{if(h.value=!0,!l.value.length||!l.value[0]){I.value="";return}try{const u=await $fetch(`${V}/cosmos/nft/v1beta1/nfts/${i.value}/${l.value[0]}`),w=((o=(e=(s=u==null?void 0:u.nft)==null?void 0:s.data)==null?void 0:e.metadata)==null?void 0:o.image)||"";I.value=bt(w)}catch(u){I.value="",((T=u==null?void 0:u.data)==null?void 0:T.code)===2?x.value="NFT not found":x.value=u.toString()}}catch(u){_.value=u.toString()}finally{h.value=!1}}async function D(s=1){try{if(x.value="",b.value=!0,(!$.value||!S.value)&&await M(),!B.value)return;const{nfts:e}=await ht({classId:i.value,owner:B.value,needCount:s});if(e.length)l.value=e.map(o=>o.id),F.value=l.value,await Q();else throw new Error(`${B.value} does not hold any NFT of class ${i.value}`)}catch(e){_.value=e.toString()}finally{b.value=!1}}function ot(){D(n.value.quantity||1)}async function rt(){if(!G.value)try{if(g.value=!0,(!$.value||!S.value)&&await M(),!$.value||!S.value)return;if(l.value){const w=(await Promise.all(l.value.map(c=>St(i.value,c)))).map(c=>c.owner).findIndex(c=>c!==B.value);if(w>=0){const c=l.value[w];throw new Error(`NFT classId: ${i.value} nftId:${c} is not owned by sender!`)}}else await D(n.value.quantity||1);if(l.value.length!==n.value.quantity)throw new Error(`NFT quantity mismatch! Expected ${n.value.quantity}, got ${l.value.length}`);if(!(await Ct(S.value)).getSigningStargateClient())throw new Error("Signing client not exists");const o=await Ft(n.value.wallet,Array(l.value.length).fill(i.value),l.value,S.value,$.value,C.value);o.transactionHash&&o.code===0&&(await $fetch(`${k}/likernft/book/purchase/${i.value}/sent/${H.value}`,{method:"POST",body:{txHash:o.transactionHash,quantity:n.value.quantity||1},headers:{authorization:`Bearer ${O.value}`}}),at.push({name:"nft-book-store-status-classId",params:{classId:i.value}}))}catch(s){console.error(s),_.value=s.toString()}finally{g.value=!1}}return(s,e)=>{const o=Tt,T=qt,u=Et,w=Dt,c=Rt,ut=At,R=Bt,it=Ut,dt=Lt,ct=Mt;return y(),q(ct,null,{default:p(()=>[a("h1",Ot,' Deliver NFT Book "'+d(t(st)||t(i))+'" ',1),t(_)?(y(),q(o,{key:0,icon:"i-heroicons-exclamation-triangle",color:"red",variant:"soft",title:`${t(_)}`,"close-button":{icon:"i-heroicons-x-mark-20-solid",color:"red",variant:"link",padded:!1},onClose:e[0]||(e[0]=f=>_.value="")},null,8,["title"])):E("",!0),t(g)?(y(),q(T,{key:1,animation:"carousel"},{indicator:p(()=>e[2]||(e[2]=[Y(" Loading... ")])),_:1})):E("",!0),t(P).isAuthenticated?(y(),q(u,{key:2,ui:{body:{base:"space-y-4"},footer:{base:"flex justify-center gap-2"}}},{footer:p(()=>[v(R,{label:"Sign and Send",disabled:t(G),size:"xl",onClick:rt},null,8,["disabled"])]),default:p(()=>[v(u,{ui:{body:{padding:""}}},{default:p(()=>{var f;return[a("table",zt,[a("tbody",null,[a("tr",null,[e[3]||(e[3]=a("th",{class:"text-left px-4 py-3"}," Buyer Email ",-1)),a("td",Ht,d(t(n).email),1)]),a("tr",null,[e[4]||(e[4]=a("th",{class:"text-left px-4 py-3"}," Reader Email ",-1)),a("td",Wt,d(((f=t(n).giftInfo)==null?void 0:f.toEmail)||t(n).email),1)]),a("tr",null,[e[5]||(e[5]=a("th",{class:"text-left px-4 py-3"}," Status ",-1)),a("td",jt,d(t(n).status),1)]),a("tr",null,[e[6]||(e[6]=a("th",{class:"text-left px-4 py-3"}," Buyer Wallet ",-1)),a("td",Gt,d(t(n).wallet),1)]),a("tr",null,[e[7]||(e[7]=a("th",{class:"text-left px-4 py-3"}," Price Name ",-1)),a("td",Qt,d(t(n).priceName),1)]),a("tr",null,[e[8]||(e[8]=a("th",{class:"text-left px-4 py-3"}," Price ",-1)),a("td",Jt,d(t(n).price),1)]),a("tr",null,[e[9]||(e[9]=a("th",{class:"text-left px-4 py-3"}," Quantity ",-1)),a("td",Kt,d(t(n).quantity),1)]),a("tr",null,[e[10]||(e[10]=a("th",{class:"text-left px-4 py-3"}," Buyer message ",-1)),a("td",Xt,d(t(n).message),1)]),a("tr",null,[e[11]||(e[11]=a("th",{class:"text-left px-4 py-3"}," Sales channel ",-1)),a("td",Zt,d(t(n).from),1)])])])]}),_:1}),v(c,{label:"Enter Author's Message",error:t(W),hint:`${t(nt)} / ${t(Z)}`},{default:p(()=>[v(w,{modelValue:t(C),"onUpdate:modelValue":e[1]||(e[1]=f=>It(C)?C.value=f:null),placeholder:"default memo"},null,8,["modelValue"])]),_:1},8,["error","hint"]),v(c,{label:"Specify NFT ID",description:"Leave empty to auto-fetch NFT ID",error:t(x),ui:{description:"text-gray-400 dark:text-gray-600"}},{default:p(()=>[a("div",Yt,[t(n).quantity?(y(),A("div",{key:0,class:tt([t(n).quantity>1?"w-full":"flex-grow","space-y-1"])},[(y(!0),A(wt,null,Nt(t(n).quantity,f=>(y(),q(ut,{key:`nft-id-input-${f}`,ref_for:!0,ref_key:"nftIdInputRef",ref:j,modelValue:t(F)[f-1],"onUpdate:modelValue":ft=>t(F)[f-1]=ft,class:"font-mono",readonly:!t(m),disabled:!t(m)},kt({_:2},[t(n).quantity>1?{name:"leading",fn:p(()=>[a("span",te,"#"+d(f),1)]),key:"0"}:void 0]),1032,["modelValue","onUpdate:modelValue","readonly","disabled"]))),128))],2)):E("",!0),v(R,{label:t(m)||t(h)&&!t(b)?"Confirm":"Edit",disabled:t(g)||t(h),variant:"outline",loading:t(h)&&!t(b),color:"gray",onClick:lt},null,8,["label","disabled","loading"]),v(it,{class:tt(["text-sm text-gray-600",{"sm:w-min":t(n).quantity<=1}])},{default:p(()=>e[12]||(e[12]=[Y(" OR ")])),_:1},8,["class"]),v(R,{label:`Auto-fetch NFT ID for ${t(n).quantity} NFTs`,disabled:t(g)||t(m),loading:t(b),variant:"outline",onClick:ot},null,8,["label","disabled","loading"])])]),_:1},8,["error"]),v(dt,{class:"h-[300px]"},{default:p(()=>[t(I)?(y(),A("img",{key:0,class:"max-w-[180px] w-full h-full object-contain",src:t(I)},null,8,ee)):E("",!0)]),_:1})]),_:1})):E("",!0)]),_:1})}}});export{de as default};
//# sourceMappingURL=DN3Dbux2.js.map
