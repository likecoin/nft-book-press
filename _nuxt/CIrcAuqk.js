import{_ as ct}from"./Dyf0NcDg.js";import{n as mt,O as pt,a0 as ft,R as vt,u as _t,I as ht,q as gt,s as i,v as kt,r as m,h as re,x as yt,y as bt,o as _,A as y,w as s,dI as Ct,dJ as xt,dK as It,ae as Oe,dL as wt,S as Lt,b as l,B as o,c as ue,a as p,t as F,C as h,d4 as St,cZ as Ut,J as T,bc as Fe,F as ze,D as Rt,Z as Ne,a6 as Vt,G as Pt,M as Dt,dM as Tt,Y as Mt,H as $t,K as Bt,L as We}from"./DBE1DAG7.js";import{_ as At}from"./CLvjVGaU.js";import{_ as Qt}from"./BARo-uas.js";import{_ as qt}from"./DFyQwwX-.js";import{_ as Et}from"./C1ufFlX3.js";import{_ as jt}from"./DpG5Vkwv.js";import{_ as Ot}from"./Qb8-O-5m.js";import{_ as Ft}from"./Btg-kwgH.js";import{_ as zt,d as Nt}from"./K_gV1ABn.js";import{_ as Wt}from"./RnWDTU7B.js";import{_ as Gt}from"./DfuBio48.js";import{a as Kt,u as Ht}from"./DXMMO_H9.js";import{u as Jt}from"./DMwVDBUQ.js";import"./iuC4bcCS.js";import"./8mvRbGEp.js";import"./DOMtwFUf.js";import"./B0trrxiO.js";import"./BFnzb7gO.js";import"./O1MvlxzO.js";(function(){try{var M=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},z=new Error().stack;z&&(M._sentryDebugIds=M._sentryDebugIds||{},M._sentryDebugIds[z]="3d4122e1-49b3-4f03-9b75-d3a81dcbcd43",M._sentryDebugIdIdentifier="sentry-dbid-3d4122e1-49b3-4f03-9b75-d3a81dcbcd43")}catch{}})();const Zt={key:0,class:"flex flex-col items-center justify-center self-stretch gap-4 py-10"},Yt=["textContent"],Xt={class:"flex gap-2"},eo={class:"relative flex max-md:flex-col flex-wrap gap-4"},to={class:"flex items-center gap-2"},oo={key:0},no=["textContent"],ao={class:"flex items-center gap-2 font-bold"},lo=["textContent"],so=["textContent"],io=["textContent"],ro={class:"flex items-center gap-2"},ke="bookpress",ye="affiliate",Vo=mt({__name:"purchase-link",setup(M){const{LIKE_CO_API:z,SITE_URL:be}=pt().public,Ge=ft(),Ce=Kt(),Ke=Jt(),He=Ht(),{userLikerInfo:$}=vt(He),B=_t(),xe=ht(),N=gt(),g=i({get:()=>B.query.share==="1",set:e=>{xe.replace({query:{...B.query,share:e?"1":void 0}})}}),de=i(()=>g.value?"Book Purchase Links":"Book Purchase Link Generator");kt({title:()=>de.value,ogTitle:()=>de.value});const ce=m(""),W=i({get:()=>{if(ce.value)return ce.value;const e=B.query.product_id;return e?Array.isArray(e)?e.join(`
`):e:""},set:e=>{ce.value=e}}),Ie=i(()=>W.value.split(`
`).map(e=>e.trim()).filter(Boolean)),Je=i(()=>Ie.value[0]||""),we=i(()=>Ie.value.map(e=>{let t=e.trim();return t.startsWith("http")&&(t=new URL(t).pathname.split("/").pop()),t!=null&&t.startsWith("col_")||t!=null&&t.startsWith("likenft")?t:""}).filter(Boolean)),Le=i(()=>we.value[0]||"");function Se(e={}){const t=new URLSearchParams;return e.utmCampaign&&t.set("utm_campaign",e.utmCampaign),e.utmSource&&t.set("utm_source",e.utmSource),e.utmMedium&&t.set("utm_medium",e.utmMedium),t.toString().replace("?","")}const G=m(""),A=m(!0),K=m(""),H=m(""),me=i(()=>{const e=L.value==="liker_land";return I.value?"custom-link":e?"likerland":"stripe"}),pe=m(""),Q=i({get:()=>pe.value?pe.value:Se({utmCampaign:G.value,utmSource:H.value,utmMedium:K.value}),set:e=>{pe.value=e}}),Ze=i(()=>Se({utmCampaign:ke,utmSource:me.value,utmMedium:ye})),fe=i(()=>({utm_medium:ye,utm_source:me.value,utm_campaign:ke})),w=i(()=>{var r;const e={...fe.value},t=((r=Je.value)==null?void 0:r.trim())||"";if(t.startsWith("http")){const{searchParams:a}=new URL(t);a.delete("from"),Object.assign(e,Object.fromEntries(a))}return Q.value&&Object.assign(e,Object.fromEntries(new URLSearchParams(Q.value))),e}),Ue=i(()=>Object.entries(w.value).filter(([e])=>!(e==="utm_campaign"&&A.value)).map(([e,t])=>({key:e,value:t}))),Re=m([{name:"Liker Land Product Page",value:"liker_land"},{name:"Stripe Checkout Page",value:"direct"},{name:"Custom Page",value:"custom"}]),L=m(Re.value[0].value),I=i(()=>L.value==="custom"),S=m(B.query.custom_link||""),ve=m(""),b=i({get:()=>{if(ve.value)return ve.value;const e=B.query.from;return e?Array.isArray(e)?e.join(","):e:""},set:e=>{ve.value=e}}),q=i(()=>b.value.split(",").map(e=>e.trim()).filter(Boolean).map(e=>{const t=Ce.getChannelInfoById(e);return{id:e,name:(t==null?void 0:t.displayName)||e}})),Ve=m(!1),J=i({get:()=>!q.value.length||Ve.value,set:e=>{Ve.value=e}}),Z=i(()=>q.value.concat(J.value?Ct:[])),x=i(()=>Z.value.length>1),Y=m("");re(Le,()=>{Y.value=""});const E=m("");re(b,()=>{E.value=""});const U=m(""),Pe=i(()=>!!U.value),De=i(()=>I.value?!!S.value:!!Le.value&&!Pe.value),k=m(void 0),X=i(()=>{const e={};if(k.value)for(const{id:t,data:r}of k.value)r.prices?e[t]=r.prices.map(a=>{var c,d;let u="";return typeof a.name=="object"?u=((c=a.name)==null?void 0:c.zh)||((d=a.name)==null?void 0:d.en)||"":u=a.name,{label:[u,`$${a.price}`].filter(Boolean).join(" - "),value:a.index||0}}):e[t]=[];return e}),R=m({}),Te=i(()=>{var e;return((e=k.value)==null?void 0:e.map(({id:t,data:r})=>{var a,u;return{id:t,name:((a=r.name)==null?void 0:a.zh)||((u=r.name)==null?void 0:u.en)||r.name,editionOptions:X.value[t]||[]}}))||[]}),Ye=i(()=>{const e=[];return I.value||e.push({key:"productId",label:"Product",sortable:!0},{key:"selectedEditionLabel",label:"Edition"}),g.value||e.push({key:"utmCampaign",label:"UTM Campaign",sortable:!0}),e.push({key:"link",label:"Link"}),e}),_e=i(()=>{const e=new Map,t=[...new Map(Z.value.map(a=>[a.id,a])).values()];return(I.value?[{id:"custom",data:{name:"Custom"}}]:k.value||[]).forEach(({id:a,data:u})=>{const c=a.startsWith("col_");t.forEach(d=>{var oe,D,O,ne,ae,le,se;e.has(d.id)||e.set(d.id,[]);let v=w.value.utm_campaign||fe.value.utm_campaign||"";A.value&&d.id!==xt&&(v=`${It(d.id)}_${v}`);const P=R.value[a]||0,C={[c?"collectionId":"classId"]:a||"",channel:d.id,priceIndex:P,customLink:I.value?S.value:void 0,isUseLikerLandLink:L.value==="liker_land",query:{utm_campaign:v,...w.value}};(se=e.get(d.id))==null||se.push({productId:a,productName:((oe=u.name)==null?void 0:oe.zh)||((D=u.name)==null?void 0:D.en)||u.name,isCollection:c,selectedEditionIndex:P,selectedEditionLabel:c?`$${(((O=u==null?void 0:u.typePayload)==null?void 0:O.priceInDecimal)||0)/100}`:((le=(ae=(ne=X.value)==null?void 0:ne[a])==null?void 0:ae[P])==null?void 0:le.label)||"",channelId:d.id,channelName:d.name,utmCampaign:v,utmMedium:w.value.utm_medium,utmSource:w.value.utm_source,url:Oe(C),qrCodeUrl:Oe({...C,isForQRCode:w.value.utm_source===fe.value.utm_source})})})}),e}),ee=i(()=>Z.value.flatMap(e=>_e.value.get(e.id)||[])),j=e=>_e.value.get(e)||[],V=m(void 0),te=i({get:()=>!!V.value,set:e=>{e||(V.value=void 0)}});async function Xe(e){if(e.startsWith("col_")){const t=await Ge.fetchCollectionById(e);if(!t)throw new Error("Cannot fetch collection data.");return{id:e,data:t}}else{const t=await $fetch(`${z}/likernft/book/store/${e}`);return{id:e,data:t}}}async function he(){if(Y.value="",k.value=void 0,R.value={},E.value="",U.value="",!!De.value)try{if(q.value.length){U.value="Validating custom channels...";const e=q.value.find(t=>!wt(t.id));if(e){E.value=`Invalid channel "${e.id}", please enter a valid channel ID starting with "@"`;return}try{await Promise.all(q.value.map(async t=>{const r=await Ce.lazyFetchChannelInfoById(t.id);if(!r)throw new Error(`Channel ID "${t.id}" has not registered for Liker ID`);const a=await Ke.fetchStripeConnectStatusByWallet(r.likeWallet);if(!(a!=null&&a.hasAccount))throw new Error(`Channel ID "${t.id}" has not connected to Stripe`);if(!(a!=null&&a.isReady))throw new Error(`Channel ID "${t.id}" has not completed Stripe Connect setup`)}))}catch(t){E.value=t.message,g.value=!1;return}}U.value="Fetching product data...";try{const e=await Promise.all(we.value.map(t=>Xe(t)));k.value=e}catch(e){Y.value=e.message,g.value=!1;return}}catch(e){console.error(e),N.add({icon:"i-heroicons-exclamation-circle",title:"Failed to create affiliation link",timeout:0,color:"red",ui:{title:"text-red-400 dark:text-red-400"}}),g.value=!1}finally{U.value=""}}function Me(e){const t=[];if(I.value){const r=new URL(S.value);t.push(r.hostname)}else t.push(`${e.productName||e.productId}`),e.isCollection&&t.push(`edition-${e.selectedEditionIndex}`);return e.channelId&&t.push(`channel-${e.channelId}`),t.join("_")}async function $e(e=""){await navigator.clipboard.writeText(e),N.add({icon:"i-heroicons-check-circle",title:"Copied link to clipboard",timeout:2e3,color:"green"})}function Be(e=[],t){Bt({data:e.map(({isCollection:r,selectedEditionIndex:a,selectedEditionLabel:u,...c})=>({edition:`${a+1}. ${u}`,...c})),fileName:["affiliation_links",t,Date.now()].filter(Boolean).join("_").concat(".csv"),fileType:"csv"})}function et(){Be(ee.value)}function tt(e){return()=>Be(j(e))}function Ae(e=[]){try{sessionStorage.setItem("nft_book_press_batch_qrcode",We(e.map(({channelId:t,qrCodeUrl:r,...a})=>({key:t,...a,url:r})))),window.open("/batch-qrcode?print=1","batch_qrcode","popup,menubar=no,location=no,status=no")}catch(t){console.error(t),N.add({icon:"i-heroicons-exclamation-circle",title:"Failed to print QR codes",timeout:0,color:"red",ui:{title:"text-red-400 dark:text-red-400"}})}}function ot(){Ae(ee.value)}function nt(e){return()=>Ae(j(e))}function Qe(e=[]){try{sessionStorage.setItem("nft_book_press_batch_shorten_url",We(e.map(({channelId:t,...r})=>({key:t,...r})))),xe.push({name:"batch-short-links",query:{print:1}})}catch(t){console.error(t),N.add({icon:"i-heroicons-exclamation-circle",title:"Failed to shorten links",timeout:0,color:"red",ui:{title:"text-red-400 dark:text-red-400"}})}}function at(){Qe(ee.value)}function lt(e){return()=>Qe(j(e))}function st(e){return()=>{const t=new URL(`${be}/affiliation-link`);t.searchParams.set("from",e),t.searchParams.set("share","1"),t.searchParams.set("nav","0"),j(e).forEach(a=>{t.searchParams.append("product_id",a.productId)}),$e(t.toString())}}async function qe(e=[],t){const r=e.map(a=>({url:a.qrCodeUrl,filename:Me(a)}));await Nt(r,{zipFilename:["affiliation_links_qrcodes",t,Date.now()].filter(Boolean).join("_")})}async function it(){await qe(ee.value)}function rt(e){return()=>qe(j(e),e)}function ge(){!b.value&&$.value&&(b.value=Lt($.value.user))}return yt(()=>{g.value&&bt(()=>{he()}),ge()}),re(g,e=>{e?he():k.value=void 0}),re($,()=>{$.value&&ge()}),(e,t)=>{const r=ct,a=Vt,u=At,c=Qt,d=qt,Ee=Et,v=Pt,P=jt,C=Dt,oe=Tt,D=Ot,O=Ft,ne=Mt,ae=zt,le=$t,se=Wt,ut=Gt;return _(),y(ut,null,{default:s(()=>[l(r,{title:o(de)},null,8,["title"]),l(se,{class:"flex flex-col items-stretch grow space-y-8"},{default:s(()=>[!o(k)&&o(g)||o(Pe)?(_(),ue("div",Zt,[l(a,{class:"w-10 h-10 animate-spin",name:"i-heroicons-arrow-path-20-solid"}),p("span",{class:"text-gray-400 dark:text-gray-700 text-sm",textContent:F(o(U)||"Creating affiliation links...")},null,8,Yt)])):o(k)?(_(),ue(ze,{key:2},[o(g)?T("",!0):(_(),ue("header",oo,[l(v,{icon:"i-heroicons-arrow-uturn-left",label:"Back to configuration",variant:"soft",onClick:t[10]||(t[10]=n=>k.value=void 0)})])),o(x)&&o(Te).length?(_(),y(C,{key:1,ui:{body:{padding:""}}},{header:s(()=>t[15]||(t[15]=[p("h3",{class:"text-lg font-bold",textContent:"Product List"},null,-1)])),default:s(()=>[l(D,{columns:[{key:"name",label:"Name"},{key:"editionSelect",label:"Selected Edition"}],rows:o(Te)},{"name-data":s(({row:n})=>[p("span",{textContent:F(n.name)},null,8,no)]),"editionSelect-data":s(({row:n})=>[n.editionOptions.length?(_(),y(u,{key:0,class:"min-w-[200px]","model-value":o(R)[n.id]||0,options:n.editionOptions,"onUpdate:modelValue":f=>o(R)[n.id]=f},null,8,["model-value","options","onUpdate:modelValue"])):T("",!0)]),_:1},8,["rows"])]),_:1})):T("",!0),!o(g)&&o(Ue).length?(_(),y(C,{key:2,ui:{body:{padding:""}}},{header:s(()=>t[16]||(t[16]=[p("h3",{class:"text-lg font-bold",textContent:"Common Query String"},null,-1)])),default:s(()=>[l(D,{columns:[{key:"key",label:"Key"},{key:"value",label:"Value"}],rows:o(Ue),ui:{td:{font:"font-mono"}}},null,8,["rows"])]),_:1})):T("",!0),l(C,{ui:{header:{base:"flex justify-between items-center gap-4"},body:{base:"space-y-8",padding:o(x)?void 0:""}}},Fe({default:s(()=>[(_(!0),ue(ze,null,Rt(o(Z),n=>(_(),y(C,{key:n.id,ui:{base:"overflow-hidden",ring:o(x)?void 0:"",shadow:o(x)?void 0:"",header:{base:"flex justify-between items-center gap-4"},body:{padding:""}}},{header:s(()=>[p("h3",ao,[p("span",{class:Ne(o(x)?"text-md":"text-lg"),textContent:F(n.name)},null,10,lo),p("span",{class:Ne([o(x)?"text-xs":"text-sm","text-gray-400 dark:text-gray-700","font-mono"]),textContent:F(n.id)},null,10,so)]),l(O,{items:[[{label:"Print QR Codes",icon:"i-heroicons-qr-code",click:nt(n.id)},{label:"Download QR Codes",icon:"i-heroicons-arrow-down-on-square-stack",click:rt(n.id)},{label:"Download Links",icon:"i-heroicons-arrow-down-on-square-stack",click:tt(n.id)},{label:"Shorten Links",icon:"i-heroicons-sparkles",click:lt(n.id)},{label:"Share Table",icon:"i-heroicons-document-duplicate",click:st(n.id)}]],popper:{placement:"top-end"}},{default:s(()=>[l(v,{icon:"i-heroicons-ellipsis-horizontal-20-solid",color:"gray",size:"sm",variant:"soft"})]),_:2},1032,["items"])]),default:s(()=>[l(D,{columns:o(Ye),rows:o(_e).get(n.id)},Fe({"productId-data":s(({row:f})=>[p("div",{textContent:F(f.productName)},null,8,io)]),"utmCampaign-data":s(({row:f})=>[l(ne,{class:"font-mono",value:f.utmCampaign},null,8,["value"])]),"link-data":s(({row:f})=>[p("div",ro,[l(v,{icon:"i-heroicons-qr-code",variant:"outline",size:"xs",onClick:ie=>V.value=f},null,8,["onClick"]),l(v,{icon:"i-heroicons-document-duplicate",variant:"outline",size:"xs",onClick:ie=>$e(f.url||"")},null,8,["onClick"]),l(v,{class:"font-mono break-all",label:f.url,to:f.url,color:"gray",variant:"outline",size:"xs",target:"_blank"},null,8,["label","to"])])]),_:2},[o(x)?void 0:{name:"selectedEditionLabel-data",fn:s(({row:f})=>{var ie,je;return[(ie=o(X))!=null&&ie[f.productId].length?(_(),y(u,{key:0,class:"min-w-[200px]","model-value":o(R)[f.productId]||0,options:((je=o(X))==null?void 0:je[f.productId])||[],"onUpdate:modelValue":dt=>o(R)[f.productId]=dt},null,8,["model-value","options","onUpdate:modelValue"])):T("",!0)]}),key:"0"}]),1032,["columns","rows"])]),_:2},1032,["ui"]))),128))]),_:2},[o(x)?{name:"header",fn:s(()=>[t[17]||(t[17]=p("h2",{class:"text-lg font-bold",textContent:"Affiliation Links by Channel"},null,-1)),l(O,{items:[[{label:"Print All QR Codes",icon:"i-heroicons-qr-code",click:ot},{label:"Download QR Codes",icon:"i-heroicons-arrow-down-on-square-stack",click:it},{label:"Download All Links",icon:"i-heroicons-arrow-down-on-square-stack",click:et},{label:"Shorten All Links",icon:"i-heroicons-sparkles",click:at}]],popper:{placement:"top-end"}},{default:s(()=>[l(v,{icon:"i-heroicons-ellipsis-horizontal-20-solid",color:"gray",variant:"soft"})]),_:1},8,["items"])]),key:"0"}:void 0]),1032,["ui"]),l(le,{modelValue:o(te),"onUpdate:modelValue":t[12]||(t[12]=n=>h(te)?te.value=n:null)},{default:s(()=>[o(V)?(_(),y(ae,{key:0,data:o(V).qrCodeUrl,"file-name":Me(o(V)),width:500,height:500},{header:s(()=>[t[18]||(t[18]=p("h3",{class:"font-bold font-mono"}," Download QR Code ",-1)),l(v,{icon:"i-heroicons-x-mark",color:"gray",variant:"ghost",onClick:t[11]||(t[11]=n=>te.value=!1)})]),_:1},8,["data","file-name"])):T("",!0)]),_:1},8,["modelValue"])],64)):(_(),y(C,{key:1,ui:{body:{base:"space-y-4"},footer:{base:"flex justify-end"}}},{footer:s(()=>[l(v,{label:"Generate",size:"lg",disabled:!o(De),onClick:he},null,8,["disabled"])]),default:s(()=>[l(c,{label:"Destination"},{default:s(()=>[l(u,{modelValue:o(L),"onUpdate:modelValue":t[0]||(t[0]=n=>h(L)?L.value=n:null),options:o(Re),"option-attribute":"name"},null,8,["modelValue","options"])]),_:1}),o(I)?(_(),y(c,{key:0,label:"Custom Page URL",required:!0},{default:s(()=>[l(d,{modelValue:o(S),"onUpdate:modelValue":t[1]||(t[1]=n=>h(S)?S.value=n:null),class:"font-mono",placeholder:"https://liker.land/store?tag=blockchain",name:"custom_destination_url"},null,8,["modelValue"])]),_:1})):(_(),y(c,{key:1,label:"Product ID/URL(s)",error:o(Y),required:!0},{default:s(()=>[l(Ee,{modelValue:o(W),"onUpdate:modelValue":t[2]||(t[2]=n=>h(W)?W.value=n:null),class:"font-mono",placeholder:`likenft1ku4ra0e7dgknhd0wckrkxspuultynl4mgkxa3j08xeshfr2l0ujqmmvy83
likenft1wrskn9a683stkje3wdmcwuvpuqrp5eevjsnn9y4f55wlystzxausuhj3em`,autoresize:!0,name:"product_id"},null,8,["modelValue"])]),_:1},8,["error"])),l(c,{label:"Channel ID(s)",hint:"Optional",error:o(E),ui:{help:"flex items-center gap-2"}},{help:s(()=>[l(P,{modelValue:o(J),"onUpdate:modelValue":t[4]||(t[4]=n=>h(J)?J.value=n:null),disabled:!o(b)},null,8,["modelValue","disabled"]),t[13]||(t[13]=p("span",{textContent:"Include default channels"},null,-1))]),default:s(()=>[p("div",Xt,[l(d,{modelValue:o(b),"onUpdate:modelValue":t[3]||(t[3]=n=>h(b)?b.value=n:null),class:"grow font-mono",placeholder:"Channel ID(s), separated by commas (e.g. @store01, @store02)",name:"channel_ids"},null,8,["modelValue"]),St(l(v,{class:"relative",label:"Prefill from Account",color:"gray",variant:"outline",size:"2xs",onClick:ge},null,512),[[Ut,!o(b)&&o($)]])])]),_:1},8,["error"]),l(oe,{color:"gray",variant:"soft",size:"md",items:[{label:"Query String (Optional)",defaultOpen:!0,slot:"body"}],ui:{item:{padding:"p-0"}}},{body:s(()=>[l(C,{ui:{body:{base:"space-y-4"}}},{default:s(()=>[p("div",eo,[l(c,{class:"flex-1",label:"UTM Campaign"},{default:s(()=>[l(d,{modelValue:o(G),"onUpdate:modelValue":t[5]||(t[5]=n=>h(G)?G.value=n:null),class:"font-mono",name:"utm_campaign",placeholder:`e.g. ${ke}`},null,8,["modelValue","placeholder"])]),_:1}),l(c,{class:"flex-1",label:"UTM Source"},{default:s(()=>[l(d,{modelValue:o(H),"onUpdate:modelValue":t[6]||(t[6]=n=>h(H)?H.value=n:null),class:"font-mono",name:"utm_source",placeholder:`e.g. ${o(me)}`},null,8,["modelValue","placeholder"])]),_:1}),l(c,{class:"flex-1",label:"UTM Medium"},{default:s(()=>[l(d,{modelValue:o(K),"onUpdate:modelValue":t[7]||(t[7]=n=>h(K)?K.value=n:null),class:"font-mono",name:"utm_medium",placeholder:`e.g. ${ye}`},null,8,["modelValue","placeholder"])]),_:1})]),l(c,{label:"Additional Query String"},{default:s(()=>[l(d,{modelValue:o(Q),"onUpdate:modelValue":t[8]||(t[8]=n=>h(Q)?Q.value=n:null),class:"font-mono",placeholder:o(Ze),name:"query_params"},null,8,["modelValue","placeholder"])]),_:1}),p("div",to,[l(P,{modelValue:o(A),"onUpdate:modelValue":t[9]||(t[9]=n=>h(A)?A.value=n:null)},null,8,["modelValue"]),t[14]||(t[14]=p("span",{textContent:"Prefix Channel ID for UTM Campaign"},null,-1))])]),_:1})]),_:1})]),_:1}))]),_:1})]),_:1})}}});export{Vo as default};
//# sourceMappingURL=CIrcAuqk.js.map
