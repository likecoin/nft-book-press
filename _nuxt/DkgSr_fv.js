import{_ as mt}from"./Dt9haj_9.js";import{a_ as pt,b6 as ft,bx as _t,bn as vt,bm as bt,by as ht,b0 as gt,b7 as kt,b9 as i,bb as yt,b8 as m,ba as re,b1 as Ct,bc as xt,b3 as k,aX as s,bz as It,bo as wt,bA as Lt,bB as Ut,bC as St,bD as Oe,aT as v,aW as l,b4 as o,aS as ue,aU as p,bE as Rt,aV as F,bt as Vt,bf as b,bF as Tt,bg as Pt,bG as Dt,bH as Mt,bi as je,br as M,bI as Fe,bj as $t,bu as Bt,bJ as ze,bh as At,bK as Qt,bL as Ne,b2 as Et}from"./C1Iws6nc.js";import{_ as qt}from"./tH9phZsQ.js";import{_ as Ot}from"./BAWiKx-w.js";import{_ as jt}from"./UdKhLVak.js";import{_ as Ft}from"./C8rFwdj2.js";import{_ as zt}from"./DLL8wjC8.js";import{_ as Nt}from"./MtMEjHTa.js";import{_ as Wt}from"./Da-bcJIo.js";import{_ as Gt,d as Ht}from"./CRJQNas_.js";import{_ as Kt}from"./CckUxYIo.js";import{_ as Jt}from"./BH82N_gD.js";import{a as Xt,u as Yt}from"./kBza-heO.js";import{u as Zt}from"./D_bIx0Dn.js";import"./B3-yD3lj.js";import"./DXAePL8a.js";import"./BsUu7wpa.js";import"./CDuNXhdq.js";import"./Cpe24Lqn.js";import"./Chb40_89.js";(function(){try{var w=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},z=new w.Error().stack;z&&(w._sentryDebugIds=w._sentryDebugIds||{},w._sentryDebugIds[z]="09ddc230-ef43-42c2-aa3c-365b4874b892",w._sentryDebugIdIdentifier="sentry-dbid-09ddc230-ef43-42c2-aa3c-365b4874b892")}catch{}})();const eo={key:0,class:"flex flex-col items-center justify-center self-stretch gap-4 py-10"},to=["textContent"],oo={class:"flex gap-2"},no={class:"relative flex max-md:flex-col flex-wrap gap-4"},ao={class:"flex items-center gap-2"},lo={key:0},so=["textContent"],io={class:"flex items-center gap-2 font-bold"},ro=["textContent"],uo=["textContent"],co=["textContent"],mo={class:"flex items-center gap-2"},ge="bookpress",ke="affiliate",Do=pt({__name:"purchase-link",setup(w){const{LIKE_CO_API:z,SITE_URL:ye}=ft().public,We=_t(),Ce=Xt(),Ge=Zt(),He=Yt(),{userLikerInfo:$}=vt(He),B=bt(),Ke=ht(),Je=gt(),N=kt(),h=i({get:()=>B.query.share==="1",set:e=>{Ke.replace({query:{...B.query,share:e?"1":void 0}})}}),ce=i(()=>h.value?"Book Purchase Links":"Book Purchase Link Generator");yt({title:()=>ce.value,ogTitle:()=>ce.value});const de=m(""),W=i({get:()=>{if(de.value)return de.value;const e=B.query.product_id;return e?Array.isArray(e)?e.join(`
`):e:""},set:e=>{de.value=e}}),xe=i(()=>W.value.split(`
`).map(e=>e.trim()).filter(Boolean)),Xe=i(()=>xe.value[0]||""),Ie=i(()=>xe.value.map(e=>{let t=e.trim();return t.startsWith("http")&&(t=new URL(t).pathname.split("/").pop()),t!=null&&t.startsWith("col_")||t!=null&&t.startsWith("likenft")?t:""}).filter(Boolean)),we=i(()=>Ie.value[0]||"");function Le(e={}){const t=new URLSearchParams;return e.utmCampaign&&t.set("utm_campaign",e.utmCampaign),e.utmSource&&t.set("utm_source",e.utmSource),e.utmMedium&&t.set("utm_medium",e.utmMedium),t.toString().replace("?","")}const G=m(""),A=m(!0),H=m(""),K=m(""),me=i(()=>{const e=U.value==="liker_land";return I.value?"custom-link":e?"likerland":"stripe"}),pe=m(""),Q=i({get:()=>pe.value?pe.value:Le({utmCampaign:G.value,utmSource:K.value,utmMedium:H.value}),set:e=>{pe.value=e}}),Ye=i(()=>Le({utmCampaign:ge,utmSource:me.value,utmMedium:ke})),fe=i(()=>({utm_medium:ke,utm_source:me.value,utm_campaign:ge})),L=i(()=>{var r;const e={...fe.value},t=((r=Xe.value)==null?void 0:r.trim())||"";if(t.startsWith("http")){const{searchParams:a}=new URL(t);a.delete("from"),Object.assign(e,Object.fromEntries(a))}return Q.value&&Object.assign(e,Object.fromEntries(new URLSearchParams(Q.value))),e}),Ue=i(()=>Object.entries(L.value).filter(([e])=>!(e==="utm_campaign"&&A.value)).map(([e,t])=>({key:e,value:t}))),Se=m([{name:"Liker Land Product Page",value:"liker_land"},{name:"Stripe Checkout Page",value:"direct"},{name:"Custom Page",value:"custom"}]),U=m(Se.value[0].value),I=i(()=>U.value==="custom"),S=m(B.query.custom_link||""),_e=m(""),y=i({get:()=>{if(_e.value)return _e.value;const e=B.query.from;return e?Array.isArray(e)?e.join(","):e:""},set:e=>{_e.value=e}}),E=i(()=>y.value.split(",").map(e=>e.trim()).filter(Boolean).map(e=>{const t=Ce.getChannelInfoById(e);return{id:e,name:(t==null?void 0:t.displayName)||e}})),Re=m(!1),J=i({get:()=>!E.value.length||Re.value,set:e=>{Re.value=e}}),X=i(()=>E.value.concat(J.value?Lt:[])),x=i(()=>X.value.length>1),Y=m("");re(we,()=>{Y.value=""});const q=m("");re(y,()=>{q.value=""});const R=m(""),Ve=i(()=>!!R.value),Te=i(()=>I.value?!!S.value:!!we.value&&!Ve.value),g=m(void 0),Z=i(()=>{const e={};if(g.value)for(const{id:t,data:r}of g.value)r.prices?e[t]=r.prices.map(a=>{var d,c;let u="";return typeof a.name=="object"?u=((d=a.name)==null?void 0:d.zh)||((c=a.name)==null?void 0:c.en)||"":u=a.name,{label:[u,`$${a.price}`].filter(Boolean).join(" - "),value:a.index||0}}):e[t]=[];return e}),V=m({}),Pe=i(()=>{var e;return((e=g.value)==null?void 0:e.map(({id:t,data:r})=>{var a,u;return{id:t,name:((a=r.name)==null?void 0:a.zh)||((u=r.name)==null?void 0:u.en)||r.name,editionOptions:Z.value[t]||[]}}))||[]}),Ze=i(()=>{const e=[];return I.value||e.push({key:"productId",label:"Product",sortable:!0},{key:"selectedEditionLabel",label:"Edition"}),h.value||e.push({key:"utmCampaign",label:"UTM Campaign",sortable:!0}),e.push({key:"link",label:"Link"}),e}),ve=i(()=>{const e=new Map,t=[...new Map(X.value.map(a=>[a.id,a])).values()];return(I.value?[{id:"custom",data:{name:"Custom"}}]:g.value||[]).forEach(({id:a,data:u})=>{const d=a.startsWith("col_");t.forEach(c=>{var oe,D,j,ne,ae,le,se;e.has(c.id)||e.set(c.id,[]);let _=L.value.utm_campaign||fe.value.utm_campaign||"";A.value&&c.id!==Ut&&(_=`${St(c.id)}_${_}`);const P=V.value[a]||0,C={[d?"collectionId":"classId"]:a||"",channel:c.id,priceIndex:P,customLink:I.value?S.value:void 0,isUseLikerLandLink:U.value==="liker_land",query:{utm_campaign:_,...L.value}};(se=e.get(c.id))==null||se.push({productId:a,productName:((oe=u.name)==null?void 0:oe.zh)||((D=u.name)==null?void 0:D.en)||u.name,isCollection:d,selectedEditionIndex:P,selectedEditionLabel:d?`$${(((j=u==null?void 0:u.typePayload)==null?void 0:j.priceInDecimal)||0)/100}`:((le=(ae=(ne=Z.value)==null?void 0:ne[a])==null?void 0:ae[P])==null?void 0:le.label)||"",channelId:c.id,channelName:c.name,utmCampaign:_,utmMedium:L.value.utm_medium,utmSource:L.value.utm_source,url:Oe(C),qrCodeUrl:Oe({...C,isForQRCode:L.value.utm_source===fe.value.utm_source})})})}),e}),ee=i(()=>X.value.flatMap(e=>ve.value.get(e.id)||[])),O=e=>ve.value.get(e)||[],T=m(void 0),te=i({get:()=>!!T.value,set:e=>{e||(T.value=void 0)}});async function et(e){if(e.startsWith("col_")){const t=await We.fetchCollectionById(e);if(!t)throw new Error("Cannot fetch collection data.");return{id:e,data:t}}else{const t=await $fetch(`${z}/likernft/book/store/${e}`);return{id:e,data:t}}}async function be(){if(Y.value="",g.value=void 0,V.value={},q.value="",R.value="",!!Te.value)try{if(E.value.length){R.value="Validating custom channels...";const e=E.value.find(t=>!It(t.id));if(e){q.value=`Invalid channel "${e.id}", please enter a valid channel ID starting with "@"`;return}try{await Promise.all(E.value.map(async t=>{const r=await Ce.lazyFetchChannelInfoById(t.id);if(!r)throw new Error(`Channel ID "${t.id}" has not registered for Liker ID`);const a=await Ge.fetchStripeConnectStatusByWallet(r.likeWallet);if(!(a!=null&&a.hasAccount))throw new Error(`Channel ID "${t.id}" has not connected to Stripe`);if(!(a!=null&&a.isReady))throw new Error(`Channel ID "${t.id}" has not completed Stripe Connect setup`)}))}catch(t){q.value=t.message,h.value=!1;return}}R.value="Fetching product data...";try{const e=await Promise.all(Ie.value.map(t=>et(t)));g.value=e}catch(e){Y.value=e.message,h.value=!1}}catch(e){console.error(e),N.add({icon:"i-heroicons-exclamation-circle",title:"Failed to create affiliation link",timeout:0,color:"red",ui:{title:"text-red-400 dark:text-red-400"}}),h.value=!1}finally{R.value=""}}function De(e){const t=[];if(I.value){const r=new URL(S.value);t.push(r.hostname)}else t.push(`${e.productName||e.productId}`),e.isCollection&&t.push(`edition-${e.selectedEditionIndex}`);return e.channelId&&t.push(`channel-${e.channelId}`),t.join("_")}async function Me(e=""){await navigator.clipboard.writeText(e),N.add({icon:"i-heroicons-check-circle",title:"Copied link to clipboard",timeout:2e3,color:"green"})}function $e(e=[],t){Qt({data:e.map(({isCollection:r,selectedEditionIndex:a,selectedEditionLabel:u,...d})=>({edition:`${a+1}. ${u}`,...d})),fileName:["affiliation_links",t,Date.now()].filter(Boolean).join("_").concat(".csv"),fileType:"csv"})}function tt(){$e(ee.value)}function ot(e){return()=>$e(O(e))}function Be(e=[]){try{sessionStorage.setItem("nft_book_press_batch_qrcode",Ne(e.map(({channelId:t,qrCodeUrl:r,...a})=>({key:t,...a,url:r})))),window.open("/batch-qrcode?print=1","batch_qrcode","popup,menubar=no,location=no,status=no")}catch(t){console.error(t),N.add({icon:"i-heroicons-exclamation-circle",title:"Failed to print QR codes",timeout:0,color:"red",ui:{title:"text-red-400 dark:text-red-400"}})}}function nt(){Be(ee.value)}function at(e){return()=>Be(O(e))}function Ae(e=[]){try{sessionStorage.setItem("nft_book_press_batch_shorten_url",Ne(e.map(({channelId:t,...r})=>({key:t,...r})))),Et(Je({name:"batch-short-links",query:{print:1}}))}catch(t){console.error(t),N.add({icon:"i-heroicons-exclamation-circle",title:"Failed to shorten links",timeout:0,color:"red",ui:{title:"text-red-400 dark:text-red-400"}})}}function lt(){Ae(ee.value)}function st(e){return()=>Ae(O(e))}function it(e){return()=>{const t=new URL(`${ye}/affiliation-link`);t.searchParams.set("from",e),t.searchParams.set("share","1"),t.searchParams.set("nav","0"),O(e).forEach(a=>{t.searchParams.append("product_id",a.productId)}),Me(t.toString())}}async function Qe(e=[],t){const r=e.map(a=>({url:a.qrCodeUrl,filename:De(a)}));await Ht(r,{zipFilename:["affiliation_links_qrcodes",t,Date.now()].filter(Boolean).join("_")})}async function rt(){await Qe(ee.value)}function ut(e){return()=>Qe(O(e),e)}function he(){!y.value&&$.value&&(y.value=wt($.value.user))}return Ct(()=>{h.value&&xt(()=>{be()}),he()}),re(h,e=>{e?be():g.value=void 0}),re($,()=>{$.value&&he()}),(e,t)=>{const r=mt,a=Rt,u=qt,d=Ot,c=jt,Ee=Ft,_=Pt,P=zt,C=Vt,oe=Mt,D=Nt,j=Wt,ne=Bt,ae=Gt,le=At,se=Kt,ct=Jt;return v(),k(ct,null,{default:s(()=>[l(r,{title:o(ce)},null,8,["title"]),l(se,{class:"flex flex-col items-stretch grow space-y-8"},{default:s(()=>[!o(g)&&o(h)||o(Ve)?(v(),ue("div",eo,[l(a,{class:"w-10 h-10 animate-spin",name:"i-heroicons-arrow-path-20-solid"}),p("span",{class:"text-gray-400 dark:text-gray-700 text-sm",textContent:F(o(R)||"Creating affiliation links...")},null,8,to)])):o(g)?(v(),ue(je,{key:2},[o(h)?M("",!0):(v(),ue("header",lo,[l(_,{icon:"i-heroicons-arrow-uturn-left",label:"Back to configuration",variant:"soft",onClick:t[10]||(t[10]=n=>g.value=void 0)})])),o(x)&&o(Pe).length?(v(),k(C,{key:1,ui:{body:{padding:""}}},{header:s(()=>t[15]||(t[15]=[p("h3",{class:"text-lg font-bold",textContent:"Product List"},null,-1)])),default:s(()=>[l(D,{columns:[{key:"name",label:"Name"},{key:"editionSelect",label:"Selected Edition"}],rows:o(Pe)},{"name-data":s(({row:n})=>[p("span",{textContent:F(n.name)},null,8,so)]),"editionSelect-data":s(({row:n})=>[n.editionOptions.length?(v(),k(u,{key:0,class:"min-w-[200px]","model-value":o(V)[n.id]||0,options:n.editionOptions,"onUpdate:modelValue":f=>o(V)[n.id]=f},null,8,["model-value","options","onUpdate:modelValue"])):M("",!0)]),_:1},8,["rows"])]),_:1})):M("",!0),!o(h)&&o(Ue).length?(v(),k(C,{key:2,ui:{body:{padding:""}}},{header:s(()=>t[16]||(t[16]=[p("h3",{class:"text-lg font-bold",textContent:"Common Query String"},null,-1)])),default:s(()=>[l(D,{columns:[{key:"key",label:"Key"},{key:"value",label:"Value"}],rows:o(Ue),ui:{td:{font:"font-mono"}}},null,8,["rows"])]),_:1})):M("",!0),l(C,{ui:{header:{base:"flex justify-between items-center gap-4"},body:{base:"space-y-8",padding:o(x)?void 0:""}}},Fe({default:s(()=>[(v(!0),ue(je,null,$t(o(X),n=>(v(),k(C,{key:n.id,ui:{base:"overflow-hidden",ring:o(x)?void 0:"",shadow:o(x)?void 0:"",header:{base:"flex justify-between items-center gap-4"},body:{padding:""}}},{header:s(()=>[p("h3",io,[p("span",{class:ze(o(x)?"text-md":"text-lg"),textContent:F(n.name)},null,10,ro),p("span",{class:ze([o(x)?"text-xs":"text-sm","text-gray-400 dark:text-gray-700","font-mono"]),textContent:F(n.id)},null,10,uo)]),l(j,{items:[[{label:"Print QR Codes",icon:"i-heroicons-qr-code",click:at(n.id)},{label:"Download QR Codes",icon:"i-heroicons-arrow-down-on-square-stack",click:ut(n.id)},{label:"Download Links",icon:"i-heroicons-arrow-down-on-square-stack",click:ot(n.id)},{label:"Shorten Links",icon:"i-heroicons-sparkles",click:st(n.id)},{label:"Share Table",icon:"i-heroicons-document-duplicate",click:it(n.id)}]],popper:{placement:"top-end"}},{default:s(()=>[l(_,{icon:"i-heroicons-ellipsis-horizontal-20-solid",color:"gray",size:"sm",variant:"soft"})]),_:2},1032,["items"])]),default:s(()=>[l(D,{columns:o(Ze),rows:o(ve).get(n.id)},Fe({"productId-data":s(({row:f})=>[p("div",{textContent:F(f.productName)},null,8,co)]),"utmCampaign-data":s(({row:f})=>[l(ne,{class:"font-mono",value:f.utmCampaign},null,8,["value"])]),"link-data":s(({row:f})=>[p("div",mo,[l(_,{icon:"i-heroicons-qr-code",variant:"outline",size:"xs",onClick:ie=>T.value=f},null,8,["onClick"]),l(_,{icon:"i-heroicons-document-duplicate",variant:"outline",size:"xs",onClick:ie=>Me(f.url||"")},null,8,["onClick"]),l(_,{class:"font-mono break-all",label:f.url,to:f.url,color:"gray",variant:"outline",size:"xs",target:"_blank"},null,8,["label","to"])])]),_:2},[o(x)?void 0:{name:"selectedEditionLabel-data",fn:s(({row:f})=>{var ie,qe;return[(ie=o(Z))!=null&&ie[f.productId].length?(v(),k(u,{key:0,class:"min-w-[200px]","model-value":o(V)[f.productId]||0,options:((qe=o(Z))==null?void 0:qe[f.productId])||[],"onUpdate:modelValue":dt=>o(V)[f.productId]=dt},null,8,["model-value","options","onUpdate:modelValue"])):M("",!0)]}),key:"0"}]),1032,["columns","rows"])]),_:2},1032,["ui"]))),128))]),_:2},[o(x)?{name:"header",fn:s(()=>[t[17]||(t[17]=p("h2",{class:"text-lg font-bold",textContent:"Affiliation Links by Channel"},null,-1)),l(j,{items:[[{label:"Print All QR Codes",icon:"i-heroicons-qr-code",click:nt},{label:"Download QR Codes",icon:"i-heroicons-arrow-down-on-square-stack",click:rt},{label:"Download All Links",icon:"i-heroicons-arrow-down-on-square-stack",click:tt},{label:"Shorten All Links",icon:"i-heroicons-sparkles",click:lt}]],popper:{placement:"top-end"}},{default:s(()=>[l(_,{icon:"i-heroicons-ellipsis-horizontal-20-solid",color:"gray",variant:"soft"})]),_:1},8,["items"])]),key:"0"}:void 0]),1032,["ui"]),l(le,{modelValue:o(te),"onUpdate:modelValue":t[12]||(t[12]=n=>b(te)?te.value=n:null)},{default:s(()=>[o(T)?(v(),k(ae,{key:0,data:o(T).qrCodeUrl,"file-name":De(o(T)),width:500,height:500},{header:s(()=>[t[18]||(t[18]=p("h3",{class:"font-bold font-mono"}," Download QR Code ",-1)),l(_,{icon:"i-heroicons-x-mark",color:"gray",variant:"ghost",onClick:t[11]||(t[11]=n=>te.value=!1)})]),_:1},8,["data","file-name"])):M("",!0)]),_:1},8,["modelValue"])],64)):(v(),k(C,{key:1,ui:{body:{base:"space-y-4"},footer:{base:"flex justify-end"}}},{footer:s(()=>[l(_,{label:"Generate",size:"lg",disabled:!o(Te),onClick:be},null,8,["disabled"])]),default:s(()=>[l(d,{label:"Destination"},{default:s(()=>[l(u,{modelValue:o(U),"onUpdate:modelValue":t[0]||(t[0]=n=>b(U)?U.value=n:null),options:o(Se),"option-attribute":"name"},null,8,["modelValue","options"])]),_:1}),o(I)?(v(),k(d,{key:0,label:"Custom Page URL",required:!0},{default:s(()=>[l(c,{modelValue:o(S),"onUpdate:modelValue":t[1]||(t[1]=n=>b(S)?S.value=n:null),class:"font-mono",placeholder:"https://3ook.com/store?tag=blockchain",name:"custom_destination_url"},null,8,["modelValue"])]),_:1})):(v(),k(d,{key:1,label:"Product ID/URL(s)",error:o(Y),required:!0},{default:s(()=>[l(Ee,{modelValue:o(W),"onUpdate:modelValue":t[2]||(t[2]=n=>b(W)?W.value=n:null),class:"font-mono",placeholder:`0x53c7243b94b3c4a4827816f00d72394ddfb974c4
0x146736dd2ccb1dbdf266130a117609e00ad566b1`,autoresize:!0,name:"product_id"},null,8,["modelValue"])]),_:1},8,["error"])),l(d,{label:"Channel ID(s)",hint:"Optional",error:o(q),ui:{help:"flex items-center gap-2"}},{help:s(()=>[l(P,{modelValue:o(J),"onUpdate:modelValue":t[4]||(t[4]=n=>b(J)?J.value=n:null),disabled:!o(y)},null,8,["modelValue","disabled"]),t[13]||(t[13]=p("span",{textContent:"Include default channels"},null,-1))]),default:s(()=>[p("div",oo,[l(c,{modelValue:o(y),"onUpdate:modelValue":t[3]||(t[3]=n=>b(y)?y.value=n:null),class:"grow font-mono",placeholder:"Channel ID(s), separated by commas (e.g. @store01, @store02)",name:"channel_ids"},null,8,["modelValue"]),Tt(l(_,{class:"relative",label:"Prefill from Account",color:"gray",variant:"outline",size:"2xs",onClick:he},null,512),[[Dt,!o(y)&&o($)]])])]),_:1},8,["error"]),l(oe,{color:"gray",variant:"soft",size:"md",items:[{label:"Query String (Optional)",defaultOpen:!0,slot:"body"}],ui:{item:{padding:"p-0"}}},{body:s(()=>[l(C,{ui:{body:{base:"space-y-4"}}},{default:s(()=>[p("div",no,[l(d,{class:"flex-1",label:"UTM Campaign"},{default:s(()=>[l(c,{modelValue:o(G),"onUpdate:modelValue":t[5]||(t[5]=n=>b(G)?G.value=n:null),class:"font-mono",name:"utm_campaign",placeholder:`e.g. ${ge}`},null,8,["modelValue","placeholder"])]),_:1}),l(d,{class:"flex-1",label:"UTM Source"},{default:s(()=>[l(c,{modelValue:o(K),"onUpdate:modelValue":t[6]||(t[6]=n=>b(K)?K.value=n:null),class:"font-mono",name:"utm_source",placeholder:`e.g. ${o(me)}`},null,8,["modelValue","placeholder"])]),_:1}),l(d,{class:"flex-1",label:"UTM Medium"},{default:s(()=>[l(c,{modelValue:o(H),"onUpdate:modelValue":t[7]||(t[7]=n=>b(H)?H.value=n:null),class:"font-mono",name:"utm_medium",placeholder:`e.g. ${ke}`},null,8,["modelValue","placeholder"])]),_:1})]),l(d,{label:"Additional Query String"},{default:s(()=>[l(c,{modelValue:o(Q),"onUpdate:modelValue":t[8]||(t[8]=n=>b(Q)?Q.value=n:null),class:"font-mono",placeholder:o(Ye),name:"query_params"},null,8,["modelValue","placeholder"])]),_:1}),p("div",ao,[l(P,{modelValue:o(A),"onUpdate:modelValue":t[9]||(t[9]=n=>b(A)?A.value=n:null)},null,8,["modelValue"]),t[14]||(t[14]=p("span",{textContent:"Prefix Channel ID for UTM Campaign"},null,-1))])]),_:1})]),_:1})]),_:1}))]),_:1})]),_:1})}}});export{Do as default};
