<template>
  <UModal :model-value="true">
    <!-- Loading -->
    <UCard v-if="isLoading">
      <template #header>
        <h2 class="text-sm font-bold font-mono">
          Refreshing Stripe Connect Account Status
        </h2>
      </template>

      <UProgress animation="carousel">
        <template #indicator>
          Refreshing...
        </template>
      </UProgress>
    </UCard>

    <!-- Success case -->
    <UCard v-else-if="isDone && !error">
      <template #header>
        <h2 class="text-sm font-bold font-mono">
          Stripe Connect Account Status Refreshed
        </h2>
      </template>

      <UProgress :value="100">
        <template #indicator>
          Refreshed! Redirect back in 3 seconds...
        </template>
      </UProgress>
    </UCard>

    <!-- Error case -->
    <UCard
      v-else
      :ui="{
        body: { base: 'space-y-4' },
        footer: { base: 'text-center' }
      }"
    >
      <template #header>
        <h2 class="text-sm font-bold font-mono">
          An error occurred when refreshing the Stripe Connect Account Status
        </h2>
      </template>

      <UProgress :value="100" color="red" />

      <UAlert
        icon="i-heroicons-exclamation-triangle"
        color="red"
        variant="soft"
        :title="error || 'Unknown error'"
      />

      <template #footer>
        <UButton
          label="Go Back"
          :to="{ name: 'nft-book-store-user' }"
        />
      </template>
    </UCard>
  </UModal>
</template>

<script setup lang="ts">
import { storeToRefs } from 'pinia'
import { useBookStoreApiStore } from '~/stores/book-store-api'
import { LIKE_CO_API } from '~/constant'

const router = useRouter()
const bookStoreApiStore = useBookStoreApiStore()
const { token } = storeToRefs(bookStoreApiStore)

const error = ref('')
const isLoading = ref(false)
const isDone = ref(false)

definePageMeta({
  layout: 'page'
})

watch(isLoading, (newIsLoading) => {
  if (newIsLoading) { error.value = '' }
})

onMounted(async () => {
  try {
    isLoading.value = true
    const { data, error: fetchError } = await useFetch(`${LIKE_CO_API}/likernft/book/user/connect/refresh`,
      {
        method: 'POST',
        headers: {
          authorization: `Bearer ${token.value}`
        }
      }
    )
    if (fetchError.value) {
      throw new Error(fetchError.value.toString())
    }
    isDone.value = (data.value as any).isReady || false

    setTimeout(() => {
      router.replace({ name: 'nft-book-store-user' })
    }, 3000)
  } catch (e) {
    console.error(e)
    error.value = (e as Error).toString()
  } finally {
    isLoading.value = false
  }
})
</script>
